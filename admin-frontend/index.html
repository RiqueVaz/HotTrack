<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HotTrack Command Center 2.0</title>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1C1C1C">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="icon" href="https://i.postimg.cc/ZnHB6HB5/icon-512x512.png">
    <link rel="apple-touch-icon" href="https://i.postimg.cc/ZnHB6HB5/icon-512x512.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --bg: #111111; --surface: #1C1C1C; --border: #2D2D2D;
            --text-primary: #FFFFFF; --text-secondary: #A0A0A0;
            --accent: #9333EA; --accent-hover: #7E22CE;
            --danger: #E11D48; --success: #22C55E; --warning: #F59E0B;
        }
        * { box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg); color: var(--text-primary); margin: 0; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;}
        
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Layout */
        #app-container { display: flex; min-height: 100vh; visibility: hidden; }
        #sidebar { width: 240px; background: var(--surface); border-right: 1px solid var(--border); padding: 20px; display: flex; flex-direction: column; position: fixed; height: 100%; z-index: 200; transition: transform 0.3s ease; }
        main { flex-grow: 1; padding: 30px; margin-left: 240px; width: calc(100% - 240px); }

        /* Components */
        .card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 25px; margin-bottom: 20px; }
        .card h3 { margin-top: 0; margin-bottom: 8px; color: var(--text-secondary); font-size: 14px; font-weight: 500; text-transform: uppercase; }
        .card .metric-value { font-size: 26px; font-weight: 700; color: var(--text-primary); }
        .nav-link { padding: 12px 15px; text-decoration: none; color: var(--text-secondary); font-weight: 500; border-radius: 8px; display: flex; align-items: center; gap: 12px; transition: background-color 0.2s, color 0.2s; }
        .nav-link.active, .nav-link:hover { color: var(--text-primary); background-color: rgba(147, 51, 234, 0.15); }
        .nav-link i { width: 18px; height: 18px; }
        
        /* Forms & Inputs */
        input, button, select, textarea { font-family: 'Inter', sans-serif; border-radius: 8px; border: 1px solid var(--border); padding: 12px 15px; font-size: 14px; background-color: var(--bg); color: var(--text-primary); transition: all 0.2s; width: 100%; }
        input:focus, select:focus, textarea:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 2px rgba(147, 51, 234, 0.2); }
        button { cursor: pointer; background-color: var(--accent); color: var(--text-primary); font-weight: 600; border-color: var(--accent); }
        button:hover:not(:disabled) { background-color: var(--accent-hover); }
        button:disabled { background-color: var(--border); color: var(--text-secondary); cursor: not-allowed; }
        .form-group { display: flex; flex-direction: column; gap: 8px; margin-bottom: 15px; }
        label { color: var(--text-secondary); font-weight: 500; font-size: 14px; }
        
        /* Table */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border); }
        th { color: var(--text-secondary); font-weight: 500; font-size: 12px; text-transform: uppercase; }
        tbody tr:hover { background-color: rgba(255,255,255,0.03); }

        /* Login Screen */
        #login-screen { position: fixed; inset: 0; z-index: 2000; background: var(--bg); display: flex; align-items: center; justify-content: center; transition: opacity 0.3s; }
        #login-box { background: var(--surface); padding: 30px; border-radius: 12px; width: 90%; max-width: 350px; text-align: center; border: 1px solid var(--border); }

        /* Modal */
        #modal-container { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; opacity: 0; transition: opacity 0.2s; }
        #modal-container.show { display: flex; opacity: 1; }
        .modal-content { background: var(--surface); padding: 30px; border-radius: 12px; width: 90%; max-width: 450px; border: 1px solid var(--border); transform: scale(0.95); transition: transform 0.2s; }
        #modal-container.show .modal-content { transform: scale(1); }
        
        /* Toasts (Notifications) */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 12px 18px; border-radius: 8px; color: white; font-weight: 500; display: flex; align-items: center; gap: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); animation: slideIn 0.3s ease-out forwards; }
        .toast.success { background-color: var(--success); }
        .toast.error { background-color: var(--danger); }
        .toast.warning { background-color: var(--warning); color: #111; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        
        /* Mobile */
        #menu-toggle { display: none; }
        @media (max-width: 768px) {
            #sidebar { transform: translateX(-100%); }
            #sidebar.show { transform: translateX(0); box-shadow: 10px 0 20px rgba(0,0,0,0.2); }
            main { margin-left: 0; width: 100%; padding: 20px; }
            #menu-toggle { display: block; position: fixed; top: 15px; left: 15px; z-index: 300; background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 10px; color: var(--text-primary); }
        }
    </style>
</head>
<body>
    <div id="login-screen">
        <div id="login-box">
            <h2 style="color: var(--accent); margin-bottom: 5px;">HotTrack</h2>
            <p style="color: var(--text-secondary); margin-top: 0; margin-bottom: 25px;">Acesso de Administrador</p>
            <form id="login-form">
                <input type="password" id="admin-key-input" placeholder="Sua ADMIN_API_KEY" required>
                <button type="submit" style="margin-top: 15px;">Entrar</button>
            </form>
        </div>
    </div>

    <button id="menu-toggle">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
    </button>
    
    <div id="app-container">
        <aside id="sidebar">
            <h2 style="font-weight: 700; color: var(--accent); text-align: center; margin-bottom: 40px;">HotTrack</h2>
            <nav id="main-nav" style="display: flex; flex-direction: column; gap: 10px;"></nav>
        </aside>
        <main id="main-content">
            <div id="dashboard" class="page"></div>
            <div id="sellers" class="page"></div>
            <div id="transactions" class="page"></div>
            <div id="tools" class="page"></div>
            <div id="settings" class="page"></div>
        </main>
    </div>

    <div id="modal-container"></div>
    <div id="toast-container"></div>

    <script>
    // --- CONFIG & STATE ---
    const CONFIG = {
        API_URL: 'http://localhost:3002/api',
        NAV_ITEMS: [
            { id: 'dashboard', label: 'Dashboard', icon: 'layout-dashboard' },
            { id: 'sellers', label: 'Vendedores', icon: 'users' },
            { id: 'transactions', label: 'Transações', icon: 'arrow-left-right' },
            { id: 'tools', label: 'Ferramentas', icon: 'wrench' },
            { id: 'settings', label: 'Definições', icon: 'settings' },
        ]
    };

    const appState = {
        sellers: [], allTransactions: [], allRanking: [], allUsage: [], dashboardData: {},
        currentSeller: null,
    };

    function setState(newState) {
        Object.assign(appState, newState);
    }

    // --- DOM ELEMENTS CACHE ---
    const DOM = {
        loginScreen: document.getElementById('login-screen'),
        appContainer: document.getElementById('app-container'),
        loginForm: document.getElementById('login-form'),
        adminKeyInput: document.getElementById('admin-key-input'),
        sidebar: document.getElementById('sidebar'),
        menuToggle: document.getElementById('menu-toggle'),
        mainNav: document.getElementById('main-nav'),
        mainContent: document.getElementById('main-content'),
        modalContainer: document.getElementById('modal-container'),
        toastContainer: document.getElementById('toast-container'),
    };

    // --- UTILS ---
    const toBrasiliaTime = (dateString) => new Date(new Date(dateString).toLocaleString('en-US', { timeZone: 'America/Sao_Paulo' }));
    const formatToBrasiliaString = (date) => date.toLocaleString('pt-BR', { year: '2-digit', month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
    const formatCurrency = (value) => (value || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    const urlBase64ToUint8Array = (base64String) => {
        const padding = '='.repeat((4 - base64String.length % 4) % 4);
        const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
        const rawData = window.atob(base64);
        return Uint8Array.from(rawData, char => char.charCodeAt(0));
    };

    // --- UI COMPONENTS ---
    function showToast(message, type = 'success', duration = 4000) {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<span>${message}</span>`;
        DOM.toastContainer.appendChild(toast);
        setTimeout(() => toast.remove(), duration);
    }

    function showModal(contentHTML) {
        DOM.modalContainer.innerHTML = `<div class="modal-content">${contentHTML}</div>`;
        DOM.modalContainer.classList.add('show');
    }

    function closeModal() {
        DOM.modalContainer.classList.remove('show');
        DOM.modalContainer.innerHTML = '';
    }

    // --- API ---
    async function apiFetch(endpoint, options = {}) {
        const adminKey = localStorage.getItem('adminApiKey');
        if (!adminKey) throw new Error("Chave de Admin não encontrada.");
        const config = { method: 'GET', ...options, headers: { 'Content-Type': 'application/json', 'x-admin-api-key': adminKey, ...options.headers } };
        const res = await fetch(`${CONFIG.API_URL}${endpoint}`, config);
        if (res.status === 403) throw new Error("Chave de API inválida ou expirada.");
        if (!res.ok) {
            const errJson = await res.json().catch(() => ({ message: "Erro desconhecido na resposta da API." }));
            throw new Error(errJson.message || "Erro de rede.");
        }
        const contentType = res.headers.get("content-type");
        return contentType?.includes("application/json") ? res.json() : res.text();
    }

    // --- PAGE RENDERERS ---
    function renderNav() {
        DOM.mainNav.innerHTML = CONFIG.NAV_ITEMS.map(item => `
            <a href="#${item.id}" class="nav-link" data-page="${item.id}">
                <i data-lucide="${item.icon}"></i> ${item.label}
            </a>
        `).join('');
        lucide.createIcons();
    }

    function renderPage(pageId, content) {
        const pageElement = document.getElementById(pageId);
        if (pageElement) pageElement.innerHTML = content;
    }

    function renderDashboardPage() {
        const { saas_profit = 0, total_revenue = 0, total_paid_transactions = 0, total_sellers = 0 } = appState.dashboardData;
        const ticketMedio = total_paid_transactions > 0 ? total_revenue / total_paid_transactions : 0;
        const arpu = total_sellers > 0 ? total_revenue / total_sellers : 0;
        const topUsage = appState.allUsage.slice(0, 5);

        const content = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="margin:0;">Dashboard Estratégico</h2>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;">
                <div class="card"><h3>Lucro do SaaS</h3><p class="metric-value" style="color:var(--success);">${formatCurrency(parseFloat(saas_profit))}</p></div>
                <div class="card"><h3>Ticket Médio</h3><p class="metric-value">${formatCurrency(ticketMedio)}</p></div>
                <div class="card"><h3>Receita / Vendedor</h3><p class="metric-value">${formatCurrency(arpu)}</p></div>
                <div class="card"><h3>Vendedores Ativos</h3><p class="metric-value">${total_sellers}</p></div>
            </div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                <div class="card">
                    <h2>Leaderboard (Receita)</h2>
                    <table><thead><tr><th>Vendedor</th><th style="text-align: right;">Receita</th></tr></thead><tbody>
                        ${appState.allRanking.slice(0, 5).map(s => `<tr><td>${s.name}</td><td style="text-align: right;">${formatCurrency(s.total_revenue)}</td></tr>`).join('') || `<tr><td colspan="2" style="text-align:center;">Nenhum dado.</td></tr>`}
                    </tbody></table>
                </div>
                <div class="card">
                    <h2>Vendedores Mais Ativos (24h)</h2>
                     <table><thead><tr><th>Vendedor</th><th style="text-align: right;">Requisições</th></tr></thead><tbody>
                        ${topUsage.map(u => `<tr><td>${u.name}</td><td style="text-align: right;">${u.requests_last_24_hours}</td></tr>`).join('') || `<tr><td colspan="2" style="text-align:center;">Nenhum dado.</td></tr>`}
                    </tbody></table>
                </div>
            </div>
            `;
        renderPage('dashboard', content);
    }
    
    function renderSellersPage() {
        const content = `
            <div class="card">
                <h2>Gerir Vendedores</h2>
                <input type="text" id="seller-search" placeholder="Buscar por nome ou e-mail..." style="margin-bottom: 20px;">
                <div style="max-height: 60vh; overflow-y: auto;">
                <table><thead><tr><th>Vendedor</th><th>Faturamento Total</th><th>Comissão</th><th>Reqs (24h)</th><th>Status</th><th>Ações</th></tr></thead><tbody id="sellers-tbody"></tbody></table>
                </div>
            </div>`;
        renderPage('sellers', content);
        renderSellersTable();
    }

    function renderSellersTable(filteredSellers = null) {
        const usageMap = new Map(appState.allUsage.map(u => [u.id, u.requests_last_24_hours]));
        const rankingMap = new Map(appState.allRanking.map(r => [r.id, r.total_revenue]));
        let sellersData = filteredSellers || appState.sellers;
        
        const tbody = document.getElementById('sellers-tbody');
        if (!tbody) return;
        
        tbody.innerHTML = sellersData.map(s => {
            const revenue = rankingMap.get(s.id) || 0;
            const requests = usageMap.get(s.id) || 0;
            const commission = ((s.commission_rate || 0.0299) * 100).toFixed(2);
            return `<tr>
                <td>${s.name}<br><small style="color: var(--text-secondary);">${s.email}</small></td>
                <td>${formatCurrency(revenue)}</td>
                <td>${commission}%</td>
                <td>${requests}</td>
                <td style="color: ${s.is_active ? 'var(--success)' : 'var(--danger)'}; font-weight: bold;">${s.is_active ? 'Ativo' : 'Bloqueado'}</td>
                <td><button data-action="manage-seller" data-seller-id="${s.id}" style="font-size: 12px; padding: 6px 10px;">Gerir</button></td>
            </tr>`
        }).join('');
    }

    function renderTransactionsPage() {
        const content = `
            <div class="card">
                <h2>Transações</h2>
                <div style="display: flex; gap: 15px; margin-bottom: 20px;">
                    <input type="date" id="tx-start-date">
                    <input type="date" id="tx-end-date">
                    <button id="tx-filter-btn" style="width: auto; white-space: nowrap;">Filtrar</button>
                </div>
                <div style="max-height: 60vh; overflow-y: auto;">
                <table><thead><tr><th>Vendedor</th><th>Status</th><th>Valor</th><th>Data</th></tr></thead><tbody id="transactions-tbody"></tbody></table>
                </div>
            </div>`;
        renderPage('transactions', content);
        renderTransactionsTable(appState.allTransactions);
    }
    
    function renderTransactionsTable(transactions) {
        const tbody = document.getElementById('transactions-tbody');
        if (!tbody) return;
        tbody.innerHTML = transactions.slice(0, 150).map(tx => `
            <tr>
                <td>${tx.seller_name || 'N/A'}</td>
                <td style="color:${tx.status === 'paid' ? 'var(--success)' : 'var(--text-secondary)'}">${tx.status}</td>
                <td>${formatCurrency(tx.pix_value)}</td>
                <td>${formatToBrasiliaString(toBrasiliaTime(tx.created_at))}</td>
            </tr>`).join('');
    }

    function renderToolsPage() {
        const sellerOptions = appState.sellers.map(s => `<option value="${s.id}">${s.name} (${s.email})</option>`).join('');
        const content = `
            <div class="card">
                <h2>Reenviar Eventos (Pixel Warming)</h2>
                <p style="color:var(--text-secondary)">Envie eventos de compra para a Meta com dados enriquecidos para maximizar a correspondência.</p>
                <form id="resend-events-form" style="margin-top: 1.5em;">
                    <div class="form-group"><label for="target-pixel-id">ID do Pixel de Destino</label><input type="text" id="target-pixel-id" placeholder="123456789012345" required></div>
                    <div class="form-group"><label for="target-meta-token">Token de Acesso da API da Meta</label><input type="text" id="target-meta-token" placeholder="EAA..." required></div>
                    <div class="form-group"><label for="resend-seller-id">Vendedor (Opcional)</label><select id="resend-seller-id"><option value="">Todos</option>${sellerOptions}</select></div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group"><label for="start-date">Data de Início</label><input type="date" id="start-date" required></div>
                        <div class="form-group"><label for="end-date">Data de Fim</label><input type="date" id="end-date" required></div>
                    </div>
                    <button type="submit">Iniciar Envio</button>
                </form>
            </div>`;
        renderPage('tools', content);
    }
    
    function renderSettingsPage() {
        const content = `
            <div class="card">
                <h2>Notificações Push</h2>
                <p style="color:var(--text-secondary)">Receba um alerta no seu dispositivo a cada nova venda.</p>
                <button id="enable-notifications-btn" style="max-width: 250px; margin-top: 1em;">Ativar Notificações</button>
            </div>`;
        renderPage('settings', content);
    }

    // --- EVENT HANDLERS ---
    function handleNavigation(hash) {
        hash = hash || '#dashboard';
        const pageId = hash.substring(1);
        
        DOM.mainNav.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active', l.hash === hash));
        document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', p.id === pageId));
        
        const renderFunction = {
            'dashboard': renderDashboardPage, 'sellers': renderSellersPage,
            'transactions': renderTransactionsPage, 'tools': renderToolsPage, 'settings': renderSettingsPage
        }[pageId];
        
        if (renderFunction) renderFunction();
    }

    async function handleLogin(e) {
        e.preventDefault();
        const key = DOM.adminKeyInput.value;
        if (key) {
            localStorage.setItem('adminApiKey', key);
            await initializeApp();
        }
    }

    function handleSellerSearch(e) {
        const query = e.target.value.toLowerCase();
        const filtered = appState.sellers.filter(s => s.name.toLowerCase().includes(query) || s.email.toLowerCase().includes(query));
        renderSellersTable(filtered);
    }

    function handleManageSeller(sellerId) {
        const seller = appState.sellers.find(s => s.id === parseInt(sellerId));
        if (!seller) return;
        setState({ currentSeller: seller });
        
        const currentCommission = ((seller.commission_rate || 0.0299) * 100).toFixed(2);

        showModal(`
            <h3 style="margin-top: 0;">${seller.name}</h3>
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div>
                    <h4>Alterar Comissão (%)</h4>
                    <input type="number" id="new-commission-rate" step="0.01" placeholder="Ex: 2.99" value="${currentCommission}">
                    <button data-action="save-commission" style="margin-top: 10px;">Salvar Comissão</button>
                </div>
                <div>
                    <h4>Alterar Senha</h4>
                    <input type="password" id="new-password" placeholder="Nova senha (mín. 8 caracteres)">
                    <button data-action="save-password" style="margin-top: 10px;">Salvar Senha</button>
                </div>
                <div>
                    <h4>Ações</h4>
                    <button data-action="toggle-status" style="background-color: ${seller.is_active ? 'var(--warning)' : 'var(--success)'}; color: ${seller.is_active ? '#111' : '#fff'};">
                        ${seller.is_active ? 'Bloquear Vendedor' : 'Desbloquear Vendedor'}
                    </button>
                </div>
            </div>
            <button data-action="close-modal" style="margin-top: 20px; background: none; border: 1px solid var(--border); color: var(--text-secondary);">Fechar</button>
        `);
    }

    async function handleModalClick(e) {
        const action = e.target.dataset.action;
        if (!action) return;

        if (action === 'close-modal') closeModal();
        
        if (action === 'save-commission') {
            const newCommissionPercent = parseFloat(document.getElementById('new-commission-rate').value);
            if (isNaN(newCommissionPercent) || newCommissionPercent < 0 || newCommissionPercent > 100) {
                return showToast("Insira um valor de comissão válido (ex: 2.99).", 'warning');
            }
            const commission_rate = newCommissionPercent / 100;
            try {
                await apiFetch(`/api/admin/sellers/${appState.currentSeller.id}/commission`, { method: 'PUT', body: JSON.stringify({ commission_rate }) });
                showToast('Comissão alterada com sucesso!');
                await fetchAllInitialData();
                renderSellersTable();
                closeModal();
            } catch(err) { showToast(`Erro: ${err.message}`, 'error'); }
        }

        if (action === 'save-password') {
            const newPassword = document.getElementById('new-password').value;
            if (!newPassword || newPassword.length < 8) return showToast("A senha deve ter pelo menos 8 caracteres.", 'warning');
            try {
                await apiFetch(`/api/admin/sellers/${appState.currentSeller.id}/password`, { method: 'PUT', body: JSON.stringify({ newPassword }) });
                showToast('Senha alterada com sucesso!');
                closeModal();
            } catch(err) { showToast(`Erro: ${err.message}`, 'error'); }
        }

        if (action === 'toggle-status') {
            const newStatus = !appState.currentSeller.is_active;
            if (!confirm(`Tem certeza que deseja ${newStatus ? 'desbloquear' : 'bloquear'} este vendedor?`)) return;
            try {
                 await apiFetch(`/api/admin/sellers/${appState.currentSeller.id}/toggle-active`, { method: 'POST', body: JSON.stringify({ isActive: newStatus }) });
                 showToast(`Vendedor ${newStatus ? 'desbloqueado' : 'bloqueado'}!`);
                 await fetchAllInitialData();
                 renderSellersTable();
                 closeModal();
            } catch(err) { showToast(`Erro: ${err.message}`, 'error'); }
        }
    }
    
    async function handleResendEvents(e) {
        e.preventDefault();
        const form = e.target;
        const button = form.querySelector('button[type="submit"]');
        button.disabled = true;
        button.textContent = 'Iniciando...';
        showToast('Iniciando processo de reenvio em lotes...', 'warning');

        try {
            const commonBody = {
                target_pixel_id: document.getElementById('target-pixel-id').value,
                target_meta_api_token: document.getElementById('target-meta-token').value,
                seller_id: document.getElementById('resend-seller-id').value,
                start_date: document.getElementById('start-date').value,
                end_date: document.getElementById('end-date').value,
            };
            if (commonBody.seller_id) commonBody.seller_id = parseInt(commonBody.seller_id, 10);

            let currentPage = 1;
            let totalPages = 1;
            while (currentPage <= totalPages) {
                button.textContent = `Processando Lote ${currentPage}/${totalPages}...`;
                const response = await apiFetch('/api/admin/resend-events', { method: 'POST', body: JSON.stringify({ ...commonBody, page: currentPage, limit: 50 }) });
                totalPages = response.total_pages || 0;
                if (totalPages === 0) {
                    showToast(response.message || "Nenhum evento encontrado para o período.", 'warning');
                    break;
                }
                showToast(`Lote ${currentPage}/${totalPages} concluído.`, 'success');
                currentPage++;
            }
             showToast('Processo de reenvio finalizado!', 'success');
             form.reset();
        } catch (error) {
            showToast(`Erro no processo: ${error.message}`, 'error');
        } finally {
            button.disabled = false;
            button.textContent = 'Iniciar Envio';
        }
    }
    
    // --- PUSH NOTIFICATIONS ---
    async function setupPushNotifications() {
        if (!('serviceWorker' in navigator && 'PushManager' in window)) return showToast('Seu navegador não suporta notificações.', 'error');
        try {
            const registration = await navigator.serviceWorker.register('sw.js');
            const permission = await Notification.requestPermission();
            if (permission !== 'granted') return showToast('Permissão para notificações negada.', 'warning');
            
            let subscription = await registration.pushManager.getSubscription();
            if (subscription === null) {
                const vapidPublicKey = await apiFetch('/api/admin/vapidPublicKey');
                if (!vapidPublicKey) throw new Error("Não foi possível obter a chave VAPID.");
                subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(vapidPublicKey)
                });
            }
            await apiFetch('/api/admin/save-subscription', { method: 'POST', body: JSON.stringify(subscription) });
            showToast('Notificações ativadas com sucesso!');
        } catch (error) {
            console.error('Falha ao configurar notificações:', error);
            showToast('Ocorreu um erro ao ativar as notificações.', 'error');
        }
    }

    async function tryReactivatingNotifications() {
        if (!('serviceWorker' in navigator && 'PushManager' in window)) return;
        try {
            const registration = await navigator.serviceWorker.register('sw.js');
            if (await Notification.permission === 'granted') {
                const subscription = await registration.pushManager.getSubscription();
                if (subscription) await apiFetch('/api/admin/save-subscription', { method: 'POST', body: JSON.stringify(subscription) });
            }
        } catch (error) { console.error('Falha ao reativar notificações:', error); }
    }
    
    // --- APP INITIALIZATION ---
    async function fetchAllInitialData() {
        try {
            const [sellers, transactions, ranking, usage, dashboardData] = await Promise.all([
                apiFetch('/api/admin/sellers'),
                apiFetch('/api/admin/transactions?limit=5000'),
                apiFetch('/api/admin/ranking'),
                apiFetch('/api/admin/usage-analysis'),
                apiFetch('/api/admin/dashboard')
            ]);
            setState({
                sellers: sellers || [],
                allTransactions: transactions?.transactions || [],
                allRanking: ranking || [],
                allUsage: usage || [],
                dashboardData: dashboardData || {}
            });
        } catch (e) {
            showToast(`Erro ao carregar dados: ${e.message}`, 'error');
            localStorage.removeItem('adminApiKey');
            setTimeout(() => window.location.reload(), 2000);
        }
    }

    function setupEventListeners() {
        // Global Listeners
        window.addEventListener('hashchange', () => handleNavigation(window.location.hash));
        DOM.loginForm.addEventListener('submit', handleLogin);
        
        // Mobile Menu
        DOM.menuToggle.addEventListener('click', () => DOM.sidebar.classList.toggle('show'));
        DOM.mainContent.addEventListener('click', () => DOM.sidebar.classList.remove('show'));
        DOM.mainNav.addEventListener('click', e => {
            if (e.target.closest('.nav-link')) {
                window.location.hash = e.target.closest('.nav-link').hash;
                DOM.sidebar.classList.remove('show');
            }
        });

        // Delegated listeners for dynamic content
        DOM.mainContent.addEventListener('keyup', e => {
            if (e.target.id === 'seller-search') handleSellerSearch(e);
        });
        
        DOM.mainContent.addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;

            if (button.id === 'tx-filter-btn') {
                const start = document.getElementById('tx-start-date').value;
                const end = document.getElementById('tx-end-date').value;
                if (!start || !end) return showToast("Selecione data de início e fim.", 'warning');
                const filtered = appState.allTransactions.filter(tx => {
                    const txDate = new Date(tx.created_at);
                    return txDate >= new Date(start) && txDate <= new Date(end);
                });
                renderTransactionsTable(filtered);
            }
            if (button.id === 'enable-notifications-btn') setupPushNotifications();
            if (button.dataset.action === 'manage-seller') handleManageSeller(button.dataset.sellerId);
        });

        DOM.mainContent.addEventListener('submit', e => {
             e.preventDefault();
             if (e.target.id === 'resend-events-form') handleResendEvents(e);
        });

        DOM.modalContainer.addEventListener('click', handleModalClick);
    }

    async function initializeApp() {
        DOM.loginScreen.style.display = 'none';
        DOM.appContainer.style.visibility = 'visible';
        
        renderNav();
        setupEventListeners();
        await tryReactivatingNotifications();
        await fetchAllInitialData();
        
        handleNavigation(window.location.hash);
    }

    // --- START ---
    document.addEventListener('DOMContentLoaded', () => {
        if (localStorage.getItem('adminApiKey')) {
            initializeApp();
        }
    });

    </script>
</body>
</html>
