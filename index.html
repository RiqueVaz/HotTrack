<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HotTrack [God Mode]</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-main: #0D0F18;
            --bg-secondary: #1A1C2A;
            --sidebar-bg: #111320;
            --border-color: #2E3040;
            --text-primary: #E0E5F0;
            --text-secondary: #8C93A9;
            --glow-cyan: #00F6FF;
            --glow-magenta: #FF00E4;
            --shadow-glow: 0 0 5px var(--glow-cyan), 0 0 10px var(--glow-cyan), 0 0 15px var(--glow-magenta);
        }
        * { box-sizing: border-box; }
        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            margin: 0;
            overflow: hidden;
        }
        h1, h2, h3 { font-family: 'Orbitron', sans-serif; text-transform: uppercase; }
        #login-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 100;
            display: flex; align-items: center; justify-content: center;
        }
        #login-box {
            border: 1px solid var(--glow-cyan);
            box-shadow: var(--shadow-glow);
            padding: 40px; border-radius: 8px; width: 90%; max-width: 400px;
            text-align: center; background: var(--bg-secondary);
        }
        #app-wrapper { display: flex; }
        #sidebar {
            width: 260px; background: var(--sidebar-bg);
            padding: 20px; height: 100vh; position: fixed;
            border-right: 1px solid var(--border-color);
        }
        #sidebar-header { text-align: center; margin-bottom: 30px; }
        #sidebar-header h1 { font-size: 1.8em; color: var(--glow-cyan); letter-spacing: 2px; }
        #admin-level { background: linear-gradient(90deg, var(--glow-cyan), var(--glow-magenta)); color: black; padding: 5px 10px; border-radius: 5px; font-weight: bold; }
        .nav-link {
            display: flex; align-items: center; padding: 12px 15px; color: var(--text-secondary);
            text-decoration: none; border-radius: 8px; margin-bottom: 10px;
            transition: all 0.3s;
        }
        .nav-link:hover, .nav-link.active {
            background-color: var(--glow-cyan); color: var(--bg-main);
            transform: translateX(5px); box-shadow: 0 0 10px var(--glow-cyan);
        }
        main {
            margin-left: 260px; padding: 30px; width: calc(100% - 260px);
            height: 100vh; overflow-y: auto;
        }
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--bg-secondary); padding: 25px; border-radius: 12px; border: 1px solid var(--border-color); margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { font-family: 'Orbitron'; background: #222536; }
        .achievements-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .achievement-card {
            background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px;
            padding: 20px; text-align: center; opacity: 0.4; transition: all 0.3s;
        }
        .achievement-card.unlocked { opacity: 1; border-color: var(--glow-cyan); box-shadow: 0 0 10px var(--glow-cyan); }
        .achievement-card .icon { font-size: 3em; }
        .achievement-card h3 { color: var(--glow-cyan); margin: 10px 0 5px 0; }
        .filters { display: flex; gap: 15px; margin-bottom: 20px; align-items: center; }
        input, select {
            font-family: 'Roboto', sans-serif; border-radius: 8px; border: 1px solid var(--border-color);
            padding: 12px 15px; font-size: 16px; background-color: var(--bg-main); color: var(--text-primary);
        }
    </style>
</head>
<body>

    <div id="login-overlay">
        <div id="login-box">
            <h2>G O D - M O D E</h2>
            <p style="color: var(--text-secondary);">Requisição de Chave de Acesso Mestra</p>
            <form id="login-form">
                <input type="password" id="admin-key" placeholder="API_KEY_ADMIN" required style="text-align: center;">
                <button type="submit" style="width: 100%; margin-top: 15px; letter-spacing: 2px;">AUTENTICAR</button>
            </form>
        </div>
    </div>

    <div id="app-wrapper">
        <aside id="sidebar">
            <div id="sidebar-header">
                <h1>HotTrack</h1>
                <p>Nível Admin: <span id="admin-level">1</span></p>
            </div>
            <a href="#dashboard" class="nav-link active">Dashboard</a>
            <a href="#achievements" class="nav-link">Conquistas</a>
            <a href="#sellers" class="nav-link">Vendedores</a>
            <a href="#ranking" class="nav-link">Leaderboard</a>
            <a href="#transactions" class="nav-link">Transações</a>
            <a href="#usage" class="nav-link">Uso da API</a>
            <a href="#" id="logout-button" class="nav-link" style="margin-top: auto; color: #FF5575;">Desconectar</a>
        </aside>

        <main id="main-content">
            <div id="dashboard" class="page active"></div>
            <div id="achievements" class="page"></div>
            <div id="sellers" class="page"></div>
            <div id="ranking" class="page"></div>
            <div id="transactions" class="page"></div>
            <div id="usage" class="page"></div>
        </main>
    </div>

<script>
    // ----- CONFIG & STATE -----
    const API_URL = 'https://novaapi-one.vercel.app';
    let appState = {
        sellers: [],
        transactions: [],
        ranking: [],
        usage: [],
        dashboard: {},
        charts: {}
    };

    // ----- CORE APP LOGIC -----
    document.addEventListener('DOMContentLoaded', () => {
        window.addEventListener('hashchange', () => navigate(window.location.hash));
        document.querySelectorAll('.nav-link').forEach(link => {
            if (link.id === 'logout-button') return;
            link.addEventListener('click', e => { e.preventDefault(); window.location.hash = e.currentTarget.hash; });
        });
        document.getElementById('logout-button').addEventListener('click', logout);
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        
        localStorage.getItem('adminApiKey') ? hideLogin() : showLogin();
    });

    function navigate(hash) {
        hash = hash || '#dashboard';
        document.querySelectorAll('.nav-link').forEach(l => l.classList.toggle('active', l.hash === hash));
        document.querySelectorAll('.page').forEach(p => p.classList.toggle('active', `#${p.id}` === hash));
        
        const pageLoaders = {
            '#dashboard': loadDashboardPage, '#achievements': loadAchievementsPage,
            '#sellers': loadSellersPage, '#ranking': loadRankingPage,
            '#transactions': loadTransactionsPage, '#usage': loadUsagePage
        };
        if (pageLoaders[hash]) pageLoaders[hash]();
    }
    
    // ----- AUTHENTICATION -----
    function showLogin() { document.getElementById('login-overlay').style.display = 'flex'; }
    function hideLogin() {
        document.getElementById('login-overlay').style.display = 'none';
        navigate(window.location.hash);
    }
    function handleLogin(e) {
        e.preventDefault();
        localStorage.setItem('adminApiKey', document.getElementById('admin-key').value);
        hideLogin();
    }
    function logout(e) {
        e.preventDefault();
        localStorage.removeItem('adminApiKey');
        showLogin();
    }

    // ----- API FETCHER -----
    async function apiFetch(endpoint) {
        const adminKey = localStorage.getItem('adminApiKey');
        if (!adminKey) { showLogin(); throw new Error("Não autenticado"); }
        const res = await fetch(`${API_URL}${endpoint}`, { headers: { 'x-admin-api-key': adminKey } });
        if (res.status === 403) { logout(); throw new Error("Chave de API inválida."); }
        if (!res.ok) throw new Error((await res.json()).message);
        return res.json();
    }
    
    // ----- PAGE RENDERERS -----
    const renderLoader = (container) => { container.innerHTML = `<p>Sincronizando com a Matrix...</p>`; };
    const destroyChart = (chartId) => { if (appState.charts[chartId]) appState.charts[chartId].destroy(); };

    async function loadDashboardPage() {
        const page = document.getElementById('dashboard');
        renderLoader(page);
        try {
            const [dashboard, sellers, transactions] = await Promise.all([
                apiFetch('/api/admin/dashboard'),
                apiFetch('/api/admin/sellers'),
                apiFetch('/api/admin/transactions?limit=1000')
            ]);
            appState.dashboard = dashboard;
            
            page.innerHTML = `
                <div class="grid card">
                    <div><h3>Receita Total</h3><h2 style="color:var(--glow-cyan)">R$ ${parseFloat(dashboard.total_revenue).toLocaleString('pt-BR')}</h2></div>
                    <div><h3>Lucro (SaaS)</h3><h2 style="color:var(--glow-magenta)">R$ ${parseFloat(dashboard.saas_profit).toLocaleString('pt-BR')}</h2></div>
                    <div><h3>Vendedores</h3><h2>${dashboard.total_sellers}</h2></div>
                    <div><h3>Vendas Pagas</h3><h2>${dashboard.total_paid_transactions}</h2></div>
                </div>
                <div class="grid">
                    <div class="card"><canvas id="revenueChart"></canvas></div>
                    <div class="card"><canvas id="sellersChart"></canvas></div>
                </div>
            `;
            
            renderRevenueChart(transactions.transactions);
            renderSellersChart(sellers);
        } catch(e) { page.innerHTML = `<p>${e.message}</p>`; }
    }
    
    async function loadAchievementsPage() {
        const page = document.getElementById('achievements');
        renderLoader(page);
        try {
            if (!appState.dashboard.total_revenue) {
                appState.dashboard = await apiFetch('/api/admin/dashboard');
            }
            const { total_revenue, total_sellers, total_paid_transactions } = appState.dashboard;
            const achievements = [
                { icon: '💰', title: 'Primeiros R$1.000', goal: 1000, value: total_revenue },
                { icon: '🚀', title: 'R$10.000 em Vendas', goal: 10000, value: total_revenue },
                { icon: '🔥', title: 'R$100.000 em Vendas', goal: 100000, value: total_revenue },
                { icon: '⭐', title: '10 Vendedores', goal: 10, value: total_sellers },
                { icon: '🏆', title: '100 Vendedores', goal: 100, value: total_sellers },
                { icon: '💯', title: '100 Vendas Pagas', goal: 100, value: total_paid_transactions },
            ];
            
            let unlockedCount = achievements.filter(a => parseFloat(a.value) >= a.goal).length;
            document.getElementById('admin-level').textContent = 1 + unlockedCount;

            page.innerHTML = `
                <h2>Conquistas da Plataforma</h2>
                <div class="achievements-grid">
                    ${achievements.map(a => `
                        <div class="achievement-card ${parseFloat(a.value) >= a.goal ? 'unlocked' : ''}">
                           <div class="icon">${a.icon}</div>
                           <h3>${a.title}</h3>
                           <p>${parseFloat(a.value).toLocaleString('pt-BR')} / ${a.goal.toLocaleString('pt-BR')}</p>
                        </div>
                    `).join('')}
                </div>
            `;
        } catch(e) { page.innerHTML = `<p>${e.message}</p>`; }
    }

    async function loadSellersPage() {
        const page = document.getElementById('sellers');
        renderLoader(page);
        try {
            appState.sellers = await apiFetch('/api/admin/sellers');
            page.innerHTML = `
                <input type="text" id="seller-search" placeholder="Buscar por nome ou e-mail...">
                <table>
                    <thead><tr><th>Nome</th><th>E-mail</th><th>Status</th><th>Ações</th></tr></thead>
                    <tbody id="sellers-tbody"></tbody>
                </table>`;
            document.getElementById('seller-search').addEventListener('keyup', e => {
                const query = e.target.value.toLowerCase();
                renderSellersTable(appState.sellers.filter(s => s.name.toLowerCase().includes(query) || s.email.toLowerCase().includes(query)));
            });
            renderSellersTable(appState.sellers);
        } catch(e) { page.innerHTML = `<p>${e.message}</p>`; }
    }

    async function loadRankingPage() {
        const page = document.getElementById('ranking');
        renderLoader(page);
        try {
            appState.ranking = await apiFetch('/api/admin/ranking');
            const medals = ['🥇', '🥈', '🥉'];
            page.innerHTML = `
                 <table>
                    <thead><tr><th>Pos.</th><th>Vendedor</th><th>Vendas</th><th>Receita</th></tr></thead>
                    <tbody>${appState.ranking.map((s, i) => `
                        <tr>
                            <td>${medals[i] || i + 1}</td>
                            <td>${s.name}</td>
                            <td>${s.total_sales}</td>
                            <td style="color:var(--glow-cyan); font-weight:bold;">R$ ${parseFloat(s.total_revenue).toLocaleString('pt-BR')}</td>
                        </tr>`).join('')}
                    </tbody>
                 </table>`;
        } catch(e) { page.innerHTML = `<p>${e.message}</p>`; }
    }
    
    async function loadTransactionsPage() {
        const page = document.getElementById('transactions');
        renderLoader(page);
        try {
            const data = await apiFetch('/api/admin/transactions?limit=200'); // Fetch more for better filtering
            appState.transactions = data.transactions;
            page.innerHTML = `
                <div class="filters">
                    <input type="text" id="tx-search" placeholder="Buscar por email do vendedor...">
                    <select id="tx-status-filter">
                        <option value="">Todos Status</option>
                        <option value="paid">Paga</option>
                        <option value="pending">Pendente</option>
                    </select>
                </div>
                <table>
                    <thead><tr><th>Vendedor</th><th>Status</th><th>Valor</th><th>Provedor</th><th>Data</th></tr></thead>
                    <tbody id="tx-tbody"></tbody>
                </table>`;
            
            const searchInput = document.getElementById('tx-search');
            const statusFilter = document.getElementById('tx-status-filter');
            
            const applyFilters = () => {
                const query = searchInput.value.toLowerCase();
                const status = statusFilter.value;
                const filtered = appState.transactions.filter(tx => 
                    (tx.seller_email.toLowerCase().includes(query)) &&
                    (!status || tx.status === status)
                );
                renderTransactionsTable(filtered);
            };

            searchInput.addEventListener('keyup', applyFilters);
            statusFilter.addEventListener('change', applyFilters);
            renderTransactionsTable(appState.transactions);

        } catch(e) { page.innerHTML = `<p>${e.message}</p>`; }
    }
    
    async function loadUsagePage() {
        const page = document.getElementById('usage');
        renderLoader(page);
        try {
            appState.usage = await apiFetch('/api/admin/usage-analysis');
            page.innerHTML = `<div class="card"><canvas id="usageChart"></canvas></div>`;
            renderUsageChart(appState.usage);
        } catch(e) { page.innerHTML = `<p>${e.message}</p>`; }
    }

    // ----- TABLE RENDERERS -----
    function renderSellersTable(sellers) {
        document.getElementById('sellers-tbody').innerHTML = sellers.map(s => `<tr>
            <td>${s.name}</td><td>${s.email}</td>
            <td style="color:${s.is_active ? 'var(--glow-cyan)' : '#FF5575'}">${s.is_active ? 'Ativo' : 'Bloqueado'}</td>
            <td><button onclick="toggleSellerStatus(${s.id}, ${!s.is_active})">${s.is_active ? 'Bloquear' : 'Ativar'}</button></td>
        </tr>`).join('');
    }

    function renderTransactionsTable(transactions) {
        document.getElementById('tx-tbody').innerHTML = transactions.map(tx => `<tr>
            <td>${tx.seller_name}</td>
            <td style="color:${tx.status === 'paid' ? 'var(--glow-cyan)' : 'var(--text-secondary)'}">${tx.status}</td>
            <td>R$ ${parseFloat(tx.pix_value).toLocaleString('pt-BR')}</td>
            <td>${tx.provider}</td>
            <td>${new Date(tx.created_at).toLocaleString('pt-BR')}</td>
        </tr>`).join('');
    }

    // ----- CHART RENDERERS -----
    function renderRevenueChart(transactions) {
        destroyChart('revenue');
        const salesByDay = transactions.filter(tx => tx.status === 'paid').reduce((acc, tx) => {
            const date = new Date(tx.created_at).toISOString().split('T')[0];
            acc[date] = (acc[date] || 0) + parseFloat(tx.pix_value);
            return acc;
        }, {});
        appState.charts.revenue = new Chart('revenueChart', {
            type: 'line', data: {
                labels: Object.keys(salesByDay).sort(),
                datasets: [{ label: 'Receita Diária', data: Object.values(salesByDay), borderColor: 'var(--glow-cyan)', tension: 0.4 }]
            }
        });
    }

    function renderSellersChart(sellers) {
        destroyChart('sellers');
        const sellersByDay = sellers.reduce((acc, s) => {
            const date = new Date(s.created_at).toISOString().split('T')[0];
            acc[date] = (acc[date] || 0) + 1;
            return acc;
        }, {});
        appState.charts.sellers = new Chart('sellersChart', {
            type: 'bar', data: {
                labels: Object.keys(sellersByDay).sort(),
                datasets: [{ label: 'Novos Vendedores', data: Object.values(sellersByDay), backgroundColor: 'var(--glow-magenta)' }]
            }
        });
    }

    function renderUsageChart(usage) {
        destroyChart('usage');
        const sortedUsage = usage.filter(u => parseInt(u.requests_last_24_hours) > 0).sort((a,b) => b.requests_last_24_hours - a.requests_last_24_hours).slice(0, 10);
        appState.charts.usage = new Chart('usageChart', {
            type: 'bar', data: {
                labels: sortedUsage.map(u => u.name),
                datasets: [{ label: 'Requisições API (24h)', data: sortedUsage.map(u => u.requests_last_24_hours), backgroundColor: 'var(--glow-cyan)' }]
            }
        });
    }

</script>
</body>
</html>
