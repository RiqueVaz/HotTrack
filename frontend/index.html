<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HotTracküî•</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/reactflow@11/dist/umd/index.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/dompurify@2.4.0/dist/purify.min.js"></script>
    <link href="https://unpkg.com/reactflow@11/dist/style.css" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* ================================== */
        /* == ESTILOS PRINCIPAIS (HOTTRACK) == */
        /* ================================== */
        :root {
            --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-card: rgba(30, 41, 59, 0.6);
            --border-color: #334155; --accent-primary: #38bdf8; --accent-secondary: #0ea5e9;
            --text-primary: #f1f5f9; --text-secondary: #94a3b8; --success: #4ade80;
            --danger: #f87171; --warning: #facc15;
        }
        body {
            font-family: 'Inter', sans-serif; background-color: var(--bg-primary); color: var(--text-primary);
            background-image: radial-gradient(circle at 1px 1px, rgba(56, 189, 248, 0.1) 1px, transparent 0),
                              radial-gradient(circle at top left, rgba(56, 189, 248, 0.2), transparent 30%),
                              radial-gradient(circle at bottom right, rgba(14, 165, 233, 0.2), transparent 40%);
            background-size: 20px 20px, 100% 100%, 100% 100%;
        }
        .card { background-color: var(--bg-card); border: 1px solid var(--border-color); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); transition: all 0.3s ease; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); }
        .form-input, .form-select, .form-date { background-color: rgba(15, 23, 42, 0.7); border: 1px solid var(--border-color); color: var(--text-primary); transition: all 0.3s ease; border-radius: 0.375rem; }
        .form-input:focus, .form-select:focus, .form-date:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2); }
        .form-date::-webkit-calendar-picker-indicator { filter: invert(0.8); }
        .btn { background-color: var(--accent-secondary); color: white; transition: all 0.3s ease; border: 1px solid var(--accent-primary); box-shadow: 0 0 15px rgba(14, 165, 233, 0.2), inset 0 0 8px rgba(255, 255, 255, 0.1); position: relative; overflow: hidden; }
        .btn:before { content: ''; position: absolute; top: 50%; left: 50%; width: 300%; height: 300%; background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%); transform: translate(-50%, -50%) scale(0); transition: transform 0.5s ease; }
        .btn:hover:before { transform: translate(-50%, -50%) scale(1); }
        .btn:hover { background-color: var(--accent-primary); box-shadow: 0 0 25px rgba(56, 189, 248, 0.5); transform: translateY(-2px); }
        .btn:disabled { background-color: #334155; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-red { background-color: #991b1b; border-color: #ef4444; box-shadow: 0 0 15px rgba(239, 68, 68, 0.2); }
        .btn-red:hover { background-color: #b91c1c; box-shadow: 0 0 25px rgba(239, 68, 68, 0.5); }
        .btn-green { background-color: #047857; border-color: #10b981; box-shadow: 0 0 15px rgba(16, 185, 129, 0.2); }
        .btn-green:hover { background-color: #059669; box-shadow: 0 0 25px rgba(16, 185, 129, 0.5); }
        .btn-secondary { background-color: var(--border-color); border-color: #475569; box-shadow: none; }
        .btn-secondary:hover { background-color: #475569; transform: translateY(-2px); }
        .nav-link { color: var(--text-secondary); position: relative; transition: all 0.3s ease; padding: 0.75rem 1rem; border-radius: 0.5rem; display: flex; align-items: center; gap: 0.75rem; cursor: pointer; text-decoration: none; }
        .nav-link:before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); height: 0; width: 4px; background-color: var(--accent-primary); border-radius: 0 4px 4px 0; transition: all 0.3s ease; }
        .nav-link:hover { background-color: rgba(56, 189, 248, 0.1); color: var(--text-primary); }
        .nav-link.active { background-color: rgba(14, 165, 233, 0.15); color: white; font-weight: 600; }
        .nav-link.active:before { height: 60%; }
        .modal { display: none; }
        .modal.active { display: flex; align-items: center; justify-content: center; position: fixed; z-index: 50; inset: 0; background-color: rgba(15, 23, 42, 0.7); backdrop-filter: blur(8px); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        .animate-fade-in { animation: fadeIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .table-custom th { color: var(--text-primary); }
        .table-custom th, .table-custom td { padding: 1rem; border-bottom: 1px solid var(--border-color); text-align: left; }
        .table-custom tbody tr:hover { background-color: rgba(30, 41, 59, 0.5); }
        .status-indicator { font-size: 0.75rem; font-weight: 500; padding: 0.25rem 0.6rem; border-radius: 9999px; display: inline-block; margin-left: 0.75rem; vertical-align: middle; }
        .status-indicator.success { background: linear-gradient(to right, rgba(74, 222, 128, 0.1), rgba(16, 185, 129, 0.1)); color: var(--success); border: 1px solid rgba(74, 222, 128, 0.2); }
        .status-indicator.failure { background: linear-gradient(to right, rgba(248, 113, 113, 0.1), rgba(185, 28, 28, 0.1)); color: var(--danger); border: 1px solid rgba(248, 113, 113, 0.2); }
        .status-indicator.unknown { background-color: rgba(100, 116, 139, 0.1); color: #94a3b8; border: 1px solid rgba(100, 116, 139, 0.2); }
        .status-indicator.testing { background: linear-gradient(to right, rgba(56, 189, 248, 0.1), rgba(14, 165, 233, 0.1)); color: #7dd3fc; border: 1px solid rgba(56, 189, 248, 0.2); }
        .tab-button { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 0.5rem 1rem; border-radius: 0.375rem; transition: all 0.3s ease; }
        .tab-button:hover { background-color: var(--bg-secondary); color: var(--text-primary); }
        .tab-button.active { background-color: rgba(14, 165, 233, 0.1); border-color: var(--accent-secondary); color: white; font-weight: 600; box-shadow: 0 0 10px rgba(14, 165, 233, 0.2); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease-out; }
        .progress-bar { background-color: #334155; border-radius: 999px; overflow: hidden; height: 8px; }
        .progress-bar-inner { height: 100%; transition: width 0.5s ease; }

        .metric-card {
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
        }
        .metric-card:before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0) 70%);
            transition: transform 0.8s ease;
            transform-origin: center center;
            transform: scale(0);
        }
        .metric-card:hover:before {
            transform: scale(3);
        }
        #app-loader { display: flex; align-items: center; justify-content: center; height: 100vh; font-size: 1.25rem; }

        /* ====================================================================== */
        /* == ESTILOS DO HOTBOT (PREFIXADOS PARA EVITAR CONFLITOS) == */
        /* ====================================================================== */
        #hotbot-root { font-family: 'Inter', sans-serif; --bg-primary: #111111; --bg-secondary: #1A1A1A; --bg-tertiary: #242424; --border-color: #2D2D2D; --text-primary: #E5E5E5; --text-secondary: #A3A3A3; --brand-primary: #00F5A0; --brand-secondary: #00B372; --danger-bg: #441C24; --danger-text: #F87171; --danger-border: #7f1d1d; --danger-hover-bg: #7f1d1d; --danger-hover-text: white; }
        .hotbot-page-container { height: 100%; width: 100%; display: flex; background: var(--bg-primary); color: var(--text-primary); }
        .hotbot-main-content { flex: 1; height: 100%; overflow-y: auto; background-image: radial-gradient(var(--border-color) 1px, transparent 1px); background-size: 2rem 2rem; }
        .hotbot-page-container .form-input, .hotbot-page-container .form-select, .hotbot-page-container .form-textarea { background: var(--bg-primary); border: 1px solid var(--border-color); color: var(--text-primary); }
        .hotbot-page-container .form-input:focus, .hotbot-page-container .form-select:focus, .hotbot-page-container .form-textarea:focus { outline: none; border-color: var(--brand-primary); box-shadow: 0 0 0 4px rgba(0, 245, 160, 0.2); }
        .hotbot-page-container .btn { display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.8rem 1.6rem; border-radius: 8px; border: none; cursor: pointer; font-weight: 700; transition: all 0.2s ease-in-out; }
        .hotbot-btn-primary { background: var(--brand-primary); color: #000; box-shadow: 0 4px 15px rgba(0, 245, 160, 0.2); }
        .hotbot-btn-secondary { background-color: var(--bg-tertiary); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .hotbot-btn-danger { background-color: var(--danger-bg); color: var(--danger-text); border: 1px solid var(--danger-border); }
        .hotbot-btn-danger:hover { background-color: var(--danger-hover-bg); color: var(--danger-hover-text); }
        .hotbot-card { background: var(--bg-secondary); padding: 2rem; border-radius: 12px; border: 1px solid var(--border-color); }
        .hotbot-sidebar { width: 80px; background: var(--bg-secondary); border-right: 1px solid var(--border-color); padding: 1.5rem 0; display: flex; flex-direction: column; align-items: center; transition: width 0.3s ease-in-out; z-index: 20; height: 100%; }
        .hotbot-sidebar:hover { width: 240px; }
        .hotbot-sidebar .logo { font-size: 1.8rem; margin-bottom: 3.5rem; color: var(--text-primary); font-weight: 800; letter-spacing: 1px; }
        .hotbot-sidebar .logo span { color: var(--brand-primary); }
        .hotbot-sidebar .logo .logo-text { opacity: 0; transition: opacity 0.3s ease-in-out; }
        .hotbot-sidebar:hover .logo .logo-text { opacity: 1; }
        .hotbot-nav-menu { display: flex; flex-direction: column; gap: 0.75rem; width: 100%; }
        .hotbot-nav-item { display: flex; align-items: center; justify-content: flex-start; gap: 1rem; padding: 1rem 1.75rem; cursor: pointer; transition: all 0.2s ease-in-out; border-left: 4px solid transparent; color: var(--text-secondary); }
        .hotbot-nav-item:hover { background: linear-gradient(90deg, rgba(0, 245, 160, 0.1), transparent); color: var(--text-primary); }
        .hotbot-nav-item.active { color: var(--brand-primary); border-left: 4px solid var(--brand-primary); }
        .hotbot-nav-item .nav-text { opacity: 0; white-space: nowrap; transform: translateX(-10px); transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out; font-weight: 600; }
        .hotbot-sidebar:hover .nav-text { opacity: 1; transform: translateX(0); }
        .hotbot-login-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(10px); }
        .hotbot-login-box { background: var(--bg-secondary); padding: 3rem; border-radius: 12px; width: 420px; border: 1px solid var(--border-color); }
        
        /* Estilos do Editor de Fluxo */
        .flow-editor-page { display: flex; flex-direction: column; height: 100%; background: #fff; color: #333; }
        .flow-editor-container { flex: 1; display: flex; overflow: hidden; }
        .reactflow-wrapper { flex-grow: 1; position: relative; background-color: #f8f9fa; background-image: radial-gradient(#dee2e6 1px, transparent 0); background-size: 30px 30px;}
        .flow-header { padding: 1rem 1.5rem; background: white; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e9ecef; z-index: 11; }
        .flow-sidebar { width: 280px; background: white; border-right: 1px solid #e9ecef; padding: 1rem; overflow-y: auto; }
        .flow-sidebar h3 { margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid #e9ecef; font-size: 1.1rem; }
        .node-button { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 8px; border: 1px solid #dee2e6; text-align: left; cursor: grab; margin-bottom: 0.75rem; transition: all 0.2s; color: #495057; }
        .node-button:hover { border-color: var(--brand-primary); color: var(--brand-secondary); background: #f1f3f5; }
        .editor-panel { position: absolute; top: 0; right: 0; width: 350px; height: 100%; background: white; z-index: 10; padding: 1.5rem; border-left: 1px solid #e9ecef; overflow-y: auto; }
        .react-flow__node { background: white; border: 1px solid #adb5bd; border-radius: 8px; padding: 0; width: 280px; font-family: 'Inter', sans-serif; box-shadow: 0 4px 10px rgba(0,0,0,0.05); color: #343a40; }
        .react-flow__node.selected { border: 2px solid var(--brand-primary); box-shadow: 0 0 15px rgba(0, 245, 160, 0.5); }
        .node-header { display: flex; align-items: center; gap: 0.75rem; font-weight: 600; padding: 0.75rem 1rem; border-bottom: 1px solid #e9ecef; color: #212529; }
        .node-content { padding: 1rem; font-size: 0.9rem; color: #6c757d; }
        .react-flow__handle { width: 12px; height: 12px; background: white; border: 2px solid #adb5bd; }
        .react-flow__handle:hover { border-color: var(--brand-primary); }
        .react-flow__node-trigger .node-header { background: #e7f5ff; } .react-flow__node-message .node-header { background: #e6fcf5; } .react-flow__node-image .node-header { background: #f3e8ff; } .react-flow__node-video .node-header { background: #f3e8ff; } .react-flow__node-audio .node-header { background: #fff0f6; } .react-flow__node-delay .node-header { background: #fff9db; } .react-flow__node-typing_action .node-header { background: #f0f9ff; } .react-flow__node-action_pix .node-header { background: #dcfce7; } .react-flow__node-action_check_pix .node-header { background: #ffedd5; } .react-flow__node-forward_flow .node-header { background: #eef2ff; }
    </style>
</head>
<body>
    <div id="app">
        <div id="app-loader">
            <svg class="animate-spin h-8 w-8 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="ml-3">Carregando...</span>
        </div>
    </div>
    <div id="modal-container"></div>

    <script>
    // ============================================
    // == L√ìGICA DO HOTTRACK (APLICA√á√ÉO PRINCIPAL) ==
    // ============================================
    const App = {
        state: {
            API_BASE_URL: 'https://localhost:3002',
            token: null,
            data: { 
                pixels: [],
                bots: [],
                pressels: [], 
                settings: {}, 
                transactions: [],
                dashboard: {},
                utmifyIntegrations: []
            },
            currentPage: 'dashboard',
            dateFilter: {
                period: 'all',
                startDate: null,
                endDate: null
            },
            revenueChart: null,
        },

        async init() {
            if (window.location.origin.includes('localhost') || window.location.origin.includes('127.0.0.1')) {
                this.state.API_BASE_URL = 'http://localhost:3002';
            }
            this.state.token = localStorage.getItem('hottrack_token');
            if (this.state.token) {
                try {
                    const [staticData, transactions] = await Promise.all([
                        this.apiRequest('/api/dashboard/data'),
                        this.apiRequest('/api/transactions'),
                    ]);
                    this.state.data = { ...this.state.data, ...staticData, transactions };
                    this.renderLayout();
                    this.navigateTo('dashboard');
                } catch (e) { 
                    this.logout();
                }
            } else {
                this.renderLogin();
                this.addAuthEventListeners(); 
            }
        },

        renderLogin(page = 'login') {
            document.getElementById('app').innerHTML = this.templates.auth(page);
        },

        renderLayout() {
            document.getElementById('app').innerHTML = this.templates.layout();
            this.addDashboardEventListeners();
        },

        formatNumber(number, isCurrency = false) {
            if (typeof number !== 'number') {
                number = parseFloat(number) || 0;
            }
            if (isCurrency) {
                return number.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            } else {
                return number.toLocaleString('pt-BR');
            }
        },
        
        templates: {
            auth(page = 'login') {
                return `<div class="flex items-center justify-center min-h-screen p-4">${page === 'login' ? this.loginForm() : this.registerForm()}</div>`;
            },
            loginForm() {
                return `
                <div class="card p-8 rounded-2xl shadow-lg w-full max-w-md animate-fade-in">
                    <div class="text-center mb-8">
                        <div class="flex items-center justify-center gap-2">
                            <svg class="h-10 w-10 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
                            <h1 class="text-4xl font-bold text-white">HotTrack</h1>
                        </div>
                        <p class="text-slate-400 mt-2">Acesse sua conta para continuar.</p>
                    </div>
                    <form id="loginForm" class="space-y-6">
                        <div><label class="text-sm font-medium text-gray-400 mb-1 block">E-mail</label><input name="email" type="email" required class="form-input w-full p-3"></div>
                        <div><label class="text-sm font-medium text-gray-400 mb-1 block">Senha</label><input name="password" type="password" required class="form-input w-full p-3"></div>
                        <button type="submit" class="btn w-full font-semibold py-3 rounded-md">Entrar na Plataforma</button>
                    </form>
                    <div class="text-center mt-6"><a href="#" id="showRegister" class="text-sm text-sky-400 hover:text-sky-300 hover:underline">N√£o tem uma conta? Cadastre-se agora</a></div>
                </div>`;
            },
            hotbot() {
    return `
    <div class="animate-fade-in">
        <div class="mb-6">
            <h1 class="text-3xl font-bold text-white">HotBot - Gerenciador de Bots</h1>
            <p class="text-slate-400">Gerencie seus bots do Telegram e fluxos de conversa√ß√£o.</p>
        </div>
        <div id="hotbot-container" style="height: calc(100vh - 200px);"></div>
    </div>`;
},
            registerForm() {
                return `
                <div class="card p-8 rounded-2xl shadow-lg w-full max-w-md animate-fade-in">
                     <div class="text-center mb-8">
                        <div class="flex items-center justify-center gap-2">
                            <svg class="h-10 w-10 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
                            <h1 class="text-4xl font-bold text-white">HotTrack</h1>
                        </div>
                        <p class="text-slate-400 mt-2">Crie sua conta e comece a rastrear.</p>
                    </div>
                    <form id="registerForm" class="space-y-4">
                        <div><label class="text-sm font-medium text-gray-400 mb-1 block">Nome</label><input name="name" type="text" required class="form-input w-full p-3"></div>
                        <div><label class="text-sm font-medium text-gray-400 mb-1 block">E-mail</label><input name="email" type="email" required class="form-input w-full p-3"></div>
                        <div><label class="text-sm font-medium text-gray-400 mb-1 block">Senha (m√≠nimo 8 caracteres)</label><input name="password" type="password" required minlength="8" class="form-input w-full p-3"></div>
                        <button type="submit" class="btn w-full font-semibold py-3 rounded-md">Criar Minha Conta</button>
                    </form>
                    <div class="text-center mt-6"><a href="#" id="showLogin" class="text-sm text-sky-400 hover:text-sky-300 hover:underline">J√° tem uma conta? Fa√ßa Login</a></div>
                </div>`;
            },
            layout() {
                return `
                <div class="relative min-h-screen md:flex">
                    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-20 md:hidden hidden"></div>

                    <aside id="sidebar" class="w-64 bg-slate-900/80 backdrop-blur-lg p-4 flex-col fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-30 border-r border-slate-800 flex">
                        <div class="text-center py-4 mb-6 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <svg class="h-8 w-8 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
                                <h1 class="text-2xl font-bold text-white">HotTrack</h1>
                            </div>
                            <button id="close-sidebar-btn" class="md:hidden text-gray-400 text-3xl hover:text-white">&times;</button>
                        </div>
                        <nav id="sidebarNav" class="flex-grow flex flex-col space-y-1">
                            <div data-target="dashboard" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>Dashboard</div>
                            <div data-target="hotbot" class="nav-link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                                </svg>
                                <span>HotBot</span>
                            </div>
                            <div data-target="bots" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M11 17a1 1 0 001.447.894l4-2A1 1 0 0017 15V5a1 1 0 00-1.447-.894l-4 2A1 1 0 0011 7v10zM4 17a1 1 0 001.447.894l4-2A1 1 0 0010 15V5a1 1 0 00-1.447-.894l-4 2A1 1 0 004 7v10z" /></svg>Gerenciar Bots</div>
                            <div data-target="pressels" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>Criador de Pressel</div>
                            <div data-target="pixels" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h10a3 3 0 013 3v5a.997.997 0 01-.293-.707zM5 4a1 1 0 00-1 1v.01L8 9.01l4-4.002V5a1 1 0 00-1-1H5z" clip-rule="evenodd" /></svg>Gerenciar Pixels</div>
                            <div data-target="transactions" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8.433 7.418c.158-.103.346-.196.567-.267v1.698a2.5 2.5 0 00-1.168-.217c-.165 0-.33.018-.488.054a1 1 0 01-.502 1.765l.986.328c.73.243 1.196.96 1.196 1.765 0 1.132-.98 1.99-2.206 1.99-1.225 0-2.205-.858-2.205-1.99 0-.962.63-1.698 1.447-1.938l.986-.329a1 1 0 01.502-1.765z" /><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 10-2 0v.092a4.5 4.5 0 00-1.838.385l-.234-.14a1 1 0 00-1.18.157l-1 1.732a1 1 0 00.157 1.18l.234.14A4.5 4.5 0 005.5 8.5v.092l-1.07.356a1 1 0 00-.503 1.765l.986.329a2.5 2.5 0 001.09.243v.092a4.5 4.5 0 001.838-.385l.234.14a1 1 0 001.18-.157l1-1.732a1 1 0 00-.157-1.18l-.234-.14a4.5 4.5 0 001.03-2.062V5z" clip-rule="evenodd" /></svg>Transa√ß√µes</div>
                            <div class="h-px bg-slate-700 my-2"></div>
                            <div data-target="settings" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z" /></svg>API PIX</div>
                            <div data-target="integrations" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0l-1.5-1.5a2 2 0 112.828-2.828l1.5 1.5z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M6.414 11.586a2 2 0 10-2.828 2.828l3 3a2 2 0 002.828 0l1.5-1.5a2 2 0 10-2.828-2.828l-1.5 1.5z" clip-rule="evenodd" /></svg>Integra√ß√µes</div>
                            <div data-target="documentation" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>API & Docs</div>
                            <a href="https://wa.me/5541995211148" target="_blank" class="nav-link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 8a7 7 0 110-14 7 7 0 010 14zm-1-11a1 1 0 100 2h2a1 1 0 100-2H9z" clip-rule="evenodd" /></svg>
                                <span>Suporte</span>
                            </a>
                        </nav>
                        <div class="mt-auto"><button id="logoutButton" class="w-full text-slate-400 hover:bg-red-900/50 hover:text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-all duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" /></svg>Sair da Conta</button></div>
                    </aside>
                    
                    <div class="flex-1 flex flex-col w-full">
                        <header class="p-4 md:hidden card flex justify-between items-center sticky top-0 z-10">
                             <button id="open-sidebar-btn" class="text-white">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                             </button>
                             <div class="text-lg font-bold">HotTrack</div>
                        </header>
                        <main id="content" class="flex-1 p-4 md:p-8 overflow-y-auto"></main>
                    </div>
                </div>`;
            },
            dateFilterComponent(page) {
                const { period } = App.state.dateFilter;
                const btnClasses = "btn-secondary py-1 px-3 rounded-md text-xs";
                const activeClasses = "active !bg-sky-500 !border-sky-400 !text-white";
                return `
                <div id="${page}-date-filter" class="card p-3 rounded-lg mb-6 flex flex-wrap items-center gap-2 text-sm">
                    <span class="font-semibold mr-2 text-slate-300">Per√≠odo:</span>
                    <button data-period="today" class="${btnClasses} ${period === 'today' ? activeClasses : ''}">Hoje</button>
                    <button data-period="yesterday" class="${btnClasses} ${period === 'yesterday' ? activeClasses : ''}">Ontem</button>
                    <button data-period="last7days" class="${btnClasses} ${period === 'last7days' ? activeClasses : ''}">7 Dias</button>
                    <button data-period="thisMonth" class="${btnClasses} ${period === 'thisMonth' ? activeClasses : ''}">Este M√™s</button>
                    <div class="flex items-center gap-2 pl-4 border-l border-slate-700 ml-2">
                         <input type="date" id="${page}-start-date" class="form-date p-1 rounded-md text-xs">
                         <span class="text-gray-500">at√©</span>
                         <input type="date" id="${page}-end-date" class="form-date p-1 rounded-md text-xs">
                         <button id="apply-custom-date-filter-${page}" class="btn-secondary py-1 px-3 rounded-md text-xs">Filtrar</button>
                    </div>
                    <button id="clear-date-filter-${page}" class="btn-secondary py-1 px-3 rounded-md ml-auto text-xs">Limpar Filtro</button>
                </div>`;
            },
            dashboard() {
                return `
                <div class="animate-fade-in">
                    <div class="mb-6">
                        <h1 class="text-3xl font-bold text-white">Painel de M√©tricas</h1>
                        <p class="text-slate-400">Vis√£o geral do desempenho de suas opera√ß√µes.</p>
                    </div>
                    ${this.dateFilterComponent('dashboard')}
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                        <div class="card metric-card"><h3 class="text-sm text-gray-400">Cliques na P√°gina</h3><p id="metric-clicks" class="text-4xl font-bold text-sky-400 mt-2">...</p></div>
                        <div class="card metric-card"><h3 class="text-sm text-gray-400">PIX Gerados</h3><p id="metric-generated" class="text-4xl font-bold text-yellow-400 mt-2">...</p></div>
                        <div class="card metric-card"><h3 class="text-sm text-gray-400">Faturamento Total</h3><p id="metric-total-revenue" class="text-4xl font-bold text-sky-400 mt-2">...</p></div>
                        <div class="card metric-card"><h3 class="text-sm text-gray-400">PIX Pagos</h3><p id="metric-paid" class="text-4xl font-bold text-green-400 mt-2">...</p></div>
                        <div class="card metric-card"><h3 class="text-sm text-gray-400">Faturamento Pago</h3><p id="metric-paid-revenue" class="text-4xl font-bold text-green-400 mt-2">...</p></div>
                    </div>
                    <div class="card p-6 rounded-lg mb-8">
                        <h2 class="text-xl font-semibold text-white mb-4">Desempenho de Faturamento</h2>
                        <canvas id="revenueChart" height="100"></canvas>
                    </div>
                    <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
                        <div class="card p-6 rounded-lg lg:col-span-2"><h2 class="text-xl font-semibold text-white mb-4">Desempenho por Bot</h2><div id="bots-performance-table-container" class="overflow-x-auto"><table class="table-custom w-full text-sm"><thead><tr><th>Bot</th><th>Cliques</th><th>Vendas</th><th>Faturamento</th></tr></thead><tbody id="bots-performance-table"><tr><td colspan="4">Carregando...</td></tr></tbody></table></div></div>
                        <div class="card p-6 rounded-lg"><h2 class="text-xl font-semibold text-white mb-4">Tr√°fego por Estado</h2><div id="traffic-by-state-table-container" class="overflow-x-auto"><table class="table-custom w-full text-sm"><thead><tr><th>Estado</th><th>Cliques</th></tr></thead><tbody id="traffic-by-state-table"><tr><td colspan="2">Carregando...</td></tr></tbody></table></div></div>
                        
                    </div>
                     <div class="grid grid-cols-1 gap-8 lg:grid-cols-3 mt-8">
                        <div class="card p-6 rounded-lg lg:col-span-2">
                             <h2 class="text-xl font-semibold text-white mb-4">Minhas Conquistas</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="achievements-list">
                                <p class="text-gray-500 text-sm">Carregando conquistas...</p>
                            </div>
                        </div>
                         <div class="card p-6 rounded-lg">
                            <h2 class="text-xl font-semibold text-white mb-4">Ranking de Vendas</h2>
                            <div id="ranking-list" class="space-y-2">
                                <p class="text-gray-500 text-sm">Carregando ranking...</p>
                            </div>
                            <p id="user-rank-status" class="mt-4 text-center text-sm font-medium text-sky-400"></p>
                        </div>
                    </div>
                </div>`;
            },
            pixels() {
                const pixelListHTML = App.state.data.pixels.map(p => `<div class="p-3 bg-slate-900/50 rounded-lg flex justify-between items-center"><span class="font-mono text-sm">${p.account_name}</span><button data-id="${p.id}" class="delete-pixel-btn btn btn-red text-xs py-1 px-2">Excluir</button></div>`).join('');
                return `
                <div class="animate-fade-in">
                    <div class="mb-6"><h1 class="text-3xl font-bold text-white">Gerenciar Pixels</h1><p class="text-slate-400">Adicione e gerencie seus pixels do Facebook.</p></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="card p-6 rounded-lg">
                            <h2 class="text-xl font-semibold mb-4 text-white">Adicionar Novo Pixel</h2>
                            <form id="pixelForm" class="space-y-4"><input name="account_name" placeholder="Nome do Pixel (Ex: Produto Y)" class="form-input w-full p-2" required><input name="pixel_id" placeholder="ID do Pixel da Meta" class="form-input w-full p-2" required><textarea name="meta_api_token" placeholder="Token da API de Convers√µes" class="form-input w-full p-2" rows="3" required></textarea><button type="submit" class="btn w-full p-2 rounded-md">Adicionar Pixel</button></form>
                        </div>
                        <div class="card p-6 rounded-lg"><h2 class="text-xl font-semibold text-white mb-4">Pixels Salvos</h2><div id="pixel-list" class="space-y-3 max-h-96 overflow-y-auto">${pixelListHTML.length ? pixelListHTML : '<p class="text-gray-500 text-sm">Nenhum pixel salvo.</p>'}</div></div>
                    </div>
                </div>`;
            },
            bots() {
                 const botListHTML = App.state.data.bots.map(b => `
                    <div class="p-3 bg-slate-900/50 rounded-lg flex justify-between items-center">
                        <div>
                            <span class="text-sm font-medium">${b.bot_name}</span>
                            <span id="status-indicator-bot-${b.id}"></span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button data-id="${b.id}" class="delete-bot-btn btn btn-red text-xs py-1 px-2">Excluir</button>
                        </div>
                    </div>`).join('');
                return `
                <div class="animate-fade-in">
                    <div class="mb-6"><h1 class="text-3xl font-bold text-white">Gerenciar Bots</h1><p class="text-slate-400">Conecte seus bots do Telegram para automatizar processos.</p></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="card p-6 rounded-lg">
                            <h2 class="text-xl font-semibold mb-4 text-white">Adicionar Novo Bot</h2>
                            <form id="botForm" class="space-y-4">
                                <input name="bot_name" placeholder="Username do Bot (sem @)" class="form-input w-full p-2" required>
                                <button type="submit" class="btn w-full p-2 rounded-md">Adicionar Bot</button>
                            </form>
                        </div>
                        <div class="card p-6 rounded-lg"><h2 class="text-xl font-semibold text-white mb-4">Bots Salvos</h2><div id="bot-list" class="space-y-3 max-h-96 overflow-y-auto">${botListHTML.length ? botListHTML : '<p class="text-gray-500 text-sm">Nenhum bot salvo.</p>'}</div></div>
                    </div>
                </div>`;
            },
            pressels() {
                const { pixels, bots, pressels, utmifyIntegrations } = App.state.data;
                const botOptions = bots.map(b => `<option value="${b.id}">${b.bot_name}</option>`).join('');
                const utmifyOptions = utmifyIntegrations.map(u => `<option value="${u.id}">${u.account_name}</option>`).join('');
                const pixelCheckboxes = pixels.map(p => `<label class="flex items-center space-x-2 text-gray-300 hover:text-white cursor-pointer p-2 rounded-md hover:bg-slate-700/50"><input type="checkbox" name="pixel_ids" value="${p.id}" class="h-4 w-4 bg-slate-700 border-slate-500 rounded text-sky-500 focus:ring-sky-500"><span>${p.account_name}</span></label>`).join('');
                const presselList = pressels.map(pr => `<div class="p-3 card flex justify-between items-center text-sm"><div><p class="font-semibold">${pr.name}</p><p class="text-xs text-gray-400">Bot: ${pr.bot_name}</p></div><div class="space-x-2"><button data-id="${pr.id}" class="generate-pressel-code-btn btn text-xs py-1 px-2">Ver C√≥digo</button><button data-id="${pr.id}" class="delete-pressel-btn btn btn-red text-xs py-1 px-2">Excluir</button></div></div>`).join('');
                
                return `
                <div class="animate-fade-in">
                    <div class="mb-6"><h1 class="text-3xl font-bold text-white">Criador de Pressel</h1><p class="text-slate-400">Configure suas p√°ginas de pressel para captura de leads.</p></div>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="card p-6 rounded-lg">
                            <h2 class="text-xl font-bold mb-4 text-white">Criar Nova Pressel</h2>
                            <form id="presselForm" class="space-y-4">
                                <input name="name" placeholder="Nome da Pressel (Ex: Campanha Black Friday)" class="form-input w-full p-2" required>
                                <input name="white_page_url" type="url" placeholder="URL da P√°gina Branca" class="form-input w-full p-2" required>
                                <select name="bot_id" class="form-select w-full p-2" required><option value="">Selecione um Bot</option>${botOptions}</select>
                                
                                <div>
                                    <label class="text-sm font-medium text-gray-400 mb-1 block">Enviar Eventos para Utmify (Opcional)</label>
                                    <select name="utmify_integration_id" class="form-select w-full p-2">
                                        <option value="">N√£o enviar</option>
                                        ${utmifyOptions}
                                    </select>
                                </div>
                                
                                <div class="card p-3"><p class="font-semibold mb-2">Selecione os Pixels:</p><div class="space-y-1">${pixelCheckboxes.length ? pixelCheckboxes : '<p class="text-gray-500 text-sm">Cadastre um pixel primeiro.</p>'}</div></div>
                                <button type="submit" class="btn w-full p-3 rounded-md text-base font-bold">Salvar e Gerar C√≥digo</button>
                            </form>
                        </div>
                        <div class="card p-6 rounded-lg"><h2 class="text-xl font-bold mb-4 text-white">Pressels Criadas</h2><div id="pressel-list" class="space-y-3">${presselList.length ? presselList : '<p class="text-gray-500 text-sm">Nenhuma pressel criada.</p>'}</div></div>
                    </div>
                </div>`;
            },
            transactions() {
                return `
                <div class="animate-fade-in">
                    <div class="mb-6"><h1 class="text-3xl font-bold text-white">Hist√≥rico de Transa√ß√µes</h1><p class="text-slate-400">Visualize todas as transa√ß√µes de PIX geradas e pagas.</p></div>
                    ${this.dateFilterComponent('transactions')}
                    <div class="card p-6 rounded-lg"><div id="transactions-table-container" class="overflow-x-auto"><table class="table-custom w-full text-sm"><thead><tr><th>Status</th><th>Valor</th><th>Origem</th><th>Provedor PIX</th><th>Data</th></tr></thead><tbody id="transactions-table-body"><tr><td colspan="5" class="text-center text-gray-500 py-8">Carregando transa√ß√µes...</td></tr></tbody></table></div></div>
                </div>`;
            },
            settings() {
                const { settings } = App.state.data;
                const providers = [
                    { value: 'pushinpay', text: 'PushinPay' },
                    { value: 'cnpay', text: 'CN Pay' },
                    { value: 'oasyfy', text: 'Oasy.fy' },
                    { value: 'syncpay', text: 'SyncPay' },
                    { value: 'brpix', text: 'BR PIX' }
                ];
                const createSelect = (name, selectedValue) => {
                    const options = providers.map(p => `<option value="${p.value}" ${p.value === selectedValue ? 'selected' : ''}>${p.text}</option>`).join('');
                    return `<select name="${name}" class="form-select w-full p-2">${options}<option value="" ${!selectedValue ? 'selected' : ''}>Nenhum</option></select>`;
                };
                return `
                <div class="animate-fade-in">
                    <div class="mb-6"><h1 class="text-3xl font-bold text-white">Configura√ß√µes de PIX</h1><p class="text-slate-400">Configure seus provedores de pagamento e a ordem de prioridade.</p></div>
                    <form id="pixSettingsForm" class="max-w-4xl">
                        <div class="flex border-b border-slate-700 mb-6" id="pix-settings-tabs">
                            <button type="button" data-tab="priority" class="tab-button active">Ordem de Prioridade</button>
                            <button type="button" data-tab="credentials" class="tab-button ml-2">Chaves da API</button>
                        </div>

                        <div id="tab-priority" class="tab-content active space-y-8">
                            <div class="card p-6 rounded-lg">
                                <h2 class="text-xl font-semibold mb-2 text-white">Ordem de Prioridade dos Provedores</h2>
                                <p class="text-sm text-gray-400 mb-4">Defina a ordem em que o sistema tentar√° gerar o PIX. Se o Provedor Prim√°rio falhar, o sistema automaticamente tentar√° o pr√≥ximo na lista.</p>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div><label class="block mb-2 text-sm font-medium text-gray-400">1¬∫ - Provedor Prim√°rio</label>${createSelect('pix_provider_primary', settings.pix_provider_primary)}</div>
                                    <div><label class="block mb-2 text-sm font-medium text-gray-400">2¬∫ - Provedor Secund√°rio</label>${createSelect('pix_provider_secondary', settings.pix_provider_secondary)}</div>
                                    <div><label class="block mb-2 text-sm font-medium text-gray-400">3¬∫ - Provedor Terci√°rio</label>${createSelect('pix_provider_tertiary', settings.pix_provider_tertiary)}</div>
                                </div>
                                <div class="mt-6 pt-6 border-t border-slate-700"><button type="button" id="testPriorityRouteBtn" class="btn btn-green w-full md:w-auto">Testar Rota de Prioridade</button></div>
                            </div>
                        </div>

                        <div id="tab-credentials" class="tab-content space-y-6">
                            <div class="card p-6 rounded-lg">
                                <div class="flex justify-between items-start mb-4">
                                    <div><h3 class="text-lg font-medium text-sky-400 inline-block">BR PIX</h3><span id="status-indicator-brpix"></span></div>
                                    <button type="button" data-provider="brpix" class="test-pix-btn btn btn-secondary text-xs py-1 px-3">Testar Conex√£o</button>
                                </div>
                                <label class="block mb-2 text-sm text-gray-400">Secret Key</label><input name="brpix_secret_key" type="password" value="${settings.brpix_secret_key || ''}" class="form-input w-full p-2">
                                <label class="block mt-4 mb-2 text-sm text-gray-400">Company ID</label><input name="brpix_company_id" type="password" value="${settings.brpix_company_id || ''}" class="form-input w-full p-2">
                            </div>
                            <div class="card p-6 rounded-lg">
                                <div class="flex justify-between items-start mb-4">
                                    <div><h3 class="text-lg font-medium text-sky-400 inline-block">SyncPay</h3><span id="status-indicator-syncpay"></span></div>
                                    <button type="button" data-provider="syncpay" class="test-pix-btn btn btn-secondary text-xs py-1 px-3">Testar Conex√£o</button>
                                </div>
                                <label class="block mb-2 text-sm text-gray-400">Client ID</label><input name="syncpay_client_id" type="password" value="${settings.syncpay_client_id || ''}" class="form-input w-full p-2">
                                <label class="block mt-4 mb-2 text-sm text-gray-400">Client Secret</label><input name="syncpay_client_secret" type="password" value="${settings.syncpay_client_secret || ''}" class="form-input w-full p-2">
                            </div>
                            <div class="card p-6 rounded-lg">
                                <div class="flex justify-between items-start mb-4">
                                    <div><h3 class="text-lg font-medium text-sky-400 inline-block">PushinPay</h3><span id="status-indicator-pushinpay"></span></div>
                                    <button type="button" data-provider="pushinpay" class="test-pix-btn btn btn-secondary text-xs py-1 px-3">Testar Conex√£o</button>
                                </div>
                                <label class="block mb-2 text-sm text-gray-400">Bearer Token</label><input name="pushinpay_token" type="password" value="${settings.pushinpay_token || ''}" class="form-input w-full p-2">
                            </div>
                             <div class="card p-6 rounded-lg">
                                <div class="flex justify-between items-start mb-4">
                                    <div><h3 class="text-lg font-medium text-sky-400 inline-block">CN Pay</h3><span id="status-indicator-cnpay"></span></div>
                                    <button type="button" data-provider="cnpay" class="test-pix-btn btn btn-secondary text-xs py-1 px-3">Testar Conex√£o</button>
                                </div>
                                <label class="block mb-2 text-sm text-gray-400">Chave P√∫blica</label><input name="cnpay_public_key" type="password" value="${settings.cnpay_public_key || ''}" class="form-input w-full p-2">
                                <label class="block mt-4 mb-2 text-sm text-gray-400">Chave Privada</label><input name="cnpay_secret_key" type="password" value="${settings.cnpay_secret_key || ''}" class="form-input w-full p-2">
                            </div>
                            <div class="card p-6 rounded-lg">
                                 <div class="flex justify-between items-start mb-4">
                                    <div><h3 class="text-lg font-medium text-sky-400 inline-block">Oasy.fy</h3><span id="status-indicator-oasyfy"></span></div>
                                    <button type="button" data-provider="oasyfy" class="test-pix-btn btn btn-secondary text-xs py-1 px-3">Testar Conex√£o</button>
                                </div>
                                <label class="block mb-2 text-sm text-gray-400">Chave P√∫blica</label><input name="oasyfy_public_key" type="password" value="${settings.oasyfy_public_key || ''}" class="form-input w-full p-2">
                                <label class="block mt-4 mb-2 text-sm text-gray-400">Chave Privada</label><input name="oasyfy_secret_key" type="password" value="${settings.oasyfy_secret_key || ''}" class="form-input w-full p-2">
                            </div>
                        </div>
                        <div class="mt-8"><button type="submit" class="btn w-full p-3 font-bold rounded-md">Salvar Configura√ß√µes de PIX</button></div>
                    </form>
                </div>`;
            },
            integrations() {
                const { utmifyIntegrations } = App.state.data;
                const utmifyListHTML = utmifyIntegrations.map(u => `
                    <div class="p-3 bg-slate-900/50 rounded-lg flex justify-between items-center">
                        <span class="font-medium text-sm">${u.account_name}</span>
                        <button data-id="${u.id}" class="delete-utmify-btn btn btn-red text-xs py-1 px-2">Excluir</button>
                    </div>
                `).join('');

                return `
                <div class="animate-fade-in">
                    <div class="mb-6"><h1 class="text-3xl font-bold text-white">Integra√ß√µes</h1><p class="text-slate-400">Conecte o HotTrack a outras ferramentas.</p></div>
                    <div class="max-w-2xl">
                        <div class="card p-6 rounded-lg">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold text-white">Contas Utmify</h2>
                                <button id="add-utmify-btn" class="btn btn-secondary text-sm py-1 px-3">Adicionar Conta</button>
                            </div>
                            <p class="text-sm text-gray-400 mt-1 mb-4">Adicione suas contas da Utmify. Depois, na cria√ß√£o de uma Pressel, voc√™ poder√° escolher para qual conta os eventos de venda devem ser enviados.</p>
                            <div id="utmify-list" class="space-y-3">
                                ${utmifyListHTML.length ? utmifyListHTML : '<p class="text-gray-500 text-sm">Nenhuma conta Utmify cadastrada.</p>'}
                            </div>
                        </div>
                    </div>
                </div>`;
            },
            documentation() {
                return `
                <div class="animate-fade-in">
                    <div class="mb-6"><h1 class="text-3xl font-bold text-white">API & Documenta√ß√£o</h1><p class="text-slate-400">Sua chave de API para integra√ß√µes e o guia de implementa√ß√£o.</p></div>
                    <div class="grid grid-cols-1 gap-8 max-w-4xl">
                        <div class="card p-6 rounded-lg">
                            <h2 class="text-xl font-semibold mb-2 text-white">Sua Chave de API HotTrack</h2>
                            <p class="text-sm text-gray-400 mb-4">Use esta chave para autenticar suas requisi√ß√µes na API HotTrack (ex: gerar PIX, consultar status).</p>
                            <div class="flex items-center gap-2">
                                <input id="hottrack-api-key" type="password" readonly value="${App.state.data.settings.api_key || ''}" class="form-input flex-grow p-2">
                                <button type="button" class="toggle-visibility-btn p-2 text-gray-400 hover:text-white" data-target="#hottrack-api-key">
                                    <svg class="pointer-events-none h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                                </button>
                                <button type="button" class="copy-btn btn text-sm py-2 px-3" data-target="#hottrack-api-key">Copiar</button>
                                <a href="https://documentacaohot.netlify.app/" target="_blank" rel="noopener noreferrer" class="btn btn-secondary text-sm py-2 px-3 flex items-center gap-2 whitespace-nowrap">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                    </svg>
                                    <span>Doc API</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>`;
            },
            modal(title, content) {
                return `<div id="modal" class="modal active"><div class="card p-6 rounded-lg w-full max-w-md animate-fade-in"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-white">${title}</h2><button id="closeModalBtn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>${content}</div></div>`;
            }
        },

        addAuthEventListeners() {
            const container = document.getElementById('app');
            container.addEventListener('click', async (e) => {
                if (e.target.id === 'showRegister') { e.preventDefault(); this.renderLogin('register'); }
                if (e.target.id === 'showLogin') { e.preventDefault(); this.renderLogin('login'); }
            });
            container.addEventListener('submit', async (e) => {
                const form = e.target;
                if (form.id === 'loginForm' || form.id === 'registerForm') {
                    e.preventDefault();
                    const data = Object.fromEntries(new FormData(form).entries());
                    const button = form.querySelector('button[type="submit"]');
                    const originalButtonText = button.innerHTML;
                    button.innerHTML = 'Processando...';
                    button.disabled = true;

                    if (form.id === 'loginForm') {
                        await this.login(data.email, data.password);
                    } else if (form.id === 'registerForm') {
                        const { name, email, password } = data;
                        await this.register(name, email, password);
                    }

                    button.innerHTML = originalButtonText;
                    button.disabled = false;
                }
            });
        },

        addDashboardEventListeners() {
            document.addEventListener('click', async (e) => {
                const sidebar = document.getElementById('sidebar');
                const overlay = document.getElementById('sidebar-overlay');

                if (sidebar && overlay) { 
                    const isOpenBtn = e.target.closest('#open-sidebar-btn');
                    const isCloseBtn = e.target.closest('#close-sidebar-btn');
                    const isOverlay = e.target.id === 'sidebar-overlay';
                    const isNavLink = e.target.closest('.nav-link');

                    if (isOpenBtn) {
                        sidebar.classList.remove('-translate-x-full');
                        overlay.classList.remove('hidden');
                    } else if (isCloseBtn || isOverlay || (isNavLink && window.innerWidth < 768)) {
                        sidebar.classList.add('-translate-x-full');
                        overlay.classList.add('hidden');
                    }
                }

                if (e.target.id === 'logoutButton') this.logout();
                if (e.target.closest('#closeModalBtn')) document.getElementById('modal-container').innerHTML = '';
                
                if (e.target.id === 'add-utmify-btn') {
                    this.showAddUtmifyModal();
                }

                const sidebarLink = e.target.closest('.nav-link[data-target]');
                if (sidebarLink && sidebarLink.dataset.target) this.navigateTo(sidebarLink.dataset.target);

                const copyBtn = e.target.closest('.copy-btn');
                if (copyBtn) {
                    const targetInput = document.querySelector(copyBtn.dataset.target);
                    if(targetInput) {
                        const textToCopy = targetInput.value || targetInput.textContent;
                        navigator.clipboard.writeText(textToCopy).then(() => {
                            const originalText = copyBtn.textContent;
                            copyBtn.textContent = 'Copiado!';
                            setTimeout(() => { copyBtn.textContent = originalText; }, 2000);
                        });
                    }
                }
                const toggleBtn = e.target.closest('.toggle-visibility-btn');
                if (toggleBtn) {
                    const targetInput = document.querySelector(toggleBtn.dataset.target);
                    const isPassword = targetInput.type === 'password';
                    targetInput.type = isPassword ? 'text' : 'password';
                    toggleBtn.innerHTML = isPassword 
                        ? `<svg class="pointer-events-none h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781z" clip-rule="evenodd" /><path d="M12.454 16.697L9.75 13.992a2.5 2.5 0 01-3.482-3.482l-2.455-2.455a10.048 10.048 0 00-3.263 5.218C1.732 14.057 5.522 17 10 17a9.95 9.95 0 005.023-1.303l-2.57-2.57z" /></svg>` 
                        : `<svg class="pointer-events-none h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>`;
                }
                if (e.target.classList.contains('generate-pressel-code-btn')) {
                    const presselId = e.target.dataset.id;
                    const pressel = this.state.data.pressels.find(p => p.id == presselId);
                    if (pressel) this.generatePresselCode(pressel);
                }
                if (e.target.classList.contains('test-pix-btn')) {
                    const provider = e.target.dataset.provider;
                    this.testIndividualPixConnection(provider, e.target);
                }
                if (e.target.id === 'testPriorityRouteBtn') {
                    this.testPriorityRoute(e.target);
                }
                const tabButton = e.target.closest('.tab-button');
                if (tabButton) {
                    const tabName = tabButton.dataset.tab;
                    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                    tabButton.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                    document.getElementById(`tab-${tabName}`).classList.add('active');
                }
                if (e.target.classList.contains('delete-pixel-btn') || e.target.classList.contains('delete-bot-btn') || e.target.classList.contains('delete-pressel-btn') || e.target.classList.contains('delete-utmify-btn')) {
                    const id = e.target.dataset.id;
                    let type = '', endpoint = '';
                    if (e.target.classList.contains('delete-pixel-btn')) { type = 'pixels'; endpoint = 'pixels'; }
                    if (e.target.classList.contains('delete-bot-btn')) { type = 'bots'; endpoint = 'bots'; }
                    if (e.target.classList.contains('delete-pressel-btn')) { type = 'pressels'; endpoint = 'pressels'; }
                    if (e.target.classList.contains('delete-utmify-btn')) { type = 'utmifyIntegrations'; endpoint = 'integrations/utmify'; }
                    
                    if (confirm(`Tem certeza que deseja excluir este item?`)) {
                        try {
                            await this.apiRequest(`/api/${endpoint}/${id}`, 'DELETE');
                            this.state.data[type] = this.state.data[type].filter(item => item.id != id);
                            this.navigateTo(this.state.currentPage);
                            this.showToast('Item exclu√≠do com sucesso!', 'success');
                        } catch(err) {}
                    }
                }
                const filterContainer = e.target.closest('#transactions-date-filter, #dashboard-date-filter');
                if (filterContainer) {
                    const page = filterContainer.id.split('-')[0];
                    const button = e.target.closest('button');
                    if (button?.dataset.period) { this.handleFilterChange(page, button.dataset.period); }
                    else if (button?.id === `apply-custom-date-filter-${page}`) {
                        const startDate = document.getElementById(`${page}-start-date`).value;
                        const endDate = document.getElementById(`${page}-end-date`).value;
                        if (startDate && endDate) { this.handleFilterChange(page, 'custom', startDate, endDate); }
                        else { this.showToast('Por favor, selecione data de in√≠cio e fim.', 'error'); }
                    } else if (button?.id === `clear-date-filter-${page}`) { this.handleFilterChange(page, 'all'); }
                }
            });

            document.addEventListener('submit', async (e) => {
                const form = e.target.closest('form');
                if (!form || form.id === 'loginForm' || form.id === 'registerForm' || form.id === 'verificationForm') return;
                e.preventDefault();
                const button = form.querySelector('button[type="submit"]');
                const originalButtonText = button.innerHTML;
                button.innerHTML = 'Salvando...';
                button.disabled = true;
                let data = Object.fromEntries(new FormData(form).entries());
                try {
                    if (form.id === 'pixSettingsForm') {
                        await this.apiRequest('/api/settings/pix', 'POST', data);
                        App.state.data.settings = { ...App.state.data.settings, ...data };
                        this.showToast('Configura√ß√µes PIX salvas!', 'success');
                    }
                    else if (form.id === 'utmifySettingsForm') {
                        const newIntegration = await this.apiRequest('/api/integrations/utmify', 'POST', data);
                        if(newIntegration) {
                            this.state.data.utmifyIntegrations.unshift(newIntegration);
                            document.getElementById('modal-container').innerHTML = '';
                            this.navigateTo('integrations');
                            this.showToast('Conta Utmify adicionada!', 'success');
                        }
                    }
                    else if (form.id === 'pixelForm') {
                        const newPixel = await this.apiRequest('/api/pixels', 'POST', data);
                        if (newPixel) { this.state.data.pixels.unshift(newPixel); this.navigateTo('pixels'); }
                    }
                    else if (form.id === 'botForm') {
                        const newBot = await this.apiRequest('/api/bots', 'POST', data);
                        if (newBot) { this.state.data.bots.unshift(newBot); this.navigateTo('bots'); }
                    }
                    else if (form.id === 'presselForm') {
                        const pixel_ids = Array.from(form.querySelectorAll('input[name="pixel_ids"]:checked')).map(cb => cb.value);
                        if (pixel_ids.length === 0) {
                             this.showToast('Selecione ao menos um pixel.', 'error');
                        } else {
                            const payload = { ...data, pixel_ids };
                            const newPressel = await this.apiRequest('/api/pressels', 'POST', payload);
                            if (newPressel) {
                                this.state.data.pressels.unshift(newPressel);
                                this.navigateTo('pressels');
                                this.generatePresselCode(newPressel);
                            }
                        }
                    }
                } catch(e) { /* Errors are handled by apiRequest */ }
                finally {
                    if(button) {
                        button.innerHTML = originalButtonText;
                        button.disabled = false;
                    }
                }
            });
            
            document.addEventListener('change', e => {
                if (e.target.id === 'value-type-selector') {
                    const container = document.getElementById('fixed-value-container');
                    if (container) {
                        container.style.display = e.target.value === 'fixed' ? 'block' : 'none';
                    }
                }

                if (e.target.id === 'flow-type-selector') {
                    const container = document.getElementById('flow-config-container');
                    if (!container) return;
                    
                    if (e.target.value === 'pix_flow') {
                        container.innerHTML = `
                            <h4 class="text-md font-semibold mt-2 mb-1 text-sky-400">Conte√∫do da Mensagem</h4>
                             <input id="mass-message-image-url" type="url" class="form-input w-full p-2" placeholder="URL da Imagem (Opcional)">
                            <textarea id="mass-message-initial-text" class="form-input w-full p-2 mt-2" rows="3" placeholder="Mensagem principal... Ex: Ol√°, gere seu PIX abaixo."></textarea>
                            <input id="mass-message-cta-button-text" class="form-input w-full p-2 mt-2" placeholder="Texto do Bot√£o (Ex: Gerar PIX Agora)">
                            <h4 class="text-md font-semibold mt-4 mb-1 text-sky-400">Valor do PIX</h4>
                            <input id="mass-message-pix-value" type="number" step="0.01" class="form-input w-full p-2" placeholder="Valor em REAIS (Ex: 19.90)">
                        `;
                    } else { // external_link
                        container.innerHTML = `
                            <h4 class="text-md font-semibold mt-2 mb-1 text-sky-400">Conte√∫do da Mensagem</h4>
                             <input id="mass-message-image-url" type="url" class="form-input w-full p-2" placeholder="URL da Imagem (Opcional)">
                            <textarea id="mass-message-initial-text" class="form-input w-full p-2 mt-2" rows="3" placeholder="Mensagem principal..."></textarea>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <input id="mass-message-cta-button-text" class="form-input w-full p-2" placeholder="Texto do Bot√£o (Ex: Acessar Site)">
                                <input id="mass-message-external-url" type="url" class="form-input w-full p-2" placeholder="https://seu-link.com">
                            </div>
                        `;
                    }
                }
            });
        },

        async apiRequest(endpoint, method = 'GET', body = null) {
            try {
                const headers = { 'Content-Type': 'application/json' };
                if (this.state.token) { headers['Authorization'] = `Bearer ${this.state.token}`; }
                const options = { method, headers };
                if (body) { options.body = JSON.stringify(body); }
                const response = await fetch(`${this.state.API_BASE_URL}${endpoint}`, options);
                if (response.status === 204) return null;
                const data = await response.json();
                if (!response.ok) throw data;
                return data;
            } catch (error) {
                this.showToast(error.message || 'Falha na conex√£o', 'error');
                if (error.message && (error.message.includes('inv√°lido') || error.message.includes('expirado'))) this.logout();
                throw error;
            }
        },
        
        async login(email, password) {
            try {
                const data = await this.apiRequest('/api/sellers/login', 'POST', { email, password });
                this.state.token = data.token;
                localStorage.setItem('hottrack_token', data.token);
                window.location.href = window.location.pathname; 
            } catch (e) {
            }
        },
        
        async register(name, email, password) {
            try {
                const data = await this.apiRequest('/api/sellers/register', 'POST', { name, email, password });
                this.showToast('Cadastro realizado! Redirecionando para aprova√ß√£o...', 'success');
                
                const message = `Ol√°, gostaria de solicitar a aprova√ß√£o do meu cadastro. Email: ${email}`;
                const whatsappUrl = `https://wa.me/5541995211148?text=${encodeURIComponent(message)}`;
                
                setTimeout(() => {
                    window.location.href = whatsappUrl;
                }, 1000);

            } catch (e) {
            }
        },

        logout() {
            this.state.token = null;
            localStorage.removeItem('hottrack_token');
            this.init();
        },

        showAddUtmifyModal() {
            const modalContent = `
                <form id="utmifySettingsForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Nome da Conta</label>
                        <input name="account_name" type="text" placeholder="Ex: Produto X - Utmify" class="form-input w-full p-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Token da API Utmify (x-api-token)</label>
                        <input name="api_token" type="password" class="form-input w-full p-2" required>
                    </div>
                    <div class="pt-2">
                        <button type="submit" class="btn w-full p-2 font-bold rounded-md">Salvar Integra√ß√£o</button>
                    </div>
                </form>
            `;
            document.getElementById('modal-container').innerHTML = this.templates.modal('Adicionar Conta Utmify', modalContent);
        },
        async viewDispatchDetails(logId) {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = this.templates.modal(`Relat√≥rio do Disparo #${logId}`, '<p>Carregando detalhes...</p>');
            
            try {
                const details = await this.apiRequest(`/api/dispatches/${logId}`);
                const rows = details.map(d => `
                    <tr>
                        <td>${d.first_name || 'N/A'} ${d.username ? `(@${d.username})` : ''}</td>
                        <td class="${d.status === 'success' ? 'text-green-400' : 'text-red-400'}">${d.status === 'success' ? 'Enviado' : 'Falhou'}</td>
                        <td class="text-xs text-gray-500">${d.details || 'OK'}</td>
                    </tr>
                `).join('');

                const content = `
                    <div class="max-h-96 overflow-y-auto">
                        <table class="table-custom w-full text-sm">
                            <thead><tr><th>Contato</th><th>Status</th><th>Detalhes</th></tr></thead>
                            <tbody>${rows.length ? rows : '<tr><td colspan="3">Nenhum detalhe encontrado.</td></tr>'}</tbody>
                        </table>
                    </div>`;
                modalContainer.innerHTML = this.templates.modal(`Relat√≥rio do Disparo #${logId}`, content);
            } catch(e) {
                 modalContainer.innerHTML = this.templates.modal(`Relat√≥rio do Disparo #${logId}`, '<p class="text-red-400">Erro ao carregar detalhes.</p>');
            }
        },
        
        async navigateTo(page) {
    this.state.currentPage = page;
    const contentContainer = document.getElementById('content');
    if (!contentContainer || !this.templates[page]) return;

    contentContainer.innerHTML = `<div class="flex items-center justify-center h-full"><svg class="animate-spin h-6 w-6 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>`;

    setTimeout(() => {
        contentContainer.innerHTML = this.templates[page]();
        document.querySelectorAll('.nav-link[data-target]').forEach(item => item.classList.toggle('active', item.dataset.target === page));

        // Inicializa√ß√£o espec√≠fica para o HotBot
        if (page === 'hotbot') {
            setTimeout(() => {
                const container = document.getElementById('hotbot-container');
                if (container) {
                    // Limpa qualquer inst√¢ncia anterior
                    if (window.hotBotRoot) {
                        window.hotBotRoot.unmount();
                    }
                    // Inicializa o HotBot
                    launchHotBot(container);
                }
            }, 100);
        } else {
            // Para outras p√°ginas, remove o HotBot se estiver montado
            if (window.hotBotRoot) {
                window.hotBotRoot.unmount();
                window.hotBotRoot = null;
            }
        }

        // Restante do c√≥digo para outras p√°ginas...
        if (page === 'dashboard') {
            this.handleFilterChange(page, this.state.dateFilter.period || 'last7days');
        } else if (page === 'transactions') {
            this.handleFilterChange(page, this.state.dateFilter.period || 'all');
        } else if (page === 'settings') {
            this.updateAllPixStatusIndicators();
        } else if (page === 'bots') {
            this.updateAllBotStatusIndicators();
        }
    }, 50);
},
        
        async fetchDashboardMetrics() {
            try {
                const { startDate, endDate } = this.state.dateFilter;
                const query = new URLSearchParams({ 
                    startDate: startDate || '',
                    endDate: endDate || ''
                }).toString();
                
                const metrics = await this.apiRequest(`/api/dashboard/metrics?${query}`);
                this.state.data.dashboard = metrics;

                document.getElementById('metric-clicks').textContent = this.formatNumber(metrics.total_clicks);
                document.getElementById('metric-generated').textContent = this.formatNumber(metrics.total_pix_generated);
                document.getElementById('metric-paid').textContent = this.formatNumber(metrics.total_pix_paid);
                document.getElementById('metric-total-revenue').textContent = this.formatNumber(metrics.total_revenue, true);
                document.getElementById('metric-paid-revenue').textContent = this.formatNumber(metrics.paid_revenue, true);
                
                const botsTableBody = document.getElementById('bots-performance-table');
                if (botsTableBody && metrics.bots_performance && metrics.bots_performance.length > 0) {
                    botsTableBody.innerHTML = metrics.bots_performance.map(b => `
                        <tr class="hover:bg-slate-800/50">
                            <td>${b.bot_name}</td>
                            <td>${this.formatNumber(b.total_clicks)}</td>
                            <td>${this.formatNumber(b.total_pix_paid)}</td>
                            <td>${this.formatNumber(b.paid_revenue, true)}</td>
                        </tr>`).join('');
                } else if(botsTableBody) {
                    botsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-8">Nenhum dado de bot.</td></tr>';
                }

                const trafficTableBody = document.getElementById('traffic-by-state-table');
                if (trafficTableBody && metrics.clicks_by_state && metrics.clicks_by_state.length > 0) {
                    trafficTableBody.innerHTML = metrics.clicks_by_state.map(s => `<tr class="hover:bg-slate-800/50"><td>${s.state}</td><td>${this.formatNumber(s.total_clicks)}</td></tr>`).join('');
                } else if(trafficTableBody){
                    trafficTableBody.innerHTML = '<tr><td colspan="2" class="text-center text-gray-500 py-8">Nenhum tr√°fego registrado.</td></tr>';
                }
                
                this.renderRevenueChart();
                this.fetchAchievementsAndRanking();
            } catch (e) { console.error("Erro ao carregar m√©tricas do painel:", e); }
        },
        
        async fetchAchievementsAndRanking() {
            try {
                const data = await this.apiRequest('/api/dashboard/achievements-and-ranking');
                
                const achievementsList = document.getElementById('achievements-list');
                const paidRevenue = this.state.data.dashboard.paid_revenue || 0;

                if (achievementsList && data.userAchievements.length > 0) {
                    achievementsList.innerHTML = data.userAchievements.map(ach => {
                        const icon = ach.is_completed ? '‚úÖ' : 'üîí';
                        const textColor = ach.is_completed ? 'text-green-400' : 'text-gray-400';
                        const missingAmount = ach.sales_goal / 100 - paidRevenue;
                        const formattedMissing = missingAmount > 0 ? `Falta ${this.formatNumber(missingAmount, true)}` : 'Conclu√≠da!';
                        
                        return `
                            <div class="card p-4 rounded-lg flex items-center gap-3 bg-slate-900/50">
                                <span class="text-2xl">${icon}</span>
                                <div>
                                    <p class="font-semibold text-white">${ach.title}</p>
                                    <p class="text-xs ${textColor}">${formattedMissing}</p>
                                </div>
                            </div>`;
                    }).join('');
                } else if(achievementsList) {
                    achievementsList.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma conquista dispon√≠vel ainda.</p>';
                }

                const rankingList = document.getElementById('ranking-list');
                if (rankingList && data.topSellersRanking.length > 0) {
                    rankingList.innerHTML = data.topSellersRanking.map((seller, index) => {
                        const rank = index + 1;
                        const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `${rank}.`;
                        const revenue = this.formatNumber(seller.total_revenue, true);
                        return `<div class="p-2 bg-slate-900/50 rounded-lg flex justify-between items-center"><span class="font-bold text-lg w-8 text-center">${medal}</span><span class="text-sm flex-1">${seller.name}</span><span class="text-xs text-gray-400">${revenue}</span></div>`;
                    }).join('');
                } else if (rankingList){
                    rankingList.innerHTML = '<p class="text-gray-500 text-sm">Nenhum dado de ranking ainda.</p>';
                }

                const userRankStatus = document.getElementById('user-rank-status');
                if(userRankStatus) userRankStatus.textContent = `Sua posi√ß√£o no ranking: ${data.currentUserRank}¬∞`;

            } catch (e) {
                console.error("Erro ao carregar conquistas e ranking:", e);
            }
        },
        
        renderTransactionsTable() {
            const tableBody = document.getElementById('transactions-table-body');
            if (!tableBody) return;

            const { period, startDate, endDate } = this.state.dateFilter;
            let filteredTransactions = this.state.data.transactions;

            if (period !== 'all' && startDate && endDate) {
                const start = new Date(startDate).getTime();
                const end = new Date(endDate).getTime();
                
                filteredTransactions = this.state.data.transactions.filter(t => {
                    const transactionDate = new Date(t.created_at).getTime();
                    return transactionDate >= start && transactionDate <= end;
                });
            }

            if (filteredTransactions.length > 0) {
                tableBody.innerHTML = filteredTransactions.map(t => {
                    const statusClass = t.status === 'paid' ? 'text-green-400 bg-green-500/10' : 'text-yellow-400 bg-yellow-500/10';
                    const statusText = t.status === 'paid' ? 'Pago' : 'Pendente';
                    const formattedValue = this.formatNumber(t.pix_value, true);
                    const formattedDate = new Date(t.created_at).toLocaleString('pt-BR');
                    const sourceName = (t.source_name === 'Checkout' || !t.source_name) ? 'Disparo' : t.source_name;
                    return `<tr class="hover:bg-slate-800/50">
                                <td><span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${statusText}</span></td>
                                <td>${formattedValue}</td><td>${sourceName}</td><td>${t.provider.toUpperCase()}</td><td>${formattedDate}</td>
                            </tr>`;
                }).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-8">Nenhuma transa√ß√£o encontrada para o per√≠odo selecionado.</td></tr>';
            }
        },

       handleFilterChange(page, period, customStartDate, customEndDate) {
            const now = new Date();
            let startDate, endDate;

            const setTimeToStartOfDay = (date) => {
                date.setHours(0, 0, 0, 0);
                return date;
            };
            const setTimeToEndOfDay = (date) => {
                date.setHours(23, 59, 59, 999);
                return date;
            };

            switch(period) {
                case 'today':
                    startDate = setTimeToStartOfDay(new Date());
                    endDate = setTimeToEndOfDay(new Date());
                    break;
                case 'yesterday':
                    const yesterday = new Date();
                    yesterday.setDate(now.getDate() - 1);
                    startDate = setTimeToStartOfDay(yesterday);
                    endDate = setTimeToEndOfDay(yesterday);
                    break;
                case 'last7days':
                    endDate = setTimeToEndOfDay(new Date());
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(now.getDate() - 6);
                    startDate = setTimeToStartOfDay(sevenDaysAgo);
                    break;
                case 'thisMonth':
                    startDate = setTimeToStartOfDay(new Date(now.getFullYear(), now.getMonth(), 1));
                    endDate = setTimeToEndOfDay(new Date(now.getFullYear(), now.getMonth() + 1, 0));
                    break;
                case 'custom':
                    if (customStartDate) startDate = new Date(customStartDate + 'T00:00:00');
                    if (customEndDate) endDate = new Date(customEndDate + 'T23:59:59.999');
                    break;
                default:
                    startDate = null; endDate = null;
            }

            this.state.dateFilter = { 
                period, 
                startDate: startDate ? startDate.toISOString() : null, 
                endDate: endDate ? endDate.toISOString() : null
            };
            
            const filterContainer = document.getElementById(`${page}-date-filter`);
            if (filterContainer) {
                filterContainer.querySelectorAll('button[data-period]').forEach(btn => btn.classList.toggle('active', btn.dataset.period === period));
            }

            if (page === 'dashboard') this.fetchDashboardMetrics();
            else if (page === 'transactions') this.renderTransactionsTable();
        },
        
        renderRevenueChart() {
            const ctx = document.getElementById('revenueChart');
            if (!ctx) return;
            const rawData = this.state.data.dashboard.daily_revenue || [];
            const labels = rawData.map(item => new Date(item.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'}));
            const revenues = rawData.map(item => item.revenue);
            
            if (this.state.revenueChart) this.state.revenueChart.destroy();

            this.state.revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Faturamento Pago',
                        data: revenues,
                        backgroundColor: (context) => {
                            const { ctx, chartArea } = context.chart;
                            if (!chartArea) return null;
                            const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                            gradient.addColorStop(0, 'rgba(56, 189, 248, 0)');
                            gradient.addColorStop(1, 'rgba(56, 189, 248, 0.3)');
                            return gradient;
                        },
                        borderColor: '#38bdf8', borderWidth: 2, tension: 0.4, fill: true,
                        pointBackgroundColor: '#38bdf8', pointRadius: 4, pointHoverRadius: 6,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: true,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(51, 65, 85, 0.5)' } },
                        x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#0f172a', titleColor: '#f1f5f9', bodyColor: '#cbd5e1',
                            borderColor: '#334155', borderWidth: 1,
                            callbacks: { label: (context) => `Faturamento: ${this.formatNumber(context.raw, true)}` }
                        }
                    }
                }
            });
        },
        generatePresselCode(pressel) {
            const { settings, pixels } = this.state.data;
            const selectedPixels = pixels.filter(p => pressel.pixel_ids.includes(p.id));
            const pixelsToTrackJSON = JSON.stringify(
                selectedPixels.map(p => ({ id: p.pixel_id })),
                null, 4
            );
            const noscriptPixelId = selectedPixels.length > 0 ? selectedPixels[0].pixel_id : '';

            const htmlContent = `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Acesso VIP</title>
    <style>
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif; background-color: #f0f2f5; color: #1c1e21; display: flex; justify-content: center; align-items: center; height: 100vh; text-align: center; }
        .container { padding: 20px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #0d6efd; margin: 20px auto; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        h1 { font-size: 1.5em; margin: 0 0 10px 0; }
        p { font-size: 1em; color: #606770; }
    </style>
    <script>
        const API_BASE_URL = '${this.state.API_BASE_URL}';
        const SELLER_API_KEY = '${settings.api_key}';
        const PRESSEL_ID = ${pressel.id};
        const TELEGRAM_USERNAME = '${pressel.bot_name}';
        const WHITE_PAGE_URL = '${pressel.white_page_url || 'https://google.com'}';
        const PIXELS_TO_TRACK = ${pixelsToTrackJSON};

        const isBot = () => /bot|facebook|crawler|spider|preview/i.test(navigator.userAgent);
        const isMobile = () => /android|iphone|ipad|ipod/i.test(navigator.userAgent);
        const getCookie = (name) => document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'))?.[2] || null;

        async function registerAndRedirect() {
            try {
                const params = new URLSearchParams(window.location.search);
                const response = await fetch(\`\${API_BASE_URL}/api/registerClick\`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        sellerApiKey: SELLER_API_KEY,
                        presselId: PRESSEL_ID,
                        referer: document.referrer || null,
                        fbclid: params.get("fbclid"),
                        fbp: getCookie("_fbp"),
                        fbc: getCookie("_fbc"),
                        user_agent: navigator.userAgent,
                        utm_source: params.get("utm_source"),
                        utm_campaign: params.get("utm_campaign"),
                        utm_medium: params.get("utm_medium"),
                        utm_content: params.get("utm_content"),
                        utm_term: params.get("utm_term")
                    })
                });
                const data = await response.json();
                if (response.ok && data.status === "success") {
                    window.location.replace(\`https://t.me/\${TELEGRAM_USERNAME}?start=\${data.click_id}\`);
                } else {
                    window.location.replace(WHITE_PAGE_URL);
                }
            } catch (error) {
                console.error("Erro ao registrar clique:", error);
                window.location.replace(WHITE_PAGE_URL);
            }
        }

        function waitForFbCookiesAndRedirect() {
            if (isBot() || !isMobile()) {
                window.location.replace(WHITE_PAGE_URL);
                return;
            }
            let attempts = 0;
            const maxAttempts = 15;
            const interval = setInterval(() => {
                const fbc = getCookie("_fbc");
                const fbclid = new URLSearchParams(window.location.search).get("fbclid");
                if (fbc || !fbclid || attempts >= maxAttempts) {
                    clearInterval(interval);
                    registerAndRedirect();
                }
                attempts++;
            }, 200);
        }
        
        window.onload = waitForFbCookiesAndRedirect;
    <\/script>
    <script>
        !function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;t.src='https://connect.facebook.net/en_US/fbevents.js';s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window,document,'script');
        PIXELS_TO_TRACK.forEach(p => { fbq('init', p.id); });
        fbq('track', 'PageView');
    <\/script>
    <noscript><img height="1" width="1" style="display:none" src="https://www.facebook.com/tr?id=${noscriptPixelId}&ev=PageView&noscript=1"/></noscript>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <h1>A preparar o seu acesso...</h1>
        <p>Aguarde um momento, estamos a redirecion√°-lo em seguran√ßa.</p>
    </div>
</body>
</html>`;

            const modalContent = `<p class="text-sm text-gray-400 mb-4">C√≥digo gerado com o novo formato de alta convers√£o. Copie e cole no HTML da sua p√°gina.</p><textarea id="pressel-code-textarea" class="form-input w-full p-2 font-mono text-xs" rows="15" readonly></textarea><button class="copy-btn btn w-full mt-4 py-2" data-target="#pressel-code-textarea">Copiar C√≥digo</button>`;
            
            document.getElementById('modal-container').innerHTML = this.templates.modal(`C√≥digo da Pressel: ${pressel.name}`, modalContent);
            document.getElementById('pressel-code-textarea').value = htmlContent;
        },

        async testIndividualPixConnection(provider, button) {
            const originalText = button.innerHTML;
            button.innerHTML = 'Testando...';
            button.disabled = true;
            this.updatePixStatusIndicator(provider, 'testing');
            
            const form = document.getElementById('pixSettingsForm');
            const formData = Object.fromEntries(new FormData(form).entries());
            try {
                await this.apiRequest('/api/settings/pix', 'POST', formData);
                App.state.data.settings = { ...App.state.data.settings, ...formData };
            } catch (e) {
                this.showToast('Erro ao salvar as configura√ß√µes antes do teste.', 'error');
                button.innerHTML = originalText; button.disabled = false;
                this.updatePixStatusIndicator(provider); return;
            }

            try {
                const result = await this.apiRequest('/api/pix/test-provider', 'POST', { provider });
                localStorage.setItem(`pix_status_${provider}`, 'success');
                localStorage.setItem(`pix_timestamp_${provider}`, Date.now());
                
                const successModalContent = `<div class="space-y-4 text-sm"><div class="flex justify-between items-center"><span class="font-semibold text-gray-400">Provedor:</span> <span class="text-white">${result.provider}</span></div><div class="flex justify-between items-center"><span class="font-semibold text-gray-400">Adquirente:</span> <span class="text-white">${result.acquirer}</span></div><div class="flex justify-between items-center"><span class="font-semibold text-gray-400">Tempo de Resposta:</span> <span class="text-white">${result.responseTime}s</span></div><hr class="border-slate-700"><div><p class="font-semibold text-gray-400 mb-2">PIX Copia e Cola (R$ 0,05):</p><textarea id="pix-test-key" class="form-input w-full p-2 font-mono text-xs" rows="4" readonly>${result.qr_code_text}</textarea><button class="copy-btn btn w-full mt-2 py-2 text-sm" data-target="#pix-test-key">Copiar Chave PIX</button></div></div>`;
                document.getElementById('modal-container').innerHTML = this.templates.modal('Conex√£o Bem-sucedida!', successModalContent);

            } catch (error) {
                localStorage.setItem(`pix_status_${provider}`, 'failure');
                localStorage.setItem(`pix_timestamp_${provider}`, Date.now());
                const errorModalContent = `<div class="text-center"><p class="text-lg font-medium text-red-400 mb-2">Falha na Conex√£o</p><p class="text-sm text-gray-400">${error.message || 'Ocorreu um erro desconhecido.'}</p></div>`;
                document.getElementById('modal-container').innerHTML = this.templates.modal('Erro no Teste', errorModalContent);
            } finally {
                button.innerHTML = originalText; button.disabled = false;
                this.updatePixStatusIndicator(provider);
            }
        },
        
        async testPriorityRoute(button) {
            const originalText = button.innerHTML;
            button.innerHTML = 'Testando Rota...';
            button.disabled = true;

            const form = document.getElementById('pixSettingsForm');
            const formData = Object.fromEntries(new FormData(form).entries());
            try {
                await this.apiRequest('/api/settings/pix', 'POST', formData);
                App.state.data.settings = { ...App.state.data.settings, ...formData };
            } catch (e) {
                this.showToast('Erro ao salvar as configura√ß√µes antes do teste.', 'error');
                button.innerHTML = originalText; button.disabled = false; return;
            }

            try {
                const result = await this.apiRequest('/api/pix/test-priority-route', 'POST');
                const logHTML = result.log.map(line => `<li class="${line.startsWith('SUCESSO') ? 'text-green-400' : 'text-red-400'}">${line}</li>`).join('');
                const successModalContent = `<div class="space-y-4 text-sm"><div class="flex justify-between items-center"><span class="font-semibold text-gray-400">Provedor de Sucesso:</span> <span class="text-white">${result.provider} (${result.position})</span></div><div class="flex justify-between items-center"><span class="font-semibold text-gray-400">Tempo de Resposta:</span> <span class="text-white">${result.responseTime}s</span></div><hr class="border-slate-700"><div><p class="font-semibold text-gray-400 mb-2">Log de Tentativas:</p><ul class="text-xs font-mono list-disc list-inside space-y-1">${logHTML}</ul></div><hr class="border-slate-700"><div><p class="font-semibold text-gray-400 mb-2">PIX Copia e Cola (R$ 0,05):</p><textarea id="pix-test-key" class="form-input w-full p-2 font-mono text-xs" rows="3" readonly>${result.qr_code_text}</textarea><button class="copy-btn btn w-full mt-2 py-2 text-sm" data-target="#pix-test-key">Copiar Chave PIX</button></div></div>`;
                document.getElementById('modal-container').innerHTML = this.templates.modal('Teste da Rota Conclu√≠do!', successModalContent);

            } catch (error) {
                const logHTML = error.log ? error.log.map(line => `<li class="text-red-400">${line}</li>`).join('') : '<li>Nenhum log dispon√≠vel.</li>';
                const errorModalContent = `<div class="space-y-4 text-sm"><p class="text-lg font-medium text-red-400 text-center mb-2">Falha na Rota de Prioridade</p><p class="text-gray-400 text-center">${error.message}</p><hr class="border-slate-700"><div><p class="font-semibold text-gray-400 mb-2">Log de Tentativas:</p><ul class="text-xs font-mono list-disc list-inside space-y-1">${logHTML}</ul></div></div>`;
                document.getElementById('modal-container').innerHTML = this.templates.modal('Erro no Teste', errorModalContent);
            } finally {
                button.innerHTML = originalText; button.disabled = false;
            }
        },

        updateAllBotStatusIndicators() {
            if (this.state.data.bots && this.state.data.bots.length > 0) {
                this.state.data.bots.forEach(bot => this.updateBotStatusIndicator(bot.id));
            }
        },
        
        updateBotStatusIndicator(botId) {
            const indicator = document.getElementById(`status-indicator-bot-${botId}`);
            if (!indicator) return;
            indicator.textContent = '';
            indicator.className = '';
        },

        updateAllPixStatusIndicators() {
            const providers = ['pushinpay', 'cnpay', 'oasyfy', 'syncpay', 'brpix'];
            providers.forEach(provider => this.updatePixStatusIndicator(provider));
        },

        updatePixStatusIndicator(provider, mode) {
             const indicator = document.getElementById(`status-indicator-${provider}`);
            if (!indicator) return;

            if (mode === 'testing') {
                indicator.textContent = 'Testando...';
                indicator.className = 'status-indicator testing';
                return;
            }

            const status = localStorage.getItem(`pix_status_${provider}`);
            const timestamp = localStorage.getItem(`pix_timestamp_${provider}`);

            if (status === 'success' && timestamp) {
                indicator.textContent = `Ativo (Testado ${this.formatTimeAgo(timestamp)})`;
                indicator.className = 'status-indicator success';
            } else if (status === 'failure' && timestamp) {
                indicator.textContent = `Falhou (Testado ${this.formatTimeAgo(timestamp)})`;
                indicator.className = 'status-indicator failure';
            } else {
                indicator.textContent = 'N√£o testado';
                indicator.className = 'status-indicator unknown';
            }
        },

        formatTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return "agora";
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `h√° ${minutes} min`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `h√° ${hours}h`;
            const days = Math.floor(hours / 24);
            return `h√° ${days}d`;
        },
        
        showToast(message, type = 'success') {
            const toast = document.createElement('div');
            let bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            toast.className = `fixed bottom-5 right-5 ${bgColor} text-white py-2 px-4 rounded-lg shadow-lg animate-fade-in z-50`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        }
    };

    // Inicializa a aplica√ß√£o principal do HotTrack
    document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
    
    <script type="text/babel">
    // ==========================================================
    // == L√ìGICA DO HOTBOT (ENCAPSULADA DENTRO DE UMA FUN√á√ÉO) ==
    // ==========================================================
    function launchHotBot(containerElement) {
        const { useState, useCallback, useEffect, useRef } = window.React;
        const { ReactFlowProvider, ReactFlow, useNodesState, useEdgesState, addEdge, Background, Controls, Handle, Position } = window.ReactFlow;

        const API_BASE_URL = App.state.API_BASE_URL; // Usa a URL do App principal
        const api = axios.create({ baseURL: API_BASE_URL });
        
        api.interceptors.request.use(
            config => {
                const token = localStorage.getItem('hottrack_token'); // USA O TOKEN DO HOTTRACK
                if (token) {
                    config.headers['Authorization'] = `Bearer ${token}`;
                }
                return config;
            },
            error => Promise.reject(error)
        );
        
        // --- IN√çCIO DO C√ìDIGO DO HOTBOT PARA COLAR ---


    const Icons = {
        contacts: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
        attach: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>,
        bots: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 8V4H8"/><rect x="4" y="12" width="16" height="8" rx="2"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="M17 12v-2a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v2"/></svg>,
        flows: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12h3"/><path d="M7 12h3"/><path d="M12 12h3"/><path d="M17 12h3"/><path d="M5 7v10"/><path d="M10 7v10"/><path d="M15 7v10"/><path d="M20 7v10"/><path d="M5 12a5 5 0 0 0 5 5"/><path d="M10 12a5 5 0 0 1 5 5"/><path d="M15 12a5 5 0 0 0 5-5"/></svg>,
        chat: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>,
        media: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>,
        disparos: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
        history: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18"/><path d="M18.7 8a6 6 0 0 1-8.4 0l-6.3-6.3"/><path d="M12 20.7a6 6 0 0 0 8.4 0l1.3-1.3"/></svg>,
        integrations: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.72"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.72-1.72"/></svg>,
        logout: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
        send: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
    };

    function AppHotBot() {
            // --- ALTERA√á√ÉO AQUI: L√ìGICA DE LOGIN REMOVIDA ---
            const [isLoading, setIsLoading] = useState(true);
            const [currentPage, setCurrentPage] = useState('bots');
            const [editingFlow, setEditingFlow] = useState(null);
            const [bots, setBots] = useState([]);
            const [importingFlowLink, setImportingFlowLink] = useState(null);

            const fetchInitialData = useCallback(() => {
                setIsLoading(true);
                api.get('/api/dashboard/data') // Note: Adicionei '/api' se sua rota for essa
                    .then((res) => {
                        setBots(res.data.bots || []);
                    })
                    .catch((err) => {
                        console.error("Erro ao buscar dados do HotBot:", err);
                        // Chama o logout global se a API falhar (ex: token expirado)
                        App.logout(); 
                    })
                    .finally(() => setIsLoading(false));
            }, []);

            useEffect(() => {
                fetchInitialData();
                const urlParams = new URLSearchParams(window.location.search);
                const shareLink = urlParams.get('link');
                if (shareLink) {
                    setImportingFlowLink(shareLink);
                    setCurrentPage('import-flow');
                }
            }, [fetchInitialData]);
            
            const handleLogout = () => {
                // Chama o logout da aplica√ß√£o principal
                App.logout(); 
            };

            const navigateToFlowEditor = (flow) => { setEditingFlow(flow); setCurrentPage('flow-editor'); };
            
            if (isLoading) return <div style={{display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100%', color: 'white'}}>Carregando dados do HotBot...</div>;
            
      
      
            const PageComponent = {
                bots: <BotsPage bots={bots} fetchBots={fetchInitialData} />,
                flows: <FlowsListPage bots={bots} onEditFlow={navigateToFlowEditor} />,
                chat: <LiveChatPage bots={bots} />,
                contacts: <ContactsPage bots={bots} />,
                media: <MediaLibraryPage />,
                disparos: <DisparosPage bots={bots} />,
                'disparos-history': <DisparosHistoryPage />,
                integrations: <SettingsPage />,
                'flow-editor': <FlowEditorPage flow={editingFlow} onBack={() => setCurrentPage('flows')} />,
                'import-flow': <ImportFlowPage shareableLinkId={importingFlowLink} bots={bots} onImported={() => { setCurrentPage('flows'); window.history.pushState({}, '', window.location.pathname); setImportingFlowLink(null); }} />
            }[currentPage];

            return (
                <div className="hotbot-page-container">
                    <Sidebar currentPage={currentPage} setCurrentPage={setCurrentPage} onLogout={handleLogout} />
                    <main className="hotbot-main-content">
                        <div style={{animation: 'fadeIn 0.5s ease-in-out', height: '100%'}}>
                            {PageComponent}
                        </div>
                    </main>
                </div>
            );
        }
    
    function Sidebar({ currentPage, setCurrentPage, onLogout }) {
        const pages = { 
            bots: 'Bots', 
            flows: 'Fluxos', 
            chat: 'Chat ao Vivo', 
            contacts: 'Contatos', 
            media: 'Biblioteca', 
            disparos: 'Disparos',
            'disparos-history': 'Hist√≥rico',
        };
        return (
            <aside className="sidebar">
                <div className="logo">H<span className="logo-text">otbot</span></div>
                <nav className="nav-menu">
                    {Object.entries(pages).map(([key, value]) => (
                        <div key={key} className={`nav-item ${currentPage === key ? 'active' : ''}`} onClick={() => setCurrentPage(key)} title={value}>
                            {Icons[key] || Icons.history} <span className="nav-text">{value}</span>
                        </div>
                    ))}
                </nav>
            </aside>
        );
    }
    
    function BotsPage({ bots, fetchBots }) {
      const [newBotName, setNewBotName] = useState('');
      const handleCreateBot = async (e) => { e.preventDefault(); if (!newBotName) return; try { await api.post('/api/bots', { bot_name: newBotName }); setNewBotName(''); fetchBots(); } catch (e) { alert('Erro: ' + (e.response?.data?.message || '')); } };
      const handleDeleteBot = async (id) => { if (confirm('Certeza?')) { try { await api.delete(`/api/bots/${id}`); fetchBots(); } catch (e) { alert('Erro'); } } };
      const handleUpdateToken = async (id) => {
          // ALERTA DE SEGURAN√áA: O uso de prompt() n√£o √© recomendado para dados sens√≠veis,
          // pois pode ser simulado em ataques de phishing.
          // RECOMENDA√á√ÉO: Use um modal seguro, constru√≠do com HTML/CSS/JS, para esta entrada.
          alert("Por seguran√ßa, use um formul√°rio modal para inserir tokens, em vez de um prompt.");
          const token = prompt("Insira o novo Token:"); 
          if (token) { 
              try { 
                  await api.put(`/api/bots/${id}`, { bot_token: token }); 
                  alert("OK"); 
                  fetchBots(); 
              } catch (e) { 
                  alert('Erro: ' + (e.response?.data?.message || '')); 
              } 
          } 
      };
      const handleSetWebhook = async (id) => { try { const res = await api.post(`/api/bots/${id}/set-webhook`); alert(res.data.message); } catch (e) { alert('Falha.'); } };
      return (
          <div style={{padding: '2rem 3rem', height: '100%', overflowY: 'auto'}}>
            <div className="page-header"><h2>Gerenciamento de Bots</h2><button className="btn btn-primary" onClick={() => document.getElementById('botName').focus()}>+ Adicionar Bot</button></div>
            <div style={{display: 'grid', gridTemplateColumns: '1fr 2fr', gap: '2rem', alignItems: 'start'}}>
                <div className="card"><h3 style={{color: 'var(--text-primary)'}}>Adicionar Novo Bot</h3><p style={{color: 'var(--text-secondary)', marginBottom: '1.5rem', fontSize: '0.9rem'}}>Crie e configure novos bots.</p><form onSubmit={handleCreateBot}><div className="form-group"><label htmlFor="botName">Nome de usu√°rio</label><input id="botName" className="form-input" value={newBotName} onChange={(e) => setNewBotName(e.target.value)} placeholder="@meu_bot"/></div><button className="btn btn-primary" type="submit" style={{width: '100%'}}>Criar</button></form></div>
                <div>
                    <h3 style={{marginBottom: '1rem', fontSize: '1.5rem', color: 'var(--text-primary)'}}>Bots Ativos</h3>
                    <div className="grid">
                        {bots.map(bot => (<div key={bot.id} className="bot-card"><div className="bot-card-header"><div className="icon">{Icons.bots}</div><h3>{bot.bot_name}</h3></div><p style={{color: 'var(--text-secondary)', fontSize: '0.9rem', marginBottom: '1.5rem', flexGrow: 1}}>Gerencie as configura√ß√µes.</p><div className="bot-card-actions"><button className="btn btn-secondary btn-sm" onClick={() => handleSetWebhook(bot.id)}>Webhook</button><button className="btn btn-secondary btn-sm" onClick={() => handleUpdateToken(bot.id)}>Token</button><button className="btn btn-danger btn-sm" style={{gridColumn: '1 / -1'}} onClick={() => handleDeleteBot(bot.id)}>Excluir</button></div></div>))}
                        {bots.length === 0 && <p style={{color: 'var(--text-secondary)'}}>Nenhum bot criado.</p>}
                    </div>
                </div>
            </div>
          </div>
        );
    }
    
    function ShareFlowModal({ flow, onClose, onLinkGenerated }) {
        const [isPaid, setIsPaid] = useState(false);
        const [price, setPrice] = useState(10);
        const [allowReshare, setAllowReshare] = useState(false);
        const [bundleLinkedFlows, setBundleLinkedFlows] = useState(false);
        const [bundleMedia, setBundleMedia] = useState(false);
        const [isGenerating, setIsGenerating] = useState(false);

        const handleGenerateLink = async () => {
            setIsGenerating(true);
            try {
                const options = {
                    priceInCents: isPaid ? Math.round(price * 100) : 0,
                    allowReshare,
                    bundleLinkedFlows,
                    bundleMedia
                };
                const response = await api.post(`/api/flows/${flow.id}/generate-share-link`, options);
                const link = `${FRONTEND_URL}/?link=${response.data.shareable_link_id}`;
                prompt("Link de compartilhamento gerado! Copie abaixo:", link);
                onLinkGenerated();
                onClose();
            } catch (error) {
                alert('Erro ao gerar link: ' + (error.response?.data?.message || 'Tente novamente.'));
            } finally {
                setIsGenerating(false);
            }
        };

        return (
            <div className="login-overlay" style={{ zIndex: 101 }}>
                <div className="login-box" style={{ width: '500px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                        <h2 style={{ fontWeight: 800, margin: 0 }}>Compartilhar Fluxo</h2>
                        <button onClick={onClose} style={{ background: 'none', border: 'none', color: 'white', fontSize: '1.5rem', cursor: 'pointer' }}>&times;</button>
                    </div>

                    <div className="form-group checkbox-group">
                        <input type="checkbox" id="isPaid" checked={isPaid} onChange={e => setIsPaid(e.target.checked)} />
                        <label htmlFor="isPaid">Cobrar pela importa√ß√£o deste fluxo?</label>
                    </div>
                    {isPaid && (
                        <div className="form-group">
                            <label htmlFor="price">Pre√ßo (R$)</label>
                            <input id="price" className="form-input" type="number" min="1" step="0.01" value={price} onChange={e => setPrice(parseFloat(e.target.value))} />
                        </div>
                    )}
                    
                    <p style={{ color: 'var(--text-secondary)', fontSize: '0.9rem', marginBottom: '1.5rem' }}>Aten√ß√£o: As funcionalidades de anexar fluxos e m√≠dias ainda est√£o em desenvolvimento.</p>

                    <div className="form-group checkbox-group">
                        <input type="checkbox" id="bundleFlows" checked={bundleLinkedFlows} onChange={e => setBundleLinkedFlows(e.target.checked)} disabled />
                        <label htmlFor="bundleFlows">Incluir fluxos anexados (encaminhados)</label>
                    </div>
                    <div className="form-group checkbox-group">
                        <input type="checkbox" id="bundleMedia" checked={bundleMedia} onChange={e => setBundleMedia(e.target.checked)} disabled />
                        <label htmlFor="bundleMedia">Incluir m√≠dias (imagens, v√≠deos, √°udios)</label>
                    </div>
                     <div className="form-group checkbox-group">
                        <input type="checkbox" id="allowReshare" checked={allowReshare} onChange={e => setAllowReshare(e.target.checked)} />
                        <label htmlFor="allowReshare">Permitir que quem importar compartilhe tamb√©m</label>
                    </div>

                    <button className="btn btn-primary" style={{ width: '100%' }} onClick={handleGenerateLink} disabled={isGenerating}>
                        {isGenerating ? 'Gerando...' : 'Gerar Link de Compartilhamento'}
                    </button>
                </div>
            </div>
        );
    }

    function FlowsListPage({ bots, onEditFlow }) {
        const [selectedBotId, setSelectedBotId] = useState('');
        const [flows, setFlows] = useState([]);
        const [isShareModalOpen, setIsShareModalOpen] = useState(false);
        const [flowToShare, setFlowToShare] = useState(null);
        
        const fetchFlows = useCallback(async () => {
            if (!selectedBotId) { setFlows([]); return; }
            try {
                const res = await api.get('/api/flows');
                setFlows(res.data.filter(f => f.bot_id == selectedBotId));
            } catch (e) { console.error("Erro ao buscar fluxos", e); }
        }, [selectedBotId]);
        
        useEffect(() => {
            if (bots.length > 0 && !selectedBotId) setSelectedBotId(bots[0].id);
        }, [bots, selectedBotId]);

        useEffect(() => { fetchFlows(); }, [fetchFlows]);

        const handleCreate = async () => {
            const n = prompt("Nome do novo fluxo:");
            if(n && selectedBotId) {
                try {
                    await api.post('/api/flows', { name: n, botId: selectedBotId });
                    fetchFlows();
                } catch (e) { alert("Erro ao criar fluxo."); }
            }
        };

        const handleDelete = async (id) => {
            if (confirm("Tem certeza que deseja excluir este fluxo?")) {
                try {
                    await api.delete(`/api/flows/${id}`);
                    fetchFlows();
                } catch (e) { alert("Erro ao excluir fluxo."); }
            }
        };

        const handleOpenShareModal = (flow) => {
            setFlowToShare(flow);
            setIsShareModalOpen(true);
        };

        return (
            <>
                {isShareModalOpen && <ShareFlowModal flow={flowToShare} onClose={() => setIsShareModalOpen(false)} onLinkGenerated={fetchFlows} />}
                <div style={{padding: '2rem 3rem', height: '100%', overflowY: 'auto'}}>
                    <div className="page-header"><h2>Fluxos de Conversa</h2><button className="btn btn-primary" onClick={handleCreate} disabled={!selectedBotId}>+ Novo Fluxo</button></div>
                    <div className="form-group" style={{maxWidth: '400px', marginBottom: '2rem'}}><label htmlFor="botSelect">Selecione um Bot</label><select id="botSelect" className="form-select" value={selectedBotId} onChange={e => setSelectedBotId(e.target.value)}><option value="">-- Selecione --</option>{bots.map(b => <option key={b.id} value={b.id}>{b.bot_name}</option>)}</select></div>
                    <div className="grid">
                        {flows.map(flow => (
                            <div key={flow.id} className="bot-card">
                               <div className="bot-card-header"><div className="icon">{Icons.flows}</div><h3>{flow.name}</h3></div>
                               <p style={{color: 'var(--text-secondary)', fontSize: '0.9rem', marginBottom: '1.5rem', flexGrow: 1}}>Modificado em: {new Date(flow.updated_at).toLocaleDateString()}</p>
                                {flow.shareable_link_id && <p style={{color: 'var(--brand-secondary)', fontSize: '0.8rem', fontWeight: '600', marginBottom: '1rem'}}>‚úì Compartilhado</p>}
                                <div className="bot-card-actions">
                                    <button className="btn btn-primary btn-sm" onClick={() => onEditFlow(flow)}>Editor</button>
                                    <button className="btn btn-secondary btn-sm" onClick={() => handleOpenShareModal(flow)}>Compartilhar</button>
                                    <button className="btn btn-danger btn-sm" style={{gridColumn: '1 / -1'}} onClick={() => handleDelete(flow.id)}>Excluir</button>
                                </div>
                            </div>
                        ))}
                        {flows.length === 0 && selectedBotId && <p style={{color: 'var(--text-secondary)'}}>Nenhum fluxo criado para este bot.</p>}
                    </div>
                </div>
            </>
        );
    }
    
    function ImportFlowPage({ shareableLinkId, bots, onImported }) {
        const [selectedBotId, setSelectedBotId] = useState('');
        const [isImporting, setIsImporting] = useState(false);
        const [isLoading, setIsLoading] = useState(true);
        const [flowDetails, setFlowDetails] = useState(null);
        const [error, setError] = useState('');
        const [pixData, setPixData] = useState(null);
        const [isWaitingPayment, setIsWaitingPayment] = useState(false);

        useEffect(() => {
            if (bots.length > 0 && !selectedBotId) {
                setSelectedBotId(bots[0].id);
            }
        }, [bots]);

        useEffect(() => {
            if (shareableLinkId) {
                setIsLoading(true);
                api.get(`/api/share/details/${shareableLinkId}`)
                    .then(response => {
                        setFlowDetails(response.data);
                    })
                    .catch(err => {
                        setError(err.response?.data?.message || 'N√£o foi poss√≠vel carregar os detalhes deste fluxo.');
                    })
                    .finally(() => {
                        setIsLoading(false);
                    });
            }
        }, [shareableLinkId]);

        const handleFreeImport = async () => {
            if (!selectedBotId) { alert('Por favor, selecione um bot para importar o fluxo.'); return; }
            setIsImporting(true);
            try {
                await api.post('/api/flows/import-from-link', { shareableLinkId, botId: selectedBotId });
                alert('Fluxo importado com sucesso!');
                onImported();
            } catch (err) {
                alert('Erro ao importar o fluxo: ' + (err.response?.data?.message || 'Tente novamente.'));
            } finally {
                setIsImporting(false);
            }
        };
        
        const handleInitiatePixPayment = () => {
             alert("Funcionalidade de pagamento via PIX em desenvolvimento. O backend precisa ser conectado √† API de PIX para esta a√ß√£o.");
        };

        if (isLoading) {
            return <div style={{ padding: '2rem 3rem' }}><h2>A carregar detalhes do fluxo...</h2></div>;
        }

        if (error) {
            return <div style={{ padding: '2rem 3rem' }}><h2>Erro</h2><p style={{color: 'var(--danger-text)'}}>{error}</p></div>;
        }
        
        const isPaid = flowDetails && flowDetails.share_price_cents > 0;
        const priceInReais = (flowDetails.share_price_cents / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

        return (
            <div style={{ padding: '2rem 3rem', height: '100%', overflowY: 'auto' }}>
                <div className="page-header"><h2>Importar Fluxo: {flowDetails?.name}</h2></div>
                <div className="card" style={{ maxWidth: '600px', margin: '0 auto' }}>
                    
                    {isPaid ? (
                        <>
                            <h3>Este √© um fluxo pago</h3>
                            <p style={{color: 'var(--text-secondary)', margin: '1rem 0' }}>Para importar este fluxo, √© necess√°rio o pagamento de:</p>
                            <h2 style={{color: 'var(--brand-primary)', marginBottom: '2rem' }}>{priceInReais}</h2>
                            <button className="btn btn-primary" onClick={handleInitiatePixPayment} disabled={isWaitingPayment}>
                                {isWaitingPayment ? 'Aguardando Pagamento...' : 'Pagar com PIX para Importar'}
                            </button>
                        </>
                    ) : (
                        <>
                            <p style={{ color: 'var(--text-secondary)', marginBottom: '1.5rem' }}>Selecione para qual dos seus bots voc√™ deseja adicionar este fluxo gratuito.</p>
                            <div className="form-group">
                                <label htmlFor="botSelectImport">Selecione o Bot de Destino</label>
                                <select id="botSelectImport" className="form-select" value={selectedBotId} onChange={e => setSelectedBotId(e.target.value)}>
                                    <option value="">-- Selecione um Bot --</option>
                                    {bots.map(b => <option key={b.id} value={b.id}>{b.bot_name}</option>)}
                                </select>
                            </div>
                            <button className="btn btn-primary" onClick={handleFreeImport} disabled={isImporting || !selectedBotId}>
                                {isImporting ? 'Importando...' : 'Confirmar Importa√ß√£o Gratuita'}
                            </button>
                        </>
                    )}
                </div>
            </div>
        );
    }
    
    function DisparosPage({ bots }) {
        const [selectedBotIds, setSelectedBotIds] = useState([]);
        const [flowSteps, setFlowSteps] = useState([]);
        const [campaignName, setCampaignName] = useState('');
        const [contactCount, setContactCount] = useState(0);
        const [isSending, setIsSending] = useState(false);
        const [isMediaModalOpen, setIsMediaModalOpen] = useState(false);
        const [mediaSelectionCallback, setMediaSelectionCallback] = useState(null);

        useEffect(() => {
            const fetchCount = async () => {
                if (selectedBotIds.length === 0) {
                    setContactCount(0);
                    return;
                }
                try {
                    const response = await api.post('/api/bots/contacts-count', { botIds: selectedBotIds });
                    setContactCount(response.data.count);
                } catch (error) {
                    console.error("Erro ao buscar contagem de contatos", error);
                    setContactCount(0);
                }
            };
            fetchCount();
        }, [selectedBotIds]);

        const handleBotSelection = (botId) => {
            setSelectedBotIds(prev => prev.includes(botId) ? prev.filter(id => id !== botId) : [...prev, botId]);
        };

        const addStep = (type) => {
            const newStep = { id: Date.now(), type };
            switch (type) {
                case 'message': newStep.text = ''; newStep.buttonText = ''; newStep.buttonUrl = ''; break;
                case 'image': case 'video': case 'audio': newStep.fileUrl = ''; newStep.caption = ''; break;
                case 'pix': newStep.valueInCents = 100; newStep.pixMessage = '‚úÖ PIX Gerado! Copie o c√≥digo abaixo:'; newStep.pixButtonText = 'üìã Copiar C√≥digo'; break;
                case 'check_pix': newStep.deliveryText = '‚úÖ Pagamento confirmado! Aqui est√° seu acesso:'; newStep.deliveryButtonText = 'Acessar Conte√∫do'; newStep.deliveryButtonUrl = ''; break;
                default: break;
            }
            setFlowSteps(prev => [...prev, newStep]);
        };
        
        const updateStep = (id, field, value) => { setFlowSteps(prev => prev.map(step => step.id === id ? { ...step, [field]: value } : step)); };
        const removeStep = (id) => { setFlowSteps(prev => prev.filter(step => step.id !== id)); };
        const openMediaLibrary = (callback) => { setMediaSelectionCallback(() => callback); setIsMediaModalOpen(true); };

        const handleSelectMedia = (mediaItem) => {
            if (mediaSelectionCallback) { mediaSelectionCallback(mediaItem.file_id); }
            setIsMediaModalOpen(false);
            setMediaSelectionCallback(null);
        };
        
        const handleSubmit = async (e) => {
            e.preventDefault();
            if (!campaignName || selectedBotIds.length === 0 || flowSteps.length === 0) {
                alert('Preencha o nome da campanha, selecione ao menos um bot e adicione uma a√ß√£o ao fluxo.');
                return;
            }
            setIsSending(true);
            try {
                const response = await api.post('/api/bots/mass-send', { campaignName, botIds: selectedBotIds, flowSteps });
                alert(response.data.message || 'Disparo agendado com sucesso!');
                setFlowSteps([]);
                setCampaignName('');
            } catch (error) {
                alert('Erro ao enviar disparo: ' + (error.response?.data?.message || error.message));
            } finally {
                setIsSending(false);
            }
        };

        const renderStep = (step) => {
            switch (step.type) {
                case 'message': return (<div key={step.id} className="card" style={{marginBottom: '1rem'}}><h4 style={{marginBottom: '1rem', display: 'flex', justifyContent: 'space-between'}}><span>üí¨ Enviar Mensagem</span> <button className="btn btn-danger btn-sm" onClick={() => removeStep(step.id)}>&times;</button></h4><div className="form-group"><label>Texto da Mensagem</label><textarea className="form-textarea" rows="3" value={step.text} onChange={e => updateStep(step.id, 'text', e.target.value)} placeholder="Use {{primeiro_nome}} ou {{nome_completo}}"/></div><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}><div className="form-group"><label>Texto do Bot√£o (Opcional)</label><input type="text" className="form-input" value={step.buttonText} onChange={e => updateStep(step.id, 'buttonText', e.target.value)} /></div><div className="form-group"><label>URL do Bot√£o (Opcional)</label><input type="url" className="form-input" value={step.buttonUrl} onChange={e => updateStep(step.id, 'buttonUrl', e.target.value)} /></div></div></div>);
                case 'image': case 'video': case 'audio': return (<div key={step.id} className="card" style={{marginBottom: '1rem'}}><h4 style={{marginBottom: '1rem', display: 'flex', justifyContent: 'space-between'}}><span>{step.type === 'image' ? 'üñºÔ∏è' : (step.type === 'video' ? 'üé¨' : 'üéµ')} Enviar {step.type.charAt(0).toUpperCase() + step.type.slice(1)}</span> <button className="btn btn-danger btn-sm" onClick={() => removeStep(step.id)}>&times;</button></h4><div className="form-group"><label>File ID ou URL</label><input type="text" className="form-input" value={step.fileUrl} onChange={e => updateStep(step.id, 'fileUrl', e.target.value)} /></div><button className="btn btn-secondary btn-sm" style={{marginBottom: '1rem'}} onClick={() => openMediaLibrary(fileId => updateStep(step.id, 'fileUrl', fileId))}>Selecionar da Biblioteca</button><div className="form-group"><label>Legenda (Opcional)</label><textarea className="form-textarea" rows="2" value={step.caption} onChange={e => updateStep(step.id, 'caption', e.target.value)} /></div></div>);
                case 'pix': return (<div key={step.id} className="card" style={{marginBottom: '1rem'}}><h4 style={{marginBottom: '1rem', display: 'flex', justifyContent: 'space-between'}}><span>üí≥ Gerar PIX</span> <button className="btn btn-danger btn-sm" onClick={() => removeStep(step.id)}>&times;</button></h4><div className="form-group"><label>Valor (em centavos)</label><input type="number" className="form-input" value={step.valueInCents} onChange={e => updateStep(step.id, 'valueInCents', e.target.value)} /></div><div className="form-group"><label>Texto da Mensagem PIX</label><textarea className="form-textarea" rows="2" value={step.pixMessage} onChange={e => updateStep(step.id, 'pixMessage', e.target.value)} /></div><div className="form-group"><label>Texto do Bot√£o PIX</label><input type="text" className="form-input" value={step.pixButtonText} onChange={e => updateStep(step.id, 'pixButtonText', e.target.value)} /></div></div>);
                case 'check_pix': return (<div key={step.id} className="card" style={{marginBottom: '1rem', borderLeft: '4px solid var(--info-bg)'}}><h4 style={{marginBottom: '1rem', display: 'flex', justifyContent: 'space-between'}}><span>üîç Verificar PIX & Entregar</span> <button className="btn btn-danger btn-sm" onClick={() => removeStep(step.id)}>&times;</button></h4><p style={{color: 'var(--text-secondary)', fontSize: '0.8rem', marginBottom: '1rem'}}>Esta a√ß√£o s√≥ ser√° executada se o PIX gerado na etapa anterior for pago.</p><div className="form-group"><label>Texto de Entrega (P√≥s-Pagamento)</label><textarea className="form-textarea" rows="3" value={step.deliveryText} onChange={e => updateStep(step.id, 'deliveryText', e.target.value)} /></div><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}><div className="form-group"><label>Texto do Bot√£o de Entrega</label><input type="text" className="form-input" value={step.deliveryButtonText} onChange={e => updateStep(step.id, 'deliveryButtonText', e.target.value)} /></div><div className="form-group"><label>URL do Bot√£o de Entrega</label><input type="url" className="form-input" value={step.deliveryButtonUrl} onChange={e => updateStep(step.id, 'deliveryButtonUrl', e.target.value)} /></div></div></div>);
                default: return null;
            }
        };

        return (
            <div style={{ padding: '2rem 3rem', height: '100%', overflowY: 'auto' }}>
                {isMediaModalOpen && <MediaLibraryModal onSelect={handleSelectMedia} onClose={() => setIsMediaModalOpen(false)} />}
                <div className="page-header"><h2>Disparo em Massa Inteligente</h2></div>
                <div style={{ maxWidth: '800px', margin: '0 auto' }}>
                    <form onSubmit={handleSubmit}>
                        <div className="card" style={{marginBottom: '2rem'}}>
                            <div className="form-group"><label>1. Nome da Campanha</label><input type="text" className="form-input" value={campaignName} onChange={e => setCampaignName(e.target.value)} placeholder="Ex: Lan√ßamento VIP" required /></div>
                            <div className="form-group"><label>2. Selecione os Bots de Destino</label><div style={{ display: 'flex', flexWrap: 'wrap', gap: '1rem' }}>{bots.map(bot => (<label key={bot.id} style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', cursor: 'pointer' }}><input type="checkbox" checked={selectedBotIds.includes(bot.id)} onChange={() => handleBotSelection(bot.id)} />{bot.bot_name}</label>))}</div>
                             <p style={{marginTop: '1rem', color: 'var(--text-secondary)', fontSize: '0.9rem'}}>Total de contatos selecionados: <strong style={{color: 'var(--brand-primary)'}}>{contactCount}</strong></p>
                            </div>
                        </div>
                        <div className="card" style={{marginBottom: '2rem'}}><label>3. Monte o Fluxo de Disparo</label><p style={{color: 'var(--text-secondary)', fontSize: '0.9rem', marginBottom: '1.5rem'}}>Adicione as a√ß√µes na ordem em que devem ser enviadas.</p><div style={{display: 'flex', flexWrap: 'wrap', gap: '0.75rem', marginBottom: '1.5rem'}}><button type="button" className="btn btn-secondary btn-sm" onClick={() => addStep('message')}>+ Mensagem</button><button type="button" className="btn btn-secondary btn-sm" onClick={() => addStep('image')}>+ Imagem</button><button type="button" className="btn btn-secondary btn-sm" onClick={() => addStep('video')}>+ V√≠deo</button><button type="button" className="btn btn-secondary btn-sm" onClick={() => addStep('audio')}>+ √Åudio</button><button type="button" className="btn btn-secondary btn-sm" onClick={() => addStep('pix')}>+ Gerar PIX</button><button type="button" className="btn btn-secondary btn-sm" onClick={() => addStep('check_pix')}>+ Verificar PIX</button></div><div>{flowSteps.map(renderStep)}</div>{flowSteps.length === 0 && <p style={{color: 'var(--text-secondary)', textAlign: 'center'}}>Nenhuma a√ß√£o adicionada ainda.</p>}</div>
                        <button type="submit" className="btn btn-primary" style={{ width: '100%', padding: '1rem' }} disabled={isSending}>{isSending ? 'Agendando...' : `Disparar para ${contactCount} contato(s)`}</button>
                    </form>
                </div>
            </div>
        );
    }
    
    function DisparosHistoryPage() {
        const [history, setHistory] = useState([]);
        const [isLoading, setIsLoading] = useState(true);
        const [isChecking, setIsChecking] = useState(null);

        const fetchHistory = useCallback(() => {
            api.get('/api/disparos/history')
                .then(res => setHistory(res.data))
                .catch(() => console.error('Erro ao atualizar hist√≥rico.'));
        }, []);

        useEffect(() => {
            setIsLoading(true);
            api.get('/api/disparos/history')
                .then(res => setHistory(res.data))
                .catch(() => alert('Erro ao carregar o hist√≥rico.'))
                .finally(() => setIsLoading(false));
            
            const intervalId = setInterval(fetchHistory, 5000);

            return () => clearInterval(intervalId);
        }, [fetchHistory]);
        
        const handleCheckConversions = async (historyId) => {
            setIsChecking(historyId);
            try {
                const res = await api.post(`/api/disparos/check-conversions/${historyId}`);
                alert(res.data.message);
                fetchHistory();
            } catch (error) {
                alert('Erro ao verificar: ' + (error.response?.data?.message || error.message));
            } finally {
                setIsChecking(null);
            }
        };
        
        const getStatusChip = (status) => {
            const styles = {
                PENDING: { background: '#a16207', color: '#fefce8' },
                RUNNING: { background: '#1d4ed8', color: '#dbeafe' },
                COMPLETED: { background: '#166534', color: '#dcfce7' },
                FAILED: { background: '#991b1b', color: '#fee2e2' }
            };
            return <span style={{...styles[status], padding: '4px 8px', borderRadius: '12px', fontSize: '0.8rem', fontWeight: '600'}}>{status}</span>
        }

        return (
            <div style={{ padding: '2rem 3rem', height: '100%', overflowY: 'auto' }}>
                <div className="page-header"><h2>Hist√≥rico de Disparos</h2><button className="btn btn-secondary" onClick={fetchHistory} disabled={isLoading}>Atualizar</button></div>
                <div className="card">
                    <table style={{width: '100%', borderCollapse: 'collapse', textAlign: 'left'}}>
                        <thead>
                            <tr style={{borderBottom: '1px solid var(--border-color)'}}>
                                <th style={{padding: '1rem'}}>Campanha</th>
                                <th style={{padding: '1rem'}}>Data</th>
                                <th style={{padding: '1rem'}}>Status</th>
                                <th style={{padding: '1rem'}}>Envios</th>
                                <th style={{padding: '1rem'}}>Convers√µes</th>
                                <th style={{padding: '1rem'}}>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {isLoading ? (<tr><td colSpan="6" style={{textAlign: 'center', padding: '2rem'}}>A carregar...</td></tr>) : 
                             history.map(item => (
                                <tr key={item.id} style={{borderBottom: '1px solid var(--border-color)'}}>
                                    <td style={{padding: '1rem', fontWeight: '600'}}>{item.campaign_name}</td>
                                    <td style={{padding: '1rem'}}>{new Date(item.created_at).toLocaleString()}</td>
                                    <td style={{padding: '1rem'}}>{getStatusChip(item.status)}</td>
                                    <td style={{padding: '1rem'}}>{item.total_sent || 0}</td>
                                    <td style={{padding: '1rem', fontWeight: 'bold', color: 'var(--brand-primary)'}}>{item.conversions || 0}</td>
                                    <td style={{padding: '1rem'}}>
                                        <button className="btn btn-secondary btn-sm" onClick={() => handleCheckConversions(item.id)} disabled={isChecking === item.id}>
                                            {isChecking === item.id ? 'A verificar...' : 'Verificar PIX'}
                                        </button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                     {!isLoading && history.length === 0 && <p style={{textAlign: 'center', padding: '2rem', color: 'var(--text-secondary)'}}>Nenhum disparo encontrado.</p>}
                </div>
            </div>
        );
    }

    function SettingsPage() {
        const [apiKey, setApiKey] = useState('');
        const [isLoading, setIsLoading] = useState(true);
        const [isSaving, setIsSaving] = useState(false);
        useEffect(() => {
            api.get('/api/dashboard/data')
                .then(res => setApiKey(res.data.settings?.hottrack_api_key || ''))
                .catch(() => alert("N√£o foi poss√≠vel carregar as suas configura√ß√µes."))
                .finally(() => setIsLoading(false));
        }, []);
        const handleSave = async (e) => {
            e.preventDefault();
            setIsSaving(true);
            try {
                const res = await api.put('/api/settings/hottrack-key', { apiKey });
                alert(res.data.message);
            } catch (error) {
                alert('Erro ao salvar: ' + (error.response?.data?.message || error.message));
            } finally {
                setIsSaving(false);
            }
        };
        if (isLoading) { return <div style={{padding: '2rem 3rem'}}><div className="page-header"><h2>Integra√ß√µes</h2></div><p>A carregar...</p></div>; }
        return (
            <div style={{ padding: '2rem 3rem', height: '100%', overflowY: 'auto' }}>
                <div className="page-header"><h2>Integra√ß√µes</h2></div>
                <div className="card" style={{ maxWidth: '700px' }}>
                    <h3 style={{color: 'var(--text-primary)'}}>Integra√ß√£o com HotTrack PIX</h3>
                    <p style={{color: 'var(--text-secondary)', marginBottom: '1.5rem', fontSize: '0.9rem'}}>Insira a sua Chave de API da plataforma HotTrack para permitir que este bot gere e consulte PIXs.</p>
                    <form onSubmit={handleSave}>
                        <div className="form-group"><label htmlFor="hottrackApiKey">A sua Chave de API HotTrack</label><input id="hottrackApiKey" className="form-input" type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="Cole a sua chave de API aqui" /></div>
                        <button className="btn btn-primary" type="submit" disabled={isSaving}>{isSaving ? 'A guardar...' : 'Guardar Chave'}</button>
                    </form>
                </div>
            </div>
        );
    }
    
    function LiveChatPage({ bots }) {
        const [selectedBotId, setSelectedBotId] = useState('');
        const [allFlows, setAllFlows] = useState([]);
        const [users, setUsers] = useState([]);
        const [filteredUsers, setFilteredUsers] = useState([]);
        const [selectedChat, setSelectedChat] = useState(null);
        const [messages, setMessages] = useState([]);
        const [newMessage, setNewMessage] = useState('');
        const [searchTerm, setSearchTerm] = useState('');
        
        const [showOnlyActive, setShowOnlyActive] = useState(false);
        const [inactiveChatIds, setInactiveChatIds] = useState([]);
        const [isValidating, setIsValidating] = useState(false);
        
        const [isMediaModalOpen, setIsMediaModalOpen] = useState(false);
        const chatWindowRef = useRef(null);
        const fileInputRef = useRef(null);
        
        useEffect(() => {
            if (bots.length > 0 && !selectedBotId) {
                setSelectedBotId(bots[0].id);
            }
        }, [bots]);
        
        useEffect(() => {
            const chatWindow = chatWindowRef.current;
            if (!chatWindow) return;

            const isScrolledToBottom = chatWindow.scrollHeight - chatWindow.clientHeight <= chatWindow.scrollTop + 150;

            if (isScrolledToBottom) {
                chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
            }
        }, [messages]);
        
        useEffect(() => {
            api.get('/api/flows').then(({data}) => setAllFlows(data || []));
        }, []);

        const fetchUsers = useCallback(async () => {
            if (!selectedBotId) return;
            try {
                const { data } = await api.get(`/api/chats/${selectedBotId}`);
                setUsers(data);
            } catch (e) {
                console.error("Erro ao buscar usu√°rios", e);
            }
        }, [selectedBotId]);
        
        useEffect(() => {
            if (!selectedBotId) return;
            fetchUsers();
            const intervalId = setInterval(fetchUsers, 10000);
            return () => clearInterval(intervalId);
        }, [fetchUsers, selectedBotId]);

        const fetchMessages = useCallback(async () => {
             if (!selectedBotId || !selectedChat?.chat_id) return;
             try {
                 const { data } = await api.get(`/api/chats/${selectedBotId}/${selectedChat.chat_id}`);
                 setMessages(prevMessages => JSON.stringify(prevMessages) === JSON.stringify(data) ? prevMessages : data);
             } catch (e) {
                 console.error("Erro ao buscar mensagens", e);
             }
        }, [selectedBotId, selectedChat?.chat_id]);

        useEffect(() => {
            if (!selectedChat) return;
            fetchMessages(); 
            const intervalId = setInterval(fetchMessages, 5000);
            return () => clearInterval(intervalId);
        }, [fetchMessages, selectedChat]);
        
        useEffect(() => {
            const activeUsers = showOnlyActive 
                ? users.filter(u => !inactiveChatIds.includes(u.chat_id))
                : users;

            setFilteredUsers(
                activeUsers.filter(u => 
                    ((u.first_name || '') + ' ' + (u.last_name || '')).toLowerCase().includes(searchTerm.toLowerCase()) || 
                    (u.chat_id || '').toString().includes(searchTerm) || 
                    (u.click_id || '').toLowerCase().includes(searchTerm.toLowerCase())
                )
            );
        }, [searchTerm, users, showOnlyActive, inactiveChatIds]);

        const handleFilterActiveToggle = async () => {
            const nextState = !showOnlyActive;
            setShowOnlyActive(nextState);

            if (nextState && selectedBotId) {
                setIsValidating(true);
                try {
                    const { data } = await api.post('/api/bots/validate-contacts', { botId: selectedBotId });
                    setInactiveChatIds(data.inactive_contacts.map(c => c.chat_id));
                } catch (error) {
                    console.error("Erro ao validar contatos", error);
                    alert('N√£o foi poss√≠vel validar os contatos.');
                } finally {
                    setIsValidating(false);
                }
            }
        };

        useEffect(() => {
            if (selectedBotId) {
                setSelectedChat(null);
            }
        }, [selectedBotId]);

        const handleSelectChat = useCallback((user) => {
            if (selectedChat?.chat_id !== user.chat_id) {
                setMessages([]);
                setSelectedChat(user);
            }
        }, [selectedChat]);

        const handleSend = async (e) => { e.preventDefault(); const txt = newMessage.trim(); if (!txt || !selectedChat) return; setNewMessage(''); try { await api.post(`/api/chats/${selectedBotId}/send-message`, { chatId: selectedChat.chat_id, text: txt }); await fetchMessages(); } catch (e) { console.error("Erro", e); alert('Erro ao enviar mensagem.');} };
        const handleFileChange = (e) => { const file = e.target.files[0]; if (!file || !selectedChat) return; const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = async () => { try { const base64Data = reader.result.split(',')[1]; await api.post(`/api/chats/${selectedBotId}/send-media`, { chatId: selectedChat.chat_id, fileData: base64Data, fileType: file.type, fileName: file.name }); fetchMessages(); } catch (error) { alert('Falha no upload: ' + (error.response?.data?.message || error.message)); }}; e.target.value = null; };
        
        const handleSendFromLibrary = async (mediaItem) => {
            if (!selectedChat || !selectedBotId) return;
            setIsMediaModalOpen(false);
            try {
                await api.post(`/api/chats/${selectedBotId}/send-library-media`, {
                    chatId: selectedChat.chat_id,
                    fileId: mediaItem.file_id,
                    fileType: mediaItem.file_type
                });
                fetchMessages();
            } catch (error) {
                alert('Falha ao enviar m√≠dia da biblioteca: ' + (error.response?.data?.message || error.message));
            }
        };

        const handleDelete = async (id) => { if (confirm(`Certeza?`)) { try { await api.delete(`/api/chats/${selectedBotId}/${id}`); fetchUsers(); if (selectedChat?.chat_id === id) { setSelectedChat(null); } } catch (e) { alert('Erro'); } } };
        const getDisplayName = (u) => { if (!u) return ''; if (u.click_id) { const cleanId = u.click_id.replace('/start ', ''); return cleanId.charAt(0).toUpperCase() + cleanId.slice(1); } return `${u.first_name || ''} ${u.last_name || ''}`.trim() || 'Desconhecido'; };
        const getMessageSender = (msg) => {
            const selectedBot = bots.find(b => b.id == selectedBotId);
            switch(msg.sender_type) {
                case 'user': return `${msg.first_name || ''} ${msg.last_name || ''}`.trim();
                case 'operator': return 'Voc√™ (Operador)';
                case 'bot': return `${(selectedBot?.bot_name || 'Bot').replace('@', '')} (Automa√ß√£o)`;
                default: return 'Desconhecido';
            }
        };
        const getMessageBubbleClass = (senderType) => {
            if (senderType === 'user') return 'message-user';
            return 'message-attendant';
        };

        // ******** CORRE√á√ÉO DE SEGURAN√áA (XSS) APLICADA AQUI ********
        const renderMessageContent = (msg) => {
            const text = msg.message_text || '';
            if (msg.media_type === 'photo') { return <img src={`${API_BASE_URL}/media/preview/${msg.bot_id}/${msg.media_file_id}`} className="chat-media" alt="Foto" onClick={() => window.open(`${API_BASE_URL}/media/preview/${msg.bot_id}/${msg.media_file_id}`)} />; }
            if (msg.media_type === 'video') { return <video src={`${API_BASE_URL}/media/preview/${msg.bot_id}/${msg.media_file_id}`} className="chat-media" controls />; }
            if (msg.media_type === 'voice') { return <audio src={`${API_BASE_URL}/media/preview/${msg.bot_id}/${msg.media_file_id}`} className="chat-audio" controls />; }
            
            // SANITIZA√á√ÉO: Limpa o HTML de qualquer script malicioso antes de renderizar.
            // A biblioteca DOMPurify foi adicionada no <head> do HTML.
            const sanitizedHtml = DOMPurify.sanitize(text.replace(/\n/g, '<br />'));
            
            return <div dangerouslySetInnerHTML={{ __html: sanitizedHtml }} />;
        };
        
        const botFlows = allFlows.filter(f => f.bot_id == selectedBotId);

        return (
            <div className="chat-page-layout">
                {isMediaModalOpen && <MediaLibraryModal onSelect={handleSendFromLibrary} onClose={() => setIsMediaModalOpen(false)} />}
                <div style={{display: 'flex', flexDirection: 'column', height: '100%'}}>
                    <div className="page-header" style={{padding: '2rem 3rem 2rem 3rem', margin: 0}}><h2>Chat ao Vivo</h2><div className="form-group" style={{ marginBottom: 0, minWidth: '300px' }}><select id="botSelectChat" className="form-select" value={selectedBotId} onChange={e => setSelectedBotId(e.target.value)}><option value="">-- Selecione um Bot --</option>{bots.map(b => <option key={b.id} value={b.id}>{b.bot_name}</option>)}</select></div></div>
                    <div className="chat-container" style={{height: 'calc(100vh - 8.5rem)', margin: '0 3rem 2rem 3rem'}} >
                        <div className="conversations-panel">
                            <div className="conversations-header">
                                <input type="text" className="form-input" placeholder="Buscar..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                            </div>
                            <div style={{ padding: '0.75rem 1rem', borderBottom: '1px solid var(--border-color)', display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                <label htmlFor="activeFilter" style={{ cursor: 'pointer', flexGrow: 1, color: 'var(--text-secondary)', fontSize: '0.9rem' }}>
                                    {isValidating ? 'Validando...' : 'Mostrar apenas ativos'}
                                </label>
                                <input 
                                    type="checkbox" 
                                    id="activeFilter" 
                                    checked={showOnlyActive} 
                                    onChange={handleFilterActiveToggle} 
                                    disabled={isValidating}
                                />
                            </div>
                            <div className="conversations-list">
                                {filteredUsers.map(u => (<div key={u.chat_id} className={`conversation-item ${selectedChat?.chat_id === u.chat_id ? 'active' : ''}`} onClick={() => handleSelectChat(u)}><div className="conversation-item-name">{getDisplayName(u)}</div><p className="conversation-item-preview">{u.message_text}</p></div>))}
                            </div>
                        </div>
                        <div className="chat-window">{selectedChat ? (<><div className="chat-header"><h3>{getDisplayName(selectedChat)}</h3><button className="btn btn-danger btn-sm" onClick={() => handleDelete(selectedChat.chat_id)}>Excluir</button></div><div className="message-list" ref={chatWindowRef}>{messages.map((m, i) => (<div key={m.message_id || i} className={`message-bubble ${getMessageBubbleClass(m.sender_type)}`}><strong>{getMessageSender(m)}</strong>{renderMessageContent(m)}<div className="message-bubble-time">{new Date(m.created_at).toLocaleTimeString()}</div></div>))}</div><div className="chat-input-area"><form onSubmit={handleSend} className="chat-input-form"><input type="file" ref={fileInputRef} onChange={handleFileChange} hidden accept="image/*,video/*,audio/*" /><button type="button" className="attach-btn" onClick={() => fileInputRef.current.click()} title="Anexar do computador">{Icons.attach}</button><button type="button" className="attach-btn" onClick={() => setIsMediaModalOpen(true)} title="Selecionar da Biblioteca">{Icons.media}</button><input className="form-input chat-input" value={newMessage} onChange={e => setNewMessage(e.target.value)} placeholder="Digite..." /><button className="btn btn-primary" type="submit">{Icons.send}</button></form></div></>) : (<div className="centered-placeholder">{Icons.chat}<h3>Selecione uma conversa</h3><p>Escolha um contato √† esquerda.</p></div>)}</div>
                        <div className="contact-panel">
                            {selectedChat ? (<>
                                <h3>Detalhes</h3>
                                <div className="contact-detail"><label>Nome</label><p>{`${selectedChat.first_name || ''} ${selectedChat.last_name || ''}`.trim() || 'N√£o informado'}</p></div>
                                <div className="contact-detail"><label>Username</label><p>{selectedChat.username ? `@${selectedChat.username}` : 'Nenhum'}</p></div>
                                <div className="contact-detail"><label>Chat ID</label><p>{selectedChat.chat_id}</p></div>
                                <div className="contact-detail"><label>Click ID</label><p>{selectedChat.click_id || 'Nenhum'}</p></div>
                                <ChatActionsPanel botId={selectedBotId} chat={selectedChat} flows={botFlows} onAction={fetchMessages}/>
                            </>) : (<div className="centered-placeholder"><h3>Informa√ß√µes</h3><p>Detalhes do contato aqui.</p></div>)}
                        </div>
                    </div>
                </div>
            </div>
        );
    }
    
    function ChatActionsPanel({ botId, chat, flows, onAction }) {
        const [pixValue, setPixValue] = useState(100);
        const [pixMessage, setPixMessage] = useState('üö® Meu amor, o c√≥digo expira em 6 minutos.');
        const [pixButtonText, setPixButtonText] = useState('üìã Copiar C√≥digo PIX');
        const [selectedFlow, setSelectedFlow] = useState('');

        const handleGeneratePix = async () => {
            try {
                const res = await api.post('/api/chats/generate-pix', {
                    botId,
                    chatId: chat.chat_id,
                    click_id: chat.click_id,
                    valueInCents: pixValue,
                    pixMessage: pixMessage,
                    pixButtonText: pixButtonText
                });
                alert(res.data.message);
                onAction();
            } catch (e) {
                alert('Erro: ' + (e.response?.data?.message || e.message));
            }
        };

        const handleCheckPix = async () => {
             try {
                const res = await api.get(`/api/chats/check-pix/${botId}/${chat.chat_id}`);
                alert(`Status do PIX: ${res.data.status}`);
            } catch (e) {
                alert('Erro: ' + (e.response?.data?.message || e.message));
            }
        };

        const handleStartFlow = async () => {
            if (!selectedFlow) {
                alert('Selecione um fluxo para iniciar.');
                return;
            }
            try {
                const res = await api.post('/api/chats/start-flow', { botId, chatId: chat.chat_id, flowId: selectedFlow });
                alert(res.data.message);
                setTimeout(() => {
                    onAction();
                }, 1500);
            } catch (e) {
                alert('Erro: ' + (e.response?.data?.message || e.message));
            }
        };

        return (
            <div className="actions-panel">
                <h3>A√ß√µes R√°pidas</h3>
                <div className="form-group">
                    <label htmlFor="pixValue">Valor do PIX (em centavos)</label>
                    <input id="pixValue" type="number" className="form-input" value={pixValue} onChange={e => setPixValue(e.target.value)} />
                    <label htmlFor="pixMessage">Texto da Mensagem do PIX</label>
                    <textarea id="pixMessage" className="form-textarea" rows="3" value={pixMessage} onChange={e => setPixMessage(e.target.value)} />
                    <label htmlFor="pixButtonText">Texto do Bot√£o PIX</label>
                    <input id="pixButtonText" type="text" className="form-input" value={pixButtonText} onChange={e => setPixButtonText(e.target.value)} />
                    <button className="btn btn-secondary btn-sm" onClick={handleGeneratePix} style={{marginTop: '1rem'}}>Gerar e Enviar PIX</button>
                    <button className="btn btn-secondary btn-sm" onClick={handleCheckPix}>Consultar √öltimo PIX</button>
                </div>
                <div className="form-group">
                    <label htmlFor="flowSelect">Iniciar Fluxo</label>
                    <select id="flowSelect" className="form-select" value={selectedFlow} onChange={e => setSelectedFlow(e.target.value)}>
                        <option value="">Selecione um fluxo...</option>
                        {flows.map(f => <option key={f.id} value={f.id}>{f.name}</option>)}
                    </select>
                    <button className="btn btn-secondary btn-sm" onClick={handleStartFlow} disabled={!selectedFlow}>Iniciar Fluxo</button>
                </div>
            </div>
        );
    }
    
    function MediaLibraryPage() {
        const [media, setMedia] = useState([]);
        const [isUploading, setIsUploading] = useState(false);
        const fetchMedia = async () => { try { const { data } = await api.get('/api/media'); setMedia(data); } catch (e) { console.error("Erro ao buscar m√≠dias", e); }};
        useEffect(() => { fetchMedia(); }, []);
        const handleFileChange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const fileType = file.type.startsWith('image/') ? 'image' : (file.type.startsWith('video/') ? 'video' : (file.type.startsWith('audio/') ? 'audio' : null));
            if (!fileType) {
                alert("Formato de ficheiro n√£o suportado.");
                return;
            }
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                setIsUploading(true);
                try {
                    const base64Data = reader.result.split(',')[1];
                    await api.post('/api/media/upload', { fileName: file.name, fileData: base64Data, fileType: fileType });
                    fetchMedia();
                } catch (error) {
                    alert('Falha no upload: ' + (error.response?.data?.message || error.message));
                } finally {
                    setIsUploading(false);
                }
            };
        };
        const handleDelete = async (id) => { if (confirm('Tem a certeza?')) { try { await api.delete(`/api/media/${id}`); fetchMedia(); } catch(e) { alert('Erro ao excluir.'); }}};
        return (
            <div style={{ padding: '2rem 3rem', height: '100%', overflowY: 'auto' }}>
                <div className="page-header">
                    <h2>Biblioteca de M√≠dia</h2>
                    <label className={`btn btn-primary ${isUploading ? 'disabled' : ''}`}>
                        {isUploading ? 'A carregar...' : '+ Carregar M√≠dia'}
                        <input type="file" hidden onChange={handleFileChange} disabled={isUploading} accept="image/*,video/*,audio/*" />
                    </label>
                </div>
                <div className="grid">
                    {media.map(item => (
                        <div key={item.id} className="bot-card">
                             {item.thumbnail_file_id || item.file_type === 'image' ? (
                                <img src={`${API_BASE_URL}/media/preview/storage/${item.thumbnail_file_id || item.file_id}`} className="media-preview" alt={item.file_name} />
                             ) : item.file_type === 'video' ? (
                                <div className="media-preview" style={{display: 'flex', alignItems: 'center', justifyContent: 'center'}}>{Icons.video}</div>
                             ) : (
                                <div className="media-preview" style={{display: 'flex', alignItems: 'center', justifyContent: 'center'}}>{Icons.audio}</div>
                             )}
                             <h3 style={{fontSize: '1.1rem', marginBottom: '0.5rem'}}>{item.file_name}</h3>
                             <p style={{color: 'var(--text-secondary)', fontSize: '0.8rem', wordBreak: 'break-all', flexGrow: 1, marginBottom: '1rem'}}>File ID: {item.file_id}</p>
                             <button className="btn btn-danger btn-sm" onClick={() => handleDelete(item.id)}>Excluir</button>
                        </div>
                    ))}
                </div>
                {media.length === 0 && !isUploading && <p style={{color: 'var(--text-secondary)'}}>A sua biblioteca est√° vazia.</p>}
            </div>
        );
    }
    
    function ContactsPage({ bots }) {
        const [selectedBotId, setSelectedBotId] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const [inactiveContacts, setInactiveContacts] = useState(null);
        
        useEffect(() => {
            if (bots.length > 0 && !selectedBotId) {
                setSelectedBotId(bots[0].id);
            }
        }, [bots]);

        const handleValidate = async () => {
            if (!selectedBotId) {
                alert('Por favor, selecione um bot.');
                return;
            }
            setIsLoading(true);
            setInactiveContacts(null);
            try {
                const response = await api.post('/api/bots/validate-contacts', { botId: selectedBotId });
                setInactiveContacts(response.data.inactive_contacts);
                 if (response.data.inactive_contacts.length === 0) {
                    alert('Nenhum contato inativo encontrado!');
                }
            } catch (error) {
                alert('Erro ao validar contatos: ' + (error.response?.data?.message || 'Falha na valida√ß√£o.'));
            } finally {
                setIsLoading(false);
            }
        };

        const handleRemove = async () => {
            if (!inactiveContacts || inactiveContacts.length === 0) {
                alert('Nenhum contato inativo para remover.');
                return;
            }
            if (!confirm(`Tem certeza que deseja remover ${inactiveContacts.length} contato(s) inativo(s)? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                return;
            }
            setIsLoading(true);
            try {
                const chatIds = inactiveContacts.map(c => c.chat_id);
                const response = await api.post('/api/bots/remove-contacts', { botId: selectedBotId, chatIds });
                alert(response.data.message);
                setInactiveContacts([]);
            } catch (error) {
                alert('Erro ao remover contatos: ' + (error.response?.data?.message || 'Falha na remo√ß√£o.'));
            } finally {
                setIsLoading(false);
            }
        };


        return (
            <div style={{ padding: '2rem 3rem', height: '100%', overflowY: 'auto' }}>
                <div className="page-header"><h2>Higieniza√ß√£o de Contatos</h2></div>
                <div className="card" style={{ maxWidth: '700px', margin: '0 auto' }}>
                    <p style={{color: 'var(--text-secondary)', marginBottom: '1.5rem', fontSize: '0.9rem'}}>
                        Use esta ferramenta para verificar quais contatos bloquearam seu bot e remov√™-los da sua base. Isso garante que seus disparos tenham uma melhor entrega e performance.
                    </p>
                    <div className="form-group" style={{maxWidth: '400px', marginBottom: '2rem'}}>
                        <label htmlFor="botSelect">Selecione um Bot</label>
                        <select id="botSelect" className="form-select" value={selectedBotId} onChange={e => { setSelectedBotId(e.target.value); setInactiveContacts(null); }}>
                            <option value="">-- Selecione --</option>
                            {bots.map(b => <option key={b.id} value={b.id}>{b.bot_name}</option>)}
                        </select>
                    </div>
                    <button className="btn btn-primary" onClick={handleValidate} disabled={isLoading || !selectedBotId}>
                        {isLoading ? 'Validando...' : 'Validar Contatos Ativos'}
                    </button>
                    
                    {inactiveContacts && (
                        <div style={{marginTop: '2rem'}}>
                            <h3>Contatos Inativos Encontrados: {inactiveContacts.length}</h3>
                            {inactiveContacts.length > 0 ? (
                                <>
                                    <ul style={{listStyle: 'none', maxHeight: '300px', overflowY: 'auto', background: 'var(--bg-primary)', padding: '1rem', borderRadius: '8px', margin: '1rem 0'}}>
                                        {inactiveContacts.map(c => (
                                            <li key={c.chat_id} style={{padding: '0.5rem', borderBottom: '1px solid var(--border-color)'}}>
                                                {c.first_name || ''} {c.last_name || ''} ({c.username ? `@${c.username}`: c.chat_id})
                                            </li>
                                        ))}
                                    </ul>
                                    <button className="btn btn-danger" onClick={handleRemove} disabled={isLoading}>
                                        {isLoading ? 'Removendo...' : `Remover ${inactiveContacts.length} Contato(s)`}
                                    </button>
                                </>
                            ) : (
                                <p style={{color: 'var(--text-secondary)', marginTop: '1rem'}}>√ìtima not√≠cia! Nenhum contato inativo foi encontrado para este bot.</p>
                            )}
                        </div>
                    )}
                </div>
            </div>
        );
    }
    
    function MediaLibraryModal({ onSelect, onClose }) {
        const [media, setMedia] = useState([]);
        useEffect(() => { api.get('/api/media').then(res => setMedia(res.data)); }, []);
        return (
            <div className="login-overlay" style={{zIndex: 1000}}>
                <div className="login-box" style={{width: '80vw', maxWidth: '900px', height: '80vh', display: 'flex', flexDirection: 'column'}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem'}}>
                        <h2>Selecionar M√≠dia</h2>
                        <button onClick={onClose} style={{background: 'none', border: 'none', color: 'white', fontSize: '1.5rem', cursor: 'pointer'}}>&times;</button>
                    </div>
                    <div className="grid" style={{overflowY: 'auto', flex: 1, padding: '1rem'}}>
                        {media.map(item => (
                            <div key={item.id} className="bot-card" onClick={() => onSelect(item)} style={{cursor: 'pointer'}}>
                                {item.thumbnail_file_id || item.file_type === 'image' ? (
                                    <img src={`${API_BASE_URL}/media/preview/storage/${item.thumbnail_file_id || item.file_id}`} className="media-preview" alt={item.file_name} />
                                 ) : item.file_type === 'video' ? (
                                    <div className="media-preview" style={{display: 'flex', alignItems: 'center', justifyContent: 'center'}}>{Icons.video}</div>
                                 ) : (
                                    <div className="media-preview" style={{display: 'flex', alignItems: 'center', justifyContent: 'center'}}>{Icons.audio}</div>
                                 )}
                                <div className="bot-card-header" style={{padding: 0, marginBottom: 0}}><h3 style={{fontSize: '1.1rem'}}>{item.file_name}</h3></div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );
    }
    
    const initialNodes = [{ id: 'start', type: 'trigger', position: { x: 250, y: 50 }, data: {}, deletable: false }];
    
    const CustomNode = ({ id, type, data, isConnectable }) => {
        const nodeInfo = {
            trigger: { icon: 'üöÄ', name: 'Gatilho Inicial', content: 'In√≠cio do fluxo com click_id.' },
            message: { icon: 'üí¨', name: 'Enviar Mensagem', content: data.text ? `"${data.text.substring(0, 50)}..."` : 'Configure o texto.' },
            image: { icon: 'üñºÔ∏è', name: 'Enviar Imagem', content: data.imageUrl ? 'Configurado.' : 'Configure.' },
            video: { icon: 'üé¨', name: 'Enviar V√≠deo', content: data.videoUrl ? 'Configurado.' : 'Configure.' },
            audio: { icon: 'üéµ', name: 'Enviar √Åudio', content: data.audioUrl ? 'Configurado.' : 'Configure.' },
            delay: { icon: '‚è±Ô∏è', name: 'Atraso', content: `Aguardar por ${data.delayInSeconds || 1}s.` },
            typing_action: { icon: '‚úçÔ∏è', name: 'A√ß√£o de Digitando', content: `Simular por ${data.durationInSeconds || 1}s.` },
            action_pix: { icon: 'üí≥', name: 'Gerar PIX', content: `Valor: R$ ${((data.valueInCents || 0) / 100).toFixed(2)}.` },
            action_check_pix: { icon: 'üîç', name: 'Consultar PIX', content: 'Verifica se o PIX foi pago.' },
            forward_flow: { icon: '‚Ü™Ô∏è', name: 'Encaminhar Fluxo', content: data.targetFlowName || 'Selecione um fluxo.' },
        };
        const info = nodeInfo[type] || { icon: '‚ùì', name: 'N√≥' };

        return (
            <>
                {type !== 'trigger' && <Handle type="target" position={Position.Top} isConnectable={isConnectable} />}
                <div className={`node-header react-flow__node-${type}`}>{info.icon} {info.name}</div>
                <div className="node-content">{info.content}</div>
                
                {type === 'trigger' && <Handle type="source" position={Position.Bottom} id="a" isConnectable={isConnectable} />}
                
                {type === 'message' && !data.waitForReply && <Handle type="source" position={Position.Bottom} id="a" isConnectable={isConnectable} />}
                {type === 'message' && data.waitForReply && (
                    <>
                        <div className="handle-label" style={{ left: '25%', transform: 'translateX(-50%)' }}>Com Resp.</div>
                        <Handle type="source" position={Position.Bottom} id="a" style={{ left: '25%' }} isConnectable={isConnectable} />
                        <div className="handle-label" style={{ left: '75%', transform: 'translateX(-50%)' }}>Sem Resp.</div>
                        <Handle type="source" position={Position.Bottom} id="b" style={{ left: '75%' }} isConnectable={isConnectable} />
                    </>
                )}
                {type === 'action_check_pix' && (
                    <>
                        <div className="handle-label" style={{ left: '25%', transform: 'translateX(-50%)' }}>Pago</div>
                        <Handle type="source" position={Position.Bottom} id="a" style={{ left: '25%' }} isConnectable={isConnectable} />
                        <div className="handle-label" style={{ left: '75%', transform: 'translateX(-50%)' }}>Pendente</div>
                        <Handle type="source" position={Position.Bottom} id="b" style={{ left: '75%' }} isConnectable={isConnectable} />
                    </>
                )}
                {['delay', 'typing_action', 'action_pix', 'image', 'video', 'audio', 'forward_flow'].includes(type) && <Handle type="source" position={Position.Bottom} id="a" isConnectable={isConnectable} />}
            </>
        );
    };

    const nodeTypes = { trigger: CustomNode, message: CustomNode, image: CustomNode, video: CustomNode, audio: CustomNode, delay: CustomNode, typing_action: CustomNode, action_pix: CustomNode, action_check_pix: CustomNode, forward_flow: CustomNode };

    function EditorPanel({ selectedNode, setNodes, setEdges, setSelectedNode, availableFlows, openMediaLibrary }) {
        const [nodeData, setNodeData] = useState(selectedNode.data || {});
        const textAreaRef = useRef(null);
        
        useEffect(() => { setNodeData(selectedNode.data || {}) }, [selectedNode]);

        const handleChange = (e) => {
            const { name, value, type, checked } = e.target;
            const finalValue = type === 'checkbox' ? checked : value;
            const newData = { ...nodeData, [name]: finalValue };

            if (name === "targetFlowId") {
                const selectedFlow = availableFlows.find(f => f.id == finalValue);
                newData.targetFlowName = selectedFlow ? selectedFlow.name : '';
            }

            setNodeData(newData);
            setNodes(nds => nds.map(n => n.id === selectedNode.id ? { ...n, data: newData } : n));
        };
        
        const onDelete = () => {
            setNodes(nds => nds.filter(n => n.id !== selectedNode.id));
            setEdges(eds => eds.filter(e => e.source !== selectedNode.id && e.target !== selectedNode.id));
            setSelectedNode(null);
        };

        const insertVariable = (variable) => {
            const textarea = textAreaRef.current;
            if (!textarea) return;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const newText = text.substring(0, start) + `{{${variable}}}` + text.substring(end);
            handleChange({ target: { name: 'text', value: newText }});
            setTimeout(() => {
                textarea.selectionStart = textarea.selectionEnd = start + variable.length + 4;
                textarea.focus();
            }, 0);
        };

        const renderPanel = () => {
            switch (selectedNode.type) {
                case 'message': return (<>
                    <div className="form-group"><label>Texto</label><textarea ref={textAreaRef} name="text" className="form-textarea" rows="5" value={nodeData.text || ''} onChange={handleChange} /></div>
                    <div><label style={{fontSize: '0.8rem', color: 'var(--text-secondary)'}}>Inserir vari√°vel:</label><div style={{marginTop: '0.5rem', marginBottom: '1rem'}}><button className="variable-btn" onClick={() => insertVariable('primeiro_nome')}>Nome</button><button className="variable-btn" onClick={() => insertVariable('nome_completo')}>Nome Completo</button><button className="variable-btn" onClick={() => insertVariable('cidade')}>Cidade</button></div></div>
                    <hr style={{border: 'none', borderTop: '1px solid #e9ecef', margin: '1rem 0'}} />
                    <div className="form-group"><label>Bot√£o (Opcional)</label><input name="buttonText" type="text" className="form-input" value={nodeData.buttonText || ''} onChange={handleChange} placeholder="Texto do Bot√£o"/><input name="buttonUrl" type="url" className="form-input" value={nodeData.buttonUrl || ''} onChange={handleChange} placeholder="URL do Bot√£o" style={{marginTop: '0.5rem'}}/></div>
                    <hr style={{border: 'none', borderTop: '1px solid #e9ecef', margin: '1rem 0'}} />
                    <div className="form-group"><label><input name="addTypingAction" type="checkbox" checked={!!nodeData.addTypingAction} onChange={handleChange} /> Adicionar "Digitando" antes</label></div>
                    {nodeData.addTypingAction && (<div className="form-group"><label>Dura√ß√£o do "Digitando..." (s)</label><input name="typingDuration" type="number" className="form-input" value={nodeData.typingDuration || 2} onChange={handleChange} /></div>)}
                    <hr style={{border: 'none', borderTop: '1px solid #e9ecef', margin: '1rem 0'}} />
                    <div className="form-group"><label><input name="waitForReply" type="checkbox" checked={!!nodeData.waitForReply} onChange={handleChange} /> Aguardar Resposta</label></div>
                    {nodeData.waitForReply && (<div className="form-group"><label>Tempo de espera (min)</label><input name="replyTimeout" type="number" className="form-input" value={nodeData.replyTimeout || 5} onChange={handleChange} /></div>)}
                </>);
                case 'image': return (<><div className="form-group"><label>File ID ou URL da Imagem</label><input name="imageUrl" type="text" className="form-input" value={nodeData.imageUrl || ''} onChange={handleChange} /></div><button className="btn btn-secondary btn-sm" onClick={() => openMediaLibrary(media => handleChange({target: { name: 'imageUrl', value: media.file_id}}))}>Selecionar da Biblioteca</button><div className="form-group" style={{marginTop: '1rem'}}><label>Legenda</label><textarea name="caption" className="form-textarea" rows="3" value={nodeData.caption || ''} onChange={handleChange} /></div></>);
                case 'video': return (<><div className="form-group"><label>File ID ou URL do V√≠deo</label><input name="videoUrl" type="text" className="form-input" value={nodeData.videoUrl || ''} onChange={handleChange} /></div><button className="btn btn-secondary btn-sm" onClick={() => openMediaLibrary(media => handleChange({target: { name: 'videoUrl', value: media.file_id}}))}>Selecionar da Biblioteca</button><div className="form-group" style={{marginTop: '1rem'}}><label>Legenda</label><textarea name="caption" className="form-textarea" rows="3" value={nodeData.caption || ''} onChange={handleChange} /></div></>);
                case 'audio': return (<><div className="form-group"><label>File ID ou URL do √Åudio</label><input name="audioUrl" type="text" className="form-input" value={nodeData.audioUrl || ''} onChange={handleChange} /></div><button className="btn btn-secondary btn-sm" onClick={() => openMediaLibrary(media => handleChange({target: { name: 'audioUrl', value: media.file_id}}))}>Selecionar da Biblioteca</button><div className="form-group" style={{marginTop: '1rem'}}><label>Dura√ß√£o do √°udio (em segundos)</label><p style={{fontSize: '0.8rem', color: 'var(--text-secondary)'}}>Define por quanto tempo a a√ß√£o "gravando √°udio" ser√° exibida.</p><input name="durationInSeconds" type="number" className="form-input" value={nodeData.durationInSeconds || 0} onChange={handleChange} /></div></>);
                case 'delay': return (<div className="form-group"><label>Aguardar por (segundos)</label><input name="delayInSeconds" type="number" className="form-input" value={nodeData.delayInSeconds || 1} onChange={handleChange} /></div>);
                case 'typing_action': return (<div className="form-group"><label>Dura√ß√£o do "Digitando..." (em segundos)</label><input name="durationInSeconds" type="number" className="form-input" value={nodeData.durationInSeconds || 1} onChange={handleChange} /></div>);
                case 'action_pix': return (<><div className="form-group"><label>Valor (centavos)</label><input name="valueInCents" type="number" className="form-input" value={nodeData.valueInCents || 0} onChange={handleChange} /></div><div className="form-group"><label>Texto da Mensagem do PIX</label><textarea name="pixMessageText" className="form-textarea" rows="4" value={nodeData.pixMessageText || ''} onChange={handleChange} placeholder="Ex: PIX Gerado! Copie o c√≥digo abaixo..." /></div></>);
                case 'forward_flow': return (<div className="form-group"><label>Encaminhar para o fluxo</label><select name="targetFlowId" className="form-select" value={nodeData.targetFlowId || ''} onChange={handleChange}><option value="">Selecione um fluxo...</option>{availableFlows.map(f => (<option key={f.id} value={f.id}>{f.name}</option>))}</select></div>);
                default: return <p>Sem configura√ß√µes para este n√≥.</p>;
            }
        };

        return (
            <div className="editor-panel">
                <h3 style={{marginBottom: '1.5rem'}}>Editar N√≥</h3>
                {renderPanel()}
                <div style={{marginTop: 'auto'}}>
                    {selectedNode.type !== 'trigger' && <button className="btn btn-danger" style={{width: '100%'}} onClick={onDelete}>Excluir N√≥</button>}
                </div>
            </div>
        );
    }
    
    function FlowEditorPage({ flow, onBack }) {
        const reactFlowWrapper = useRef(null);
        const [nodes, setNodes, onNodesChange] = useNodesState(initialNodes);
        const [edges, setEdges, onEdgesChange] = useEdgesState([]);
        const [selectedNode, setSelectedNode] = useState(null);
        const [reactFlowInstance, setReactFlowInstance] = useState(null);
        const [availableFlows, setAvailableFlows] = useState([]);
        const [isMediaModalOpen, setIsMediaModalOpen] = useState(false);
        const [mediaSelectionCallback, setMediaSelectionCallback] = useState(null);
        
        useEffect(() => {
            if (flow?.nodes) {
                const flowContent = typeof flow.nodes === 'string' ? JSON.parse(flow.nodes) : flow.nodes;
                setNodes(flowContent.nodes || initialNodes);
                setEdges(flowContent.edges || []);
            }
            if(flow?.bot_id) {
                api.get('/api/flows')
                   .then(res => setAvailableFlows(res.data.filter(f => f.bot_id == flow.bot_id && f.id !== flow.id)))
                   .catch(console.error);
            }
        }, [flow]);

        const onNodesDelete = useCallback((deleted) => { setEdges(deleted.reduce((acc, node) => { const connectedEdges = getConnectedEdges([node], acc); return acc.filter((edge) => !connectedEdges.includes(edge)); }, edges)); }, [nodes, edges] );
        const onConnect = useCallback((params) => setEdges((eds) => addEdge({ ...params, type: 'smoothstep', animated: true }, eds)), [setEdges]);
        const onNodeClick = useCallback((_, node) => setSelectedNode(node), []);
        const onPaneClick = useCallback(() => setSelectedNode(null), []);
        const onDragOver = useCallback((event) => { event.preventDefault(); event.dataTransfer.dropEffect = 'move'; }, []);
        const onDrop = useCallback((event) => { event.preventDefault(); const type = event.dataTransfer.getData('application/reactflow'); if (!type) return; const position = reactFlowInstance.project({ x: event.clientX, y: event.clientY }); const newNode = { id: `${type}-${Date.now()}`, type, position, data: {}, }; setNodes((nds) => nds.concat(newNode)); }, [reactFlowInstance] );
        const handleSave = async () => { try { await api.put(`/api/flows/${flow.id}`, { name: flow.name, nodes: JSON.stringify({ nodes, edges }) }); alert("Salvo!"); } catch (e) { alert("Erro ao salvar."); } };
        const onDragStart = (event, nodeType) => event.dataTransfer.setData('application/reactflow', nodeType);
        
        const openMediaLibrary = (callback) => { setMediaSelectionCallback(() => callback); setIsMediaModalOpen(true); };
        const handleSelectMedia = (mediaItem) => { if (mediaSelectionCallback) { mediaSelectionCallback(mediaItem); } setIsMediaModalOpen(false); setMediaSelectionCallback(null); };

        return (
            <div className="flow-editor-page">
                {isMediaModalOpen && <MediaLibraryModal onSelect={handleSelectMedia} onClose={() => setIsMediaModalOpen(false)} />}
                <div className="flow-header"><h3>Editando: {flow.name}</h3><div><button className="btn btn-secondary" onClick={onBack}>Voltar</button><button className="btn btn-primary" onClick={handleSave}>Salvar</button></div></div>
                <div className="flow-editor-container">
                    <div className="flow-sidebar">
                        <h3>Componentes</h3>
                        <div className="node-button" onDragStart={(e) => onDragStart(e, 'message')} draggable>üí¨ Mensagem</div>
                        <div className="node-button" onDragStart={(e) => onDragStart(e, 'image')} draggable>üñºÔ∏è Imagem</div>
                        <div className="node-button" onDragStart={(e) => onDragStart(e, 'video')} draggable>üé¨ V√≠deo</div>
                        <div className="node-button" onDragStart={(e) => onDragStart(e, 'audio')} draggable>üéµ √Åudio</div>
                        <div className="node-button" onDragStart={(e) => onDragStart(e, 'delay')} draggable>‚è±Ô∏è Atraso</div>
                        <h3>A√ß√µes</h3>
                        <div className="node-button" onDragStart={(e) => onDragStart(e, 'typing_action')} draggable>‚úçÔ∏è A√ß√£o de Digitando</div>
                        <div className="node-button" onDragStart={(e) => onDragStart(e, 'action_pix')} draggable>üí≥ Gerar PIX</div>
                        <div className="node-button" onDragStart={(e) => onDragStart(e, 'action_check_pix')} draggable>üîç Consultar PIX</div>
                        <div className="node-button" onDragStart={(e) => onDragStart(e, 'forward_flow')} draggable>‚Ü™Ô∏è Encaminhar Fluxo</div>
                    </div>
                    <div className="reactflow-wrapper" ref={reactFlowWrapper}>
                        <ReactFlowProvider>
                            <ReactFlow nodes={nodes} edges={edges} onNodesChange={onNodesChange} onEdgesChange={onEdgesChange} onConnect={onConnect} onNodeClick={onNodeClick} onPaneClick={onPaneClick} onInit={setReactFlowInstance} onDrop={onDrop} onDragOver={onDragOver} onNodesDelete={onNodesDelete} nodeTypes={nodeTypes} fitView>
                                <Background />
                                <Controls />
                            </ReactFlow>
                        </ReactFlowProvider>
                        {selectedNode && <EditorPanel selectedNode={selectedNode} setNodes={setNodes} setEdges={setEdges} setSelectedNode={setSelectedNode} availableFlows={availableFlows} openMediaLibrary={openMediaLibrary} />}
                    </div>
                </div>
            </div>
        );
    }
    

        // --- FIM DO C√ìDIGO DO HOTBOT PARA COLAR ---

        // Renderiza a aplica√ß√£o React no container
        const root = window.ReactDOM.createRoot(containerElement);
        // Certifique-se de que o nome do componente principal foi renomeado
        root.render(<AppHotBot />); 
        window.hotBotRoot = root; // Guarda a refer√™ncia para poder desmontar
    }
    </script>
</body>
</html>