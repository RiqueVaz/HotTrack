<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HotTracküî•</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/reactflow@11/dist/umd/index.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/dompurify@2.4.0/dist/purify.min.js"></script>
    <link href="https://unpkg.com/reactflow@11/dist/style.css" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* ================================== */
        /* == ESTILOS PRINCIPAIS (HOTTRACK) == */
        /* ================================== */
        :root {
            --bg-primary: #0f172a; /* slate-900 */
            --bg-secondary: #1e293b; /* slate-800 */
            --bg-card: rgba(30, 41, 59, 0.6); /* slate-800 com transpar√™ncia */
            --border-color: #334155; /* slate-700 */
            --accent-primary: #38bdf8; /* sky-400 */
            --accent-secondary: #0ea5e9; /* sky-500 */
            --text-primary: #f1f5f9; /* slate-100 */
            --text-secondary: #94a3b8; /* slate-400 */
            --success: #4ade80; /* green-400 */
            --danger: #f87171; /* red-400 */
            --warning: #facc15; /* yellow-400 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            background-image:
                radial-gradient(circle at 1px 1px, rgba(56, 189, 248, 0.1) 1px, transparent 0),
                radial-gradient(circle at top left, rgba(56, 189, 248, 0.2), transparent 30%),
                radial-gradient(circle at bottom right, rgba(14, 165, 233, 0.2), transparent 40%);
            background-size: 20px 20px, 100% 100%, 100% 100%;
        }

        main#content {
            height: calc(100% - 72px); /* Altura padr√£o para mobile (considerando header) */
        }
        @media (min-width: 768px) { /* md */
            main#content {
                height: 100%; /* Em desktop, o header n√£o afeta a altura */
            }
        }

        .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .form-input, .form-select, .form-date, .form-textarea {
            background-color: rgba(15, 23, 42, 0.7);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: all 0.3s ease;
            border-radius: 0.375rem;
        }

        .form-input:focus, .form-select:focus, .form-date:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2);
        }

        .form-date::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
        }

        .btn {
            background-color: var(--accent-secondary);
            color: white;
            transition: all 0.3s ease;
            border: 1px solid var(--accent-primary);
            box-shadow: 0 0 15px rgba(14, 165, 233, 0.2), inset 0 0 8px rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
            border-radius: 0.375rem;
            font-weight: 600;
        }
        .btn:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 300%;
            height: 300%;
            background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0) 70%);
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.5s ease;
        }
        .btn:hover:before {
            transform: translate(-50%, -50%) scale(1);
        }

        .btn:hover {
            background-color: var(--accent-primary);
            box-shadow: 0 0 25px rgba(56, 189, 248, 0.5);
            transform: translateY(-2px);
        }
        .btn:disabled { background-color: #334155; cursor: not-allowed; transform: none; box-shadow: none; color: #64748b; }

        .btn-red { background-color: #991b1b; border-color: #ef4444; box-shadow: 0 0 15px rgba(239, 68, 68, 0.2); }
        .btn-red:hover { background-color: #b91c1c; box-shadow: 0 0 25px rgba(239, 68, 68, 0.5); }
        .btn-green { background-color: #047857; border-color: #10b981; box-shadow: 0 0 15px rgba(16, 185, 129, 0.2); }
        .btn-green:hover { background-color: #059669; box-shadow: 0 0 25px rgba(16, 185, 129, 0.5); }
        .btn-secondary { background-color: var(--border-color); border-color: #475569; box-shadow: none; }
        .btn-secondary:hover { background-color: #475569; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); }

        .nav-link {
            color: var(--text-secondary);
            position: relative;
            transition: all 0.3s ease;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            text-decoration: none;
        }
        .nav-link:before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 0;
            width: 4px;
            background-color: var(--accent-primary);
            border-radius: 0 4px 4px 0;
            transition: all 0.3s ease;
        }
        .nav-link:hover {
            background-color: rgba(56, 189, 248, 0.1);
            color: var(--text-primary);
        }
        .nav-link.active {
            background-color: rgba(14, 165, 233, 0.15);
            color: white;
            font-weight: 600;
        }
        .nav-link.active:before {
            height: 60%;
        }

        .modal { display: none; }
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            z-index: 50;
            inset: 0;
            background-color: rgba(15, 23, 42, 0.7);
            backdrop-filter: blur(8px);
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes pulse { 
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        @keyframes shimmer { 
            0% { left: -100%; }
            100% { left: 100%; }
        }
        .animate-fade-in { animation: fadeIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); }
        .table-custom th { color: var(--text-primary); }
        .table-custom th, .table-custom td { padding: 1rem; border-bottom: 1px solid var(--border-color); text-align: left; }
        .table-custom tbody tr:hover { background-color: rgba(30, 41, 59, 0.5); }
        .status-indicator { font-size: 0.75rem; font-weight: 500; padding: 0.25rem 0.6rem; border-radius: 9999px; display: inline-block; margin-left: 0.75rem; vertical-align: middle; }
        .status-indicator.success { background: linear-gradient(to right, rgba(74, 222, 128, 0.1), rgba(16, 185, 129, 0.1)); color: var(--success); border: 1px solid rgba(74, 222, 128, 0.2); }
        .status-indicator.failure { background: linear-gradient(to right, rgba(248, 113, 113, 0.1), rgba(185, 28, 28, 0.1)); color: var(--danger); border: 1px solid rgba(248, 113, 113, 0.2); }
        .status-indicator.unknown { background-color: rgba(100, 116, 139, 0.1); color: #94a3b8; border: 1px solid rgba(100, 116, 139, 0.2); }
        .status-indicator.testing { background: linear-gradient(to right, rgba(56, 189, 248, 0.1), rgba(14, 165, 233, 0.1)); color: #7dd3fc; border: 1px solid rgba(56, 189, 248, 0.2); }
        .tab-button { background-color: transparent; border: 1px solid var(--border-color); color: var(--text-secondary); padding: 0.5rem 1rem; border-radius: 0.375rem; transition: all 0.3s ease; }
        .tab-button:hover { background-color: var(--bg-secondary); color: var(--text-primary); }
        .tab-button.active { background-color: rgba(14, 165, 233, 0.1); border-color: var(--accent-secondary); color: white; font-weight: 600; box-shadow: 0 0 10px rgba(14, 165, 233, 0.2); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease-out; }
        .progress-bar { background-color: #334155; border-radius: 999px; overflow: hidden; height: 8px; }
        .progress-bar-inner { height: 100%; transition: width 0.5s ease; }

        .metric-card {
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
        }
        .metric-card:before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0) 70%);
            transition: transform 0.8s ease;
            transform-origin: center center;
            transform: scale(0);
        }
        .metric-card:hover:before {
            transform: scale(3);
        }
        #app-loader { display: flex; align-items: center; justify-content: center; height: 100vh; font-size: 1.25rem; }

        /* ====================================================================== */
        /* == ESTILOS CORRIGIDOS DO HOTBOT (INTEGRADOS AO HOTTRACK) == */
        /* ====================================================================== */
        
        .hotbot-scope {
            --hotbot-accent: var(--accent-primary); /* #38bdf8 - Azul da aplica√ß√£o principal */
            --hotbot-accent-dark: var(--accent-secondary); /* #0ea5e9 - Azul mais escuro */
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
        }
    
        /* Layout Principal do HotBot com abas horizontais - ESTILOS APLICADOS */
        .hotbot-nav-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }
        
        /* Bot√µes das abas - ESTILOS APLICADOS seguindo o padr√£o pressel */
        .hotbot-scope .nav-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background-color: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            transition: all 0.3s ease;
            font-weight: 500;
            cursor: pointer;
        }
    
        .hotbot-scope .nav-button:hover {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            transform: translateY(-2px);
        }
    
        .hotbot-scope .nav-button.active {
            background-color: rgba(56, 189, 248, 0.15);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            font-weight: 600;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.2);
        }
    
        .hotbot-scope .hotbot-content {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        
        /* Fullscreen flow editor styles */
        .flow-editor-page {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-primary);
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }
        
        .flow-header {
            padding: 1rem 2rem;
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        
        .flow-header h3 {
            margin: 0;
            color: var(--text-primary);
        }
        
        .flow-header .btn {
            margin-left: 0.5rem;
        }
        
        .flow-editor-container {
            display: flex;
            flex: 1;
            height: calc(100% - 60px);
            position: relative;
            overflow: hidden;
        }
        
        .flow-sidebar {
            width: 280px;
            background-color: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 1rem;
            overflow-y: auto;
        }
        
        .flow-sidebar {
            scrollbar-width: thin;
            scrollbar-color: var(--accent-primary) transparent;
        }
        
        /* Webkit browsers (Chrome, Safari, newer Edge) */
        .flow-sidebar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .flow-sidebar::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .flow-sidebar::-webkit-scrollbar-thumb {
            background-color: var(--accent-primary);
            border-radius: 3px;
        }
        
        .flow-sidebar::-webkit-scrollbar-thumb:hover {
            background-color: var(--accent-secondary);
        }
        .flow-sidebar h3 {
            color: var(--text-primary);
            margin-top: 0;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 1.1rem;
        }
        
        .node-button {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: left;
            cursor: grab;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
            color: var(--text-secondary);
            background-color: var(--bg-card);
        }
        
        .node-button:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            background-color: rgba(56, 189, 248, 0.05);
        }
        
        .reactflow-wrapper {
            scrollbar-width: thin;
            scrollbar-color: var(--accent-primary) transparent;
        }
        
        /* Webkit browsers (Chrome, Safari, newer Edge) */
        .reactflow-wrapper::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        .reactflow-wrapper::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .reactflow-wrapper::-webkit-scrollbar-thumb {
            background-color: var(--accent-primary);
            border-radius: 3px;
        }
        
        .reactflow-wrapper::-webkit-scrollbar-thumb:hover {
            background-color: var(--accent-secondary);
        }
        
        .reactflow-wrapper {
            flex: 1;
            background-color: var(--bg-primary);
            position: relative;
        }
        
        .editor-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 300px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.5rem;
            z-index: 10;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        /* Herda os estilos de formul√°rio, mas com foco azul - ESTILOS APLICADOS */
        .hotbot-scope .form-input, 
        .hotbot-scope .form-select, 
        .hotbot-scope .form-textarea {
            background-color: rgba(15, 23, 42, 0.7);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            transition: all 0.3s ease;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
        }
    
        .hotbot-scope .form-input:focus, 
        .hotbot-scope .form-select:focus, 
        .hotbot-scope .form-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2);
        }
    
        .hotbot-scope .form-textarea {
            min-height: 100px;
            resize: vertical;
        }
    
        /* Bot√µes - ESTILOS APLICADOS seguindo o padr√£o pressel */
        .hotbot-scope .btn {
            background-color: var(--accent-primary);
            color: white;
            border: 1px solid var(--accent-primary);
            transition: all 0.3s ease;
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.2);
        }
    
        .hotbot-scope .btn:hover {
            background-color: var(--accent-secondary);
            transform: translateY(-2px);
            box-shadow: 0 0 25px rgba(56, 189, 248, 0.4);
        }
    
        .hotbot-scope .btn:disabled {
            background-color: #334155;
            border-color: #475569;
            color: #64748b;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
    
        .hotbot-scope .btn-primary {
            background-color: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }
    
        .hotbot-scope .btn-primary:hover {
            background-color: var(--accent-secondary);
        }
    
        .hotbot-scope .btn-secondary {
            background-color: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--border-color);
            box-shadow: 0 0 10px rgba(30, 41, 59, 0.3);
        }
    
        .hotbot-scope .btn-secondary:hover {
            background-color: #334155;
            border-color: #475569;
        }
    
        .hotbot-scope .btn-red {
            background-color: #991b1b;
            border-color: #ef4444;
            color: white;
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.2);
        }
    
        .hotbot-scope .btn-red:hover {
            background-color: #b91c1c;
            box-shadow: 0 0 25px rgba(239, 68, 68, 0.4);
        }
    
        .hotbot-scope .btn-green {
            background-color: #047857;
            border-color: #10b981;
            color: white;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.2);
        }
    
        .hotbot-scope .btn-green:hover {
            background-color: #059669;
            box-shadow: 0 0 25px rgba(16, 185, 129, 0.4);
        }
    
        .hotbot-scope .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }
    
        /* Cart√µes - ESTILOS APLICADOS seguindo o padr√£o pressel */
        .hotbot-scope .card {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            border-radius: 0.75rem;
            padding: 1.5rem;
        }
    
        .hotbot-scope .bot-card {
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            padding: 1.5rem;
            transition: all 0.3s ease;
            height: fit-content;
        }
    
        .hotbot-scope .bot-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 40px 0 rgba(0, 0, 0, 0.45);
        }
    
        /* Grid layout - ESTILOS APLICADOS */
        .hotbot-scope .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
    
        /* Headers de p√°gina - ESTILOS APLICADOS */
        .hotbot-scope .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 0 0.5rem;
        }
    
        .hotbot-scope .page-header h2 {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }
    
        /* Form groups - ESTILOS APLICADOS */
        .hotbot-scope .form-group {
            margin-bottom: 1.5rem;
        }
    
        .hotbot-scope .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.875rem;
        }
    
        /* Ajustes espec√≠ficos para Disparos Page - ESPA√áAMENTOS APLICADOS */
        .hotbot-scope .disparos-container {
            padding: 1.5rem;
        }
    
        .hotbot-scope .tabs-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
        }
        
        .hotbot-scope .tabs-container button {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
            transition: all 0.2s;
        }
        
        .hotbot-scope .tabs-container button:hover {
            color: var(--text-primary);
        }
        
        .hotbot-scope .tabs-container button.active {
            color: var(--accent-primary);
            border-bottom-color: var(--accent-primary);
            font-weight: 600;
        }
    
        .hotbot-scope .step-actions-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
    
        .hotbot-scope .campaign-info-card {
            margin-bottom: 2rem;
        }
    
        .hotbot-scope .flow-steps-container {
            margin-bottom: 2rem;
        }
    
        /* Ajustes para bot√µes de vari√°veis - ESTILOS APLICADOS */
        .hotbot-scope .variable-btn {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
    
        .hotbot-scope .variable-btn:hover {
            background-color: rgba(56, 189, 248, 0.1);
            color: var(--accent-primary);
            border-color: var(--accent-primary);
        }
    
        /* Ajustes para checkboxes - ESTILOS APLICADOS */
        .hotbot-scope .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
    
        .hotbot-scope .checkbox-group input[type="checkbox"] {
            width: 1rem;
            height: 1rem;
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
        }
    
        .hotbot-scope .checkbox-group label {
            margin-bottom: 0;
            cursor: pointer;
        }
    
        /* --- ESTILOS DO EDITOR DE FLUXOS (TEMA ESCURO) --- */
        .hotbot-scope .flow-editor-page { display: flex; flex-direction: column; height: 100%; background-color: transparent; color: var(--text-primary); }
        .hotbot-scope .flow-editor-container { flex: 1; display: flex; overflow: hidden; border: 1px solid var(--border-color); border-radius: 0.75rem; position: relative; }
        .hotbot-scope .reactflow-wrapper { flex-grow: 1; position: relative; background-color: var(--bg-primary); background-image: radial-gradient(var(--border-color) 1px, transparent 1px); background-size: 2rem 2rem; }
        
        .hotbot-scope .flow-header { padding: 1rem 1.5rem; background-color: var(--bg-secondary); display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); }
        .hotbot-scope .flow-header h3 { font-size: 1.2rem; font-weight: 700; color: var(--text-primary); margin:0; }
        .hotbot-scope .flow-header div { display: flex; gap: 0.75rem; }
        
        .hotbot-scope .flow-sidebar { width: 280px; background-color: var(--bg-secondary); border-right: 1px solid var(--border-color); padding: 1rem; overflow-y: auto; }
        .hotbot-scope .flow-sidebar h3 { margin-top: 0; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 1px solid var(--border-color); font-size: 1.1rem; }
    
        .hotbot-scope .node-button { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; border-radius: 8px; border: 1px solid var(--border-color); text-align: left; cursor: grab; margin-bottom: 0.75rem; transition: all 0.2s; color: var(--text-secondary); }
        .hotbot-scope .node-button:hover { border-color: var(--accent-primary); color: var(--accent-primary); background-color: rgba(56, 189, 248, 0.05); }
    
        .hotbot-scope .node-editor-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .hotbot-scope .node-editor-modal {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .hotbot-scope .node-editor-modal-header {
            padding: 0.7rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        
        .hotbot-scope .node-editor-modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--text-primary);
        }
        
        .hotbot-scope .node-editor-modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .hotbot-scope .node-editor-modal-close:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        
        .hotbot-scope .node-editor-modal-content {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-primary) transparent;
        }
        
        .hotbot-scope .node-editor-modal-footer {
            padding: 0.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 0.75rem;
            justify-content: space-between;
            flex-shrink: 0;
        }
        
        .hotbot-scope .add-node-fab {
            position: fixed;
            top: 6rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: white;
            font-size: 2rem;
            font-weight: 300;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(56, 189, 248, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: all 0.3s ease;
        }
        
        .hotbot-scope .add-node-fab:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(56, 189, 248, 0.6);
        }
        
        .hotbot-scope .add-node-fab:active {
            transform: scale(0.95);
        }
        
        .hotbot-scope .node-selector-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            z-index: 1500;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .hotbot-scope .node-selector-modal {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .hotbot-scope .node-selector-modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .hotbot-scope .node-selector-modal-header h3 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--text-primary);
        }
        
        .hotbot-scope .node-selector-modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .hotbot-scope .node-selector-modal-close:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }
        
        .hotbot-scope .node-selector-modal-content {
            padding: 1.5rem;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .hotbot-scope .node-selector-button {
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
        }
        
        .hotbot-scope .node-selector-button:hover {
            border-color: var(--accent-primary);
            background-color: rgba(56, 189, 248, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(56, 189, 248, 0.2);
        }
        
        .hotbot-scope .node-selector-button-icon {
            font-size: 1.5rem;
        }
        
        .hotbot-scope .action-drag-handle {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            cursor: grab;
            color: var(--text-secondary);
            font-size: 1.2rem;
            user-select: none;
            z-index: 1;
            padding: 0.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .hotbot-scope .action-drag-handle:active {
            cursor: grabbing;
        }
        
        .hotbot-scope .action-item {
            position: relative;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background-color: rgba(0,0,0,0.2);
            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
        }
        
        .hotbot-scope .action-item.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }
        
        .hotbot-scope .action-item.drag-over {
            border-color: var(--accent-primary);
            box-shadow: 0 0 10px rgba(56, 189, 248, 0.3);
        }
        
        /* Estilos dos N√≥s do ReactFlow */
        .hotbot-scope .react-flow__node { background-color: var(--bg-card); border: 1px solid var(--border-color); border-radius: 8px; padding: 0; width: 280px; font-family: 'Inter', sans-serif; box-shadow: 0 4px 10px rgba(0,0,0,0.2); color: var(--text-secondary); }
        .hotbot-scope .react-flow__node.selected { border: 2px solid var(--accent-primary); box-shadow: 0 0 20px rgba(56, 189, 248, 0.3); }
        
        .hotbot-scope .action-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.25rem 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .hotbot-scope .node-header { 
            display: flex; 
            align-items: center; 
            justify-content: center;
            gap: 0.5rem; 
            font-weight: 600; 
            padding: 1rem 1rem 0.75rem; 
            border-bottom: 1px solid var(--border-color); 
            color: var(--text-primary);
            position: relative;
            margin-top: 8px;
        }

        /* Adicione estas regras ap√≥s as regras existentes do .node-header */
.hotbot-scope .node-header {
    border-top-left-radius: 8px;
    border-top-right-radius: 8px;
    padding: 0.25rem 0.5rem;
}

        /* Badge de contagem de execu√ß√µes do node */
        .hotbot-scope .node-execution-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: linear-gradient(135deg, #4c4d50, #2563eb);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 12px;
            z-index: 10;
            min-width: 24px;
            text-align: center;
            line-height: 1.2;
            border: 2px solid var(--bg-primary);
        }
        
        .hotbot-scope .node-execution-badge:hover {
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            
            transform: scale(1.05);
            transition: all 0.2s ease;
        }

/* Cores espec√≠ficas para cada tipo de a√ß√£o */
.hotbot-scope .node-header.react-flow__node-message {
    background-color: rgba(184, 204, 238, 0.1);
    
}

.hotbot-scope .node-header.react-flow__node-image,
.hotbot-scope .node-header.react-flow__node-video,
.hotbot-scope .node-header.react-flow__node-audio {
    background-color: rgba(78, 49, 176, 0.1);
    
}

.hotbot-scope .node-header.react-flow__node-typing_action {
    background-color: rgba(148, 104, 28, 0.1);
    
}

.hotbot-scope .node-header.react-flow__node-action_pix {
    background-color: rgba(34, 197, 94, 0.1);
    
}

.hotbot-scope .node-header.react-flow__node-action_check_pix {
    background-color: rgba(120, 53, 15, 0.1);
    
}

.hotbot-scope .node-header.react-flow__node-forward_flow {
    background-color: rgba(214, 76, 242, 0.1);
    
}

.hotbot-scope .node-header.react-flow__node-delay {
    background-color: rgba(239, 68, 68, 0.2);  /* Aumentei a opacidade para 0.2 */
      /* Deixa o texto um pouco mais escuro */
}

        .hotbot-scope .node-actions {
            position: absolute;
            top: -4rem;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 6px;
            background: var(--bg-card);
            border-radius: 20px;
            padding: 0.5rem 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }
        
        .hotbot-scope .react-flow__node:hover .node-actions {
            opacity: 1;
            visibility: visible;
        }
        
        .hotbot-scope .node-action-btn {
            width: 2rem;
            height: 2rem;
            border-radius: 20%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #475569;
            cursor: pointer;
            font-size: 12px;
            padding: 0;
            transition: all 0.2s ease;
        }
        
        .hotbot-scope .node-action-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .hotbot-scope .node-action-btn.delete {
            border-color: #fecaca;
            color: #ef4444;
        }
        
        .hotbot-scope .node-action-btn.delete:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .hotbot-scope .node-content { padding: 1rem; font-size: 0.9rem; }
        .hotbot-scope .react-flow__handle { width: 12px; height: 12px; background-color: var(--bg-secondary); border: 2px solid var(--border-color); }
        .hotbot-scope .react-flow__handle:hover { border-color: var(--accent-primary); }
        .hotbot-scope .handle-label { position: absolute; bottom: -20px; font-size: 10px; color: var(--text-secondary); }
        /* Cores dos Headers dos N√≥s */
        .hotbot-scope .react-flow__node-trigger .node-header { background-color: rgba(139, 92, 246, 0.1); }
        .hotbot-scope .react-flow__node-message .node-header { background-color: rgba(59, 130, 246, 0.1); }
        .hotbot-scope .react-flow__node-image .node-header,
        .hotbot-scope .react-flow__node-video .node-header,
        .hotbot-scope .react-flow__node-audio .node-header { background-color: rgba(217, 70, 239, 0.1); }
        .hotbot-scope .react-flow__node-delay .node-header,
        .hotbot-scope .react-flow__node-typing_action .node-header { background-color: rgba(245, 158, 11, 0.1); }
        .hotbot-scope .react-flow__node-action_pix .node-header { background-color: rgba(34, 197, 94, 0.1); }
        .hotbot-scope .react-flow__node-action_check_pix .node-header { background-color: rgba(249, 115, 22, 0.1); }
        .hotbot-scope .react-flow__node-forward_flow .node-header { background-color: rgba(99, 102, 241, 0.1); }
    
        /* Estilos do Live Chat */
        .hotbot-scope .chat-container { display: grid; grid-template-columns: 300px 1fr 320px; height: calc(100% - 78px); border: 1px solid var(--border-color); border-radius: 0.75rem; background-color: var(--bg-secondary); overflow: auto; }
        .hotbot-scope .conversations-panel { display: flex; flex-direction: column; border-right: 1px solid var(--border-color); }
        .hotbot-scope .conversations-header { padding: 1rem; border-bottom: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 0.75rem; }
        .hotbot-scope .conversations-list { 
            overflow-y: auto; 
            flex: 1; 
            max-height: calc(100vh - 12rem);
            scrollbar-width: thin;
            scrollbar-color: var(--accent-primary) transparent;
        }
        .hotbot-scope .conversations-list::-webkit-scrollbar { width: 6px; }
        .hotbot-scope .conversations-list::-webkit-scrollbar-track { background: transparent; }
        .hotbot-scope .conversations-list::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 3px; }
        .hotbot-scope .conversations-list::-webkit-scrollbar-thumb:hover { background: var(--accent-secondary); }
        .hotbot-scope .conversation-item { padding: 1rem; border-bottom: 1px solid var(--border-color); cursor: pointer; transition: background-color 0.2s; }
        .hotbot-scope .conversation-item:hover { background-color: var(--bg-primary); }
        .hotbot-scope .conversation-item.active { background-color: rgba(56, 189, 248, 0.1); border-left: 3px solid var(--accent-primary); }
        .hotbot-scope .conversation-item-name { font-weight: 600; color: var(--text-primary); }
        .hotbot-scope .conversation-item-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 0.75rem; }
        .hotbot-scope .conversation-item-time { font-size: 0.75rem; color: var(--text-secondary); white-space: nowrap; }
        .hotbot-scope .conversation-item-preview { font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .hotbot-scope .conversation-item-tags { display: flex; flex-wrap: wrap; gap: 0.35rem; margin-top: 0.5rem; }
        .hotbot-scope .chat-header-main { display: flex; flex-direction: column; gap: 0.5rem; }
        .hotbot-scope .chat-header-tags { display: flex; flex-wrap: wrap; gap: 0.4rem; }
        .hotbot-scope .chat-header-actions { display: flex; align-items: center; gap: 0.5rem; }
        .hotbot-scope .tag-badge {     display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.15rem 0.25rem;
            border-radius: 999px;
            font-size: 0.55rem;
            font-weight: 600;
            background: rgba(59, 130, 246, 0.1);
            color: #2563EB;
            border: 1px solid transparent;
            text-transform: uppercase; letter-spacing: 0.02em; }
        .hotbot-scope .tag-badge--auto { background: rgba(34, 197, 94, 0.12); color: #15803D; border-color: rgba(34, 197, 94, 0.35); }
        .hotbot-scope .tag-actions { display: flex; flex-direction: column; gap: 0.5rem; margin-top: 0.75rem; align-items: flex-start; }
        .hotbot-scope .tag-filter-container { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
        .hotbot-scope .tag-filter-label { font-size: 0.75rem; color: var(--text-secondary); }
        .hotbot-scope .tag-filter-chip { border: 1px solid var(--border-color); background: transparent; color: var(--text-secondary); padding: 0.25rem 0.6rem; border-radius: 999px; font-size: 0.7rem; cursor: pointer; transition: all 0.2s ease; }
        .hotbot-scope .tag-filter-chip.auto { border-color: rgba(34, 197, 94, 0.35); color: #15803D; }
        .hotbot-scope .tag-filter-chip.active { background: var(--accent-primary); color: #ffffff !important; border-color: var(--accent-primary); }
        .hotbot-scope .tag-manager-backdrop { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.55); display: flex; align-items: center; justify-content: center; z-index: 1100; }
        .hotbot-scope .tag-manager-modal { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1.5rem; width: min(420px, 90%); box-shadow: 0 20px 40px rgba(15,23,42,0.35); display: flex; flex-direction: column; gap: 1rem; }
        .hotbot-scope .tag-manager-header { display: flex; align-items: center; justify-content: space-between; }
        .hotbot-scope .tag-manager-header h3 { margin: 0; font-size: 1.1rem; }
        .hotbot-scope .tag-manager-header button { background: none; border: none; font-size: 1.5rem; color: var(--text-secondary); cursor: pointer; line-height: 1; }
        .hotbot-scope .tag-manager-form { display: flex; flex-direction: column; gap: 0.75rem; }
        .hotbot-scope .tag-color-picker { display: flex; align-items: center; gap: 0.75rem; }
        .hotbot-scope .tag-color-picker input[type="color"] { width: 42px; height: 32px; border: none; padding: 0; background: transparent; cursor: pointer; }
        .hotbot-scope .tag-error { color: #f87171; font-size: 0.8rem; margin: 0; }
        .hotbot-scope .tag-manager-list { max-height: 180px; overflow-y: auto; display: flex; flex-direction: column; gap: 0.75rem; }
        .hotbot-scope .tag-manager-item { display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
        .hotbot-scope .tag-loading, .hotbot-scope .tag-empty { font-size: 0.85rem; color: var(--text-secondary); margin: 0; }
        .hotbot-scope .tag-context-menu { position: fixed; z-index: 1200; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 0.5rem; box-shadow: 0 20px 40px rgba(15,23,42,0.35); padding: 0.5rem 0; width: 220px; }
        .hotbot-scope .tag-context-title { font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); padding: 0.5rem 1rem; border-bottom: 1px solid var(--border-color); }
        .hotbot-scope .tag-context-item { width: 100%; background: none; border: none; display: flex; align-items: center; gap: 0.5rem; padding: 0.45rem 1rem; font-size: 0.85rem; color: var(--text-primary); cursor: pointer; text-align: left; }
        .hotbot-scope .tag-context-item:hover { background: var(--bg-primary); }
        .hotbot-scope .tag-context-item.active { background: rgba(56, 189, 248, 0.1); }
        .hotbot-scope .tag-color-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; }
        .hotbot-scope .tag-context-check { margin-left: auto; color: var(--accent-primary); font-weight: 700; }
        .hotbot-scope .tag-context-empty { font-size: 0.8rem; color: var(--text-secondary); padding: 0.75rem 1rem; margin: 0; }
        .hotbot-scope .contact-tags { display: flex; flex-wrap: wrap; gap: 0.4rem; }
        
        .hotbot-scope .chat-window { display: flex; flex-direction: column; }
        .hotbot-scope .chat-header { padding: 1rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; }
        .hotbot-scope .chat-header h3 { font-size: 1.1rem; font-weight: 700; margin:0; }
        .hotbot-scope .message-list { 
            flex: 1; 
            overflow-y: auto; 
            padding: 1.5rem; 
            display: flex; 
            flex-direction: column; 
            gap: 1rem;
            max-height: calc(100vh - 16rem);
            scrollbar-width: thin;
            scrollbar-color: var(--accent-primary) transparent;
        }
        .hotbot-scope .message-list::-webkit-scrollbar { width: 6px; }
        .hotbot-scope .message-list::-webkit-scrollbar-track { background: transparent; }
        .hotbot-scope .message-list::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 3px; }
        .hotbot-scope .message-list::-webkit-scrollbar-thumb:hover { background: var(--accent-secondary); }
        .hotbot-scope .message-bubble { max-width: 75%; padding: 0.75rem 1rem; border-radius: 1rem; overflow-wrap: anywhere; word-break: break-word; }
        .hotbot-scope .message-bubble strong { display: block; font-size: 0.8rem; margin-bottom: 0.25rem; }
        .hotbot-scope .message-bubble-time { font-size: 0.7rem; color: var(--text-secondary); text-align: right; margin-top: 0.5rem; }

        .hotbot-scope .message-user { background-color: var(--bg-primary); align-self: flex-start; border-top-left-radius: 0; }
        .hotbot-scope .message-attendant { background-color: #0c4a6e; align-self: flex-end; border-top-right-radius: 0; white-space: pre-wrap; word-break: break-all;}
        .hotbot-scope .message-attendant strong { color: var(--accent-primary); }
        .hotbot-scope .chat-media { max-width: 100%; border-radius: 0.5rem; margin-top: 0.5rem; cursor: pointer; }
        .hotbot-scope .inline-buttons-container { margin-top: 0.75rem; display: flex; flex-direction: column; gap: 0.5rem; }
        .hotbot-scope .inline-buttons-row { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .hotbot-scope .inline-button { display: inline-block; padding: 0.5rem 1rem; background-color: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 0.5rem; font-size: 0.85rem; color: var(--text-primary); }
        .hotbot-scope .inline-button-url { font-size: 0.75rem; color: var(--text-secondary); opacity: 0.7; }
        
        .hotbot-scope .chat-input-area { padding: 1rem; border-top: 1px solid var(--border-color); }
        .hotbot-scope .chat-input-form { display: flex; gap: 0.75rem; }
        .hotbot-scope .attach-btn { background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 0.5rem; color: var(--text-secondary); cursor: pointer; padding: 0.6rem; }
        .hotbot-scope .chat-input { flex: 1; }
        .hotbot-scope .centered-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary); text-align: center; }
        .hotbot-scope .centered-placeholder svg { width: 48px; height: 48px; margin-bottom: 1rem; }
        
        .hotbot-scope .contact-panel { 
            padding: 1.5rem; 
            border-left: 1px solid var(--border-color); 
            overflow-y: auto;
            max-height: calc(100vh - 8.5rem);
            scrollbar-width: thin;
            scrollbar-color: var(--accent-primary) transparent;
        }
        .hotbot-scope .contact-panel::-webkit-scrollbar { width: 6px; }
        .hotbot-scope .contact-panel::-webkit-scrollbar-track { background: transparent; }
        .hotbot-scope .contact-panel::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 3px; }
        .hotbot-scope .contact-panel::-webkit-scrollbar-thumb:hover { background: var(--accent-secondary); }
        .hotbot-scope .contact-panel h3 { font-size: 1.1rem; font-weight: 700; margin-bottom: 1.5rem; }
        .hotbot-scope .contact-detail { margin-bottom: 1rem; }
        .hotbot-scope .contact-detail label { display: block; font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
        .hotbot-scope .contact-detail p { color: var(--text-primary); font-weight: 500; word-break: break-all; }
        
        .hotbot-scope .actions-panel { 
            margin-top: 2rem; 
            padding-top: 2rem; 
            border-top: 1px solid var(--border-color);
            max-height: calc(50vh - 4rem);
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-primary) transparent;
        }
        .hotbot-scope .actions-panel::-webkit-scrollbar { width: 6px; }
        .hotbot-scope .actions-panel::-webkit-scrollbar-track { background: transparent; }
        .hotbot-scope .actions-panel::-webkit-scrollbar-thumb { background: var(--accent-primary); border-radius: 3px; }
        .hotbot-scope .actions-panel::-webkit-scrollbar-thumb:hover { background: var(--accent-secondary); }
        
        /* Outros estilos do HotBot */
        .hotbot-scope .bot-card-header { display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; }
        .hotbot-scope .bot-card-header h3 { font-size: 1.2rem; font-weight: 700; color: var(--text-primary); margin:0; }
        .hotbot-scope .bot-card-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-top: auto; }
        .hotbot-scope .media-preview { width: 100%; height: 150px; object-fit: cover; border-radius: 0.5rem; margin-bottom: 1rem; background-color: var(--bg-primary); }
    
        .hotbot-scope .login-overlay { position: fixed; inset: 0; background-color: rgba(15, 23, 42, 0.7); display: flex; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(8px); }
        .hotbot-scope .login-box { background-color: var(--bg-secondary); padding: 2rem; border-radius: 0.75rem; width: 100%; max-width: 420px; border: 1px solid var(--border-color); }
    

	 .form-checkbox { accent-color: var(--accent-primary); }
        .btn-danger { background-color: #991b1b; }
        .btn-danger:hover { background-color: #b91c1c; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.2); }
        .btn-view { color: var(--text-secondary); }
        .btn-view.active { background-color: var(--accent-secondary); color: white; }

        #preview-wrapper {
            background-color: #fff;
            border-radius: 0.75rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            transition: all 0.3s ease-in-out;
            overflow: hidden;
        }
        #preview-wrapper.mobile { max-width: 375px; height: 667px; border: 8px solid #1e293b; }
        #preview-wrapper.desktop { width: 100%; height: 700px; }
        #preview-content {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: #888 #f1f1f1;
        }
        #preview-content::-webkit-scrollbar { width: 6px; }
        #preview-content::-webkit-scrollbar-track { background: #f1f1f1; }
        #preview-content::-webkit-scrollbar-thumb { background: #888; border-radius: 3px; }
        #preview-content::-webkit-scrollbar-thumb:hover { background: #555; }

        #thankYouCreator #preview-wrapper {
            background-color: var(--bg-secondary);
            border-radius: 0.75rem;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        /* Media queries para responsividade */
        @media (max-width: 768px) {
            .hotbot-nav-bar {
                gap: 0.25rem;
            }
            
            .hotbot-scope .nav-button {
                padding: 0.5rem 1rem;
                font-size: 0.875rem;
            }
            
            .hotbot-scope .page-header {
                flex-direction: column;
                gap: 1rem;
                align-items: flex-start;
            }
            
            .hotbot-scope .grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <div id="app-loader">
            <svg class="animate-spin h-8 w-8 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="ml-3">Carregando...</span>
        </div>
    </div>
    <div id="modal-container"></div>

    <script>
    // ============================================
    // == L√ìGICA DO HOTTRACK (APLICA√á√ÉO PRINCIPAL) ==
    // ============================================
    const ACCESS_TOKEN_KEY = 'hottrack_token';
    const REFRESH_TOKEN_KEY = 'hottrack_refresh_token';

    const normalizePixQrCodeSrc = (value) => {
        if (!value || typeof value !== 'string') return null;
        const trimmed = value.trim();
        if (!trimmed) return null;
        if (/^data:image\/[a-z0-9.+-]+;base64,/i.test(trimmed)) {
            return trimmed;
        }
        return `data:image/png;base64,${trimmed}`;
    };

    const App = {
        state: {
            API_BASE_URL: '', // Ser√° carregado dinamicamente
            token: null,
            refreshToken: null,
            data: { 
                pixels: [],
                bots: [],
                pressels: [], 
                settings: {}, 
                transactions: [],
                dashboard: {},
                utmifyIntegrations: [],
                checkouts: []
            },
            currentPage: 'dashboard',
            editingCheckoutId: null,
            editingThankYouPageId: null,
            pixPollingIntervalId: null,
            sectionPolling: {},
            sectionFetchInProgress: {},
            dateFilter: {
                period: 'all',
                startDate: null,
                endDate: null
            },
            transactionsPagination: {
                page: 1,
                totalPages: 1,
                total: 0,
                limit: 100
            },
            revenueChart: null,
        },

        // --- REFRESH AUTOM√ÅTICO DE TOKEN ---
        tokenRefreshTimer: null,
        isRefreshing: false, // Flag para evitar m√∫ltiplos refresh simult√¢neos

        decodeJWT(token) {
            try {
                if (!token) return null;
                const parts = token.split('.');
                if (parts.length !== 3) return null;
                const payload = parts[1];
                const decoded = JSON.parse(atob(payload.replace(/-/g, '+').replace(/_/g, '/')));
                return decoded;
            } catch (error) {
                console.warn('[Auth] Erro ao decodificar JWT:', error);
                return null;
            }
        },

        scheduleTokenRefresh() {
            // Cancela timer anterior se existir
            this.cancelTokenRefresh();

            const token = this.state.token || this.getToken();
            if (!token) {
                return; // Sem token, n√£o h√° o que agendar
            }

            const decoded = this.decodeJWT(token);
            if (!decoded || !decoded.exp) {
                console.warn('[Auth] Token inv√°lido ou sem expira√ß√£o, n√£o ser√° agendado refresh autom√°tico.');
                return;
            }

            const expirationTime = decoded.exp * 1000; // Converte para milliseconds
            const now = Date.now();
            const timeUntilExpiration = expirationTime - now;
            
            // Agenda refresh 2 minutos antes da expira√ß√£o (120000 ms)
            const refreshDelay = Math.max(0, timeUntilExpiration - 120000);

            if (refreshDelay <= 0) {
                // Token j√° expirou ou est√° muito pr√≥ximo, tenta refresh imediatamente
                console.log('[Auth] Token pr√≥ximo da expira√ß√£o, fazendo refresh imediato.');
                this.tryRefreshToken().then(success => {
                    if (success) {
                        this.scheduleTokenRefresh(); // Reagenda ap√≥s refresh bem-sucedido
                    }
                });
                return;
            }

            console.log(`[Auth] Refresh autom√°tico agendado para ${Math.round(refreshDelay / 1000)} segundos (${Math.round(refreshDelay / 60000)} minutos).`);

            this.tokenRefreshTimer = setTimeout(async () => {
                console.log('[Auth] Executando refresh autom√°tico de token...');
                const success = await this.tryRefreshToken();
                if (success) {
                    // Reagenda pr√≥ximo refresh ap√≥s sucesso
                    this.scheduleTokenRefresh();
                } else {
                    console.warn('[Auth] Refresh autom√°tico falhou, sistema reativo assumir√°.');
                }
            }, refreshDelay);
        },

        cancelTokenRefresh() {
            if (this.tokenRefreshTimer) {
                clearTimeout(this.tokenRefreshTimer);
                this.tokenRefreshTimer = null;
            }
        },

        // --- SEGURAN√áA: Fun√ß√£o para obter token de forma segura ---
        getToken() {
            let token = sessionStorage.getItem(ACCESS_TOKEN_KEY);
            if (!token) {
                token = localStorage.getItem(ACCESS_TOKEN_KEY);
                if (token) {
                    sessionStorage.setItem(ACCESS_TOKEN_KEY, token);
                    localStorage.removeItem(ACCESS_TOKEN_KEY);
                }
            }
            this.state.token = token;
            return token;
        },

        getRefreshToken() {
            let refreshToken = sessionStorage.getItem(REFRESH_TOKEN_KEY);
            if (!refreshToken) {
                refreshToken = localStorage.getItem(REFRESH_TOKEN_KEY);
                if (refreshToken) {
                    sessionStorage.setItem(REFRESH_TOKEN_KEY, refreshToken);
                    localStorage.removeItem(REFRESH_TOKEN_KEY);
                }
            }
            this.state.refreshToken = refreshToken;
            return refreshToken;
        },

        setToken(token) {
            if (token) {
                sessionStorage.setItem(ACCESS_TOKEN_KEY, token);
                localStorage.removeItem(ACCESS_TOKEN_KEY);
            } else {
                sessionStorage.removeItem(ACCESS_TOKEN_KEY);
                localStorage.removeItem(ACCESS_TOKEN_KEY);
            }
            this.state.token = token;
        },

        setRefreshToken(refreshToken) {
            if (refreshToken) {
                sessionStorage.setItem(REFRESH_TOKEN_KEY, refreshToken);
                localStorage.removeItem(REFRESH_TOKEN_KEY);
            } else {
                sessionStorage.removeItem(REFRESH_TOKEN_KEY);
                localStorage.removeItem(REFRESH_TOKEN_KEY);
            }
            this.state.refreshToken = refreshToken;
        },

        clearAuthTokens() {
            this.setToken(null);
            this.setRefreshToken(null);
        },

        async init() {
            // Determina a URL base do backend para buscar a configura√ß√£o
            const backendHost = window.location.origin; // Usa a mesma origem do frontend

            try {
                // Busca a configura√ß√£o do backend
                const response = await fetch(`${backendHost}/api/config`);
                if (!response.ok) throw new Error('Falha ao carregar configura√ß√£o do servidor.');
                const config = await response.json();
                this.state.API_BASE_URL = config.apiBaseUrl;
                console.log('API Base URL carregada:', this.state.API_BASE_URL);
            } catch (error) {
                console.error('Erro cr√≠tico ao inicializar o App:', error);
                // Define um fallback ou mostra uma mensagem de erro para o usu√°rio
                this.state.API_BASE_URL = backendHost; // Fallback para a URL conhecida
                document.body.innerHTML = '<p style="color: red; text-align: center; margin-top: 50px;">Erro ao conectar com o servidor. Tente recarregar a p√°gina.</p>';
                return; // Impede o resto da inicializa√ß√£o
            }

            const path = window.location.pathname;
            const origin = window.location.origin;

            // Verificar se √© uma p√°gina de oferta
            if (path.startsWith('/oferta/')) {
                const checkoutId = path.split('/')[2];
                this.renderCheckoutPage(checkoutId);
                return;
            }
            else if (path.startsWith('/obrigado/')) {
                const pageId = path.split('/')[2];
                this.renderStandaloneThankYouPage(pageId, origin);
                return;
            }

            this.state.token = this.getToken();
            this.state.refreshToken = this.getRefreshToken();
            if (this.state.token) {
                try {
                    const [staticData] = await Promise.all([
                        this.apiRequest('/api/dashboard/data'),
                        this.apiRequest('/api/transactions'),
                    ]);
                    this.state.data = { ...this.state.data, ...staticData };
                    this.renderLayout();
                    // Restaurar a √∫ltima p√°gina visitada do localStorage
                    const lastPage = localStorage.getItem('app-currentPage') || 'dashboard';
                    this.navigateTo(lastPage);
                } catch (e) {
                    console.error("Erro ao inicializar:", e);
                    this.logout();
                }
            } else {
                this.renderLogin();
                this.addAuthEventListeners();
            }
        },

        async renderCheckoutPage(checkoutId) {
            const appContainer = document.getElementById('app');
            appContainer.innerHTML = `<div id="app-loader" style="height: 100vh; display: flex; align-items: center; justify-content: center;"><svg class="animate-spin h-8 w-8 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="ml-3">Carregando...</span></div>`;

            try {
                const { config, click_id: clickIdFromServer } = await this.apiRequest(`/api/oferta/${checkoutId}`);
                if (!config || !config.pricing || !config.content) {
                     throw new Error("Configura√ß√£o da oferta inv√°lida recebida da API.");
                }

                const formatCurrency = (cents) => (cents / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                const countdownHTML = config.conversion_elements.countdown.enabled
                    ? `<div style="background-color: var(--checkout-accent, #38bdf8); color: white; text-align: center; padding: 0.75rem; position: sticky; top: 0; z-index: 10;">
                           <p style="font-weight: 600; font-size: 0.9rem;">A OFERTA TERMINA EM</p>
                           <p id="countdown-timer" style="font-size: 1.5rem; font-weight: 800; letter-spacing: 0.1em;">--:--</p>
                       </div>`
                    : '';

                const mediaHTML = config.content.media_url
                    ? `<img src="${config.content.media_url}" alt="Preview da Oferta" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 0.5rem; margin-bottom: 1.5rem;">`
                    : '';

                let pricingHTML = '';
                if (config.pricing.type === 'fixed' && Array.isArray(config.pricing.packages)) {
                    pricingHTML = config.pricing.packages.map((pkg, index) => `
                        <div data-package-index="${index}" class="package-item p-4 rounded-lg cursor-pointer hover:border-sky-400 border border-gray-300 bg-white hover:bg-gray-50 transition-all shadow-sm">
                            <h3 class="font-bold text-lg text-gray-900 pointer-events-none">${pkg.title || 'Pacote'}</h3>
                            <p class="text-sm text-gray-600 pointer-events-none">${pkg.description || ''}</p>
                            <p class="text-2xl font-bold mt-2 pointer-events-none" style="color: var(--checkout-accent);">${formatCurrency(pkg.value_cents)}</p>
                        </div>
                    `).join('');
                     pricingHTML = `<div id="packages-list" class="space-y-4 mt-6">${pricingHTML}</div>`;
                } else {
                     pricingHTML = '<p class="text-center text-red-400">Erro na configura√ß√£o de pre√ßos.</p>';
                }

                const orderBumpHTML = config.order_bump.enabled && config.order_bump.product_name
                    ? `<div style="background-color: #fefce8; border: 2px dashed #facc15; padding: 1rem; border-radius: 0.5rem; margin-top: 1.5rem;">
                           <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                               <input id="order-bump-checkbox" type="checkbox" style="width: 1.5rem; height: 1.5rem; margin-top: 0.25rem; accent-color: #ca8a04;">
                               <div>
                                   <h4 style="font-weight: 700; color: #ca8a04;">${config.order_bump.product_name}</h4>
                                   <p style="font-size: 0.9rem; color: #4b5563;">${config.order_bump.description}</p>
                               </div>
                           </div>
                       </div>`
                    : '';

                const guaranteeHTML = config.conversion_elements.guarantee.text
                    ? `<div style="margin-top: 2rem; display: flex; align-items: center; gap: 1rem; background-color: #f9fafb; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
                            ${config.conversion_elements.guarantee.seal_url ? `<img src="${config.conversion_elements.guarantee.seal_url}" alt="Selo de Garantia" style="width: 60px; height: 60px;">` : ''}
                            <div>
                                <h4 style="font-weight: 700; color: #374151;">Garantia Total</h4>
                                <p style="font-size: 0.9rem; color: #6b7280;">${config.conversion_elements.guarantee.text}</p>
                            </div>
                        </div>`
                    : '';
                const testimonials = Array.isArray(config.testimonials) ? config.testimonials : [];
                const testimonialsHTML = testimonials.filter(t => t.name && t.text).length > 0
                    ? `<div style="margin-top: 2.5rem;">
                           <h3 style="font-size: 1.5rem; font-weight: 800; text-align: center; color: var(--checkout-text-primary); margin-bottom: 1.5rem;">O Que Nossos Clientes Dizem</h3>
                           <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                               ${testimonials.map(t => `
                                   <div style="background-color: #f9fafb; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; color: #1f2937;">
                                       <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                           ${(t.photo_url && t.photo_url !== 'null') ? `<img src="${t.photo_url}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` : ''}
                                           <p style="font-weight: 600; color: #111827;">${t.name}</p>
                                       </div>
                                       <p style="font-size: 0.9rem; color: #4b5563; font-style: italic;">"${t.text}"</p>
                                   </div>
                               `).join('')}
                           </div>
                       </div>`
                    : '';

                const bgColor = config.style.background_color || '#0f172a';
                const accentColor = config.style.accent_color || '#38bdf8';
                const isDarkBg = (bgColor = '#0f172a') => {
                    const color = (bgColor.charAt(0) === '#') ? bgColor.substring(1, 7) : bgColor;
                    const r = parseInt(color.substring(0, 2), 16); // Red
                    const g = parseInt(color.substring(2, 4), 16); // Green
                    const b = parseInt(color.substring(4, 6), 16); // Blue
                    // Esta √© a f√≥rmula exata usada em renderCheckoutPage
                    return (r * 0.299 + g * 0.587 + b * 0.114) < 186;
                };
                const primaryTextColor = isDarkBg ? '#f1f5f9' : '#111827';
                const secondaryTextColor = isDarkBg ? '#94a3b8' : '#4b5563';

                const checkoutHTML = `
                    <style>
                        :root {
                            --checkout-bg: ${bgColor};
                            --checkout-accent: ${accentColor};
                            --checkout-text-primary: ${primaryTextColor};
                            --checkout-text-secondary: ${secondaryTextColor};
                        }
                        body, #app {
                            background-color: var(--checkout-bg) !important;
                            font-family: 'Inter', sans-serif;
                            color: var(--checkout-text-primary);
                            height: auto;
                            overflow-y: auto;
                        }
                        .checkout-card {
                            background-color: ${isDarkBg ? 'rgba(30, 41, 59, 0.6)' : 'rgba(255, 255, 255, 0.8)'};
                            border: 1px solid ${isDarkBg ? '#334155' : '#e5e7eb'};
                            backdrop-filter: blur(16px);
                            -webkit-backdrop-filter: blur(16px);
                            color: var(--checkout-text-primary);
                        }
                        .package-item {
                            background-color: ${isDarkBg ? '#1e293b' : '#ffffff'};
                            border-color: ${isDarkBg ? '#334155' : '#e5e7eb'};
                        }
                        .package-item h3 { color: ${isDarkBg ? '#f1f5f9' : '#111827'}; }
                        .package-item p { color: ${isDarkBg ? '#94a3b8' : '#6b7280'}; }
                        .package-item:hover { border-color: var(--checkout-accent); }
                        .package-item.selected {
                            border-color: var(--checkout-accent);
                            box-shadow: 0 0 0 2px var(--checkout-accent);
                        }
                        .final-pay-btn {
                            background-color: var(--checkout-accent);
                            color: ${ (parseInt(accentColor.substring(1, 3), 16) * 0.299 + parseInt(accentColor.substring(3, 5), 16) * 0.587 + parseInt(accentColor.substring(5, 7), 16) * 0.114) < 186 ? '#FFFFFF' : '#000000' };
                            font-weight: 700;
                            padding: 1rem;
                            border-radius: 0.5rem;
                            margin-top: 1.5rem;
                            font-size: 1.1rem;
                            text-transform: uppercase;
                            border: none;
                            width: 100%;
                            cursor: pointer;
                            transition: all 0.2s ease;
                        }
                        .final-pay-btn:hover { filter: brightness(1.1); }
                        .final-pay-btn:disabled { background-color: #334155; color: #64748b; cursor: not-allowed; filter: none; }
                    </style>

                    ${countdownHTML}
                    <div id="checkout-body-wrapper" class="min-h-screen flex items-center justify-center p-4 animate-fade-in">
                        <div class="checkout-card w-full max-w-lg p-6 md:p-8 rounded-2xl shadow-lg">
                            ${mediaHTML}
                            <h1 class="text-2xl font-bold text-center" style="color: var(--checkout-text-primary);">${config.content.main_title || 'Oferta Especial'}</h1>
                            <p style="color: var(--checkout-text-secondary);" class="text-center mb-6">${config.content.subtitle || ''}</p>

                            ${pricingHTML}
                            ${orderBumpHTML}

                            <button id="pay-button" class="final-pay-btn" disabled>Selecione um pacote</button>

                            ${guaranteeHTML}
                            ${testimonialsHTML}
                        </div>
                    </div>
                `;

                appContainer.innerHTML = checkoutHTML;

                // Listener DELEGADO para fechar o modal PIX e parar o polling
                appContainer.addEventListener('click', (e) => {
                    const closeModalButton = e.target.closest('.modal-close-btn');
                    const modalContainer = document.getElementById('modal-container');

                    if (closeModalButton && modalContainer.querySelector('#pix-status-message')) {
                        if (App.state.pixPollingIntervalId) {
                            clearInterval(App.state.pixPollingIntervalId);
                            App.state.pixPollingIntervalId = null;
                            console.log("Polling PIX interrompido pelo fechamento manual do modal.");
                        }
                        modalContainer.innerHTML = ''; // Fecha o modal
                    }
                });



                if (config.pricing.type === 'fixed' && Array.isArray(config.pricing.packages) && config.pricing.packages.length > 0) {
                    let selectedPackage = null;
                    const packagesList = document.getElementById('packages-list');
                    const payButton = document.getElementById('pay-button');
                    const orderBumpCheckbox = document.getElementById('order-bump-checkbox');

                    function updatePayButtonText() {
                        if (!selectedPackage) return;
                        let totalValue = selectedPackage.value_cents;
                        let buttonText = `Pagar Agora (${formatCurrency(totalValue)})`;
                        if (orderBumpCheckbox && orderBumpCheckbox.checked && config.order_bump && config.order_bump.value_cents > 0) {
                            totalValue += config.order_bump.value_cents;
                            buttonText = `Pagar Agora (${formatCurrency(totalValue)})`;
                        }
                        payButton.textContent = buttonText;
                    }

                    packagesList.addEventListener('click', (e) => {
                        const clickedPackage = e.target.closest('.package-item');
                        if (!clickedPackage) return;
                        packagesList.querySelectorAll('.package-item').forEach(p => p.classList.remove('selected'));
                        clickedPackage.classList.add('selected');
                        const packageIndex = clickedPackage.dataset.packageIndex;
                        selectedPackage = config.pricing.packages[packageIndex];
                        updatePayButtonText();
                        payButton.disabled = false;
                    });

                    if (orderBumpCheckbox) {
                        orderBumpCheckbox.addEventListener('change', updatePayButtonText);
                    }

                    payButton.addEventListener('click', async () => {
                        if (!selectedPackage) { alert('Por favor, selecione um pacote v√°lido.'); return; }
                        let totalValueCents = selectedPackage.value_cents;
                        if (orderBumpCheckbox && orderBumpCheckbox.checked && config.order_bump && config.order_bump.value_cents > 0) {
                            totalValueCents += config.order_bump.value_cents;
                        }
                        payButton.textContent = 'Gerando PIX...';
                        payButton.disabled = true;
                        const urlParams = new URLSearchParams(window.location.search);
                        const clickIdFromUrl = urlParams.get('click_id') || urlParams.get('cid') || clickIdFromServer; // Usa o ID do servidor como fallback
                        try {
                            const pixData = await this.apiRequest('/api/oferta/generate-pix', 'POST', {
                                checkoutId: checkoutId,
                                value_cents: totalValueCents,
                                click_id: clickIdFromUrl
                            });
                            this.showPixModal(pixData, config.redirects?.success_url); // Mostra o modal e inicia polling
                        } catch (error) {
                            alert('Erro ao gerar PIX. Tente novamente.');
                        } finally {
                            updatePayButtonText();
                            payButton.disabled = !selectedPackage;
                        }
                    });
                }

                if (config.conversion_elements.countdown.enabled) {
                    const timerEl = document.getElementById('countdown-timer');
                    if (timerEl) {
                        let duration = (config.conversion_elements.countdown.minutes || 15) * 60;
                        const interval = setInterval(() => {
                            const minutes = Math.floor(duration / 60).toString().padStart(2, '0');
                            const seconds = (duration % 60).toString().padStart(2, '0');
                            timerEl.textContent = `${minutes}:${seconds}`;
                            duration--;
                            if (duration < 0) {
                                clearInterval(interval);
                                timerEl.textContent = "00:00";
                            }
                        }, 1000);
                    }
                }

            } catch (error) {
                console.error("Erro ao renderizar p√°gina de checkout:", error);
                appContainer.innerHTML = `<p class="text-center text-red-400 text-lg mt-20">Erro ao carregar oferta: ${error.message || 'Verifique o console.'}</p>`;
            }
       },

       // ******** FUN√á√ÉO showPixModal ATUALIZADA ********
        async showPixModal(pixData, successRedirectUrl) {
            // Limpa qualquer polling anterior ao abrir um novo modal
            if (this.state.pixPollingIntervalId) {
                clearInterval(this.state.pixPollingIntervalId);
                this.state.pixPollingIntervalId = null;
            }

            // Monta o HTML do QR Code (se base64 estiver dispon√≠vel)
            const qrCodeSrc = normalizePixQrCodeSrc(pixData.qr_code_base64);
            const qrCodeHTML = qrCodeSrc
                ? `<img src="${qrCodeSrc}" alt="QR Code PIX" class="mx-auto my-4 border border-slate-600 p-2 rounded-lg bg-white max-w-[200px]">`
                : '<p class="text-xs text-slate-500 my-4">(QR Code n√£o dispon√≠vel)</p>'; // Fallback

            const modalContent = `
                <div class="text-center">
                    <h3 id="pix-modal-title" class="text-lg font-bold text-green-400">PIX Gerado com Sucesso!</h3>
                    <p class="text-sm text-gray-400 mt-2 mb-4">Escaneie o QR Code ou copie o c√≥digo abaixo e pague no seu aplicativo do banco.</p>
                    ${qrCodeHTML}
                    <textarea id="pix-code-textarea" class="form-input w-full p-2 font-mono text-xs bg-slate-900" rows="4" readonly>${pixData.qr_code_text || 'Erro ao obter c√≥digo'}</textarea>
                    <button id="copy-pix-btn" class="btn w-full mt-4 py-2">Copiar C√≥digo PIX</button>
                    <p id="pix-status-message" class="text-xs text-sky-400 mt-3 animate-pulse">Aguardando pagamento...</p>
                </div>
            `;
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = this.templates.modal('Pagamento via PIX', modalContent);


            await new Promise(resolve => setTimeout(resolve, 0));

            const copyBtn = document.getElementById('copy-pix-btn');
            if (copyBtn) {
                copyBtn.addEventListener('click', async (e) => { // Tornar async
                    const textarea = document.getElementById('pix-code-textarea');
                    if (textarea && textarea.value !== 'Erro ao obter c√≥digo') {
                        try {
                            // ============ CORRE√á√ÉO ============
                            await navigator.clipboard.writeText(textarea.value);
                            // ==================================
                            
                            e.target.textContent = 'Copiado!';
                            setTimeout(() => { e.target.textContent = 'Copiar C√≥digo PIX'; }, 2000);
                        } catch (err) {
                            console.error('Falha ao copiar:', err); 
                            alert('N√£o foi poss√≠vel copiar.');
                        }
                    } else { 
                        alert('Sem c√≥digo PIX para copiar.'); 
                    }
                });
            }

            // Inicia a verifica√ß√£o de status se tivermos um transaction_id
            if (pixData.transaction_id) {
                console.log("Iniciando polling para transaction_id:", pixData.transaction_id);
                this.startPixStatusPolling(pixData.transaction_id, successRedirectUrl);
            } else {
                 console.error("N√£o foi poss√≠vel iniciar o polling: transaction_id ausente em pixData.");
                 const statusMsg = document.getElementById('pix-status-message');
                 if(statusMsg) statusMsg.textContent = "Erro: ID da transa√ß√£o n√£o encontrado.";
            }

             // Adiciona listener para limpar o polling quando o modal for fechado (pelo bot√£o X)
             const closeModalBtn = document.getElementById('closeModalBtn');
             if (closeModalBtn) {
                 // Usamos uma fun√ß√£o nomeada para poder remover depois se necess√°rio
                 const closeModalListener = () => {
                     if (this.state.pixPollingIntervalId) {
                         clearInterval(this.state.pixPollingIntervalId);
                         this.state.pixPollingIntervalId = null;
                         console.log("Polling interrompido pelo fechamento do modal (Bot√£o X).");
                     }
                     document.getElementById('modal-container').innerHTML = ''; // Limpa o modal
                 };
                 // Limpa listener antigo se existir antes de adicionar um novo
                 if (closeModalBtn._listener) {
                     closeModalBtn.removeEventListener('click', closeModalBtn._listener);
                 }
                 closeModalBtn.addEventListener('click', closeModalListener);
                 closeModalBtn._listener = closeModalListener; // Guarda a refer√™ncia
             }
        },

        startPixStatusPolling(transactionId, successRedirectUrl) {
            const startTime = Date.now();
            const pollDuration = 5 * 60 * 1000; // 5 minutos em milissegundos

            this.state.pixPollingIntervalId = setInterval(async () => {
                if (Date.now() - startTime > pollDuration) {
                    clearInterval(this.state.pixPollingIntervalId);
                    this.state.pixPollingIntervalId = null;
                    const statusEl = document.getElementById('pix-status-message');
                    if (statusEl) statusEl.innerHTML = '<span class="text-red-500">Tempo esgotado. Gere um novo PIX.</span>';
                    // Re-habilita o bot√£o de fechar se o tempo esgotar
                    const closeBtn = document.querySelector('#modal-container .modal-close-btn');
                    if(closeBtn) closeBtn.disabled = false;
                    return;
                }

                try {
                    const { status, redirectUrl: apiRedirectUrl } = await this.apiRequest(`/api/pix-status/${transactionId}`);
                    const statusEl = document.getElementById('pix-status-message');
                    
                    // Usa redirectUrl da resposta da API, ou fallback para o par√¢metro
                    const redirectUrl = apiRedirectUrl || successRedirectUrl;

                    if (status === 'paid') {
                        clearInterval(this.state.pixPollingIntervalId);
                        this.state.pixPollingIntervalId = null;
                        if (statusEl) {
                            statusEl.innerHTML = '<span class="text-green-400">Pagamento Aprovado! Redirecionando...</span>';
                        }
                        // Redireciona ap√≥s um pequeno delay
                        setTimeout(() => {
                            if (redirectUrl) {
                                window.location.href = redirectUrl;
                            } else {
                                // Fallback se n√£o houver URL de sucesso
                                document.getElementById('modal-container').innerHTML = '';
                                this.showToast('Pagamento aprovado com sucesso!', 'success');
                            }
                        }, 2000);
                    }
                } catch (error) {
                    console.error('Erro ao verificar status do PIX:', error);
                    // Opcional: parar o polling em caso de erro de rede, etc.
                }
            }, 5000); // Verifica a cada 5 segundos
        },

        async renderStandaloneThankYouPage(pageId, originUrl) {
            const appContainer = document.getElementById('app');
            appContainer.innerHTML = `<div id="app-loader" style="height: 100vh; display: flex; align-items: center; justify-content: center;"><svg class="animate-spin h-8 w-8 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="ml-3">Carregando...</span></div>`;

            try {
                const { config } = await this.apiRequest(`/api/obrigado/${pageId}`);
                if (!config) {
                    throw new Error("Configura√ß√£o da p√°gina de obrigado n√£o encontrada.");
                }

                const thankYouHTML = `
                    <div style="background-color: var(--bg-secondary, #0f172a); color: var(--text-primary, #f1f5f9); font-family: 'Inter', sans-serif; min-height: 100vh; display: flex; align-items: center; justify-content: center; text-align: center; padding: 2rem;">
                        <div class="animate-fade-in">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-400 mx-auto mb-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                            </svg>
                            <h1 style="font-size: 2.25rem; font-weight: 800; color: white;">${config.main_title || 'Obrigado!'}</h1>
                            <p style="color: var(--text-secondary, #94a3b8); margin-top: 0.5rem; max-width: 450px; margin-left: auto; margin-right: auto;">${config.subtitle || 'Sua compra foi conclu√≠da com sucesso.'}</p>
                            <a id="redirect-button" href="${config.redirect_url || '#'}" style="display: inline-block; background-color: var(--accent-secondary, #0ea5e9); color: white; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.375rem; margin-top: 1.5rem; text-decoration: none; transition: background-color 0.2s ease;">
                                ${config.button_text || 'Acessar Conte√∫do'}
                            </a>
                        </div>
                    </div>
                `;
                appContainer.innerHTML = thankYouHTML;

                if (config.pixel_id && config.purchase_value > 0) {
                    if (!document.getElementById('facebook-pixel-script')) {
                        const script = document.createElement('script'); script.id = 'facebook-pixel-script';
                        script.innerHTML = `!function(f,b,e,v,n,t,s){if(f.fbq)return;n=f.fbq=function(){n.callMethod?n.callMethod.apply(n,arguments):n.queue.push(arguments)};if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';n.queue=[];t=b.createElement(e);t.async=!0;t.src=v;s=b.getElementsByTagName(e)[0];s.parentNode.insertBefore(t,s)}(window, document,'script','https://connect.facebook.net/en_US/fbevents.js');`;
                        document.head.appendChild(script);
                    }
                    window.fbq('init', config.pixel_id); window.fbq('track', 'Purchase', { value: config.purchase_value, currency: 'BRL' }); console.log(`Pixel ${config.pixel_id} init and Purchase fired.`);
                }

                if (config.utmify_integration_id) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const trackingParameters = {};
                    ['utm_source', 'utm_medium', 'utm_campaign', 'utm_content', 'utm_term', 'src', 'sck'].forEach(param => {
                        if (urlParams.has(param)) {
                            trackingParameters[param] = urlParams.get(param);
                        }
                    });

                    // Captura o click_id e adiciona aos par√¢metros de rastreamento
                    const clickIdFromUrl = urlParams.get('click_id') || urlParams.get('cid');
                    if (clickIdFromUrl) {
                        trackingParameters.click_id = clickIdFromUrl; // Adiciona o click_id
                    }

                    const customerData = {
                        name: urlParams.get('name') || null,
                        email: urlParams.get('email') || null,
                        phone: urlParams.get('phone') || null
                    };

                    try {
                        await this.apiRequest('/api/thank-you-pages/fire-utmify', 'POST', {
                            pageId: pageId,
                            trackingParameters: trackingParameters, // Agora inclui o click_id, se existir
                            customerData: customerData
                        });
                        console.log("Utmify event fired (via backend).");
                    } catch (utmifyError) {
                        console.error("Error firing Utmify event via backend:", utmifyError);
                    }
                }

            } catch (error) {
                console.error("Erro ao renderizar p√°gina de obrigado:", error);
                appContainer.innerHTML = `<p class="text-center text-red-400 text-lg mt-20">Erro ao carregar p√°gina: ${error.message || 'Verifique o console.'}</p>`;
            }
        },




        // ******** FIM DAS FUN√á√ïES ATUALIZADAS ********

        renderLogin(page = 'login') { document.getElementById('app').innerHTML = this.templates.auth(page); },
        renderLayout() { document.getElementById('app').innerHTML = this.templates.layout(); this.addDashboardEventListeners(); },

        formatNumber(number, isCurrency = false) {
            let num = parseFloat(number);
            if (isNaN(num)) {
                 num = 0;
            }
            if (isCurrency) {
                return num.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            } else {
                return num.toLocaleString('pt-BR');
            }
        },

        templates: {
            auth(page = 'login') {
                return `<div class="flex items-center justify-center min-h-screen p-4">${page === 'login' ? this.loginForm() : this.registerForm()}</div>`;
            },
            loginForm() {
                return `
                <div class="card p-8 rounded-2xl shadow-lg w-full max-w-md animate-fade-in">
                    <div class="text-center mb-8">
                        <div class="flex items-center justify-center gap-2">
                            <svg class="h-10 w-10 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
                            <h1 class="text-4xl font-bold text-white">HotTrack</h1>
                        </div>
                        <p class="text-slate-400 mt-2">Acesse sua conta para continuar.</p>
                    </div>
                    <form id="loginForm" class="space-y-6">
                        <div><label class="text-sm font-medium text-gray-400 mb-1 block">E-mail</label><input name="email" type="email" required class="form-input w-full p-3"></div>
                        <div><label class="text-sm font-medium text-gray-400 mb-1 block">Senha</label><input name="password" type="password" required class="form-input w-full p-3"></div>
                        <button type="submit" class="btn w-full font-semibold py-3 rounded-md">Entrar na Plataforma</button>
                    </form>
                    
                    <div class="relative my-6">
                        <div class="absolute inset-0 flex items-center">
                            <div class="w-full border-t border-slate-600"></div>
                        </div>
                        <div class="relative flex justify-center text-sm">
                            <span class="px-2 bg-slate-800 text-slate-400">ou</span>
                        </div>
                    </div>
                    
                    <button id="googleLoginBtn" class="w-full flex items-center justify-center gap-3 bg-white text-gray-900 font-semibold py-3 px-4 rounded-md hover:bg-gray-100 transition-colors">
                        <svg class="w-5 h-5" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        Entrar com Google
                    </button>
                    
                    <div class="text-center mt-6"><a href="#" id="showRegister" class="text-sm text-sky-400 hover:text-sky-300 hover:underline">N√£o tem uma conta? Cadastre-se agora</a></div>
                </div>`;
            },
            hotbot() {
    return `
                <div class="animate-fade-in" style="height: 100%; display: flex; flex-direction: column;">
        <div class="mb-6">
                        <h1 class="text-3xl font-bold text-white">HotBot - Automa√ß√£o & Vendas</h1>
                        <p class="text-slate-400">Gerencie seus bots, fluxos, disparos e conversas em um s√≥ lugar.</p>
        </div>
                    <div id="hotbot-container" class="hotbot-scope" style="flex: 1; min-height: 0;"></div>
    </div>`;
},
            registerForm() {
                return `
                <div class="card p-8 rounded-2xl shadow-lg w-full max-w-md animate-fade-in">
                     <div class="text-center mb-8">
                        <div class="flex items-center justify-center gap-2">
                            <svg class="h-10 w-10 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
                            <h1 class="text-4xl font-bold text-white">HotTrack</h1>
                        </div>
                        <p class="text-slate-400 mt-2">Crie sua conta e comece a rastrear.</p>
                    </div>
                    <form id="registerForm" class="space-y-4">
                        <div><label class="text-sm font-medium text-gray-400 mb-1 block">Nome</label><input name="name" type="text" required class="form-input w-full p-3"></div>
                        <div><label class="text-sm font-medium text-gray-400 mb-1 block">E-mail</label><input name="email" type="email" required class="form-input w-full p-3"></div>
                        <div><label class="text-sm font-medium text-gray-400 mb-1 block">Telefone</label><input name="phone" type="tel" required class="form-input w-full p-3"></div>
                        <div><label class="text-sm font-medium text-gray-400 mb-1 block">Senha (m√≠nimo 8 caracteres)</label><input name="password" type="password" required minlength="8" class="form-input w-full p-3"></div>
                        <button type="submit" class="btn w-full font-semibold py-3 rounded-md">Criar Minha Conta</button>
                    </form>
                    <div class="text-center mt-6"><a href="#" id="showLogin" class="text-sm text-sky-400 hover:text-sky-300 hover:underline">J√° tem uma conta? Fa√ßa Login</a></div>
                </div>`;
            },
            layout() {
                return `
                <div class="relative min-h-screen md:flex">
                    <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-60 z-20 md:hidden hidden"></div>

                    <aside id="sidebar" class="w-64 bg-slate-900/80 backdrop-blur-lg p-4 flex-col fixed inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition-transform duration-300 ease-in-out z-30 border-r border-slate-800 flex">
                        <div class="text-center py-4 mb-6 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <svg class="h-8 w-8 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" /></svg>
                                <h1 class="text-2xl font-bold text-white">HotTrack</h1>
                            </div>
                            <button id="close-sidebar-btn" class="md:hidden text-gray-400 text-3xl hover:text-white">&times;</button>
                        </div>
                        <nav id="sidebarNav" class="flex-grow flex flex-col space-y-1">
                            <div data-target="dashboard" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>Dashboard</div>
                            <div data-target="hotbot" class="nav-link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
                                </svg>
                                <span>HotBot</span>
                            </div>
                            
                            <div data-target="pressels" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>Criador de Pressel</div>
                            <div data-target="checkouts" class="nav-link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4l2 2h4a2 2 0 012 2v1H2V6z" clip-rule="evenodd" /><path d="M2 12a2 2 0 012-2h12a2 2 0 012 2v2a2 2 0 01-2 2H4a2 2 0 01-2-2v-2z" /></svg>
                                <span>Checkouts</span>
                            </div>
                            <div data-target="thankYouPages" class="nav-link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                                </svg>
                                <span>P√°gs. de Obrigado</span>
                            </div>
                            <div data-target="pixels" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h10a3 3 0 013 3v5a.997.997 0 01-.293.707zM5 4a1 1 0 00-1 1v.01L8 9.01l4-4.002V5a1 1 0 00-1-1H5z" clip-rule="evenodd" /></svg>Gerenciar Pixels</div>
                            <div data-target="transactions" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M8.433 7.418c.158-.103.346-.196.567-.267v1.698a2.5 2.5 0 00-1.168-.217c-.165 0-.33.018-.488.054a1 1 0 01-.502 1.765l.986.328c.73.243 1.196.96 1.196 1.765 0 1.132-.98 1.99-2.206 1.99-1.225 0-2.205-.858-2.205-1.99 0-.962.63-1.698 1.447-1.938l.986-.329a1 1 0 01.502-1.765z" /><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-13a1 1 0 00-2 0v.092a4.5 4.5 0 00-1.838.385l-.234-.14a1 1 0 00-1.18.157l-1 1.732a1 1 0 00.157 1.18l.234.14A4.5 4.5 0 005.5 8.5v.092l-1.07.356a1 1 0 00-.503 1.765l.986.329a2.5 2.5 0 001.09.243v.092a4.5 4.5 0 001.838-.385l.234.14a1 1 0 001.18-.157l1-1.732a1 1 0 00-.157-1.18l-.234-.14a4.5 4.5 0 001.03-2.062V5z" clip-rule="evenodd" /></svg>Transa√ß√µes</div>
                            <div class="h-px bg-slate-700 my-2"></div>
                            <div data-target="settings" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z" /></svg>API PIX</div>
                            <div data-target="integrations" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0l-1.5-1.5a2 2 0 112.828-2.828l1.5 1.5z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M6.414 11.586a2 2 0 10-2.828 2.828l3 3a2 2 0 002.828 0l1.5-1.5a2 2 0 10-2.828-2.828l-1.5 1.5z" clip-rule="evenodd" /></svg>Integra√ß√µes</div>
                            <div data-target="documentation" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 6a1 1 0 011-1h6a1 1 0 110 2H7a1 1 0 01-1-1zm1 3a1 1 0 100 2h6a1 1 0 100-2H7z" clip-rule="evenodd" /></svg>API & Docs</div>
                            <a href="https://wa.me/5541995211148" target="_blank" class="nav-link">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 8a7 7 0 110-14 7 7 0 010 14zm-1-11a1 1 0 100 2h2a1 1 0 100-2H9z" clip-rule="evenodd" /></svg>
                                <span>Suporte</span>
                            </a>
                        </nav>
                        <div class="mt-auto"><button id="logoutButton" class="w-full text-slate-400 hover:bg-red-900/50 hover:text-white font-semibold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transition-all duration-300"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd" /></svg>Sair da Conta</button></div>
                    </aside>
                    
                    <div class="flex-1 flex flex-col w-full">
                        <header class="p-4 md:hidden card flex justify-between items-center sticky top-0 z-10">
                             <button id="open-sidebar-btn" class="text-white">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                             </button>
                             <div class="text-lg font-bold">HotTrack</div>
                        </header>
                        <main id="content" class="flex-1 p-4 md:p-8 overflow-y-auto"></main>
                    </div>
                </div>`;
            },
            dateFilterComponent(page) {
                const { period } = App.state.dateFilter;
                const btnClasses = "btn-secondary py-1 px-3 rounded-md text-xs";
                const activeClasses = "active !bg-sky-500 !border-sky-400 !text-white";
                return `
                <div id="${page}-date-filter" class="card p-3 rounded-lg mb-6 flex flex-wrap items-center gap-2 text-sm">
                    <span class="font-semibold mr-2 text-slate-300">Per√≠odo:</span>
                    <button data-period="today" class="${btnClasses} ${period === 'today' ? activeClasses : ''}">Hoje</button>
                    <button data-period="yesterday" class="${btnClasses} ${period === 'yesterday' ? activeClasses : ''}">Ontem</button>
                    <button data-period="last7days" class="${btnClasses} ${period === 'last7days' ? activeClasses : ''}">7 Dias</button>
                    <button data-period="thisMonth" class="${btnClasses} ${period === 'thisMonth' ? activeClasses : ''}">Este M√™s</button>
                    <div class="flex items-center gap-2 pl-4 border-l border-slate-700 ml-2">
                         <input type="date" id="${page}-start-date" class="form-date p-1 rounded-md text-xs">
                         <span class="text-gray-500">at√©</span>
                         <input type="date" id="${page}-end-date" class="form-date p-1 rounded-md text-xs">
                         <button id="apply-custom-date-filter-${page}" class="btn-secondary py-1 px-3 rounded-md text-xs">Filtrar</button>
                    </div>
                    <button id="clear-date-filter-${page}" class="btn-secondary py-1 px-3 rounded-md ml-auto text-xs">Limpar Filtro</button>
                </div>`;
            },
            dashboard() {
                return `
                <div class="animate-fade-in">
                    <div class="mb-6">
                        <h1 class="text-3xl font-bold text-white">Painel de M√©tricas</h1>
                        <p class="text-slate-400">Vis√£o geral do desempenho de suas opera√ß√µes.</p>
                    </div>
                    ${this.dateFilterComponent('dashboard')}
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
                        <div class="card metric-card"><h3 class="text-sm text-gray-400">Cliques na P√°gina</h3><p id="metric-clicks" class="text-4xl font-bold text-sky-400 mt-2">...</p></div>
                        <div class="card metric-card"><h3 class="text-sm text-gray-400">PIX Gerados</h3><p id="metric-generated" class="text-4xl font-bold text-yellow-400 mt-2">...</p></div>
                        <div class="card metric-card"><h3 class="text-sm text-gray-400">Faturamento Total</h3><p id="metric-total-revenue" class="text-4xl font-bold text-sky-400 mt-2">...</p></div>
                        <div class="card metric-card"><h3 class="text-sm text-gray-400">PIX Pagos</h3><p id="metric-paid" class="text-4xl font-bold text-green-400 mt-2">...</p></div>
                        <div class="card metric-card"><h3 class="text-sm text-gray-400">Faturamento Pago</h3><p id="metric-paid-revenue" class="text-4xl font-bold text-green-400 mt-2">...</p></div>
                    </div>
                    <div class="card p-6 rounded-lg mb-8">
                        <h2 class="text-xl font-semibold text-white mb-4">Desempenho de Faturamento</h2>
                        <canvas id="revenueChart" height="100"></canvas>
                    </div>
                    <div class="grid grid-cols-1 gap-8 lg:grid-cols-3">
                        <div class="card p-6 rounded-lg lg:col-span-2"><h2 class="text-xl font-semibold text-white mb-4">Desempenho por Bot</h2><div id="bots-performance-table-container" class="overflow-x-auto"><table class="table-custom w-full text-sm"><thead><tr><th>Bot</th><th>Cliques</th><th>Vendas</th><th>Faturamento</th></tr></thead><tbody id="bots-performance-table"><tr><td colspan="4">Carregando...</td></tr></tbody></table></div></div>
                        <div class="card p-6 rounded-lg"><h2 class="text-xl font-semibold text-white mb-4">Tr√°fego por Estado</h2><div id="traffic-by-state-table-container" class="overflow-x-auto"><table class="table-custom w-full text-sm"><thead><tr><th>Estado</th><th>Cliques</th></tr></thead><tbody id="traffic-by-state-table"><tr><td colspan="2">Carregando...</td></tr></tbody></table></div></div>
                        
                    </div>
                     <div class="grid grid-cols-1 gap-8 lg:grid-cols-3 mt-8">
                        <div class="card p-6 rounded-lg lg:col-span-2">
                             <h2 class="text-xl font-semibold text-white mb-4">Minhas Conquistas</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="achievements-list">
                                <p class="text-gray-500 text-sm">Carregando conquistas...</p>
                            </div>
                        </div>
                         <div class="card p-6 rounded-lg">
                            <h2 class="text-xl font-semibold text-white mb-4">Ranking de Vendas</h2>
                            <div id="ranking-list" class="space-y-2">
                                <p class="text-gray-500 text-sm">Carregando ranking...</p>
                            </div>
                            <p id="user-rank-status" class="mt-4 text-center text-sm font-medium text-sky-400"></p>
                        </div>
                    </div>
                </div>`;
            },
            checkouts() {
                return `
                <div class="animate-fade-in p-4 md:p-8"> <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div>
                            <h1 class="text-3xl font-bold text-white">Meus Checkouts</h1>
                            <p class="text-slate-400">Gerencie suas p√°ginas de oferta criadas.</p>
                        </div>
                        <button id="go-to-creator-btn" class="btn">Criar Novo Checkout</button>
                    </div>
                    <div class="card p-0 md:p-6 rounded-lg">
                        <div id="checkouts-table-container" class="overflow-x-auto">
                            <table class="table-custom w-full text-sm">
                                <thead>
                                    <tr>
                                        <th>Nome da Oferta</th>
                                        <th>Data de Cria√ß√£o</th>
                                        <th class="text-right">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="checkouts-table-body">
                                    <tr><td colspan="3" class="text-center text-gray-500 py-8">Carregando checkouts...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            },
            pageCreator() {
                 return `
                <div id="creator-screen" class="animate-fade-in flex flex-col h-full">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 flex-shrink-0 p-4 md:p-8 pb-0">
                        <div>
                            <h1 id="creator-title" class="text-3xl font-bold text-white">Criador de Ofertas</h1>
                            <p class="text-slate-400 mt-1">Configure √† esquerda e veja o resultado √† direita em tempo real.</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <button type="button" id="back-to-checkouts-btn" class="btn btn-secondary">Cancelar</button>
                            <button type="submit" form="checkout-form" id="submit-btn" class="btn font-bold text-lg py-2 px-6">Criar Checkout</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 flex-1 p-4 md:p-8 pt-0" style="min-height: 0;">

                        <form id="checkout-form" class="space-y-6 overflow-y-auto pr-4 h-full">
                            <div class="card p-6 rounded-xl">
                                <h2 class="text-xl font-semibold mb-4 border-b border-slate-700 pb-2">1. Conte√∫do da P√°gina</h2>
                                <div class="space-y-4">
                                    <div><label for="main_title" class="text-sm font-medium text-gray-400 mb-1 block">T√≠tulo Principal</label><input id="main_title" type="text" class="form-input w-full p-2" value="Desbloqueie o Segredo Para um Corpo Definido" required></div>
                                    <div><label for="subtitle" class="text-sm font-medium text-gray-400 mb-1 block">Subt√≠tulo</label><input id="subtitle" type="text" class="form-input w-full p-2" value="Acesso exclusivo por tempo limitado √† metodologia que j√° transformou 5.000+ vidas." required></div>
                                    <div><label for="media_url" class="text-sm font-medium text-gray-400 mb-1 block">URL da Imagem/V√≠deo (Opcional)</label><input id="media_url" type="url" class="form-input w-full p-2" placeholder="https://exemplo.com/imagem.png"></div>
                                </div>
                            </div>
                            <div class="card p-6 rounded-xl">
                                <h2 class="text-xl font-semibold mb-4 border-b border-slate-700 pb-2">2. Pre√ßos</h2>
                                <div class="mb-4">
                                    <label for="pricing-type-select" class="text-sm font-medium text-gray-400 mb-1 block">Modelo de Pre√ßo</label>
                                    <select id="pricing-type-select" class="form-select w-full p-2">
                                        <option value="fixed">Pacotes com Pre√ßo Fixo</option>
                                        <option value="open" disabled>Valor Aberto (Em breve)</option>
                                    </select>
                                </div>
                                <div id="fixed-pricing-container">
                                    <div class="flex justify-between items-center mb-4"><h3 class="text-lg font-medium">Pacotes de Pre√ßos</h3><button type="button" id="add-package-btn" class="btn btn-secondary text-sm py-1 px-3">+ Pacote</button></div>
                                    <div id="packages-container" class="space-y-4"></div>
                                </div>
                                <div id="open-pricing-container" class="hidden space-y-4">
                                </div>
                            </div>
                            <div class="card p-6 rounded-xl">
                                <h2 class="text-xl font-semibold mb-4 border-b border-slate-700 pb-2">3. Order Bump (Opcional)</h2>
                                <div class="flex items-center space-x-3 mb-4"><input id="enable_order_bump" type="checkbox" class="form-checkbox h-5 w-5 rounded"><label for="enable_order_bump" class="font-medium">Ativar Order Bump</label></div>
                                <div id="order-bump-fields" class="hidden space-y-4">
                                    <div><label for="order_bump_product_name" class="text-sm font-medium text-gray-400 mb-1 block">Nome do Produto</label><input id="order_bump_product_name" type="text" class="form-input w-full p-2" value="Ebook de Receitas Fit"></div>
                                    <div><label for="order_bump_description" class="text-sm font-medium text-gray-400 mb-1 block">Descri√ß√£o da Oferta</label><input id="order_bump_description" type="text" class="form-input w-full p-2" value="SIM! Quero adicionar o guia completo por apenas R$9,90!"></div>
                                    <div><label for="order_bump_value" class="text-sm font-medium text-gray-400 mb-1 block">Valor (R$)</label><input id="order_bump_value" type="number" step="0.01" min="0" class="form-input w-full p-2" value="9.90"></div>
                                </div>
                            </div>
                            <div class="card p-6 rounded-xl">
                                <h2 class="text-xl font-semibold mb-4 border-b border-slate-700 pb-2">4. Elementos de Convers√£o</h2>
                                <div class="space-y-6">
                                    <div>
                                        <div class="flex items-center space-x-3 mb-2"><input id="enable_countdown" type="checkbox" class="form-checkbox h-5 w-5 rounded"><label for="enable_countdown" class="font-medium">Ativar Contador Regressivo</label></div>
                                        <div id="countdown-fields" class="hidden"><label for="countdown_minutes" class="text-sm font-medium text-gray-400 mb-1 block">Dura√ß√£o em Minutos</label><input id="countdown_minutes" type="number" min="1" class="form-input w-full max-w-xs p-2" value="15"></div>
                                    </div>
                                    <div>
                                        <h3 class="font-medium mb-2">Selo de Garantia</h3>
                                        <div class="space-y-4">
                                            <div><label for="guarantee_text" class="text-sm font-medium text-gray-400 mb-1 block">Texto da Garantia</label><textarea id="guarantee_text" class="form-textarea w-full p-2" rows="3">Sua satisfa√ß√£o garantida ou seu dinheiro de volta em 7 dias. Risco zero!</textarea></div>
                                            <div><label for="guarantee_seal_url" class="text-sm font-medium text-gray-400 mb-1 block">URL da Imagem do Selo (Opcional)</label><input id="guarantee_seal_url" type="url" class="form-input w-full p-2" placeholder="https://exemplo.com/selo.png"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card p-6 rounded-xl">
                                <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2"><h2 class="text-xl font-semibold">5. Prova Social</h2><button type="button" id="add-testimonial-btn" class="btn btn-secondary text-sm py-1 px-3">+ Depoimento</button></div>
                                <div id="testimonials-container" class="space-y-4"></div>
                            </div>
                            <div class="card p-6 rounded-xl">
                                <h2 class="text-xl font-semibold mb-4 border-b border-slate-700 pb-2">6. Rastreamento e Estilo</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div>
                                        <label for="pixel_id" class="text-sm font-medium text-gray-400 mb-1 block">Pixel da Meta</label>
                                        <select id="pixel_id" class="form-select w-full p-2" required>
                                            <option value="">-- Selecione um Pixel --</option>
                                            </select>
                                    </div>
                                    <div>
                                        <label for="utmify_integration_id" class="text-sm font-medium text-gray-400 mb-1 block">Integra√ß√£o Utmify (Opcional)</label>
                                        <select id="utmify_integration_id" class="form-select w-full p-2">
                                            <option value="">-- Nenhuma --</option>
                                        </select>
                                    </div>
                                    <div class="flex items-center gap-4">
                                        <div><label for="background_color" class="text-sm font-medium text-gray-400 mb-1 block">Fundo</label><input id="background_color" type="color" value="#0f172a" class="form-input h-10 w-16 p-1"></div>
                                        <div><label for="accent_color" class="text-sm font-medium text-gray-400 mb-1 block">Destaque</label><input id="accent_color" type="color" value="#38bdf8" class="form-input h-10 w-16 p-1"></div>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="success_redirect_url" class="text-sm font-medium text-gray-400 mb-1 block">URL de Redirecionamento P√≥s-Pagamento (Opcional)</label>
                                        <input id="success_redirect_url" type="url" class="form-input w-full p-2" placeholder="https://seu-site.com/obrigado">
                                    </div>
                                </div>
                            </div>
                        </form>

                        <div class="relative h-full">
                            <div class="sticky top-0">
                                <div class="flex justify-center items-center gap-2 mb-4">
                                    <div class="flex rounded-lg bg-slate-700 p-1">
                                        <button id="desktop-view-btn" class="btn-view active px-3 py-1 text-xs rounded-md">Desktop</button>
                                        <button id="mobile-view-btn" class="btn-view px-3 py-1 text-xs rounded-md">Mobile</button>
                                    </div>
                                </div>
                                <div id="preview-wrapper" class="desktop mx-auto">
                                    <div id="preview-content"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="result-screen" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center animate-fade-in z-50 p-4">
                        <div class="card p-8 rounded-2xl w-full max-w-2xl mx-auto">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-center text-green-400">Checkout Criado com Sucesso!</h2>
                                <button id="closeModalBtn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
                            </div>
                            <p class="text-slate-400 text-center mt-2 mb-6">Este √© o link <span class="font-bold text-white">√∫nico e exclusivo</span> da sua nova p√°gina de oferta. Guarde-o e use-o em suas campanhas.</p>
                            <div class="bg-slate-900 p-4 rounded-lg flex items-center gap-4">
                                <input id="checkout-link-output" type="text" class="form-input flex-grow bg-transparent border-0" readonly>
                                <button id="copy-link-btn" class="btn btn-secondary text-sm py-2 px-4 whitespace-nowrap">Copiar Link</button>
                            </div>
                            <div class="text-center mt-6">
                                <button id="create-another-btn" class="btn text-sm py-2 px-5">Ver Meus Checkouts</button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            },

            thankYouCreator() {
                return `
                <div id="creator-screen" class="animate-fade-in p-4 md:p-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div>
                            <h1 id="ty-creator-title" class="text-3xl font-bold text-white">Criador de P√°gina de Obrigado</h1>
                            <p class="text-slate-400 mt-1">Gere links para disparar eventos de compra no navegador.</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <button type="button" id="back-to-ty-list-btn" class="btn btn-secondary">Cancelar</button>
                            <button type="submit" form="thank-you-form" id="submit-btn" class="btn font-bold text-lg py-2 px-6">Gerar P√°gina</button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <form id="thank-you-form" class="space-y-6">
                            <div class="card p-6 rounded-xl">
                                <h2 class="text-xl font-semibold mb-4 border-b border-slate-700 pb-2">1. Configura√ß√µes da P√°gina</h2>
                                <div class="space-y-4">
                                    <input id="page_name" type="text" class="form-input w-full p-2" placeholder="Nome da P√°gina (Ex: Compra Ebook X)" required>
                                    <input id="main_title" type="text" class="form-input w-full p-2" placeholder="T√≠tulo (Ex: Obrigado pela sua compra!)" value="Obrigado pela sua compra!" required>
                                    <input id="subtitle" type="text" class="form-input w-full p-2" placeholder="Subt√≠tulo (Ex: Clique abaixo para acessar)" value="Seu acesso foi enviado para seu email. Clique no bot√£o abaixo para ir para a √°rea de membros." required>
                                    <div class="grid grid-cols-2 gap-4">
                                        <input id="button_text" type="text" class="form-input w-full p-2" placeholder="Texto do Bot√£o" value="Acessar Conte√∫do" required>
                                        <input id="redirect_url" type="url" class="form-input w-full p-2" placeholder="URL de Redirecionamento" required>
                                    </div>
                                </div>
                            </div>

                            <div class="card p-6 rounded-xl">
                                <h2 class="text-xl font-semibold mb-4 border-b border-slate-700 pb-2">2. Configura√ß√µes de Convers√£o</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div>
                                        <label for="purchase_value" class="text-sm font-medium text-gray-400 mb-1 block">Valor da Compra (R$)</label>
                                        <input id="purchase_value" type="number" step="0.01" min="0" class="form-input w-full p-2" placeholder="97.90" required>
                                    </div>
                                    <div>
                                        <label for="pixel_id" class="text-sm font-medium text-gray-400 mb-1 block">ID do Pixel da Meta</label>
                                        <input id="pixel_id" type="text" class="form-input w-full p-2" placeholder="Cole o ID do seu Pixel" required>
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="utmify_integration_id" class="text-sm font-medium text-gray-400 mb-1 block">Enviar evento para Utmify (Opcional)</label>
                                        <select id="utmify_integration_id" class="form-select w-full p-2">
                                            <option value="">N√£o enviar</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </form>

                        <div class="sticky top-8">
                            <h3 class="text-lg font-semibold text-center mb-4">Visualiza√ß√£o</h3>
                            <div id="preview-wrapper" class="w-full h-[500px]">
                                <div id="preview-content"></div>
                            </div>
                        </div>
                    </div>

                    <div id="result-screen" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center animate-fade-in z-50 p-4">
                        <div class="card p-8 rounded-2xl w-full max-w-2xl mx-auto">
                             <div class="flex justify-between items-center mb-4">
                                <h2 class="text-2xl font-bold text-center text-green-400">P√°gina Criada com Sucesso!</h2>
                                <button id="closeModalBtn" class="text-gray-400 hover:text-white text-3xl">&times;</button>
                            </div>
                            <p class="text-slate-400 text-center mt-2 mb-6">Use este link como a URL de obrigado na sua plataforma de pagamento.</p>
                            <div class="bg-slate-900 p-4 rounded-lg flex items-center gap-4">
                                <input id="page-link-output" type="text" class="form-input flex-grow bg-transparent border-0" readonly>
                                <button id="copy-link-btn" class="btn btn-secondary text-sm py-2 px-4 whitespace-nowrap">Copiar Link</button>
                            </div>
                            <div class="text-center mt-6">
                                <button id="create-another-btn" class="btn text-sm py-2 px-5">Criar Outra P√°gina</button>
                                <button id="view-ty-pages-btn" class="btn btn-secondary text-sm py-2 px-5 ml-2">Ver Minhas P√°ginas</button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
            },

            thankYouPages() {
                return `
                <div class="animate-fade-in p-4 md:p-8">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div>
                            <h1 class="text-3xl font-bold text-white">Minhas P√°ginas de Obrigado</h1>
                            <p class="text-slate-400">Gerencie suas p√°ginas de obrigado criadas.</p>
                        </div>
                        <button id="go-to-thankyou-creator-btn" class="btn">Criar Nova P√°gina</button>
                    </div>
                    <div class="card p-0 md:p-6 rounded-lg">
                        <div id="thankyou-table-container" class="overflow-x-auto">
                            <table class="table-custom w-full text-sm">
                                <thead>
                                    <tr>
                                        <th>Nome da P√°gina</th>
                                        <th>Data de Cria√ß√£o</th>
                                        <th class="text-right">A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="thankyou-table-body">
                                    <tr><td colspan="3" class="text-center text-gray-500 py-8">Carregando p√°ginas...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>`;
            },
            pixels() {
                const pixelListHTML = App.state.data.pixels.map(p => `<div class="p-3 bg-slate-900/50 rounded-lg flex justify-between items-center"><span class="font-mono text-sm">${p.account_name}</span><button data-id="${p.id}" class="delete-pixel-btn btn btn-red text-xs py-1 px-2">Excluir</button></div>`).join('');
                return `
                <div class="animate-fade-in">
                    <div class="mb-6"><h1 class="text-3xl font-bold text-white">Gerenciar Pixels</h1><p class="text-slate-400">Adicione e gerencie seus pixels do Facebook.</p></div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="card p-6 rounded-lg">
                            <h2 class="text-xl font-semibold mb-4 text-white">Adicionar Novo Pixel</h2>
                            <form id="pixelForm" class="space-y-4"><input name="account_name" placeholder="Nome do Pixel (Ex: Produto Y)" class="form-input w-full p-2" required><input name="pixel_id" placeholder="ID do Pixel da Meta" class="form-input w-full p-2" required><textarea name="meta_api_token" placeholder="Token da API de Convers√µes" class="form-input w-full p-2" rows="3" required></textarea><button type="submit" class="btn w-full p-2 rounded-md">Adicionar Pixel</button></form>
                        </div>
                        <div class="card p-6 rounded-lg"><h2 class="text-xl font-semibold text-white mb-4">Pixels Salvos</h2><div id="pixel-list" class="space-y-3 max-h-96 overflow-y-auto">${pixelListHTML.length ? pixelListHTML : '<p class="text-gray-500 text-sm">Nenhum pixel salvo.</p>'}</div></div>
                    </div>
                </div>`;
            },
            pressels() {
                const { pixels, pressels, utmifyIntegrations, bots } = App.state.data;
                const utmifyOptions = utmifyIntegrations.map(u => `<option value="${u.id}">${u.account_name}</option>`).join('');
                const pixelCheckboxes = pixels.map(p => `<label class="flex items-center space-x-2 text-gray-300 hover:text-white cursor-pointer p-2 rounded-md hover:bg-slate-700/50"><input type="checkbox" name="pixel_ids" value="${p.id}" class="h-4 w-4 bg-slate-700 border-slate-500 rounded text-sky-500 focus:ring-sky-500"><span>${p.account_name}</span></label>`).join('');
                
                // Add bot selection options
                const botOptions = bots ? bots.map(bot => 
                    `<option value="${bot.id}">${bot.bot_name}</option>`
                ).join('') : '<option value="">Nenhum bot dispon√≠vel</option>';
                const presselList = App.generatePresselListHTML(pressels);
                
            return `
            <div class="animate-fade-in">
                <div class="mb-6">
                    <h1 class="text-3xl font-bold text-white">Criador de Pressel</h1>
                    <p class="text-slate-400">Configure suas p√°ginas de pressel para captura de leads.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card p-6 rounded-lg">
                        <h2 class="text-xl font-bold mb-4 text-white">Criar Nova Pressel</h2>
                        <form id="presselForm" class="space-y-4">

                            <input name="name" placeholder="Nome da Pressel (Ex: Campanha Black Friday)" class="form-input w-full p-2" required>
                            <input name="white_page_url" type="url" placeholder="URL da P√°gina Branca" class="form-input w-full p-2" required>
                            <div>
                                <label class="text-sm font-medium text-gray-400 mb-1 block">Selecione o Bot</label>
                                <select name="bot_id" class="form-select w-full p-2" required>
                                    <option value="">Selecione um bot</option>
                                    ${botOptions}
                                </select>
                                <p class="text-xs text-gray-500 mt-1">Selecione o bot que ser√° usado para enviar mensagens</p>
                            </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-400 mb-1 block">Enviar Eventos para Utmify (Opcional)</label>
                                    <select name="utmify_integration_id" class="form-select w-full p-2">
                                        <option value="">N√£o enviar</option>
                                        ${utmifyOptions}
                                    </select>
                                </div>
                                
                                <div>
                                    <label class="text-sm font-medium text-gray-400 mb-1 block">Tipo de Tr√°fego Aceito</label>
                                    <select name="traffic_type" class="form-select w-full p-2" required>
                                        <option value="mobile">Apenas Mobile</option>
                                        <option value="desktop">Apenas Desktop</option> 
                                        <option value="both">Desktop e Mobile</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-1">Selecione quais tipos de dispositivos podem acessar a pressel</p>
                                </div>
                                
                                <div class="card p-3"><p class="font-semibold mb-2">Selecione os Pixels:</p><div class="space-y-1">${pixelCheckboxes.length ? pixelCheckboxes : '<p class="text-gray-500 text-sm">Cadastre um pixel primeiro.</p>'}</div></div>
                                
                                <div class="card p-3">
                                    <label class="flex items-center space-x-3 cursor-pointer">
                                        <input type="checkbox" name="deploy_to_netlify" id="deploy_to_netlify" class="h-4 w-4 bg-slate-700 border-slate-500 rounded text-sky-500 focus:ring-sky-500">
                                        <div>
                                            <span class="font-semibold text-white">Deploy Autom√°tico no Netlify</span>
                                            <p class="text-xs text-gray-400 mt-1">Deploy a pressel automaticamente e receba uma URL pronta para usar</p>
                                            <p class="text-xs text-blue-400 mt-1">Configure a API Key do Netlify clicando <a href="#" onclick="App.navigateTo('integrations')" class="text-blue-400 hover:text-blue-300 underline cursor-pointer">aqui</a></p>
                                            </div>
                                    </label>
                                    
                                    <!-- Input para nome do site Netlify (inicialmente oculto) -->
                                    <div id="netlify-site-name-container" class="mt-3 hidden">
                                        <label for="netlify_site_name" class="block text-sm font-medium text-gray-300 mb-2">Nome do Site Netlify</label>
                                        <input 
                                            type="text" 
                                            name="netlify_site_name" 
                                            id="netlify_site_name"
                                            placeholder="meu-site-pressel"
                                            maxlength="37"
                                            class="w-full px-3 py-2 bg-slate-700 border border-slate-500 rounded-md text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:border-sky-500"
                                        >
                                        <p class="text-xs text-gray-400 mt-1">
                                            Apenas letras, n√∫meros e h√≠fens. M√°ximo 37 caracteres. 
                                            <span id="netlify-char-count" class="text-sky-400">0/37</span>
                                        </p>
                                        <div id="netlify-validation-error" class="text-red-400 text-xs mt-1 hidden"></div>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn w-full p-3 rounded-md text-base font-bold">Salvar e Gerar C√≥digo</button>
                                                </form>
                                            </div>
                                            <div class="card p-6 rounded-lg">
                                                <div class="flex justify-between items-center mb-4">
                                                    <h2 class="text-xl font-bold text-white">Pressels Criadas</h2>
                                                    <button 
                                                        type="button" 
                                                        class="btn text-sm py-2 px-4"
                                                        onclick="App.openDomainManagerModal()"
                                                    >
                                                        üåê Gerenciar Dom√≠nios
                                                    </button>
                                                </div>
                                                <p class="text-xs text-gray-400 mt-1">ATEN√á√ÉO: Lembre-se de cadastrar o dom√≠nio da pressel sen√£o ela n√£o ir√° funcionar. Obs: Pressels configuradas com o deploy pelo Netlify j√° ficam com o dom√≠nio cadastrado.</p>
                                                <div id="pressel-list" class="space-y-3">${presselList}</div>
                                            </div>
                                        </div>
                                    </div>`;
                                },
            transactions() {
                return `
                <div class="animate-fade-in">
                    <div class="mb-6"><h1 class="text-3xl font-bold text-white">Hist√≥rico de Transa√ß√µes</h1><p class="text-slate-400">Visualize todas as transa√ß√µes de PIX geradas e pagas.</p></div>
                    ${this.dateFilterComponent('transactions')}
                    <div class="card p-6 rounded-lg">
                        <div id="transactions-table-container" class="overflow-x-auto">
                            <table class="table-custom w-full text-sm">
                                <thead>
                                    <tr>
                                        <th>Status</th><th>Valor</th><th>Origem</th><th>Provedor PIX</th><th>Data</th>
                                    </tr>
                                </thead>
                                <tbody id="transactions-table-body">
                                    <tr><td colspan="5" class="text-center text-gray-500 py-8">Carregando transa√ß√µes...</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div id="transactions-pagination-container"></div>
                    </div>
                </div>`;
            },
            settings() {
                const { settings } = App.state.data;
                const providers = [
                    { value: 'pushinpay', text: 'PushinPay' },
                    { value: 'cnpay', text: 'CN Pay' },
                    { value: 'oasyfy', text: 'Oasy.fy' },
                    { value: 'syncpay', text: 'SyncPay' },
                    { value: 'brpix', text: 'BR PIX' },
                    { value: 'wiinpay', text: 'WiinPay' },
                    { value: 'pixup', text: 'Pixup' },
                    { value: 'paradise', text: 'Paradise' }
                ];
                const createSelect = (name, selectedValue) => {
                    const options = providers.map(p => `<option value="${p.value}" ${p.value === selectedValue ? 'selected' : ''}>${p.text}</option>`).join('');
                    return `<select name="${name}" class="form-select w-full p-2">${options}<option value="" ${!selectedValue ? 'selected' : ''}>Nenhum</option></select>`;
                };
                return `
                <div class="animate-fade-in">
                    <div class="mb-6"><h1 class="text-3xl font-bold text-white">Configura√ß√µes de PIX</h1><p class="text-slate-400">Configure seus provedores de pagamento e a ordem de prioridade.</p></div>
                    <form id="pixSettingsForm" class="max-w-4xl">
                        <div class="flex border-b border-slate-700 mb-6" id="pix-settings-tabs">
                            <button type="button" data-tab="priority" class="tab-button active">Ordem de Prioridade</button>
                            <button type="button" data-tab="credentials" class="tab-button ml-2">Chaves da API</button>
                        </div>

                        <div id="tab-priority" class="tab-content active space-y-8">
                            <div class="card p-6 rounded-lg">
                                <h2 class="text-xl font-semibold mb-2 text-white">Ordem de Prioridade dos Provedores</h2>
                                <p class="text-sm text-gray-400 mb-4">Defina a ordem em que o sistema tentar√° gerar o PIX. Se o Provedor Prim√°rio falhar, o sistema automaticamente tentar√° o pr√≥ximo na lista.</p>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <div><label class="block mb-2 text-sm font-medium text-gray-400">1¬∫ - Provedor Prim√°rio</label>${createSelect('pix_provider_primary', settings.pix_provider_primary)}</div>
                                    <div><label class="block mb-2 text-sm font-medium text-gray-400">2¬∫ - Provedor Secund√°rio</label>${createSelect('pix_provider_secondary', settings.pix_provider_secondary)}</div>
                                    <div><label class="block mb-2 text-sm font-medium text-gray-400">3¬∫ - Provedor Terci√°rio</label>${createSelect('pix_provider_tertiary', settings.pix_provider_tertiary)}</div>
                                </div>
                                <div class="mt-6 pt-6 border-t border-slate-700"><button type="button" id="testPriorityRouteBtn" class="btn-secondary text-md py-1 px-3">Testar Rota de Prioridade</button></div>
                            </div>
                        </div>

                        <div id="tab-credentials" class="tab-content space-y-6">
                            <div class="card p-6 rounded-lg">
                                <div class="flex justify-between items-start mb-4">
                                    <div><h3 class="text-lg font-medium text-sky-400 inline-block">BR PIX</h3><span id="status-indicator-brpix"></span></div>
                                    <button type="button" data-provider="brpix" class="test-pix-btn btn btn-secondary text-xs py-1 px-3">Testar Conex√£o</button>
                                </div>
                                <label class="block mb-2 text-sm text-gray-400">Secret Key</label><input name="brpix_secret_key" type="password" value="${settings.brpix_secret_key || ''}" class="form-input w-full p-2">
                                <label class="block mt-4 mb-2 text-sm text-gray-400">Company ID</label><input name="brpix_company_id" type="password" value="${settings.brpix_company_id || ''}" class="form-input w-full p-2">
                            </div>
                            <div class="card p-6 rounded-lg">
                                <div class="flex justify-between items-start mb-4">
                                    <div><h3 class="text-lg font-medium text-sky-400 inline-block">SyncPay</h3><span id="status-indicator-syncpay"></span></div>
                                    <button type="button" data-provider="syncpay" class="test-pix-btn btn btn-secondary text-xs py-1 px-3">Testar Conex√£o</button>
                                </div>
                                <label class="block mb-2 text-sm text-gray-400">Client ID</label><input name="syncpay_client_id" type="password" value="${settings.syncpay_client_id || ''}" class="form-input w-full p-2">
                                <label class="block mt-4 mb-2 text-sm text-gray-400">Client Secret</label><input name="syncpay_client_secret" type="password" value="${settings.syncpay_client_secret || ''}" class="form-input w-full p-2">
                            </div>
                            <div class="card p-6 rounded-lg">
                                <div class="flex justify-between items-start mb-4">
                                    <div><h3 class="text-lg font-medium text-sky-400 inline-block">PushinPay</h3><span id="status-indicator-pushinpay"></span></div>
                                    <button type="button" data-provider="pushinpay" class="test-pix-btn btn btn-secondary text-xs py-1 px-3">Testar Conex√£o</button>
                                </div>
                                <label class="block mb-2 text-sm text-gray-400">Bearer Token</label><input name="pushinpay_token" type="password" value="${settings.pushinpay_token || ''}" class="form-input w-full p-2">
                            </div>
                            <div class="card p-6 rounded-lg">
                                <div class="flex justify-between items-start mb-4">
                                    <div><h3 class="text-lg font-medium text-sky-400 inline-block">WiinPay</h3><span id="status-indicator-wiinpay"></span></div>
                                    <button type="button" data-provider="wiinpay" class="test-pix-btn btn btn-secondary text-xs py-1 px-3">Testar Conex√£o</button>
                                </div>
                                <label class="block mb-2 text-sm text-gray-400">API Key</label><input name="wiinpay_api_key" type="password" value="${settings.wiinpay_api_key || ''}" class="form-input w-full p-2">
                                <p class="text-xs text-gray-500 mt-2">Use a chave fornecida pela WiinPay para gerar cobran√ßas PIX.</p>
                            </div>
                            <div class="card p-6 rounded-lg">
                                <div class="flex justify-between items-start mb-4">
                                    <div><h3 class="text-lg font-medium text-sky-400 inline-block">Pixup</h3><span id="status-indicator-pixup"></span></div>
                                    <button type="button" data-provider="pixup" class="test-pix-btn btn btn-secondary text-xs py-1 px-3">Testar Conex√£o</button>
                                </div>
                                <label class="block mb-2 text-sm text-gray-400">Client ID</label><input name="pixup_client_id" type="text" value="${settings.pixup_client_id || ''}" class="form-input w-full p-2">
                                <label class="block mb-2 mt-3 text-sm text-gray-400">Client Secret</label><input name="pixup_client_secret" type="password" value="${settings.pixup_client_secret || ''}" class="form-input w-full p-2">
                            </div>
                            <div class="card p-6 rounded-lg">
                                <div class="flex justify-between items-start mb-4">
                                    <div><h3 class="text-lg font-medium text-sky-400 inline-block">Paradise</h3><span id="status-indicator-paradise"></span></div>
                                    <button type="button" data-provider="paradise" class="test-pix-btn btn btn-secondary text-xs py-1 px-3">Testar Conex√£o</button>
                                </div>
                                <label class="block mb-2 text-sm text-gray-400">Secret Key</label><input name="paradise_secret_key" type="password" value="${settings.paradise_secret_key || ''}" class="form-input w-full p-2">
                                <label class="block mb-2 mt-3 text-sm text-gray-400">Product Hash</label><input name="paradise_product_hash" type="text" value="${settings.paradise_product_hash || ''}" class="form-input w-full p-2">
                            </div>
                             <div class="card p-6 rounded-lg">
                                <div class="flex justify-between items-start mb-4">
                                    <div><h3 class="text-lg font-medium text-sky-400 inline-block">CN Pay</h3><span id="status-indicator-cnpay"></span></div>
                                    <button type="button" data-provider="cnpay" class="test-pix-btn btn btn-secondary text-xs py-1 px-3">Testar Conex√£o</button>
                                </div>
                                <label class="block mb-2 text-sm text-gray-400">Chave P√∫blica</label><input name="cnpay_public_key" type="password" value="${settings.cnpay_public_key || ''}" class="form-input w-full p-2">
                                <label class="block mt-4 mb-2 text-sm text-gray-400">Chave Privada</label><input name="cnpay_secret_key" type="password" value="${settings.cnpay_secret_key || ''}" class="form-input w-full p-2">
                            </div>
                            <div class="card p-6 rounded-lg">
                                 <div class="flex justify-between items-start mb-4">
                                    <div><h3 class="text-lg font-medium text-sky-400 inline-block">Oasy.fy</h3><span id="status-indicator-oasyfy"></span></div>
                                    <button type="button" data-provider="oasyfy" class="test-pix-btn btn btn-secondary text-xs py-1 px-3">Testar Conex√£o</button>
                                </div>
                                <label class="block mb-2 text-sm text-gray-400">Chave P√∫blica</label><input name="oasyfy_public_key" type="password" value="${settings.oasyfy_public_key || ''}" class="form-input w-full p-2">
                                <label class="block mt-4 mb-2 text-sm text-gray-400">Chave Privada</label><input name="oasyfy_secret_key" type="password" value="${settings.oasyfy_secret_key || ''}" class="form-input w-full p-2">
                            </div>
                        </div>
                        
                        <div class="mt-8"><button type="submit" class="btn w-full p-3 font-bold rounded-md">Salvar Configura√ß√µes de PIX</button></div>
                    </form>
                </div>`;
            },
            integrations() {
            const { utmifyIntegrations, settings } = App.state.data;
            const utmifyListHTML = utmifyIntegrations.map(u => `
                <div class="p-3 bg-slate-900/50 rounded-lg flex justify-between items-center">
                    <span class="font-medium text-sm">${u.account_name}</span>
                    <button data-id="${u.id}" class="delete-utmify-btn btn btn-red text-xs py-1 px-2">Excluir</button>
                </div>
            `).join('');

            return `
            <div class="animate-fade-in">
                <div class="mb-6"><h1 class="text-3xl font-bold text-white">Integra√ß√µes</h1><p class="text-slate-400">Conecte o HotTrack a outras ferramentas.</p></div>
                
                <div class="max-w-4xl">
                    <!-- Se√ß√£o Utmify -->
                    <div class="card p-6 rounded-lg mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold text-white">Contas Utmify</h2>
                            <button id="add-utmify-btn" class="btn btn-secondary text-sm py-1 px-3">Adicionar Conta</button>
                        </div>
                        <p class="text-sm text-gray-400 mt-1 mb-4">Adicione suas contas da Utmify. Depois, na cria√ß√£o de uma Pressel, voc√™ poder√° escolher para qual conta os eventos de venda devem ser enviados.</p>
                        <div id="utmify-list" class="space-y-3">
                            ${utmifyListHTML.length ? utmifyListHTML : '<p class="text-gray-500 text-sm">Nenhuma conta Utmify cadastrada.</p>'}
                        </div>
                    </div>

                    <!-- Nova Se√ß√£o Netlify -->
                    <div class="card p-6 rounded-lg">
                        <h2 class="text-xl font-semibold mb-2 text-white">Configura√ß√µes do Netlify</h2>
                        <p class="text-sm text-gray-400 mb-6">Configure o deploy autom√°tico das suas pressels no Netlify. Receba URLs prontas para usar automaticamente.</p>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block mb-2 text-sm text-gray-400">Token de Acesso do Netlify</label>
                                <input id="netlify-access-token-input" type="password" value="${settings.netlify_access_token || ''}" class="form-input w-full p-2" placeholder="Seu token de acesso pessoal do Netlify">
                                <p class="text-xs text-gray-500 mt-1">Obtenha seu token em: <a href="https://app.netlify.com/user/applications#personal-access-tokens" target="_blank" class="text-sky-400 hover:text-sky-300">app.netlify.com/user/applications</a></p>
                            </div>
                            
                            <div class="flex space-x-4">
                                <button type="button" id="validate-netlify-token" class="btn btn-secondary flex-1">Validar Token</button>
                            </div>
                            
                            <div id="netlify-status" class="hidden">
                                <div class="p-3 rounded-md bg-slate-800">
                                    <p class="text-sm text-gray-300" id="netlify-status-text"></p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
        },
            documentation() {
                return `
                <div class="animate-fade-in">
                    <div class="mb-6"><h1 class="text-3xl font-bold text-white">API & Documenta√ß√£o</h1><p class="text-slate-400">Sua chave de API para integra√ß√µes e o guia de implementa√ß√£o.</p></div>
                    <div class="grid grid-cols-1 gap-8 max-w-4xl">
                        <div class="card p-6 rounded-lg">
                            <h2 class="text-xl font-semibold mb-2 text-white">Sua Chave de API HotTrack</h2>
                            <p class="text-sm text-gray-400 mb-4">Use esta chave para autenticar suas requisi√ß√µes na API HotTrack (ex: gerar PIX, consultar status).</p>
                            <div class="flex items-center gap-2">
                                <input id="hottrack-api-key" type="password" readonly value="${App.state.data.settings.api_key || ''}" class="form-input flex-grow p-2">
                                <button type="button" class="toggle-visibility-btn p-2 text-gray-400 hover:text-white" data-target="#hottrack-api-key">
                                    <svg class="pointer-events-none h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                                </button>
                                <button type="button" class="copy-btn btn text-sm py-2 px-3" data-target="#hottrack-api-key">Copiar</button>
                                <a href="https://documentacaohot.netlify.app/" target="_blank" rel="noopener noreferrer" class="btn btn-secondary text-sm py-2 px-3 flex items-center gap-2 whitespace-nowrap">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                                    </svg>
                                    <span>Doc API</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>`;
            },
            modal(title, content) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† return `<div id="modal" class="modal active"><div class="card p-6 rounded-lg w-full max-w-md animate-fade-in"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-white">${title}</h2><button id="closeModalBtn" class="text-gray-400 hover:text-white text-3xl">&times;</button></div>${content}</div></div>`;
¬† ¬† ¬† ¬† ¬† ¬† }

        },

        addAuthEventListeners() {
            const container = document.getElementById('app');
            container.addEventListener('click', async (e) => {
                if (e.target.id === 'showRegister') { e.preventDefault(); this.renderLogin('register'); }
                if (e.target.id === 'showLogin') { e.preventDefault(); this.renderLogin('login'); }
                if (e.target.id === 'googleLoginBtn') { e.preventDefault(); await this.loginWithGoogle(); }
            });
            container.addEventListener('submit', async (e) => {
                const form = e.target;
                if (form.id === 'loginForm' || form.id === 'registerForm') {
                    e.preventDefault();
                    const data = Object.fromEntries(new FormData(form).entries());
                    const button = form.querySelector('button[type="submit"]');
                    const originalButtonText = button.innerHTML;
                    button.innerHTML = 'Processando...';
                    button.disabled = true;

                    if (form.id === 'loginForm') {
                        await this.login(data.email, data.password);
                    } else if (form.id === 'registerForm') {
                        const { name, email, password, phone } = data;
                        await this.register(name, email, password, phone);
                    }

                    button.innerHTML = originalButtonText;
                    button.disabled = false;
                }
            });
        },

        addDashboardEventListeners() {

            ¬†const listenerTarget = document.body; // USE document.body instead

            // Remove listener antigo para evitar duplica√ß√£o
            if (listenerTarget._clickListener) {
                listenerTarget.removeEventListener('click', listenerTarget._clickListener); // Target document.body
            }
            if (listenerTarget._submitListener) {
                listenerTarget.removeEventListener('submit', listenerTarget._submitListener); // Target document.body
            }

            listenerTarget._clickListener = async (e) => { // Guarda a refer√™ncia
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const sidebar = document.getElementById('sidebar');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const overlay = document.getElementById('sidebar-overlay');

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Toggle Sidebar
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (sidebar && overlay) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const isOpenBtn = e.target.closest('#open-sidebar-btn');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const isCloseBtn = e.target.closest('#close-sidebar-btn');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const isOverlay = e.target.id === 'sidebar-overlay';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const isNavLink = e.target.closest('.nav-link');

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (isOpenBtn) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† sidebar.classList.remove('-translate-x-full');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† overlay.classList.remove('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else if (isCloseBtn || isOverlay || (isNavLink && window.innerWidth < 768 && !isNavLink.closest('a[target="_blank"]'))) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† sidebar.classList.add('-translate-x-full');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† overlay.classList.add('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Logout
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (e.target.id === 'logoutButton') this.logout();

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Close Modal (Atualizado)
                const closeModalButton = e.target.closest('#closeModalBtn');
                if (closeModalButton) {
                    const modalContainer = document.getElementById('modal-container');
                    const isInsideModalContainer = modalContainer && modalContainer.contains(closeModalButton);
                    const creatorResultScreen = closeModalButton.closest('#result-screen'); // Check if it's inside a result screen

                    // L√≥gica para fechar modais DENTRO de #modal-container
                    if (isInsideModalContainer) {
                        const pixModalActive = modalContainer.querySelector('#pix-code-textarea'); // Verifica se √© o modal do PIX

                        // L√≥gica espec√≠fica para o Modal do PIX
                        if (pixModalActive && this.state.pixPollingIntervalId) {
                            clearInterval(this.state.pixPollingIntervalId);
                            this.state.pixPollingIntervalId = null;
                            console.log("Polling PIX interrompido pelo fechamento manual do modal (Bot√£o X).");
                        }
                        modalContainer.innerHTML = ''; // Limpa o container geral de modais
                    }
                    // L√≥gica espec√≠fica para o Modal de Resultado (Checkout/P√°gina de Obrigado) QUE EST√Å FORA do #modal-container
                    else if (creatorResultScreen) {
                        creatorResultScreen.classList.add('hidden'); // Esconde a tela de resultado
                        // Decide para onde navegar:
                        if (document.getElementById('thank-you-form')) { // Verifica pelo form, mais espec√≠fico que o ID do container
                           this.navigateTo('thankYouPages');
                        } else if (document.getElementById('checkout-form')) {
                            this.navigateTo('checkouts');
                        }
                     }
                }


¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Open Add Utmify Modal
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (e.target.id === 'add-utmify-btn') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† this.showAddUtmifyModal();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Navigate SPA
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const sidebarLink = e.target.closest('.nav-link[data-target]');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (sidebarLink && sidebarLink.dataset.target) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Limpa estados de edi√ß√£o ao navegar pelo menu
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (sidebarLink.dataset.target === 'checkouts') { this.state.editingCheckoutId = null; }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (sidebarLink.dataset.target === 'thankYouPages') { this.state.editingThankYouPageId = null; }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (sidebarLink.dataset.target === 'pageCreator') { this.state.editingCheckoutId = null; }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (sidebarLink.dataset.target === 'thankYouCreator') { this.state.editingThankYouPageId = null; }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† this.navigateTo(sidebarLink.dataset.target);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

                // Bot√µes Criador de Checkout
                if (e.target.id === 'go-to-creator-btn') { this.state.editingCheckoutId = null; this.navigateTo('pageCreator'); }
                if (e.target.id === 'back-to-checkouts-btn') { this.state.editingCheckoutId = null; this.navigateTo('checkouts'); }
                const editCheckoutBtn = e.target.closest('.edit-checkout-btn');
                if (editCheckoutBtn) { this.state.editingCheckoutId = editCheckoutBtn.dataset.id; this.navigateTo('pageCreator'); }
                const copyCheckoutLinkBtn = e.target.closest('.copy-checkout-link-btn');
                if (copyCheckoutLinkBtn) {
                    const link = `${window.location.origin}/oferta/${copyCheckoutLinkBtn.dataset.id}`;
                    try { await navigator.clipboard.writeText(link); const o=copyCheckoutLinkBtn.textContent; copyCheckoutLinkBtn.textContent='Copiado!'; setTimeout(()=>{copyCheckoutLinkBtn.textContent='Copiar Link'},2000); } catch(err){this.showToast('Erro.', 'error');}
                }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Bot√µes Criador/Listagem P√°gina de Obrigado
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (e.target.id === 'go-to-thankyou-creator-btn') { this.state.editingThankYouPageId = null; this.navigateTo('thankYouCreator'); }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (e.target.id === 'back-to-ty-list-btn') { this.state.editingThankYouPageId = null; this.navigateTo('thankYouPages'); }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const editThankYouBtn = e.target.closest('.edit-thankyou-btn');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (editThankYouBtn) { this.state.editingThankYouPageId = editThankYouBtn.dataset.id; this.navigateTo('thankYouCreator'); }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const copyThankYouLinkBtn = e.target.closest('.copy-thankyou-link-btn');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (copyThankYouLinkBtn) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†const link = `${window.location.origin}/obrigado/${copyThankYouLinkBtn.dataset.id}`;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†try { await navigator.clipboard.writeText(link); const o=copyThankYouLinkBtn.textContent; copyThankYouLinkBtn.textContent='Copiado!'; setTimeout(()=>{copyThankYouLinkBtn.textContent='Copiar Link'},2000); } catch(err){this.showToast('Erro.', 'error');}
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (e.target.id === 'view-ty-pages-btn') { // Bot√£o "Ver Minhas P√°ginas" no modal de sucesso TY
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const resultScreen = e.target.closest('#result-screen');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if(resultScreen) resultScreen.classList.add('hidden');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† this.navigateTo('thankYouPages');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†if (e.target.id === 'create-another-btn') { // Bot√£o "Criar Outra" ou "Ver Meus Checkouts" no modal de sucesso
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†const resultScreen = e.target.closest('#result-screen');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†if(resultScreen) resultScreen.classList.add('hidden');

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†if (document.getElementById('thankYouCreator')) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†// Se estava no criador de TY, reinicia ele
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†this.state.editingThankYouPageId = null;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†this.initThankYouCreatorPage();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†} else if (document.getElementById('pageCreator')) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Se estava no criador de Checkout, vai para a lista
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†this.navigateTo('checkouts');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†}
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }


¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Copy Buttons Gen√©rico
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const copyBtn = e.target.closest('.copy-btn');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (copyBtn) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†const targetSelector = copyBtn.dataset.target; const targetInput = document.querySelector(targetSelector); if(targetInput){ const textToCopy=targetInput.value||targetInput.textContent; try { await navigator.clipboard.writeText(textToCopy); const o=copyBtn.textContent; copyBtn.textContent='Copiado!'; setTimeout(()=>{copyBtn.textContent=o},2000); } catch(err){ console.error('Falha:',err); this.showToast('Erro.', 'error'); } }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Toggle Password Visibility
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const toggleBtn = e.target.closest('.toggle-visibility-btn');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (toggleBtn) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const targetSelector = toggleBtn.dataset.target; const targetInput = document.querySelector(targetSelector); if(targetInput){ const isPassword=targetInput.type==='password'; targetInput.type=isPassword?'text':'password'; toggleBtn.innerHTML=isPassword ? `<svg class="pointer-events-none h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.707 2.293a1 1 0 00-1.414 1.414l14 14a1 1 0 001.414-1.414l-1.473-1.473A10.014 10.014 0 0019.542 10C18.268 5.943 14.478 3 10 3a9.958 9.958 0 00-4.512 1.074l-1.78-1.781z" clip-rule="evenodd" /><path d="M12.454 16.697L9.75 13.992a2.5 2.5 0 01-3.482-3.482l-2.455-2.455a10.048 10.048 0 00-3.263 5.218C1.732 14.057 5.522 17 10 17a9.95 9.95 0 005.023-1.303l-2.57-2.57z" /></svg>` : `<svg class="pointer-events-none h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>`; }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Generate Pressel Code
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (e.target.classList.contains('generate-pressel-code-btn')) { const id=e.target.dataset.id; const p=this.state.data.pressels.find(x=>x.id==id); if(p)this.generatePresselCode(p); }

                // Copy Netlify Link
                if (e.target.classList.contains('copy-netlify-link-btn')) {
                    const url = e.target.dataset.url;
                    if (url) {
                        navigator.clipboard.writeText(url).then(() => {
                            this.showToast('Link copiado para a √°rea de transfer√™ncia!', 'success');
                        }).catch(() => {
                            // Fallback para navegadores mais antigos
                            const textArea = document.createElement('textarea');
                            textArea.value = url;
                            document.body.appendChild(textArea);
                            textArea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textArea);
                            this.showToast('Link copiado para a √°rea de transfer√™ncia!', 'success');
                        });
                    }
                }

                // Test PIX Buttons
                if (e.target.classList.contains('test-pix-btn')) { this.testIndividualPixConnection(e.target.dataset.provider, e.target); }
                if (e.target.id === 'testPriorityRouteBtn') { this.testPriorityRoute(e.target); }
                
                // Netlify Buttons
                if (e.target.id === 'validate-netlify-token') { this.validateNetlifyToken(e.target); }
                if (e.target.id === 'create-netlify-site') { this.createNetlifySite(e.target); }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Tab Buttons (L√≥gica Corrigida e Isolada)
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const tabButton = e.target.closest('.tab-button');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (tabButton && tabButton.dataset.tab) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const tabName = tabButton.dataset.tab;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Encontra o container pai mais pr√≥ximo (o form ou uma div que contenha as abas)
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const container = tabButton.closest('form, div.hotbot-scope'); // Procura no form ou no escopo do hotbot
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (container) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Procura bot√µes e conte√∫dos APENAS dentro deste container
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† container.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† tabButton.classList.add('active');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† container.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const activeContent = container.querySelector(`#tab-${tabName}`);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (activeContent) activeContent.classList.add('active');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Delete Buttons (Atualizado)
                const deleteBtn = e.target.closest('.delete-pixel-btn, .delete-bot-btn, .delete-pressel-btn, .delete-utmify-btn, .delete-checkout-btn, .delete-thankyou-btn');
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    if (!id) return this.showToast('ID do item n√£o encontrado.', 'error');

                    let type = '', endpoint = '', itemName = 'item';
                    let isGenericRefresh = true;
                    // default refresh: navega para a p√°gina atual (re-fetch padr√£o)
                    let refreshFunction = () => this.navigateTo(this.state.currentPage);

                    if (deleteBtn.classList.contains('delete-pixel-btn')) { type = 'pixels'; endpoint = 'pixels'; itemName = 'pixel'; }
                    if (deleteBtn.classList.contains('delete-bot-btn')) { type = 'bots'; endpoint = 'bots'; itemName = 'bot'; }
                    if (deleteBtn.classList.contains('delete-pressel-btn')) { type = 'pressels'; endpoint = 'pressels'; itemName = 'pressel'; }
                    if (deleteBtn.classList.contains('delete-utmify-btn')) { type = 'utmifyIntegrations'; endpoint = 'integrations/utmify'; itemName = 'integra√ß√£o Utmify'; }
                    if (deleteBtn.classList.contains('delete-checkout-btn')) { endpoint = 'checkouts'; itemName = 'checkout'; isGenericRefresh = false; refreshFunction = this.fetchAndRenderCheckouts; }
                    if (deleteBtn.classList.contains('delete-thankyou-btn')) { endpoint = 'thank-you-pages'; itemName = 'p√°gina de obrigado'; isGenericRefresh = false; refreshFunction = this.fetchAndRenderThankYouPages; }

                    if (!confirm(`Tem certeza que deseja excluir est${itemName.includes('integra√ß√£o') || itemName.includes('p√°gina') ? 'a' : 'e'} ${itemName}?`)) return;

                    const originalText = deleteBtn.textContent;
                    deleteBtn.textContent = 'Excluindo...';
                    deleteBtn.disabled = true;

                    try {
                        await this.apiRequest(`/api/${endpoint}/${id}`, 'DELETE');

                        // Se h√° um tipo e a lista existe no state, atualiza localmente s√≥ quando usamos o refresh gen√©rico.
                        // Observa√ß√£o: isGenericRefresh indica que n√£o foi atribu√≠da uma refresh espec√≠fica.
                        if (type && Array.isArray(this.state.data[type]) && isGenericRefresh) {
                            this.state.data[type] = this.state.data[type].filter(item => String(item.id) !== String(id));
                            // se voc√™ renderiza a partir do state, for√ßar re-render pode ser necess√°rio dependendo do framework
                            // ex: this.setState({ data: this.state.data }) ou this.renderList();
                        }

                        // Chama a fun√ß√£o de refresh (gen√©rica ou espec√≠fica). 
                        // use call(this) caso as fun√ß√µes dependam do contexto.
                        await refreshFunction.call(this);

                        this.showToast(`${itemName.charAt(0).toUpperCase() + itemName.slice(1)} exclu√≠d${itemName.includes('integra√ß√£o') || itemName.includes('p√°gina') ? 'a' : 'o'} com sucesso!`, 'success');
                    } catch (err) {
                        this.showToast(`Erro ao excluir ${itemName === 'integra√ß√£o Utmify' || itemName === 'p√°gina de obrigado' ? 'a' : 'o'} ${itemName}. Detalhes: ${err.message}`, 'error');
                        // Voc√™ pode reverter altera√ß√µes no state aqui se fez remo√ß√£o otimista
                    } finally {
                        // Restaura o bot√£o
                        deleteBtn.textContent = originalText;
                        deleteBtn.disabled = false;
                    }
                }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Date Filters
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const filterContainer = e.target.closest('#transactions-date-filter, #dashboard-date-filter');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (filterContainer) { const p=filterContainer.id.split('-')[0]; const b=e.target.closest('button'); if(b?.dataset.period){this.handleFilterChange(p,b.dataset.period);}else if(b?.id===`apply-custom-date-filter-${p}`){const sD=document.getElementById(`${p}-start-date`).value; const eD=document.getElementById(`${p}-end-date`).value; if(sD&&eD){this.handleFilterChange(p,'custom',sD,eD);}else{this.showToast('Selecione datas.','error');}}else if(b?.id===`clear-date-filter-${p}`){this.handleFilterChange(p,'all');} }
¬† ¬† ¬† ¬† ¬† ¬† };
¬†           listenerTarget.addEventListener('click', listenerTarget._clickListener); // Attach to document.body

            listenerTarget._submitListener = async (e) => {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const form = e.target.closest('form');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!form || ['loginForm', 'registerForm', 'checkout-form', 'thank-you-form'].includes(form.id)) return;

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† e.preventDefault();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const button = form.querySelector('button[type="submit"]');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const originalButtonText = button ? button.innerHTML : 'Salvar';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†if(button){ button.innerHTML = 'Salvando...'; button.disabled = true; }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† let data = Object.fromEntries(new FormData(form).entries());
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† try {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (form.id === 'pixSettingsForm') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† await this.apiRequest('/api/settings/pix', 'POST', data);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† App.state.data.settings = { ...App.state.data.settings, ...data };
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† this.showToast('Configura√ß√µes PIX salvas!', 'success');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†this.updateAllPixStatusIndicators();
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† else if (form.id === 'utmifySettingsForm') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const newIntegration = await this.apiRequest('/api/integrations/utmify', 'POST', data);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if(newIntegration) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† this.state.data.utmifyIntegrations.unshift(newIntegration);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†document.getElementById('modal-container').innerHTML = '';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† this.navigateTo('integrations');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† this.showToast('Conta Utmify adicionada!', 'success');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
                    else if (form.id === 'pixelForm') {
                        const newPixel = await this.apiRequest('/api/pixels', 'POST', data);
                        if (newPixel) { this.state.data.pixels.unshift(newPixel); this.navigateTo('pixels'); }
                    }
                    else if (form.id === 'botForm') {
                        const newBot = await this.apiRequest('/api/bots', 'POST', data);
                        if (newBot) { this.state.data.bots.unshift(newBot); this.showToast('Bot adicionado!', 'success'); }
                    }
                    else if (form.id === 'presselForm') {
                        console.log('Processando formul√°rio presselForm...');
                        const pixel_ids = Array.from(form.querySelectorAll('input[name="pixel_ids"]:checked')).map(cb => cb.value);
                        const deploy_to_netlify = form.querySelector('input[name="deploy_to_netlify"]').checked;
                        const netlify_site_name = form.querySelector('input[name="netlify_site_name"]')?.value || '';
                        
                        console.log('Dados do formul√°rio:', {
                            pixel_ids,
                            deploy_to_netlify,
                            netlify_site_name,
                            data
                        });
                        
                        // Valida√ß√£o de pixels
                        if (pixel_ids.length === 0) {
                            console.log('Erro: Nenhum pixel selecionado');
                            this.showToast('Selecione ao menos um pixel.', 'error');
                            return;
                        }
                        
                        // Valida√ß√µes espec√≠ficas para Netlify
                        if (deploy_to_netlify) {
                            if (!netlify_site_name.trim()) {
                                console.log('Erro: Nome do site Netlify n√£o fornecido');
                                this.showToast('Digite o nome do site para o deploy no Netlify.', 'error');
                                return;
                            }
                            
                            if (!App.state.data.settings?.netlify_access_token) {
                                this.showToast('Token do Netlify n√£o configurado. Por favor, valide seu token nas configura√ß√µes.', 'error');
                                return;
                            }
                            
                            // Valida√ß√£o do formato do nome do site
                            const siteName = netlify_site_name.trim();
                            const validNameRegex = /^[a-zA-Z0-9-]+$/;
                            
                            if (!validNameRegex.test(siteName)) {
                                this.showToast('Nome do site deve conter apenas letras, n√∫meros e h√≠fens.', 'error');
                                return;
                            }
                            
                            if (siteName.length > 37) {
                                this.showToast('Nome do site deve ter no m√°ximo 37 caracteres.', 'error');
                                return;
                            }
                            
                            if (siteName.startsWith('-') || siteName.endsWith('-')) {
                                this.showToast('Nome do site n√£o pode come√ßar ou terminar com h√≠fen.', 'error');
                                return;
                            }
                        }
                        
                        // Se chegou at√© aqui, todas as valida√ß√µes passaram
                        try {
                            const payload = { ...data, pixel_ids, deploy_to_netlify, netlify_site_name };
                            console.log('Payload sendo enviado:', payload);
                            
                            if (deploy_to_netlify) {
                                this.showToast('üöÄ Fazendo deploy no Netlify...', 'success');
                            }
                            
                            const newPressel = await this.apiRequest('/api/pressels', 'POST', payload);
                            if (!newPressel) return;

                            // Valida√ß√£o extra: se solicitou deploy Netlify, URL deve existir
                            if (deploy_to_netlify && !newPressel.netlify_url) {
                                this.showToast('Falha no deploy Netlify: URL n√£o gerada.', 'error');
                                return;
                            }

                            this.state.data.pressels.unshift(newPressel);
                            this.navigateTo('pressels');

                            if (newPressel.netlify_url) {
                                this.showToast(`‚úÖ Deploy realizado! URL: ${newPressel.netlify_url}`, 'success');
                            } else {
                                this.showToast('Pressel criada com sucesso!', 'success');
                            }
                        } catch (error) {
                            console.error('Erro ao criar pressel:', error);
                            this.showToast('Ocorreu um erro ao criar a pressel. Por favor, tente novamente.', 'error');
                        }
                    }
                    else if (form.id === 'domain-form') {
                        e.preventDefault();
                        await this.addDomain();
                    }
                    else if (form.id === 'modal-domain-form') {
                        e.preventDefault();
                        await this.addModalDomain();
                    }
                    else if (form.id === 'checkoutForm') {
                        const packages = [];
                        const packageTitles = form.querySelectorAll('input[name="package_title[]"]');
                        const packageDescriptions = form.querySelectorAll('input[name="package_description[]"]');
                        const packageValues = form.querySelectorAll('input[name="package_value_cents[]"]');
                        
                        for (let i = 0; i < packageTitles.length; i++) {
                            if (packageTitles[i].value && packageDescriptions[i].value && packageValues[i].value) {
                                packages.push({
                                    title: packageTitles[i].value,
                                    description: packageDescriptions[i].value,
                                    value_cents: parseInt(packageValues[i].value)
                                });
                            }
                        }
                        
                        if (packages.length === 0) {
                            this.showToast('Adicione pelo menos um pacote.', 'error');
                            return;
                        }
                        
                        const payload = {
                            name: data.name,
                            content: {
                                main_title: data.main_title,
                                subtitle: data.subtitle,
                                media_url: data.media_url || null
                            },
                            pricing: {
                                packages: packages
                            }
                        };
                        
                        const newCheckout = await this.apiRequest('/api/checkouts/create-hosted', 'POST', payload);
                        if (newCheckout) {
                            this.state.data.checkouts = this.state.data.checkouts || [];
                            this.state.data.checkouts.unshift(newCheckout);
                            this.navigateTo('checkouts');
                            this.showToast('Checkout criado com sucesso!', 'success');
                        }
                    }
                    else if (form.id === 'thankYouPageForm') {
                        const payload = {
                            page_name: data.page_name,
                            purchase_value: parseInt(data.purchase_value),
                            pixel_id: data.pixel_id || null,
                            redirect_url: data.redirect_url,
                            utmify_integration_id: data.utmify_integration_id || null
                        };
                        
                        const newPage = await this.apiRequest('/api/thank-you-pages/create', 'POST', payload);
                        if (newPage) {
                            this.state.data.thankYouPages = this.state.data.thankYouPages || [];
                            this.state.data.thankYouPages.unshift(newPage);
                            this.navigateTo('thank-you-pages');
                            this.showToast('P√°gina de obrigado criada com sucesso!', 'success');
                        }
                    }
                } catch(e) { /* Errors are handled by apiRequest */ }
                finally {
                    if(button) {
                        button.innerHTML = originalButtonText;
                        button.disabled = false;
                    }
                }
            };
            listenerTarget.addEventListener('submit', listenerTarget._submitListener); // <<<====== PUT IT RIGHT HERE
            
            document.addEventListener('change', e => {
                // Controle do input Netlify
                if (e.target.id === 'deploy_to_netlify') {
                    const netlifyContainer = document.getElementById('netlify-site-name-container');
                    if (netlifyContainer) {
                        if (e.target.checked) {
                            netlifyContainer.classList.remove('hidden');
                        } else {
                            netlifyContainer.classList.add('hidden');
                            // Limpar valida√ß√£o quando esconder
                            const validationError = document.getElementById('netlify-validation-error');
                            if (validationError) {
                                validationError.classList.add('hidden');
                                validationError.textContent = '';
                            }
                        }
                    }
                }

                if (e.target.id === 'value-type-selector') {
                    const container = document.getElementById('fixed-value-container');
                    if (container) {
                        container.style.display = e.target.value === 'fixed' ? 'block' : 'none';
                    }
                }

                if (e.target.id === 'flow-type-selector') {
                    const container = document.getElementById('flow-config-container');
                    if (!container) return;
                    
                    if (e.target.value === 'pix_flow') {
                        container.innerHTML = `
                            <h4 class="text-md font-semibold mt-2 mb-1 text-sky-400">Conte√∫do da Mensagem</h4>
                             <input id="mass-message-image-url" type="url" class="form-input w-full p-2" placeholder="URL da Imagem (Opcional)">
                            <textarea id="mass-message-initial-text" class="form-input w-full p-2 mt-2" rows="3" placeholder="Mensagem principal... Ex: Ol√°, gere seu PIX abaixo."></textarea>
                            <input id="mass-message-cta-button-text" class="form-input w-full p-2 mt-2" placeholder="Texto do Bot√£o (Ex: Gerar PIX Agora)">
                            <h4 class="text-md font-semibold mt-4 mb-1 text-sky-400">Valor do PIX</h4>
                            <input id="mass-message-pix-value" type="number" step="0.01" class="form-input w-full p-2" placeholder="Valor em REAIS (Ex: 19.90)">
                        `;
                    } else { // external_link
                        container.innerHTML = `
                            <h4 class="text-md font-semibold mt-2 mb-1 text-sky-400">Conte√∫do da Mensagem</h4>
                             <input id="mass-message-image-url" type="url" class="form-input w-full p-2" placeholder="URL da Imagem (Opcional)">
                            <textarea id="mass-message-initial-text" class="form-input w-full p-2 mt-2" rows="3" placeholder="Mensagem principal..."></textarea>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <input id="mass-message-cta-button-text" class="form-input w-full p-2" placeholder="Texto do Bot√£o (Ex: Acessar Site)">
                                <input id="mass-message-external-url" type="url" class="form-input w-full p-2" placeholder="https://seu-link.com">
                            </div>
                        `;
                    }
                }
            });
            // Event listener para input do Netlify
            document.addEventListener('input', e => {
                if (e.target.id === 'netlify_site_name') {
                    const charCount = document.getElementById('netlify-char-count');
                    const validationError = document.getElementById('netlify-validation-error');
                    const value = e.target.value;
                    const charCountValue = value.length;
                    
                    // Atualizar contador de caracteres
                    if (charCount) {
                        charCount.textContent = `${charCountValue}/37`;
                    }
                    
                    // Valida√ß√£o em tempo real
                    const validNameRegex = /^[a-zA-Z0-9-]*$/;
                    let errorMessage = '';
                    
                    if (value.length > 0) {
                        if (!validNameRegex.test(value)) {
                            errorMessage = 'Apenas letras, n√∫meros e h√≠fens s√£o permitidos.';
                        } else if (value.startsWith('-') || value.endsWith('-')) {
                            errorMessage = 'Nome n√£o pode come√ßar ou terminar com h√≠fen.';
                        } else if (value.length > 37) {
                            errorMessage = 'M√°ximo 37 caracteres permitidos.';
                        }
                    }
                    
                    if (validationError) {
                        if (errorMessage) {
                            validationError.textContent = errorMessage;
                            validationError.classList.remove('hidden');
                            e.target.classList.add('border-red-500');
                            e.target.classList.remove('border-slate-500');
                        } else {
                            validationError.classList.add('hidden');
                            e.target.classList.remove('border-red-500');
                            e.target.classList.add('border-slate-500');
                        }
                    }
                }
            });
        },

        // Adicionada sobrecarga para aceitar headers customizados
// Adicionada sobrecarga para aceitar headers customizados
¬† ¬† ¬† ¬† async apiRequest(endpoint, method = 'GET', body = null, customHeaders = {}, options = {}) {
            const { skipAuthRetry = false } = options;
¬† ¬† ¬† ¬† ¬† ¬† try {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const headers = { 'Content-Type': 'application/json', ...customHeaders }; // Mescla headers customizados
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (this.state.token) { headers['Authorization'] = `Bearer ${this.state.token}`; }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† // Mant√©m a l√≥gica de adicionar x-api-key se necess√°rio E n√£o foi fornecido um customizado
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const apiKeyRequired = endpoint.includes('/api/checkouts/create-hosted') ||
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†(endpoint.includes('/api/checkouts/') && method === 'PUT') ||
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†endpoint.includes('/api/thank-you-pages/create') ||
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†(endpoint.includes('/api/thank-you-pages/') && method === 'PUT');

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (this.state.data.settings?.api_key && apiKeyRequired && !headers['x-api-key']) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† headers['x-api-key'] = this.state.data.settings.api_key;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const requestOptions = { method, headers };
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (body) { requestOptions.body = JSON.stringify(body); }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const response = await fetch(`${this.state.API_BASE_URL}${endpoint}`, requestOptions);

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (response.status === 204) return null; // No Content

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† const responseBody = await response.text(); // L√™ como texto primeiro
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† let data;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† try {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† data = JSON.parse(responseBody); // Tenta parsear como JSON
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } catch (jsonError) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!response.ok) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† console.error(`API Error ${response.status} on ${method} ${endpoint}. Response: ${responseBody}`);
                        const err = new Error(responseBody || `Erro ${response.status}`);
                        err.status = response.status;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† throw err;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† data = responseBody;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }

¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (!response.ok) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† console.error(`API Error ${response.status} on ${method} ${endpoint}:`, data);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† let errorMsg = 'Erro desconhecido da API.';
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† if (data && data.message) {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†errorMsg = data.message;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† } else if (typeof data === 'string') {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†errorMsg = data; // Usa o texto da resposta como mensagem de erro
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
                    const err = new Error(errorMsg);
                    err.status = response.status;
                    if (data && data.code) {
                        err.code = data.code;
                    }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† throw err;
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† return data;
            } catch (error) {
                 if (error instanceof Error) {
                    const statusCode = error.status;
                    const errorCode = error.code;
                    const isAuthError = statusCode === 401 || statusCode === 403;
                    const isPublicRoute =
                        endpoint.includes('/sellers/login') ||
                        endpoint.startsWith('/oferta/') ||
                        endpoint.startsWith('/obrigado/') ||
                        endpoint.includes('/api/auth/refresh') ||
                        endpoint.includes('/api/auth/logout');

                    // Tentar refresh em TODOS os casos de 401/403, n√£o apenas quando looksExpired
                    const canRetryAuth =
                        !skipAuthRetry &&
                        (statusCode === 401 || statusCode === 403) &&
                        !endpoint.includes('/api/auth/refresh') &&
                        !endpoint.includes('/api/auth/logout') &&
                        !endpoint.includes('/api/sellers/login');

                    if (canRetryAuth) {
                        console.log(`[API] Tentando renovar token ap√≥s erro ${statusCode}...`);
                        const refreshed = await this.tryRefreshToken();
                        if (refreshed) {
                            console.log(`[API] Token renovado, repetindo requisi√ß√£o...`);
                            return this.apiRequest(endpoint, method, body, customHeaders, { ...options, skipAuthRetry: true });
                        } else {
                            console.warn(`[API] Falha ao renovar token ap√≥s erro ${statusCode}.`);
                        }
                    }

                    // S√≥ mostrar toast e fazer logout se n√£o conseguiu renovar
                    const refreshToken = this.state.refreshToken || this.getRefreshToken();
                    const shouldLogout = isAuthError && !isPublicRoute && !refreshToken;
                    
                    if (shouldLogout) {
                        console.warn(`[API Auth Error] Status ${statusCode} no endpoint '${endpoint}' e sem refresh token. Deslogando...`);
                        this.showToast('Sess√£o expirada. Por favor, fa√ßa login novamente.', 'error');
                        await this.logout();
                    } else if (isAuthError && !isPublicRoute) {
                        // Se tem refresh token mas falhou, n√£o mostra toast de erro gen√©rico
                        // O erro j√° foi tratado acima
                        console.warn(`[API Auth Error] Status ${statusCode} no endpoint '${endpoint}'.`);
                    } else {
                        this.showToast(error.message, 'error');
                    }
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†} else {
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† console.error(`Network Error on ${method} ${endpoint}:`, error);
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† this.showToast('Falha na conex√£o com o servidor.', 'error');
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†}
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬†throw error; // Re-throw para quem chamou poder tratar
¬† ¬† ¬† ¬† ¬† ¬† }
¬† ¬† ¬† ¬† },

        async tryRefreshToken() {
            // Se j√° est√° fazendo refresh, aguarda o refresh em andamento
            if (this.isRefreshing) {
                console.log('[Auth] Refresh j√° em andamento, aguardando...');
                // Aguarda at√© 5 segundos pelo refresh em andamento
                let waitCount = 0;
                while (this.isRefreshing && waitCount < 50) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    waitCount++;
                }
                // Verifica se o refresh foi bem-sucedido
                const token = this.state.token || this.getToken();
                return !!token;
            }

            const refreshToken = this.state.refreshToken || this.getRefreshToken();
            if (!refreshToken) {
                console.warn('[Auth] Nenhum refresh token dispon√≠vel para renovar.');
                return false;
            }

            this.isRefreshing = true;
            const apiBaseUrl = this.state.API_BASE_URL || window.location.origin;

            try {
                console.log('[Auth] Tentando renovar token...');
                const response = await fetch(`${apiBaseUrl}/api/auth/refresh`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refreshToken }),
                });

                let data = null;
                try {
                    data = await response.json();
                } catch (parseErr) {
                    console.warn('[Auth] Resposta inesperada ao renovar token.', parseErr);
                }

                if (!response.ok) {
                    console.warn('[Auth] Falha ao renovar token:', data);
                    if (data?.code === 'REFRESH_TOKEN_EXPIRED' || data?.code === 'REFRESH_TOKEN_INVALID' || data?.code === 'REFRESH_TOKEN_NOT_FOUND') {
                        console.warn('[Auth] Refresh token inv√°lido ou expirado, limpando tokens.');
                        this.clearAuthTokens();
                    }
                    return false;
                }

                if (data?.token || data?.accessToken) {
                    const newToken = data.token || data.accessToken;
                    this.setToken(newToken);
                    console.log('[Auth] Token renovado com sucesso.');
                }
                if (data?.refreshToken) {
                    this.setRefreshToken(data.refreshToken);
                }

                // Reagenda refresh autom√°tico ap√≥s sucesso
                this.scheduleTokenRefresh();

                return true;
            } catch (error) {
                console.error('[Auth] Erro ao tentar renovar token:', error);
                return false;
            } finally {
                this.isRefreshing = false;
            }
        },
        
        async login(email, password) {
            try {
                const data = await this.apiRequest('/api/sellers/login', 'POST', { email, password });
                this.setToken(data.token); // Usa fun√ß√£o segura para armazenar token
                if (data.refreshToken) {
                    this.setRefreshToken(data.refreshToken);
                }
                window.location.href = window.location.pathname; 
            } catch (e) {
                if (e.response && e.response.status === 403 && e.response.data && e.response.data.requiresVerification) {
                    this.showToast('Email n√£o verificado. Verifique sua caixa de entrada.', 'error');
                    this.showVerificationScreen(email);
                } else {
                    console.error('Erro no login:', e);
                }
            }
        },

        async loginWithGoogle() {
            try {
                // Obter URL de autoriza√ß√£o do Google
                const response = await fetch('/api/auth/google/url');
                const { authUrl } = await response.json();
                
                // Usar redirecionamento em vez de popup para evitar problemas de CORS
                window.location.href = authUrl;
                
            } catch (error) {
                console.error('Erro no login com Google:', error);
                this.showToast('Erro ao iniciar login com Google', 'error');
            }
        },

        
        async register(name, email, password, phone) {
            try {
                const data = await this.apiRequest('/api/sellers/register', 'POST', { name, email, password, phone });
                
                if (data.requiresVerification) {
                    this.showToast('Cadastro realizado! Verifique seu email para ativar a conta.', 'success');
                    // Mostrar tela de verifica√ß√£o
                    this.showVerificationScreen(email);
                } else {
                    this.showToast('Cadastro realizado com sucesso!', 'success');
                }

            } catch (e) {
                console.error('Erro no registro:', e);
            }
        },

        showVerificationScreen(email) {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="flex items-center justify-center min-h-screen p-4">
                    <div class="card p-8 rounded-2xl shadow-lg w-full max-w-md animate-fade-in">
                        <div class="text-center mb-8">
                            <div class="flex items-center justify-center gap-2 mb-4">
                                <svg class="h-10 w-10 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" />
                                </svg>
                                <h1 class="text-4xl font-bold text-white">HotTrack</h1>
                            </div>
                            <h2 class="text-2xl font-bold text-white mb-2">Verifique seu Email</h2>
                            <p class="text-slate-400">Enviamos um link de verifica√ß√£o para:</p>
                            <p class="text-sky-400 font-semibold">${email}</p>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="bg-slate-800 p-4 rounded-lg">
                                <h3 class="font-semibold text-white mb-2">Pr√≥ximos passos:</h3>
                                <ol class="text-sm text-gray-300 space-y-1">
                                    <li>1. Verifique sua caixa de entrada</li>
                                    <li>2. Clique no link de verifica√ß√£o</li>
                                    <li>3. Volte aqui e fa√ßa login</li>
                                </ol>
                            </div>
                            
                            <div class="text-center">
                                <button id="resend-verification" class="btn text-sm py-2 px-4 mr-2">Reenviar Email</button>
                                <button id="back-to-login" class="btn btn-secondary text-sm py-2 px-4">Voltar ao Login</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Event listeners
            document.getElementById('resend-verification').addEventListener('click', () => {
                this.resendVerification(email);
            });
            
            document.getElementById('back-to-login').addEventListener('click', () => {
                this.renderLogin('login');
            });
        },

        async resendVerification(email) {
            try {
                const data = await this.apiRequest('/api/sellers/resend-verification', 'POST', { email });
                this.showToast('Email de verifica√ß√£o reenviado!', 'success');
            } catch (error) {
                console.error('Erro ao reenviar verifica√ß√£o:', error);
                this.showToast('Erro ao reenviar email. Tente novamente.', 'error');
            }
        },

        async logout(shouldReload = true) {
            const apiBaseUrl = this.state.API_BASE_URL || window.location.origin;
            const refreshToken = this.state.refreshToken || this.getRefreshToken();

            if (refreshToken) {
                try {
                    await fetch(`${apiBaseUrl}/api/auth/logout`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ refreshToken })
                    });
                } catch (error) {
                    console.warn('[Auth] Falha ao informar logout ao servidor:', error);
                }
            }

            this.clearAuthTokens();
            this.state.editingCheckoutId = null;
            this.state.editingThankYouPageId = null;
            this.state.pixPollingIntervalId = null; // Limpa o ID do polling

            const providers = ['pushinpay', 'cnpay', 'oasyfy', 'syncpay', 'brpix', 'wiinpay'];
            providers.forEach(p => {
                localStorage.removeItem(`pix_status_${p}`);
                localStorage.removeItem(`pix_timestamp_${p}`);
            });

            if (shouldReload) {
                window.location.reload();
            }
        },

        showAddUtmifyModal() {
            const modalContent = `
                <form id="utmifySettingsForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Nome da Conta</label>
                        <input name="account_name" type="text" placeholder="Ex: Produto X - Utmify" class="form-input w-full p-2" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-1">Token da API Utmify (x-api-token)</label>
                        <input name="api_token" type="password" class="form-input w-full p-2" required>
                    </div>
                    <div class="pt-2">
                        <button type="submit" class="btn w-full p-2 font-bold rounded-md">Salvar Integra√ß√£o</button>
                    </div>
                </form>
            `;
            document.getElementById('modal-container').innerHTML = this.templates.modal('Adicionar Conta Utmify', modalContent);
        },
        async viewDispatchDetails(logId) {
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = this.templates.modal(`Relat√≥rio do Disparo #${logId}`, '<p>Carregando detalhes...</p>');
            
            try {
                const details = await this.apiRequest(`/api/dispatches/${logId}`);
                const rows = details.map(d => `
                    <tr>
                        <td>${d.first_name || 'N/A'} ${d.username ? `(@${d.username})` : ''}</td>
                        <td class="${d.status === 'success' ? 'text-green-400' : 'text-red-400'}">${d.status === 'success' ? 'Enviado' : 'Falhou'}</td>
                        <td class="text-xs text-gray-500">${d.details || 'OK'}</td>
                    </tr>
                `).join('');

                const content = `
                    <div class="max-h-96 overflow-y-auto">
                        <table class="table-custom w-full text-sm">
                            <thead><tr><th>Contato</th><th>Status</th><th>Detalhes</th></tr></thead>
                            <tbody>${rows.length ? rows : '<tr><td colspan="3">Nenhum detalhe encontrado.</td></tr>'}</tbody>
                        </table>
                    </div>`;
                modalContainer.innerHTML = this.templates.modal(`Relat√≥rio do Disparo #${logId}`, content);
            } catch(e) {
                 modalContainer.innerHTML = this.templates.modal(`Relat√≥rio do Disparo #${logId}`, '<p class="text-red-400">Erro ao carregar detalhes.</p>');
            }
        },
        
        async navigateTo(page) {
    // L√≥gica de limpeza de estado
    if (App.state.currentPage === 'pageCreator' && page !== 'pageCreator') {
        App.state.editingCheckoutId = null;
    }
    if (App.state.currentPage === 'thankYouCreator' && page !== 'thankYouCreator') {
        App.state.editingThankYouPageId = null;
    }

    App.state.currentPage = page;
    // Salvar a p√°gina atual no localStorage para restaurar ap√≥s F5
    localStorage.setItem('app-currentPage', page);
    this.clearAllSectionPolling();
    
    const contentContainer = document.getElementById('content');
    if (!contentContainer) { console.error("Container #content n√£o encontrado."); return; }
    if (!this.templates[page]) { console.error(`Template para a p√°gina "${page}" n√£o encontrado.`); contentContainer.innerHTML = `<p class="text-red-500 p-8">Erro: Template da p√°gina "${page}" n√£o definido.</p>`; return; }

    contentContainer.innerHTML = `<div class="flex items-center justify-center h-full"><svg class="animate-spin h-6 w-6 text-sky-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg></div>`;

    // O layout agora √© consistente, controlado pelo CSS do <main>.
    contentContainer.classList.add('overflow-y-auto', 'p-4', 'md:p-8');
    contentContainer.classList.remove('overflow-hidden');

    // L√≥gica de limpeza do React/HotBot
    if (page !== 'hotbot' && window.hotBotRoot) {
        window.hotBotRoot.unmount();
        window.hotBotRoot = null;
    }

    setTimeout(async () => {
        try {
            contentContainer.innerHTML = this.templates[page](); // Renderiza o template HTML
            document.querySelectorAll('.nav-link[data-target]').forEach(item => item.classList.toggle('active', item.dataset.target === page));

            // L√≥gica de inicializa√ß√£o de TODAS as p√°ginas
            if (page === 'hotbot') {
                // L√≥gica de inicializa√ß√£o do HotBot
                const container = document.getElementById('hotbot-container');
                if (container) {
                    if (window.hotBotRoot) window.hotBotRoot.unmount();
                    launchHotBot(container);
                }
            } 
            // L√≥gica de inicializa√ß√£o das outras p√°ginas
            else if (page === 'dashboard') { this.handleFilterChange(page, this.state.dateFilter.period || 'last7days'); }
            else if (page === 'transactions') { await this.fetchTransactions(); this.handleFilterChange(page, this.state.dateFilter.period || 'all'); } 
            else if (page === 'settings') { this.updateAllPixStatusIndicators(); }
            else if (page === 'pageCreator') { await this.initCreatorPage(); }
            else if (page === 'thankYouCreator') { await this.initThankYouCreatorPage(); }
            else if (page === 'thankYouPages') { await this.fetchAndRenderThankYouPages(); }
            else if (page === 'checkouts') { await this.fetchAndRenderCheckouts(); }

        } catch (renderError) {
            console.error(`Erro ao renderizar ou inicializar a p√°gina "${page}":`, renderError);
            contentContainer.innerHTML = `<p class="text-center text-red-400 p-8">Erro ao carregar a se√ß√£o ${page}. Verifique o console.</p>`;
        }
    }, 10);
},
        
        async fetchDashboardMetrics() {
            try {
                const { startDate, endDate } = this.state.dateFilter;
                const query = new URLSearchParams({ 
                    startDate: startDate || '',
                    endDate: endDate || ''
                }).toString();
                
                const metrics = await this.apiRequest(`/api/dashboard/metrics?${query}`);
                this.state.data.dashboard = metrics;

                document.getElementById('metric-clicks').textContent = this.formatNumber(metrics.total_clicks);
                document.getElementById('metric-generated').textContent = this.formatNumber(metrics.total_pix_generated);
                document.getElementById('metric-paid').textContent = this.formatNumber(metrics.total_pix_paid);
                document.getElementById('metric-total-revenue').textContent = this.formatNumber(metrics.total_revenue, true);
                document.getElementById('metric-paid-revenue').textContent = this.formatNumber(metrics.paid_revenue, true);
                
                const botsTableBody = document.getElementById('bots-performance-table');
                if (botsTableBody && metrics.bots_performance && metrics.bots_performance.length > 0) {
                    botsTableBody.innerHTML = metrics.bots_performance.map(b => `
                        <tr class="hover:bg-slate-800/50">
                            <td>${b.bot_name}</td>
                            <td>${this.formatNumber(b.total_clicks)}</td>
                            <td>${this.formatNumber(b.total_pix_paid)}</td>
                            <td>${this.formatNumber(b.paid_revenue, true)}</td>
                        </tr>`).join('');
                } else if(botsTableBody) {
                    botsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-500 py-8">Nenhum dado de bot.</td></tr>';
                }

                const trafficTableBody = document.getElementById('traffic-by-state-table');
                if (trafficTableBody && metrics.clicks_by_state && metrics.clicks_by_state.length > 0) {
                    trafficTableBody.innerHTML = metrics.clicks_by_state.map(s => `<tr class="hover:bg-slate-800/50"><td>${s.state}</td><td>${this.formatNumber(s.total_clicks)}</td></tr>`).join('');
                } else if(trafficTableBody){
                    trafficTableBody.innerHTML = '<tr><td colspan="2" class="text-center text-gray-500 py-8">Nenhum tr√°fego registrado.</td></tr>';
                }
                
                this.renderRevenueChart();
                this.fetchAchievementsAndRanking();
            } catch (e) { console.error("Erro ao carregar m√©tricas do painel:", e); }
        },
        
        async fetchAchievementsAndRanking() {
            try {
                const data = await this.apiRequest('/api/dashboard/achievements-and-ranking');
                
                const achievementsList = document.getElementById('achievements-list');
                const paidRevenue = this.state.data.dashboard.paid_revenue || 0;

                if (achievementsList && data.userAchievements.length > 0) {
                    achievementsList.innerHTML = data.userAchievements.map(ach => {
                        const icon = ach.is_completed ? '‚úÖ' : 'üîí';
                        const textColor = ach.is_completed ? 'text-green-400' : 'text-gray-400';
                        const missingAmount = ach.sales_goal / 100 - paidRevenue;
                        const formattedMissing = missingAmount > 0 ? `Falta ${this.formatNumber(missingAmount, true)}` : 'Conclu√≠da!';
                        
                        return `
                            <div class="card p-4 rounded-lg flex items-center gap-3 bg-slate-900/50">
                                <span class="text-2xl">${icon}</span>
                                <div>
                                    <p class="font-semibold text-white">${ach.title}</p>
                                    <p class="text-xs ${textColor}">${formattedMissing}</p>
                                </div>
                            </div>`;
                    }).join('');
                } else if(achievementsList) {
                    achievementsList.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma conquista dispon√≠vel ainda.</p>';
                }

                const rankingList = document.getElementById('ranking-list');
                if (rankingList && data.topSellersRanking.length > 0) {
                    rankingList.innerHTML = data.topSellersRanking.map((seller, index) => {
                        const rank = index + 1;
                        const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `${rank}.`;
                        const revenue = this.formatNumber(seller.total_revenue, true);
                        return `<div class="p-2 bg-slate-900/50 rounded-lg flex justify-between items-center"><span class="font-bold text-lg w-8 text-center">${medal}</span><span class="text-sm flex-1">${seller.name}</span><span class="text-xs text-gray-400">${revenue}</span></div>`;
                    }).join('');
                } else if (rankingList){
                    rankingList.innerHTML = '<p class="text-gray-500 text-sm">Nenhum dado de ranking ainda.</p>';
                }

                const userRankStatus = document.getElementById('user-rank-status');
                if(userRankStatus) userRankStatus.textContent = `Sua posi√ß√£o no ranking: ${data.currentUserRank}¬∞`;

            } catch (e) {
                console.error("Erro ao carregar conquistas e ranking:", e);
            }
        },

        async fetchTransactions(page = this.state.transactionsPagination.page) {
            const tableBody = document.getElementById('transactions-table-body');
            if (!tableBody) { console.warn("Transactions table body not found."); return; }
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-8">Carregando transa√ß√µes...</td></tr>';

            try {
                const { startDate, endDate } = this.state.dateFilter;
                const queryParams = new URLSearchParams({ 
                    startDate: startDate || '', 
                    endDate: endDate || '',
                    page: page,
                    limit: this.state.transactionsPagination.limit
                });
                const response = await this.apiRequest(`/api/transactions?${queryParams.toString()}`);
                
                // Extrair array de transa√ß√µes da resposta
                // Compatibilidade: se for array direto (formato antigo) ou objeto com transactions (formato novo)
                const transactions = Array.isArray(response) ? response : (response.transactions || []);
                
                // Salvar informa√ß√µes de pagina√ß√£o
                if (response.pagination) {
                    this.state.transactionsPagination = {
                        page: response.pagination.page,
                        totalPages: response.pagination.totalPages,
                        total: response.pagination.total,
                        limit: response.pagination.limit
                    };
                }
                
                this.state.data.transactions = transactions;
                this.renderTransactionsTable();
                this.renderTransactionsPagination();
            } catch (e) {
                console.error("Erro ao buscar transa√ß√µes:", e);
                if (tableBody) tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-red-400 py-8">Erro ao carregar transa√ß√µes.</td></tr>';
            }
        },

        renderTransactionsTable() {
            const tableBody = document.getElementById('transactions-table-body');
            if (!tableBody) return;
            const transactionsToRender = this.state.data.transactions || [];
            if (transactionsToRender.length > 0) {
                tableBody.innerHTML = transactionsToRender.map(t => {
                    const statusClass = t.status === 'paid' ? 'text-green-400 bg-green-500/10' : 'text-yellow-400 bg-yellow-500/10';
                    const statusText = t.status === 'paid' ? 'Pago' : 'Pendente';
                    const formattedValue = this.formatNumber(t.pix_value, true);
                    const formattedDate = t.created_at ? new Date(t.created_at).toLocaleString('pt-BR') : 'Data inv√°lida';
                    const sourceName = t.source_name || 'Desconhecida';
                    const providerName = t.provider ? t.provider.toUpperCase() : 'N/A';
                    return `<tr class="hover:bg-slate-800/50">
                                <td><span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass}">${statusText}</span></td>
                                <td>${formattedValue}</td><td>${sourceName}</td><td>${providerName}</td><td>${formattedDate}</td>
                            </tr>`;
                }).join('');
            } else {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-500 py-8">Nenhuma transa√ß√£o encontrada para o per√≠odo selecionado.</td></tr>';
            }
        },

        renderTransactionsPagination() {
            const pagination = this.state.transactionsPagination;
            if (pagination.totalPages <= 1) {
                const container = document.getElementById('transactions-pagination-container');
                if (container) container.innerHTML = '';
                return;
            }
            
            const container = document.getElementById('transactions-pagination-container');
            if (!container) return;
            
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; padding: 1rem;">
                    <button 
                        class="btn btn-secondary" 
                        onclick="App.fetchTransactions(${pagination.page - 1})"
                        ${pagination.page === 1 ? 'disabled' : ''}
                    >
                        Anterior
                    </button>
                    <span style="color: var(--text-secondary);">
                        P√°gina ${pagination.page} de ${pagination.totalPages} (${pagination.total} total)
                    </span>
                    <button 
                        class="btn btn-secondary" 
                        onclick="App.fetchTransactions(${pagination.page + 1})"
                        ${pagination.page === pagination.totalPages ? 'disabled' : ''}
                    >
                        Pr√≥ximo
                    </button>
                </div>
            `;
        },

       handleFilterChange(page, period, customStartDate, customEndDate) {
            const now = new Date();
            let startDate, endDate;

            const setTimeToStartOfDay = (date) => {
                date.setHours(0, 0, 0, 0);
                return date;
            };
            const setTimeToEndOfDay = (date) => {
                date.setHours(23, 59, 59, 999);
                return date;
            };

            switch(period) {
                case 'today':
                    startDate = setTimeToStartOfDay(new Date());
                    endDate = setTimeToEndOfDay(new Date());
                    break;
                case 'yesterday':
                    const yesterday = new Date();
                    yesterday.setDate(now.getDate() - 1);
                    startDate = setTimeToStartOfDay(yesterday);
                    endDate = setTimeToEndOfDay(yesterday);
                    break;
                case 'last7days':
                    endDate = setTimeToEndOfDay(new Date());
                    const sevenDaysAgo = new Date();
                    sevenDaysAgo.setDate(now.getDate() - 6);
                    startDate = setTimeToStartOfDay(sevenDaysAgo);
                    break;
                case 'thisMonth':
                    startDate = setTimeToStartOfDay(new Date(now.getFullYear(), now.getMonth(), 1));
                    endDate = setTimeToEndOfDay(new Date(now.getFullYear(), now.getMonth() + 1, 0));
                    break;
                case 'custom':
                    if (customStartDate) startDate = new Date(customStartDate + 'T00:00:00');
                    if (customEndDate) endDate = new Date(customEndDate + 'T23:59:59.999');
                    break;
                default:
                    startDate = null; endDate = null;
            }

            this.state.dateFilter = { 
                period, 
                startDate: startDate ? startDate.toISOString() : null, 
                endDate: endDate ? endDate.toISOString() : null
            };
            
            const filterContainer = document.getElementById(`${page}-date-filter`);
            if (filterContainer) {
                filterContainer.querySelectorAll('button[data-period]').forEach(btn => btn.classList.toggle('active', btn.dataset.period === period));
            }

            if (page === 'dashboard') this.fetchDashboardMetrics();
            else if (page === 'transactions') {
                this.state.transactionsPagination.page = 1;
                this.fetchTransactions(1);
            }
        },
        
        renderRevenueChart() {
            const ctx = document.getElementById('revenueChart');
            if (!ctx) return;
            const rawData = this.state.data.dashboard.daily_revenue || [];
            const labels = rawData.map(item => new Date(item.date).toLocaleDateString('pt-BR', {timeZone: 'UTC'}));
            const revenues = rawData.map(item => item.revenue);
            
            if (this.state.revenueChart) this.state.revenueChart.destroy();

            this.state.revenueChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Faturamento Pago',
                        data: revenues,
                        backgroundColor: (context) => {
                            const { ctx, chartArea } = context.chart;
                            if (!chartArea) return null;
                            const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                            gradient.addColorStop(0, 'rgba(56, 189, 248, 0)');
                            gradient.addColorStop(1, 'rgba(56, 189, 248, 0.3)');
                            return gradient;
                        },
                        borderColor: '#38bdf8', borderWidth: 2, tension: 0.4, fill: true,
                        pointBackgroundColor: '#38bdf8', pointRadius: 4, pointHoverRadius: 6,
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: true,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#94a3b8' }, grid: { color: 'rgba(51, 65, 85, 0.5)' } },
                        x: { ticks: { color: '#94a3b8' }, grid: { display: false } }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#0f172a', titleColor: '#f1f5f9', bodyColor: '#cbd5e1',
                            borderColor: '#334155', borderWidth: 1,
                            callbacks: { label: (context) => `Faturamento: ${this.formatNumber(context.raw, true)}` }
                        }
                    }
                }
            });
        },
        generatePresselCode(pressel) {
            const { settings, pixels } = this.state.data;
            const presselPixelIds = Array.isArray(pressel.pixel_ids) ? pressel.pixel_ids : [];
            const selectedPixels = pixels.filter(p => presselPixelIds.includes(p.id));
            const pixelsToTrackJSON = JSON.stringify(selectedPixels.map(p => ({ id: p.pixel_id })), null, 4);
            const noscriptPixelId = selectedPixels.length > 0 ? selectedPixels[0].pixel_id : '';
            
            // L√≥gica de detec√ß√£o de dispositivo baseada no traffic_type
            const trafficType = pressel.traffic_type || 'both';
            let deviceDetectionCode = '';
            
            if (trafficType === 'mobile') {
                deviceDetectionCode = `
            // Verificar se √© mobile
            const isMobile = /android|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent);
            if (!isMobile) {
                window.location.href = CONFIG.WHITE_PAGE_URL;
                return;
            }`;
            } else if (trafficType === 'desktop') {
                deviceDetectionCode = `
            // Verificar se √© desktop
            const isMobile = /android|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(navigator.userAgent);
            if (isMobile) {
                window.location.href = CONFIG.WHITE_PAGE_URL;
                return;
            }`;
            }
            
            const htmlContent = `
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carregando...</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #1a1a1a; /* Fundo escuro */
            color: #ffffff;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .loader-container {
            text-align: center;
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-left-color: #ffffff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        p {
            font-size: 1.2em;
            opacity: 0;
            animation: fadeIn 1s forwards;
            animation-delay: 0.5s;
        }
        @keyframes fadeIn {
            to { opacity: 1; }
        }
    </style>
    <script>
        !function(f,b,e,v,n,t,s)
        {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
        n.callMethod.apply(n,arguments):n.queue.push(arguments)};
        if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
        n.queue=[];t=b.createElement(e);t.async=!0;
        t.src=v;s=b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t,s)}(window, document,'script',
        'https://connect.facebook.net/en_US/fbevents.js');
        ${selectedPixels.map(p => `fbq('init', '${p.pixel_id}');`).join('\n        ')}
        fbq('track', 'PageView');
    <\/script>
    ${noscriptPixelId ? `<noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=${noscriptPixelId}&ev=PageView&noscript=1"
    /></noscript>` : ''}
    <script>
        (async function() {
            const CONFIG = {
                                PRESSEL_ID: ${pressel.id},
                WHITE_PAGE_URL: "${pressel.white_page_url}",
                BOT_USERNAME: "${pressel.bot_name.replace('@', '')}",
                API_BASE_URL: "${this.state.API_BASE_URL}"
            };
            function getQueryParam(param) {
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.get(param);
            }
            function getCookie(name) {
                const cookies = document.cookie.split('; ');
                for (const cookie of cookies) {
                    const parts = cookie.split('=');
                    if (parts[0] === name) return parts[1];
                }
                return null;
            }
            function getFacebookCookies() {
                return {
                    fbp: getCookie('_fbp'),
                    fbc: getCookie('_fbc')
                };
            }
            function isBot() {
                const userAgent = navigator.userAgent;
                return /facebookexternalhit|Facebot/i.test(userAgent);
            }
            async function registerAndRedirect() {
                try {
                    ${deviceDetectionCode} // <<< INJETA O C√ìDIGO DE DETEC√á√ÉO
                    
                    const { fbp, fbc } = getFacebookCookies();
                    // Construir payload para /api/registerClick
                    const clickPayload = {
                        presselId: CONFIG.PRESSEL_ID,
                        referer: document.referrer || null,
                        fbclid: getQueryParam('fbclid'),
                        fbp: fbp,
                        fbc: fbc,
                        user_agent: navigator.userAgent,
                        utm_source: getQueryParam('utm_source'),
                        utm_campaign: getQueryParam('utm_campaign'),
                        utm_medium: getQueryParam('utm_medium'),
                        utm_content: getQueryParam('utm_content'),
                        utm_term: getQueryParam('utm_term')
                    };

                    const response = await fetch(CONFIG.API_BASE_URL + '/api/registerClick', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(clickPayload)
                    });
                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'Falha ao registrar clique.');
                    }
                    const { click_id } = await response.json();

                    // Dispara ViewContent no Pixel da Meta com o eventID
                    if (typeof fbq !== 'undefined') {
                        fbq('track', 'ViewContent', {}, { eventID: click_id });
                        console.log('Evento ViewContent disparado com eventID:', click_id);
                    } else {
                        console.warn('fbq n√£o definido. N√£o foi poss√≠vel disparar ViewContent.');
                    }

                    const botUrl = \`https://t.me/\${CONFIG.BOT_USERNAME}?start=\${click_id}\`;
                    window.location.href = botUrl;
                } catch (error) {
                    console.error("Erro na l√≥gica da pressel:", error);
                    window.location.href = CONFIG.WHITE_PAGE_URL; // Redireciona para p√°gina branca em caso de erro
                }
            }
            function startFlow() {
                if (isBot()) {
                    window.location.href = CONFIG.WHITE_PAGE_URL;
                    return;
                }
                let attempts = 0;
                const maxAttempts = 15;
                const interval = setInterval(() => {
                    const fbc = getCookie("_fbc");
                    const fbclid = getQueryParam("fbclid");
                    if (fbc || !fbclid || attempts >= maxAttempts) {
                        clearInterval(interval);
                        registerAndRedirect();
                    }
                    attempts++;
                }, 200);
            }
            startFlow();
        })();
    <\/script>
</head>
<body>
    <div class="loader-container">
        <div class="spinner"></div>
        <p>Aguarde, estamos redirecionando...</p>
    </div>
</body>
</html>`;

            const modalContent = `<p class="text-sm text-gray-400 mb-4">C√≥digo gerado com o novo formato de alta convers√£o. Copie e cole no HTML da sua p√°gina.</p><textarea id="pressel-code-textarea" class="form-input w-full p-2 font-mono text-xs" rows="15" readonly></textarea><button class="copy-btn btn w-full mt-4 py-2" data-target="#pressel-code-textarea">Copiar C√≥digo</button>`;
            
            document.getElementById('modal-container').innerHTML = this.templates.modal(`C√≥digo da Pressel: ${pressel.name}`, modalContent);
            document.getElementById('pressel-code-textarea').value = htmlContent;
        },

        // ==========================================================
        // FUNCIONALIDADES DE GERENCIAMENTO DE DOM√çNIOS
        // ==========================================================

        async loadDomainsForPressel() {
            const presselId = document.getElementById('pressel-selector').value;
            const domainsSection = document.getElementById('domains-section');
            const publicLinkInput = document.getElementById('public-link');
            
            if (!presselId) {
                domainsSection.style.display = 'none';
                publicLinkInput.value = '';
                return;
            }
            
            // Atualizar link p√∫blico
            const publicLink = `${window.location.origin}/presselteste/domain-manager.html?pressel=${presselId}`;
            publicLinkInput.value = publicLink;
            
            // Mostrar se√ß√£o de dom√≠nios
            domainsSection.style.display = 'block';
            
            try {
                const domains = await this.apiRequest(`/api/pressels/${presselId}/domains`);
                this.displayDomains(domains);
            } catch (error) {
                console.error('Erro ao carregar dom√≠nios:', error);
                document.getElementById('domains-list').innerHTML = `
                    <div class="text-center text-red-400 py-8">
                        <p>Erro ao carregar dom√≠nios. Tente novamente.</p>
                    </div>
                `;
            }
        },

        displayDomains(domains) {
            const container = document.getElementById('domains-list');
            
            if (domains.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <p>Nenhum dom√≠nio registrado ainda.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = domains.map(domain => `
                <div class="flex justify-between items-center p-3 bg-slate-800 rounded-lg">
                    <div>
                        <div class="font-mono text-sky-400 font-semibold">${domain.domain}</div>
                        <div class="text-xs text-gray-400">
                            Registrado em: ${new Date(domain.created_at).toLocaleString('pt-BR')}
                        </div>
                    </div>
                    <button 
                        class="btn btn-red text-xs py-1 px-2"
                        onclick="App.deleteDomain(${domain.id})"
                    >
                        Remover
                    </button>
                </div>
            `).join('');
        },

        async addDomain() {
            const presselId = document.getElementById('pressel-selector').value;
            const domainInput = document.getElementById('domain-input');
            const domain = domainInput.value.trim();
            
            if (!presselId) {
                this.showToast('Selecione uma pressel primeiro.', 'error');
                return;
            }
            
            if (!domain) {
                this.showToast('Digite um dom√≠nio v√°lido.', 'error');
                return;
            }
            
            try {
                await this.apiRequest(`/api/pressels/${presselId}/domains`, 'POST', { domain });
                this.showToast('Dom√≠nio adicionado com sucesso!', 'success');
                domainInput.value = '';
                this.loadDomainsForPressel();
            } catch (error) {
                console.error('Erro ao adicionar dom√≠nio:', error);
                this.showToast('Erro ao adicionar dom√≠nio. Tente novamente.', 'error');
            }
        },

        async deleteDomain(domainId) {
            const presselId = document.getElementById('pressel-selector').value;
            
            if (!confirm('Tem certeza que deseja remover este dom√≠nio?')) {
                return;
            }
            
            try {
                await this.apiRequest(`/api/pressels/${presselId}/domains/${domainId}`, 'DELETE');
                this.showToast('Dom√≠nio removido com sucesso!', 'success');
                this.loadDomainsForPressel();
            } catch (error) {
                console.error('Erro ao remover dom√≠nio:', error);
                this.showToast('Erro ao remover dom√≠nio. Tente novamente.', 'error');
            }
        },

        copyPublicLink() {
            const publicLinkInput = document.getElementById('public-link');
            const presselId = document.getElementById('pressel-selector').value;
            
            if (!presselId) {
                this.showToast('Selecione uma pressel primeiro.', 'error');
                return;
            }
            
            publicLinkInput.select();
            publicLinkInput.setSelectionRange(0, 99999);
            
            try {
                document.execCommand('copy');
                this.showToast('Link copiado para a √°rea de transfer√™ncia!', 'success');
            } catch (error) {
                console.error('Erro ao copiar link:', error);
                this.showToast('Erro ao copiar link. Tente novamente.', 'error');
            }
        },

        openDomainManagerModal() {
            const { pressels } = this.state.data;
            const presselOptions = pressels.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            
            const modalContent = `
                <div class="space-y-6">
                    <div class="text-center">
                        <h2 class="text-2xl font-bold text-white mb-2">üåê Gerenciador de Dom√≠nios</h2>
                        <p class="text-gray-400">Configure os dom√≠nios permitidos para suas pressels</p>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- Sele√ß√£o de Pressel -->
                        <div class="card p-4 rounded-lg">
                            <h3 class="text-lg font-bold mb-3 text-white">Selecionar Pressel</h3>
                            <div class="space-y-3">
                                <select id="modal-pressel-selector" class="form-select w-full p-3" onchange="App.loadDomainsForModal()">
                                    <option value="">Selecione uma pressel</option>
                                    ${presselOptions}
                                </select>
                                <div class="text-sm text-gray-400">
                                    <p>Selecione uma pressel para gerenciar seus dom√≠nios permitidos.</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Adicionar Dom√≠nio -->
                        <div class="card p-4 rounded-lg">
                            <h3 class="text-lg font-bold mb-3 text-white">Adicionar Dom√≠nio</h3>
                            <form id="modal-domain-form" class="space-y-3">
                                <input 
                                    type="text" 
                                    id="modal-domain-input" 
                                    name="domain" 
                                    placeholder="exemplo.com ou https://exemplo.com"
                                    class="form-input w-full p-3"
                                    required
                                />
                                <button type="submit" class="btn w-full p-3 rounded-md text-base font-bold">
                                    Adicionar Dom√≠nio
                                </button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Lista de Dom√≠nios -->
                    <div class="card p-4 rounded-lg" id="modal-domains-section" style="display: none;">
                        <h3 class="text-lg font-bold mb-3 text-white">Dom√≠nios Registrados</h3>
                        <div id="modal-domains-list" class="space-y-3">
                            <div class="text-center text-gray-500 py-8">
                                <div class="spinner mx-auto mb-4"></div>
                                <p>Carregando dom√≠nios...</p>
                            </div>
                        </div>
                    </div>
                    
                </div>
            `;
            
            document.getElementById('modal-container').innerHTML = this.templates.modal('Gerenciador de Dom√≠nios', modalContent);
        },

        async loadDomainsForModal() {
            const presselId = document.getElementById('modal-pressel-selector').value;
            const domainsSection = document.getElementById('modal-domains-section');
            
            if (!presselId) {
                domainsSection.style.display = 'none';
                return;
            }
            
            // Mostrar se√ß√£o de dom√≠nios
            domainsSection.style.display = 'block';
            
            try {
                const domains = await this.apiRequest(`/api/pressels/${presselId}/domains`);
                this.displayModalDomains(domains);
            } catch (error) {
                console.error('Erro ao carregar dom√≠nios:', error);
                document.getElementById('modal-domains-list').innerHTML = `
                    <div class="text-center text-red-400 py-8">
                        <p>Erro ao carregar dom√≠nios. Tente novamente.</p>
                    </div>
                `;
            }
        },

        displayModalDomains(domains) {
            const container = document.getElementById('modal-domains-list');
            
            if (domains.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        <p>Nenhum dom√≠nio registrado ainda.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = domains.map(domain => `
                <div class="flex justify-between items-center p-3 bg-slate-800 rounded-lg">
                    <div>
                        <div class="font-mono text-sky-400 font-semibold">${domain.domain}</div>
                        <div class="text-xs text-gray-400">
                            Registrado em: ${new Date(domain.created_at).toLocaleString('pt-BR')}
                        </div>
                    </div>
                    <button 
                        class="btn btn-red text-xs py-1 px-2"
                        onclick="App.deleteModalDomain(${domain.id})"
                    >
                        Remover
                    </button>
                </div>
            `).join('');
        },

        async addModalDomain() {
            const presselId = document.getElementById('modal-pressel-selector').value;
            const domainInput = document.getElementById('modal-domain-input');
            let domain = domainInput.value.trim();
            domain = domain.replace(/^(https?:\/\/)?/, '').split('/')[0];
           
            if (!presselId) {
                this.showToast('Selecione uma pressel primeiro.', 'error');
                return;
            }
            
            if (!domain) {
                this.showToast('Digite um dom√≠nio v√°lido.', 'error');
                return;
            }
            
            try {
                await this.apiRequest(`/api/pressels/${presselId}/domains`, 'POST', { domain });
                this.showToast('Dom√≠nio adicionado com sucesso!', 'success');
                domainInput.value = '';
                this.loadDomainsForModal();
            } catch (error) {
                console.error('Erro ao adicionar dom√≠nio:', error);
                this.showToast('Erro ao adicionar dom√≠nio. Tente novamente.', 'error');
            }
        },

        async deleteModalDomain(domainId) {
            const presselId = document.getElementById('modal-pressel-selector').value;
            
            if (!confirm('Tem certeza que deseja remover este dom√≠nio?')) {
                return;
            }
            
            try {
                await this.apiRequest(`/api/pressels/${presselId}/domains/${domainId}`, 'DELETE');
                this.showToast('Dom√≠nio removido com sucesso!', 'success');
                this.loadDomainsForModal();
            } catch (error) {
                console.error('Erro ao remover dom√≠nio:', error);
                this.showToast('Erro ao remover dom√≠nio. Tente novamente.', 'error');
            }
        },


        // ==========================================================
        // FUNCIONALIDADES DE CHECKOUT E P√ÅGINAS DE OBRIGADO
        // ==========================================================



        async renderThankYouPage(pageId) {
            const appContainer = document.getElementById('app');
            appContainer.innerHTML = '<p class="text-center text-lg mt-20">Carregando p√°gina...</p>';

            try {
                const pageData = await this.apiRequest(`/api/obrigado/${pageId}`);
                const { config } = pageData;

                const thankYouHTML = `
                    <div class="min-h-screen flex items-center justify-center p-4">
                        <div class="card w-full max-w-md p-6 md:p-8 rounded-2xl text-center">
                            <div class="mb-6">
                                <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                </div>
                                <h1 class="text-2xl font-bold text-white mb-2">${config.page_name}</h1>
                                <p class="text-gray-400">Obrigado pela sua compra!</p>
                            </div>
                            
                            <div class="space-y-4 mb-6">
                                <div class="bg-slate-800/50 p-4 rounded-lg">
                                    <p class="text-sm text-gray-400">Valor da compra:</p>
                                    <p class="text-xl font-bold text-green-400">R$ ${(config.purchase_value / 100).toFixed(2).replace('.', ',')}</p>
                                </div>
                            </div>

                            <div class="space-y-3">
                                <button id="redirect-btn" class="btn w-full py-3 font-bold">
                                    Continuar
                                </button>
                                <p class="text-xs text-gray-500">
                                    Voc√™ ser√° redirecionado automaticamente em alguns segundos...
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                
                appContainer.innerHTML = thankYouHTML;

                // Configurar redirecionamento
                const redirectBtn = document.getElementById('redirect-btn');
                redirectBtn.addEventListener('click', () => {
                    window.location.href = config.redirect_url;
                });

                // Redirecionamento autom√°tico ap√≥s 5 segundos
                setTimeout(() => {
                    window.location.href = config.redirect_url;
                }, 5000);

                // Enviar evento para Utmify se configurado
                if (config.utmify_integration_id) {
                    try {
                        await this.apiRequest('/api/thank-you-pages/fire-utmify', 'POST', {
                            pageId: pageId,
                            trackingParameters: {
                                utm_source: new URLSearchParams(window.location.search).get('utm_source'),
                                utm_campaign: new URLSearchParams(window.location.search).get('utm_campaign'),
                                utm_medium: new URLSearchParams(window.location.search).get('utm_medium'),
                                utm_content: new URLSearchParams(window.location.search).get('utm_content'),
                                utm_term: new URLSearchParams(window.location.search).get('utm_term')
                            },
                            customerData: {
                                email: '',
                                phone: '',
                                name: ''
                            }
                        });
                    } catch (error) {
                        console.error('Erro ao enviar evento para Utmify:', error);
                    }
                }

            } catch (error) {
                appContainer.innerHTML = `<p class="text-center text-red-400 text-lg mt-20">P√°gina n√£o encontrada ou inv√°lida.</p>`;
            }
        },


        
        async loadCheckouts() {
            try {
                const checkouts = await this.apiRequest('/api/checkouts');
                this.state.data.checkouts = checkouts;
                this.renderCheckoutsList();
            } catch (error) {
                console.error('Erro ao carregar checkouts:', error);
                document.getElementById('checkouts-list').innerHTML = '<p class="text-red-400 text-sm">Erro ao carregar checkouts.</p>';
            }
        },

        async fetchAndRenderCheckouts() {
            const tableBody = document.getElementById('checkouts-table-body');
            if (!tableBody) return;
            if (!tableBody.dataset.loaded) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-8">Carregando...</td></tr>';
            }
            if (this.isSectionFetching('checkouts')) return;
            this.setSectionFetching('checkouts', true);
            try {
                const checkouts = await this.apiRequest('/api/checkouts');
                this.state.data.checkouts = Array.isArray(checkouts) ? checkouts : [];
                if (this.state.data.checkouts.length > 0) {
                    tableBody.innerHTML = this.state.data.checkouts.map(c => `
                        <tr class="hover:bg-slate-800/50">
                            <td class="font-medium">${c.name || 'Checkout Sem T√≠tulo'}</td>
                            <td>${new Date(c.created_at).toLocaleString('pt-BR')}</td>
                            <td class="text-right space-x-2">
                                <button class="btn-secondary btn-sm py-1 px-2 copy-checkout-link-btn" data-id="${c.id}">Copiar Link</button>
                                <button class="btn-secondary btn-sm py-1 px-2 edit-checkout-btn" data-id="${c.id}">Editar</button>
                                <button class="btn-red btn-sm py-1 px-2 delete-checkout-btn" data-id="${c.id}">Excluir</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-8">Nenhum checkout criado ainda.</td></tr>';
                }
                tableBody.dataset.loaded = 'true';
            } catch (e) {
                console.error("Erro ao buscar checkouts:", e);
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-red-400 py-8">Erro ao carregar checkouts.</td></tr>';
            } finally {
                this.setSectionFetching('checkouts', false);
            }
        },

        async fetchAndRenderThankYouPages() {
            const tableBody = document.getElementById('thankyou-table-body');
            if (!tableBody) return;
            if (!tableBody.dataset.loaded) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-8">Carregando...</td></tr>';
            }
            if (this.isSectionFetching('thankYouPages')) return;
            this.setSectionFetching('thankYouPages', true);
            try {
                const pages = await this.apiRequest('/api/thank-you-pages');
                const list = Array.isArray(pages) ? pages : [];
                if (list.length > 0) {
                    tableBody.innerHTML = list.map(p => `
                        <tr class="hover:bg-slate-800/50">
                            <td class="font-medium">${p.name || 'P√°gina Sem Nome'}</td>
                            <td>${new Date(p.created_at).toLocaleString('pt-BR')}</td>
                            <td class="text-right space-x-2">
                                <button class="btn-secondary btn-sm py-1 px-2 copy-thankyou-link-btn" data-id="${p.id}">Copiar Link</button>
                                <button class="btn-secondary btn-sm py-1 px-2 edit-thankyou-btn" data-id="${p.id}">Editar</button>
                                <button class="btn-red btn-sm py-1 px-2 delete-thankyou-btn" data-id="${p.id}">Excluir</button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-gray-500 py-8">Nenhuma p√°gina de obrigado criada ainda.</td></tr>';
                }
                tableBody.dataset.loaded = 'true';
            } catch (e) {
                console.error("Erro ao buscar p√°ginas de obrigado:", e);
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-red-400 py-8">Erro ao carregar p√°ginas.</td></tr>';
            } finally {
                this.setSectionFetching('thankYouPages', false);
            }
        },

        generatePresselListHTML(pressels = []) {
            if (!Array.isArray(pressels) || pressels.length === 0) {
                return '<p class="text-gray-500 text-sm">Nenhuma pressel criada.</p>';
            }
            return pressels.map(pr => {
                const netlifyIcon = pr.netlify_url ? '<span class="inline-flex items-center text-green-400 text-xs ml-2" title="Deploy no Netlify"><svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20"><path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/></svg>Netlify</span>' : '';
                const copyLinkButton = pr.netlify_url ? `<button data-url="${pr.netlify_url}" class="copy-netlify-link-btn btn text-xs py-1 px-2 bg-green-600 hover:bg-green-700">Copiar Link</button>` : '';
                return `<div class="p-3 card flex justify-between items-center text-sm">
                        <div class="flex items-center">
                            <div>
                                <p class="font-semibold">${pr.name}${netlifyIcon}</p>
                            </div>
                        </div>
                        <div class="space-x-2">
                            <button data-id="${pr.id}" class="generate-pressel-code-btn btn text-xs py-1 px-2">Ver C√≥digo</button>
                            ${copyLinkButton}
                            <button data-id="${pr.id}" class="delete-pressel-btn btn btn-red text-xs py-1 px-2">Excluir</button>
                        </div>
                    </div>`;
            }).join('');
        },

        renderPresselList() {
            const listContainer = document.getElementById('pressel-list');
            if (!listContainer) return;
            const pressels = this.state.data.pressels || [];
            listContainer.innerHTML = this.generatePresselListHTML(pressels);
            listContainer.dataset.loaded = 'true';
        },

        async fetchAndRenderPressels() {
            const listContainer = document.getElementById('pressel-list');
            if (!listContainer) return;
            if (!listContainer.dataset.loaded) {
                listContainer.innerHTML = '<p class="text-gray-500 text-sm">Carregando pressels...</p>';
            }
            if (this.isSectionFetching('pressels')) return;
            this.setSectionFetching('pressels', true);
            try {
                const pressels = await this.apiRequest('/api/pressels');
                this.state.data.pressels = Array.isArray(pressels) ? pressels : (pressels?.pressels || []);
                this.renderPresselList();
            } catch (error) {
                console.error('Erro ao carregar pressels:', error);
                listContainer.innerHTML = '<p class="text-red-400 text-sm">Erro ao carregar pressels.</p>';
            } finally {
                this.setSectionFetching('pressels', false);
            }
        },
        
        renderCheckoutsList() {
            const container = document.getElementById('checkouts-list');
            if (!container) return;
            
            const checkouts = this.state.data.checkouts || [];
            if (checkouts.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Nenhum checkout criado.</p>';
                return;
            }
            
            container.innerHTML = checkouts.map(checkout => `
                <div class="p-3 bg-slate-900/50 rounded-lg flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-sm">${checkout.name}</p>
                        <p class="text-xs text-gray-400">ID: ${checkout.id}</p>
                    </div>
                    <div class="flex space-x-2">
                        <a href="/oferta/${checkout.id}" target="_blank" class="btn btn-secondary text-xs py-1 px-2">Ver</a>
                        <button data-id="${checkout.id}" class="delete-checkout-btn btn btn-red text-xs py-1 px-2">Excluir</button>
                    </div>
                </div>
            `).join('');
        },
        
        async loadThankYouPages() {
            try {
                const pages = await this.apiRequest('/api/thank-you-pages');
                this.state.data.thankYouPages = pages;
                this.renderThankYouPagesList();
            } catch (error) {
                console.error('Erro ao carregar p√°ginas de obrigado:', error);
                document.getElementById('thank-you-pages-list').innerHTML = '<p class="text-red-400 text-sm">Erro ao carregar p√°ginas.</p>';
            }
        },
        
        renderThankYouPagesList() {
            const container = document.getElementById('thank-you-pages-list');
            if (!container) return;
            
            const pages = this.state.data.thankYouPages || [];
            if (pages.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">Nenhuma p√°gina criada.</p>';
                return;
            }
            
            container.innerHTML = pages.map(page => `
                <div class="p-3 bg-slate-900/50 rounded-lg flex justify-between items-center">
                    <div>
                        <p class="font-semibold text-sm">${page.page_name}</p>
                        <p class="text-xs text-gray-400">ID: ${page.id}</p>
                    </div>
                    <div class="flex space-x-2">
                        <a href="/obrigado/${page.id}" target="_blank" class="btn btn-secondary text-xs py-1 px-2">Ver</a>
                        <button data-id="${page.id}" class="delete-thank-you-page-btn btn btn-red text-xs py-1 px-2">Excluir</button>
                    </div>
                </div>
            `).join('');
        },
        
        addPackageField() {
            const container = document.getElementById('packages-container');
            if (!container) return;
            
            const packageHTML = `
                <div class="package-item p-3 bg-slate-800/50 rounded-lg">
                    <input name="package_title[]" placeholder="T√≠tulo do Pacote" class="form-input w-full p-2 mb-2" required>
                    <input name="package_description[]" placeholder="Descri√ß√£o do Pacote" class="form-input w-full p-2 mb-2" required>
                    <input name="package_value_cents[]" type="number" placeholder="Valor em centavos (Ex: 1990)" class="form-input w-full p-2" required>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', packageHTML);
        },

        // *** FUN√á√ÉO initCreatorPage ATUALIZADA para incluir success_redirect_url ***
        async initCreatorPage() {
            const FRONTEND_URL = window.location.origin;
            const contentEl = document.getElementById('content');
            if (!contentEl) { console.error("Container #content n√£o encontrado."); return; }

            // Verifica se os elementos existem antes de acess√°-los
            const creatorTitle = contentEl.querySelector('#creator-title');
            const submitBtn = contentEl.querySelector('#submit-btn');
            const checkoutForm = contentEl.querySelector('#checkout-form');
            const packagesContainer = contentEl.querySelector('#packages-container');
            const testimonialsContainer = contentEl.querySelector('#testimonials-container');
            const pixelSelect = contentEl.querySelector('#pixel_id');
            const utmifySelect = contentEl.querySelector('#utmify_integration_id');
            const resultScreen = contentEl.querySelector('#result-screen');
            const checkoutLinkOutput = contentEl.querySelector('#checkout-link-output');
            const successRedirectUrlInput = contentEl.querySelector('#success_redirect_url'); // Campo novo

            if (!creatorTitle || !submitBtn || !checkoutForm || !packagesContainer || !testimonialsContainer || !pixelSelect || !utmifySelect || !resultScreen || !checkoutLinkOutput || !successRedirectUrlInput) {
                console.error("Um ou mais elementos do Criador de Ofertas n√£o foram encontrados no DOM.");
                this.showToast("Erro ao carregar o criador de ofertas.", "error");
                return;
            }

            packagesContainer.innerHTML = '';
            testimonialsContainer.innerHTML = '';

            pixelSelect.innerHTML = '<option value="">-- Selecione um Pixel --</option>' + App.state.data.pixels.map(p => `<option value="${p.pixel_id}">${p.account_name} (${p.pixel_id})</option>`).join('');
            utmifySelect.innerHTML = '<option value="">-- Nenhuma --</option>' + App.state.data.utmifyIntegrations.map(u => `<option value="${u.id}">${u.account_name}</option>`).join('');

            let packageCount = 0;
            function addPackage(title = 'Acesso Completo', desc = 'Todo o conte√∫do liberado.', val = '29.90') {
                packageCount++; const el = document.createElement('div'); el.id = `package-${packageCount}`; el.className = 'grid grid-cols-1 md:grid-cols-7 gap-4 border border-slate-700 p-4 rounded-lg';
                el.innerHTML = `<div class="md:col-span-2"><label class="text-xs text-gray-400 mb-1 block">Nome</label><input type="text" class="form-input w-full p-2 package-title" value="${title}" required></div> <div class="md:col-span-3"><label class="text-xs text-gray-400 mb-1 block">Descri√ß√£o</label><input type="text" class="form-input w-full p-2 package-description" value="${desc}" required></div> <div class="md:col-span-1"><label class="text-xs text-gray-400 mb-1 block">Valor (R$)</label><input type="number" step="0.01" min="0" class="form-input w-full p-2 package-value" value="${val}" required></div> <div class="flex items-end"><button type="button" class="btn btn-danger w-full h-10 remove-package-btn" data-id="${packageCount}">X</button></div>`;
                packagesContainer.appendChild(el);
                updatePreview();
            }
            let testimonialCount = 0;
            function addTestimonial(name = '', photo_url = '', text = '') {
                testimonialCount++; const el = document.createElement('div'); el.id = `testimonial-${testimonialCount}`; el.className = 'border border-slate-700 p-4 rounded-lg space-y-3';
                el.innerHTML = `<div class="flex justify-end"><button type="button" class="btn btn-danger text-xs py-1 px-2 remove-testimonial-btn" data-id="${testimonialCount}">Remover</button></div> <div class="grid grid-cols-1 md:grid-cols-2 gap-4"> <div><label class="text-xs text-gray-400 mb-1 block">Nome</label><input type="text" class="form-input w-full p-2 testimonial-name" value="${name}" placeholder="Ex: Jo√£o da Silva"></div> <div><label class="text-xs text-gray-400 mb-1 block">URL da Foto (Opcional)</label><input type="url" class="form-input w-full p-2 testimonial-photo" value="${photo_url}" placeholder="https://..."></div> </div> <div><label class="text-xs text-gray-400 mb-1 block">Texto</label><textarea class="form-textarea w-full p-2 testimonial-text" rows="3" placeholder="Excelente produto...">${text}</textarea></div>`;
                testimonialsContainer.appendChild(el);
                updatePreview();
            }

            function populateCreatorForm(config) {
                const get = (selector) => contentEl.querySelector(selector);
                get('#main_title').value = config.content?.main_title || ''; get('#subtitle').value = config.content?.subtitle || ''; get('#media_url').value = config.content?.media_url || '';
                get('#pricing-type-select').value = config.pricing?.type || 'fixed'; packagesContainer.innerHTML=''; if (config.pricing?.type === 'fixed' && config.pricing.packages?.length > 0) { config.pricing.packages.forEach(pkg => addPackage(pkg.title || '', pkg.description || '', ((pkg.value_cents || 0) / 100).toFixed(2))); } else { addPackage(); }
                get('#enable_order_bump').checked = config.order_bump?.enabled; get('#order-bump-fields').classList.toggle('hidden', !config.order_bump?.enabled); get('#order_bump_product_name').value = config.order_bump?.product_name || '';
                get('#order_bump_description').value = config.order_bump?.description || '';
                get('#order_bump_value').value = ((config.order_bump?.value_cents || 0) / 100).toFixed(2);
                get('#enable_countdown').checked = config.conversion_elements?.countdown?.enabled; get('#countdown-fields').classList.toggle('hidden', !config.conversion_elements?.countdown?.enabled); get('#countdown_minutes').value = config.conversion_elements?.countdown?.minutes || 15;
                get('#guarantee_text').value = config.conversion_elements?.guarantee?.text || ''; get('#guarantee_seal_url').value = config.conversion_elements?.guarantee?.seal_url || '';
                testimonialsContainer.innerHTML=''; if (config.testimonials?.length > 0) { config.testimonials.forEach(t => addTestimonial(t.name || '', t.photo_url || '', t.text || '')); }
                get('#pixel_id').value = config.tracking?.pixel_id || ''; get('#utmify_integration_id').value = config.tracking?.utmify_integration_id || ''; get('#background_color').value = config.style?.background_color || '#0f172a'; get('#accent_color').value = config.style?.accent_color || '#38bdf8';
                get('#success_redirect_url').value = config.redirects?.success_url || ''; // Popula o campo novo
            }

            function getFormData() {
                 const getElValue=(s,d='')=>contentEl.querySelector(s)?.value||d; const getElChecked=(s)=>contentEl.querySelector(s)?.checked||false; const getElFloat=(s,d=0)=>parseFloat(contentEl.querySelector(s)?.value)||d; const getElInt=(s,d=0)=>parseInt(contentEl.querySelector(s)?.value)||d; const pT=getElValue('#pricing-type-select','fixed'); let pD; if(pT==='fixed'){pD={type:'fixed',packages:Array.from(contentEl.querySelectorAll('#packages-container > div')).map(p=>({title:p.querySelector('.package-title')?.value||'',description:p.querySelector('.package-description')?.value||'',value_cents:Math.round((parseFloat(p.querySelector('.package-value')?.value)||0)*100)}))};}else{pD={type:'open',label:getElValue('#open_value_label'),minimum_value_cents:Math.round(getElFloat('#open_value_min',5)*100),suggested_value_cents:Math.round(getElFloat('#open_value_suggested',50)*100)};}
                 return{content:{main_title:getElValue('#main_title'),subtitle:getElValue('#subtitle'),media_url:getElValue('#media_url')||null},pricing:pD,order_bump:{enabled:getElChecked('#enable_order_bump'),product_name:getElValue('#order_bump_product_name'),description:getElValue('#order_bump_description'),value_cents:Math.round(getElFloat('#order_bump_value',0)*100)},conversion_elements:{countdown:{enabled:getElChecked('#enable_countdown'),minutes:getElInt('#countdown_minutes',15)},guarantee:{text:getElValue('#guarantee_text',''),seal_url:getElValue('#guarantee_seal_url')||null}},testimonials:Array.from(contentEl.querySelectorAll('#testimonials-container > div')).map(t=>({name:t.querySelector('.testimonial-name')?.value||'',text:t.querySelector('.testimonial-text')?.value||'',photo_url:t.querySelector('.testimonial-photo')?.value||null})),style:{background_color:getElValue('#background_color','#0f172a'),accent_color:getElValue('#accent_color','#38bdf8')},tracking:{pixel_id:getElValue('#pixel_id',''),utmify_integration_id:getElValue('#utmify_integration_id','')||null}, redirects: { success_url: getElValue('#success_redirect_url') || null }}; // Adiciona redirects
            }
// DENTRO DE async initCreatorPage(), SUBSTITUA A FUN√á√ÉO INTEIRA:
// DENTRO DE async initCreatorPage(), SUBSTITUA A FUN√á√ÉO INTEIRA:

function generatePreviewHTML(data) {
    const fC = (c) => (c / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

    // L√≥gica CORRETA para determinar a cor do texto
    const isDarkBg = (bgColor = '#0f172a') => {
        let colorStr = (bgColor.charAt(0) === '#') ? bgColor.substring(1, 7) : bgColor;
        if (colorStr.length === 3) { // Converte #RGB para #RRGGBB
            colorStr = colorStr[0] + colorStr[0] + colorStr[1] + colorStr[1] + colorStr[2] + colorStr[2];
        }
        if (colorStr.length !== 6) {
            return true; // Assume escuro por padr√£o se a cor for inv√°lida
        }
        const r = parseInt(colorStr.substring(0, 2), 16);
        const g = parseInt(colorStr.substring(2, 4), 16);
        const b = parseInt(colorStr.substring(4, 6), 16);
        // F√≥rmula exata usada em renderCheckoutPage
        return (r * 0.299 + g * 0.587 + b * 0.114) < 186;
    };

    // --- CORRE√á√ÉO DE BUG DE SINTAXE E L√ìGICA ---
    // Bug 1: Chamava isBgDark recursivamente. Corrigido para isDarkBg
    const isBgDark = isDarkBg(data.style.background_color); 
    
    const primaryTextColor = isBgDark ? '#f1f5f9' : '#111827';
    const secondaryTextColor = isBgDark ? '#94a3b8' : '#6b7280';
    
    // Bug 2: L√≥gica de cor do card estava invertida. Corrigida.
    const cardBgColor = isBgDark ? '#1e293b' : '#ffffff'; // Card escuro em BG escuro, Card claro em BG claro
    const cardBorderColor = isBgDark ? '#334155' : '#e5e7eb';
    const cardTextColor = isBgDark ? primaryTextColor : '#111827';
    const cardSecondaryTextColor = isBgDark ? secondaryTextColor : '#6b7280';
    // --- FIM DAS CORRE√á√ïES DE COR ---

    // L√≥gica para cor do bot√£o
    const accentColor = data.style.accent_color || '#38bdf8';
    const isAccentDark = isDarkBg(accentColor);
    const buttonTextColor = isAccentDark ? '#FFFFFF' : '#000000';

    // --- GERA√á√ÉO DO HTML ---

    const cdH = data.conversion_elements.countdown.enabled
        ? `<div style="background-color: var(--preview-accent, #38bdf8); color: white; text-align: center; padding: 0.75rem; position: sticky; top: 0; z-index: 10;">
               <p style="font-weight: 600; font-size: 0.9rem;">A OFERTA TERMINA EM</p>
               <p style="font-size: 1.5rem; font-weight: 800; letter-spacing: 0.1em;">${String(data.conversion_elements.countdown.minutes).padStart(2, '0')}:00</p>
           </div>`
        : '';

    const mH = data.content.media_url
        ? `<img src="${data.content.media_url}" alt="Preview" style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 0.5rem; margin-bottom: 1.5rem;">`
        : '';

    let pH;
    if (data.pricing.type === 'fixed') {
        const packages = Array.isArray(data.pricing.packages) ? data.pricing.packages : [];
        const defaultBoxShadow = '0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1)';
        
        const packageItemsHTML = (packages.length > 0 ? packages : [{ title: 'Configure um pacote', description: '', value_cents: 0 }]).map((pk, i) => `
            <div style="border: 1px solid ${cardBorderColor}; background-color: ${cardBgColor}; padding: 1rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s; box-shadow: ${defaultBoxShadow};"
                 onclick="this.parentElement.querySelectorAll('div[style*=\'border: 1px\']').forEach(el => { el.style.borderColor='${cardBorderColor}'; el.style.boxShadow='${defaultBoxShadow}'; }); this.style.borderColor=getComputedStyle(document.documentElement).getPropertyValue('--preview-accent'); this.style.boxShadow = '0 0 0 2px '+getComputedStyle(document.documentElement).getPropertyValue('--preview-accent');">
                 <h3 style="font-weight: 700; font-size: 1.1rem; color: ${cardTextColor}; pointer-events: none;">${pk.title || 'Pacote'}</h3>
                 <p style="font-size: 0.9rem; color: ${cardSecondaryTextColor}; margin-top: 0.25rem; pointer-events: none;">${pk.description || 'Descri√ß√£o'}</p>
                 <p style="font-size: 1.5rem; font-weight: 800; color: var(--preview-accent, #38bdf8); margin-top: 0.75rem; pointer-events: none;">${fC(pk.value_cents)}</p>
            </div>
        `).join('');
        pH = `<div style="margin-top: 1.5rem; display: flex; flex-direction: column; gap: 1rem;">${packageItemsHTML}</div>`;
    } else {
        pH = '<p style="color: red;">Modelo de pre√ßo aberto n√£o implementado no preview.</p>';
    }

    // --- CORRE√á√ÉO 3: ONCLICK DO ORDER BUMP ---
    const obH = data.order_bump.enabled && data.order_bump.product_name
        ? `<div style="background-color: #fefce8; border: 2px dashed #facc15; padding: 1rem; border-radius: 0.5rem; margin-top: 1.5rem; cursor: pointer;"
               onclick="var cb = this.querySelector('.preview-order-bump-checkbox'); if (event.target.tagName !== 'INPUT') { cb.checked = !cb.checked; }">
               <div style="display: flex; align-items: flex-start; gap: 0.75rem;">
                   <input type="checkbox" class="preview-order-bump-checkbox" style="width: 1.5rem; height: 1.5rem; margin-top: 0.25rem; accent-color: #ca8a04; flex-shrink: 0;">
                   <div style="pointer-events: none;">
                       <h4 style="font-weight: 700; color: #ca8a04;">${data.order_bump.product_name}</h4>
                       <p style="font-size: 0.9rem; color: #4b5563;">${data.order_bump.description}</p>
                   </div>
               </div>
           </div>`
        : '';
    // --- FIM DA CORRE√á√ÉO 3 ---

    const gH = data.conversion_elements.guarantee.text
        ? `<div style="margin-top: 2rem; display: flex; align-items: center; gap: 1rem; background-color: #f9fafb; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
               ${data.conversion_elements.guarantee.seal_url ? `<img src="${data.conversion_elements.guarantee.seal_url}" alt="Selo" style="width: 60px; height: 60px; flex-shrink: 0;">` : ''}
               <div>
                   <h4 style="font-weight: 700; color: #374151;">Garantia Total</h4>
                   <p style="font-size: 0.9rem; color: #6b7280;">${data.conversion_elements.guarantee.text}</p>
               </div>
           </div>`
        : '';

    const testimonials = Array.isArray(data.testimonials) ? data.testimonials : [];
    const tH = testimonials.filter(t => t.name && t.text).length > 0
        ? `<div style="margin-top: 2.5rem;">
               <h3 style="font-size: 1.5rem; font-weight: 800; text-align: center; color: ${primaryTextColor}; margin-bottom: 1.5rem;">O Que Nossos Clientes Dizem</h3>
               <div style="display: grid; grid-template-columns: 1fr; gap: 1rem;">
                   ${testimonials.map(t => `
                       <div style="background-color: #f9fafb; padding: 1rem; border-radius: 0.5rem; border: 1px solid #e5e7eb; color: #1f2937;">
                           <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                               ${t.photo_url ? `<img src="${t.photo_url}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; flex-shrink: 0;">` : ''}
                               <p style="font-weight: 600; color: #111827;">${t.name}</p>
                           </div>
                           <p style="font-size: 0.9rem; color: #4b5563; font-style: italic;">"${t.text}"</p>
                       </div>
                   `).join('')}
               </div>
           </div>`
        : '';


    return `
        <div id="preview-body" style="--preview-bg: ${data.style.background_color || '#0f172a'}; --preview-accent: ${accentColor}; background-color: var(--preview-bg); color: ${primaryTextColor}; min-height: 100%; font-family: 'Inter', sans-serif;">
            ${cdH}
            <div style="padding: 1.5rem 2rem;">
                 <h1 style="font-size: 1.8rem; font-weight: 800; text-align: center; color: ${primaryTextColor};">${data.content.main_title || 'T√≠tulo Principal'}</h1>
                 <p style="text-align: center; color: ${secondaryTextColor}; margin-top: 0.5rem; margin-bottom: 2rem;">${data.content.subtitle || 'Subt√≠tulo da oferta'}</p>
                 ${mH}
                 ${pH}
                 ${obH}
                 <button disabled style="width: 100%; background-color: var(--preview-accent, #38bdf8); color: ${buttonTextColor}; font-weight: 700; padding: 1rem; border-radius: 0.5rem; margin-top: 1.5rem; font-size: 1.1rem; text-transform: uppercase; border: none; cursor: not-allowed; transition: filter 0.2s;">
                     Comprar Agora
                 </button>
                 ${gH}
                 ${tH}
            </div>
        </div>
    `;
}
            function updatePreview() { if (App.state.currentPage === 'pageCreator' && contentEl.querySelector('#creator-screen') && contentEl.querySelector('#preview-content')) { try { const data = getFormData(); contentEl.querySelector('#preview-content').innerHTML = generatePreviewHTML(data); const pb = contentEl.querySelector('#preview-content').querySelector('#preview-body'); if(pb) { pb.style.setProperty('--preview-bg', data.style.background_color); pb.style.setProperty('--preview-accent', data.style.accent_color); } } catch (e) { console.error("Erro no updatePreview:", e); } } }
            function showResultScreen(checkoutId) { if (!checkoutLinkOutput || !resultScreen) return; const link = `${FRONTEND_URL}/oferta/${checkoutId}`; checkoutLinkOutput.value = link; resultScreen.classList.remove('hidden'); }
            function hideResultScreen() { if (!resultScreen || !checkoutForm || !packagesContainer || !testimonialsContainer) return; resultScreen.classList.add('hidden'); checkoutForm.reset(); contentEl.querySelector('#pricing-type-select').value = 'fixed'; contentEl.querySelector('#fixed-pricing-container').classList.remove('hidden'); contentEl.querySelector('#open-pricing-container').classList.add('hidden'); contentEl.querySelector('#enable_order_bump').checked = false; contentEl.querySelector('#order-bump-fields').classList.add('hidden'); contentEl.querySelector('#enable_countdown').checked = false; contentEl.querySelector('#countdown-fields').classList.add('hidden'); packagesContainer.innerHTML = ''; testimonialsContainer.innerHTML = ''; addPackage(); updatePreview(); }

            if (this.state.editingCheckoutId) {
                creatorTitle.textContent = 'Editar Checkout'; submitBtn.textContent = 'Carregando...'; submitBtn.disabled = true;
                try {
                    const data = await this.apiRequest(`/api/oferta/${this.state.editingCheckoutId}`);
                    if (data && data.config) { populateCreatorForm(data.config); submitBtn.textContent = 'Salvar Altera√ß√µes'; } else { throw new Error('Config n√£o encontrada.'); }
                } catch (e) { this.showToast('Erro ao carregar.', 'error'); this.state.editingCheckoutId = null; creatorTitle.textContent = 'Criador'; submitBtn.textContent = 'Criar'; addPackage(); }
                finally { submitBtn.disabled = false; updatePreview(); }
            } else {
                creatorTitle.textContent = 'Criador de Ofertas'; submitBtn.textContent = 'Criar Checkout'; addPackage(); updatePreview();
            }

            // Listeners para atualiza√ß√£o em tempo real do preview
            const updatePreviewDebounced = (() => {
                let timeout;
                return () => {
                    clearTimeout(timeout);
                    timeout = setTimeout(updatePreview, 100);
                };
            })();

            // Remove listeners antigos para evitar duplicatas
            contentEl.removeEventListener('input', updatePreviewDebounced);
            contentEl.removeEventListener('change', contentEl._changeListener);
            contentEl.removeEventListener('input', contentEl._inputListener);

            // Listener para eventos 'input' (textos, n√∫meros, textareas)
            contentEl._inputListener = (e) => {
                // Atualiza preview para qualquer campo de input/textarea dentro do formul√°rio
                if (e.target.closest('#checkout-form')) {
                    updatePreviewDebounced();
                }
            };
            contentEl.addEventListener('input', contentEl._inputListener);

            // Listener para eventos 'change' (selects, checkboxes, color inputs)
            contentEl._changeListener = (e) => {
                const target = e.target;
                // Toggle de containers e atualiza√ß√£o de preview
                if (target.matches('#pricing-type-select, #enable_order_bump, #enable_countdown')) {
                    const pS = contentEl.querySelector('#pricing-type-select');
                    const fC = contentEl.querySelector('#fixed-pricing-container');
                    const oC = contentEl.querySelector('#open-pricing-container');
                    const eOB = contentEl.querySelector('#enable_order_bump');
                    const oBF = contentEl.querySelector('#order-bump-fields');
                    const eC = contentEl.querySelector('#enable_countdown');
                    const cF = contentEl.querySelector('#countdown-fields');
                    const iF = pS.value === 'fixed';
                    if (fC) fC.classList.toggle('hidden', !iF);
                    if (oC) oC.classList.toggle('hidden', iF);
                    if (oBF) oBF.classList.toggle('hidden', !eOB.checked);
                    if (cF) cF.classList.toggle('hidden', !eC.checked);
                    updatePreviewDebounced();
                }
                // Atualiza preview para qualquer campo dentro do formul√°rio
                if (target.closest('#checkout-form')) {
                    updatePreviewDebounced();
                }
            };
            contentEl.addEventListener('change', contentEl._changeListener);

            contentEl.removeEventListener('click', contentEl._clickListener);
            contentEl._clickListener = (e) => {
                 if(e.target.id==='add-package-btn')addPackage(); if(e.target.id==='add-testimonial-btn')addTestimonial(); const rPB=e.target.closest('.remove-package-btn'); if(rPB){contentEl.querySelector(`#package-${rPB.dataset.id}`)?.remove();updatePreview();} const rTB=e.target.closest('.remove-testimonial-btn'); if(rTB){contentEl.querySelector(`#testimonial-${rTB.dataset.id}`)?.remove();updatePreview();}
                 const pW=contentEl.querySelector('#preview-wrapper'); if(e.target.id==='desktop-view-btn'){pW.className='desktop mx-auto'; e.target.classList.add('active'); contentEl.querySelector('#mobile-view-btn').classList.remove('active');} if(e.target.id==='mobile-view-btn'){pW.className='mobile mx-auto'; e.target.classList.add('active'); contentEl.querySelector('#desktop-view-btn').classList.remove('active');}
                 if(e.target.id==='copy-link-btn'){checkoutLinkOutput.select(); document.execCommand('copy'); e.target.textContent='Copiado!'; setTimeout(()=>{e.target.textContent='Copiar Link'},2000);} if(e.target.id==='create-another-btn'){hideResultScreen(); App.navigateTo('checkouts');} // Ajustado para ir para lista
            };
            contentEl.addEventListener('click', contentEl._clickListener);

             checkoutForm.removeEventListener('submit', checkoutForm._submitListener);
             checkoutForm._submitListener = async (e) => {
                 e.preventDefault(); const b=submitBtn; const oT=b.textContent; b.textContent='Salvando...'; b.disabled=true;
                 try{ const cD=getFormData(); if(cD.pricing.type==='fixed'&&(!cD.pricing.packages||cD.pricing.packages.length===0))throw new Error('Adicione pelo menos um pacote de pre√ßo.'); if(!cD.tracking.pixel_id)throw new Error('A sele√ß√£o de um Pixel da Meta √© obrigat√≥ria.');
                 if(App.state.editingCheckoutId){await App.apiRequest(`/api/checkouts/${App.state.editingCheckoutId}`,'PUT',cD); App.showToast('Checkout atualizado com sucesso!', 'success'); App.state.editingCheckoutId=null; App.navigateTo('checkouts');}else{const r=await App.apiRequest('/api/checkouts/create-hosted','POST',cD); if(r&&r.checkoutId){showResultScreen(r.checkoutId);}else{throw new Error('Erro ao criar checkout. Resposta da API inv√°lida.');}}}catch(error){App.showToast(error.message||'Erro ao salvar checkout. Verifique os campos.','error');} finally { b.disabled=false; b.textContent=oT;} // Garante restaura√ß√£o do bot√£o
             };
             checkoutForm.addEventListener('submit', checkoutForm._submitListener);
        },

        // *** FUN√á√ÉO initThankYouCreatorPage ATUALIZADA (refatorada) ***
        async initThankYouCreatorPage() {
            const FRONTEND_URL = window.location.origin;
            const creatorScreen = document.getElementById('creator-screen');
            if (!creatorScreen) { console.error("Creator screen not found."); return; }

            const thankYouForm = document.getElementById('thank-you-form');
            const submitBtn = document.getElementById('submit-btn');
            const resultScreen = document.getElementById('result-screen');
            const pageLinkOutput = document.getElementById('page-link-output');
            const copyLinkBtn = document.getElementById('copy-link-btn');
            const createAnotherBtn = document.getElementById('create-another-btn');
            const utmifySelect = document.getElementById('utmify_integration_id');
            const previewContent = document.getElementById('preview-content');
            const pageTitle = document.getElementById('ty-creator-title');
            const backBtn = document.getElementById('back-to-ty-list-btn');

            if (!thankYouForm || !submitBtn || !resultScreen || !pageLinkOutput || !copyLinkBtn || !createAnotherBtn || !utmifySelect || !previewContent || !pageTitle || !backBtn) {
                 console.error("Um ou mais elementos do Criador TY n√£o foram encontrados.");
                 this.showToast("Erro ao carregar o criador de p√°gina.", "error");
                 return;
            }

            // Garante que o bot√£o de voltar n√£o apare√ßa se n√£o houver sidebar (p√°gina standalone)
            if (!document.getElementById('sidebar')) {
                backBtn.style.display = 'none';
            }

            const apiKey = App.state.data.settings?.api_key;
            if (!apiKey) {
                App.showToast("Chave de API n√£o encontrada. Salve-a na p√°gina 'API PIX' antes de criar p√°ginas.", "error");
                submitBtn.disabled = true;
                thankYouForm.querySelectorAll('input, select, button').forEach(el => el.disabled = true); // Desabilita o form
                return;
            } else {
                 submitBtn.disabled = false;
                 thankYouForm.querySelectorAll('input, select, button').forEach(el => el.disabled = false); // Habilita o form
            }

            utmifySelect.innerHTML = '<option value="">N√£o enviar</option>';
            if (App.state.data.utmifyIntegrations && Array.isArray(App.state.data.utmifyIntegrations)) {
                App.state.data.utmifyIntegrations.forEach(int => {
                    const option = document.createElement('option'); option.value = int.id; option.textContent = int.account_name; utmifySelect.appendChild(option);
                });
            }

            function populateForm(config) {
                 document.getElementById('page_name').value = config.page_name || ''; document.getElementById('main_title').value = config.main_title || ''; document.getElementById('subtitle').value = config.subtitle || ''; document.getElementById('button_text').value = config.button_text || ''; document.getElementById('redirect_url').value = config.redirect_url || ''; document.getElementById('purchase_value').value = config.purchase_value || ''; document.getElementById('pixel_id').value = config.pixel_id || ''; document.getElementById('utmify_integration_id').value = config.utmify_integration_id || '';
            }
            function getFormDataFromTY() {
                const getV = (id) => document.getElementById(id)?.value || '';
                return {
                    page_name: getV('page_name'), main_title: getV('main_title'), subtitle: getV('subtitle'), button_text: getV('button_text'), redirect_url: getV('redirect_url'), purchase_value: parseFloat(getV('purchase_value')) || 0, pixel_id: getV('pixel_id'), utmify_integration_id: getV('utmify_integration_id') || null
                };
            }
            function updatePreviewTY() {
                 if (!previewContent) return;
                 const data = getFormDataFromTY();
                 previewContent.innerHTML = `
                    <div style="background-color: var(--bg-secondary); color: var(--text-primary); font-family: 'Inter', sans-serif; min-height: 100%; display: flex; align-items: center; justify-content: center; text-align: center; padding: 2rem;">
                        <div>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-400 mx-auto mb-4" viewBox="0 0 20 20" fill="currentColor"> <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /> </svg>
                            <h1 style="font-size: 2.25rem; font-weight: 800; color: white;">${data.main_title || 'Obrigado!'}</h1>
                            <p style="color: var(--text-secondary); margin-top: 0.5rem; max-width: 450px; margin-left: auto; margin-right: auto;">${data.subtitle || 'Subt√≠tulo...'}</p>
                            <a href="${data.redirect_url || '#'}" target="_blank" style="display: inline-block; background-color: var(--accent-secondary); color: white; font-weight: 600; padding: 0.75rem 1.5rem; border-radius: 0.375rem; margin-top: 1.5rem; text-decoration: none;">
                                ${data.button_text || 'Bot√£o'}
                            </a>
                        </div>
                    </div>`;
            }
            function showResultScreenTY(pageId) { const link = `${FRONTEND_URL}/obrigado/${pageId}`; pageLinkOutput.value = link; resultScreen.classList.remove('hidden'); }
            function hideResultScreenTY() { resultScreen.classList.add('hidden'); thankYouForm.reset(); updatePreviewTY(); }

            // L√≥gica de Edi√ß√£o ou Cria√ß√£o
            if (App.state.editingThankYouPageId) {
                pageTitle.textContent = 'Editar P√°gina de Obrigado'; submitBtn.textContent = 'Carregando...'; submitBtn.disabled = true; backBtn.textContent = 'Cancelar Edi√ß√£o';
                try {
                    const pageData = await App.apiRequest(`/api/thank-you-pages/${App.state.editingThankYouPageId}`);
                    if (pageData && pageData.config) { populateForm(pageData.config); submitBtn.textContent = 'Salvar Altera√ß√µes'; } else { throw new Error('Configura√ß√£o n√£o encontrada.'); }
                } catch (e) { App.showToast('Erro ao carregar dados da p√°gina.', 'error'); App.state.editingThankYouPageId = null; pageTitle.textContent = 'Criador de P√°gina de Obrigado'; submitBtn.textContent = 'Gerar P√°gina'; backBtn.textContent = 'Voltar para Lista'; thankYouForm.reset(); }
                finally { submitBtn.disabled = false; updatePreviewTY(); }
            } else {
                pageTitle.textContent = 'Criador de P√°gina de Obrigado'; submitBtn.textContent = 'Gerar P√°gina'; backBtn.textContent = 'Voltar para Lista'; thankYouForm.reset(); updatePreviewTY();
            }

            // Listeners
            thankYouForm.removeEventListener('input', updatePreviewTY);
            thankYouForm.addEventListener('input', updatePreviewTY);

            thankYouForm.removeEventListener('submit', thankYouForm._submitListener);
            thankYouForm._submitListener = async (e) => {
                e.preventDefault(); const button = submitBtn; const originalText = button.textContent; button.textContent = 'Salvando...'; button.disabled = true;
                const payload = getFormDataFromTY();
                 // Valida√ß√£o b√°sica no frontend
                if (!payload.page_name || !payload.purchase_value || !payload.pixel_id || !payload.redirect_url) {
                    App.showToast('Preencha todos os campos obrigat√≥rios.', 'error'); button.disabled = false; button.textContent = originalText; return;
                }
                try {
                    if (App.state.editingThankYouPageId) {
                         await App.apiRequest(`/api/thank-you-pages/${App.state.editingThankYouPageId}`, 'PUT', payload);
                         App.showToast('P√°gina atualizada com sucesso!', 'success'); App.state.editingThankYouPageId = null; App.navigateTo('thankYouPages');
                    } else {
                        const result = await App.apiRequest(`/api/thank-you-pages/create`, 'POST', payload);
                        showResultScreenTY(result.pageId);
                    }
                } catch (error) { /* Erro j√° tratado no apiRequest */ }
                finally { button.disabled = false; button.textContent = originalText; }
            };
            thankYouForm.addEventListener('submit', thankYouForm._submitListener);

            copyLinkBtn.removeEventListener('click', copyLinkBtn._clickListener);
            copyLinkBtn._clickListener = () => { pageLinkOutput.select(); document.execCommand('copy'); copyLinkBtn.textContent = 'Copiado!'; setTimeout(() => { copyLinkBtn.textContent = 'Copiar Link'; }, 2000); };
            copyLinkBtn.addEventListener('click', copyLinkBtn._clickListener);

            createAnotherBtn.removeEventListener('click', createAnotherBtn._clickListener);
            createAnotherBtn._clickListener = () => { hideResultScreenTY(); App.state.editingThankYouPageId = null; pageTitle.textContent = 'Criador de P√°gina de Obrigado'; submitBtn.textContent = 'Gerar P√°gina'; };
            createAnotherBtn.addEventListener('click', createAnotherBtn._clickListener);

            backBtn.removeEventListener('click', backBtn._clickListener);
            backBtn._clickListener = () => { App.state.editingThankYouPageId = null; App.navigateTo('thankYouPages'); };
            backBtn.addEventListener('click', backBtn._clickListener);
        },
    
    
        
        async validateNetlifyToken(button) {
    const tokenInput = document.getElementById('netlify-access-token-input');
    const token = tokenInput.value.trim();

    if (!token) {
        this.showToast('Por favor, insira o token de acesso do Netlify.', 'error');
        this.updateNetlifyStatus('Por favor, insira o token de acesso do Netlify.', 'error');
        return;
    }

    const originalText = button.textContent;
    button.textContent = 'Validando...';
    button.disabled = true;
    this.updateNetlifyStatus('Validando token do Netlify...', 'info');

    try {
        // Usa a fun√ß√£o apiRequest, que j√° envia o Bearer Token no cabe√ßalho Authorization
        const data = await this.apiRequest('/api/netlify/validate-token', 'POST', {
            access_token: token
            // REMOVIDO: N√£o precisa mais enviar 'X-User-ID': App.state.user.id
        });

        // A fun√ß√£o apiRequest j√° trata erros de rede e status n√£o-OK
        if (data.success) {
            this.showToast(data.message, 'success');
            this.updateNetlifyStatus(`‚úÖ ${data.message}`, 'success');

            // Atualiza o estado local (garantindo que settings exista)
            App.state.data.settings = App.state.data.settings || {};
            App.state.data.settings.netlify_access_token = token;

            if (data.user) {
                this.updateNetlifyStatus(
                    `‚úÖ ${data.message}\nüë§ Logado como: ${data.user.full_name || data.user.email}`,
                    'success'
                );
            }
        } else {
            // Embora apiRequest lance erro, podemos manter isso para clareza
            throw new Error(data.message || 'Erro na valida√ß√£o retornado pela API.');
        }
    } catch (error) { // O erro agora vem do apiRequest ou da l√≥gica acima
        const errorMessage = 'Erro ao validar token: ' + error.message;
        this.showToast(errorMessage, 'error');
        this.updateNetlifyStatus(`‚ùå ${errorMessage}`, 'error');
    } finally {
        button.textContent = originalText;
        button.disabled = false;
    }
}, // N√£o esque√ßa a v√≠rgula se houver mais fun√ß√µes depois

        
        
        updateNetlifyStatus(message, type) {
            const statusDiv = document.getElementById('netlify-status');
            const statusText = document.getElementById('netlify-status-text');
            
            if (statusDiv && statusText) {
                statusDiv.classList.remove('hidden');
                statusText.textContent = message;
                statusDiv.className = `p-3 rounded-md ${type === 'success' ? 'bg-green-800' : 'bg-red-800'}`;
            }
        },

        async testIndividualPixConnection(provider, button) {
            const originalText = button.innerHTML;
            button.innerHTML = 'Testando...';
            button.disabled = true;
            this.updatePixStatusIndicator(provider, 'testing');
            
            const form = document.getElementById('pixSettingsForm');
            const formData = Object.fromEntries(new FormData(form).entries());
            try {
                await this.apiRequest('/api/settings/pix', 'POST', formData);
                App.state.data.settings = { ...App.state.data.settings, ...formData };
            } catch (e) {
                this.showToast('Erro ao salvar as configura√ß√µes antes do teste.', 'error');
                button.innerHTML = originalText; button.disabled = false;
                this.updatePixStatusIndicator(provider); return;
            }

            try {
                const result = await this.apiRequest('/api/pix/test-provider', 'POST', { provider });
                localStorage.setItem(`pix_status_${provider}`, 'success');
                localStorage.setItem(`pix_timestamp_${provider}`, Date.now());
                
                const successModalContent = `<div class="space-y-4 text-sm"><div class="flex justify-between items-center"><span class="font-semibold text-gray-400">Provedor:</span> <span class="text-white">${result.provider}</span></div><div class="flex justify-between items-center"><span class="font-semibold text-gray-400">Adquirente:</span> <span class="text-white">${result.acquirer}</span></div><div class="flex justify-between items-center"><span class="font-semibold text-gray-400">Tempo de Resposta:</span> <span class="text-white">${result.responseTime}s</span></div><hr class="border-slate-700"><div><p class="font-semibold text-gray-400 mb-2">PIX Copia e Cola (R$ 0,05):</p><textarea id="pix-test-key" class="form-input w-full p-2 font-mono text-xs" rows="4" readonly>${result.qr_code_text}</textarea><button class="copy-btn btn w-full mt-2 py-2 text-sm" data-target="#pix-test-key">Copiar Chave PIX</button></div></div>`;
                document.getElementById('modal-container').innerHTML = this.templates.modal('Conex√£o Bem-sucedida!', successModalContent);

            } catch (error) {
                localStorage.setItem(`pix_status_${provider}`, 'failure');
                localStorage.setItem(`pix_timestamp_${provider}`, Date.now());
                const errorModalContent = `<div class="text-center"><p class="text-lg font-medium text-red-400 mb-2">Falha na Conex√£o</p><p class="text-sm text-gray-400">${error.message || 'Ocorreu um erro desconhecido.'}</p></div>`;
                document.getElementById('modal-container').innerHTML = this.templates.modal('Erro no Teste', errorModalContent);
            } finally {
                button.innerHTML = originalText; button.disabled = false;
                this.updatePixStatusIndicator(provider);
            }
        },
        
        async testPriorityRoute(button) {
            const originalText = button.innerHTML;
            button.innerHTML = 'Testando Rota...';
            button.disabled = true;

            const form = document.getElementById('pixSettingsForm');
            const formData = Object.fromEntries(new FormData(form).entries());
            try {
                await this.apiRequest('/api/settings/pix', 'POST', formData);
                App.state.data.settings = { ...App.state.data.settings, ...formData };
            } catch (e) {
                this.showToast('Erro ao salvar as configura√ß√µes antes do teste.', 'error');
                button.innerHTML = originalText; button.disabled = false; return;
            }

            try {
                const result = await this.apiRequest('/api/pix/test-priority-route', 'POST');
                const logHTML = result.log.map(line => `<li class="${line.startsWith('SUCESSO') ? 'text-green-400' : 'text-red-400'}">${line}</li>`).join('');
                const successModalContent = `<div class="space-y-4 text-sm"><div class="flex justify-between items-center"><span class="font-semibold text-gray-400">Provedor de Sucesso:</span> <span class="text-white">${result.provider} (${result.position})</span></div><div class="flex justify-between items-center"><span class="font-semibold text-gray-400">Tempo de Resposta:</span> <span class="text-white">${result.responseTime}s</span></div><hr class="border-slate-700"><div><p class="font-semibold text-gray-400 mb-2">Log de Tentativas:</p><ul class="text-xs font-mono list-disc list-inside space-y-1">${logHTML}</ul></div><hr class="border-slate-700"><div><p class="font-semibold text-gray-400 mb-2">PIX Copia e Cola (R$ 0,05):</p><textarea id="pix-test-key" class="form-input w-full p-2 font-mono text-xs" rows="3" readonly>${result.qr_code_text}</textarea><button class="copy-btn btn w-full mt-2 py-2 text-sm" data-target="#pix-test-key">Copiar Chave PIX</button></div></div>`;
                document.getElementById('modal-container').innerHTML = this.templates.modal('Teste da Rota Conclu√≠do!', successModalContent);

            } catch (error) {
                const logHTML = error.log ? error.log.map(line => `<li class="text-red-400">${line}</li>`).join('') : '<li>Nenhum log dispon√≠vel.</li>';
                const errorModalContent = `<div class="space-y-4 text-sm"><p class="text-lg font-medium text-red-400 text-center mb-2">Falha na Rota de Prioridade</p><p class="text-gray-400 text-center">${error.message}</p><hr class="border-slate-700"><div><p class="font-semibold text-gray-400 mb-2">Log de Tentativas:</p><ul class="text-xs font-mono list-disc list-inside space-y-1">${logHTML}</ul></div></div>`;
                document.getElementById('modal-container').innerHTML = this.templates.modal('Erro no Teste', errorModalContent);
            } finally {
                button.innerHTML = originalText; button.disabled = false;
            }
        },

        updateAllBotStatusIndicators() {
            if (this.state.data.bots && this.state.data.bots.length > 0) {
                this.state.data.bots.forEach(bot => this.updateBotStatusIndicator(bot.id));
            }
        },
        
        updateBotStatusIndicator(botId) {
            const indicator = document.getElementById(`status-indicator-bot-${botId}`);
            if (!indicator) return;
            indicator.textContent = '';
            indicator.className = '';
        },

        updateAllPixStatusIndicators() {
            const providers = ['pushinpay', 'cnpay', 'oasyfy', 'syncpay', 'brpix', 'wiinpay'];
            providers.forEach(provider => this.updatePixStatusIndicator(provider));
        },

        updatePixStatusIndicator(provider, mode) {
             const indicator = document.getElementById(`status-indicator-${provider}`);
            if (!indicator) return;

            if (mode === 'testing') {
                indicator.textContent = 'Testando...';
                indicator.className = 'status-indicator testing';
                return;
            }

            const status = localStorage.getItem(`pix_status_${provider}`);
            const timestamp = localStorage.getItem(`pix_timestamp_${provider}`);

            if (status === 'success' && timestamp) {
                indicator.textContent = `Ativo (Testado ${this.formatTimeAgo(timestamp)})`;
                indicator.className = 'status-indicator success';
            } else if (status === 'failure' && timestamp) {
                indicator.textContent = `Falhou (Testado ${this.formatTimeAgo(timestamp)})`;
                indicator.className = 'status-indicator failure';
            } else {
                indicator.textContent = 'N√£o testado';
                indicator.className = 'status-indicator unknown';
            }
        },

        formatTimeAgo(timestamp) {
            const seconds = Math.floor((Date.now() - timestamp) / 1000);
            if (seconds < 60) return "agora";
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `h√° ${minutes} min`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `h√° ${hours}h`;
            const days = Math.floor(hours / 24);
            return `h√° ${days}d`;
        },

        isSectionFetching(section) {
            return !!(this.state.sectionFetchInProgress && this.state.sectionFetchInProgress[section]);
        },

        setSectionFetching(section, isFetching) {
            if (!this.state.sectionFetchInProgress) {
                this.state.sectionFetchInProgress = {};
            }
            this.state.sectionFetchInProgress[section] = isFetching;
        },

        clearSectionPolling(section) {
            if (!this.state.sectionPolling) return;
            if (this.state.sectionPolling[section]) {
                clearInterval(this.state.sectionPolling[section]);
                delete this.state.sectionPolling[section];
            }
        },

        clearAllSectionPolling() {
            if (!this.state.sectionPolling) return;
            Object.values(this.state.sectionPolling).forEach(intervalId => {
                if (intervalId) clearInterval(intervalId);
            });
            this.state.sectionPolling = {};
        },

        startSectionPolling(section, handler, intervalMs = 15000) {
            if (typeof handler !== 'function') return;
            this.clearSectionPolling(section);
            if (!this.state.sectionPolling) {
                this.state.sectionPolling = {};
            }
            this.state.sectionPolling[section] = setInterval(() => {
                Promise.resolve()
                    .then(() => handler())
                    .catch(error => console.error(`[Polling] Erro ao atualizar ${section}:`, error));
            }, intervalMs);
        },
        
        showToast(message, type = 'success') {
            const toast = document.createElement('div');
            let bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            toast.className = `fixed bottom-5 right-5 ${bgColor} text-white py-2 px-4 rounded-lg shadow-lg animate-fade-in z-50`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        }
    };

    // Inicializa a aplica√ß√£o principal do HotTrack
    document.addEventListener('DOMContentLoaded', () => {
        App.init();
        
        // Verificar par√¢metros de callback do Google OAuth
        const urlParams = new URLSearchParams(window.location.search);
        const success = urlParams.get('success');
        const error = urlParams.get('error');
        const message = urlParams.get('message');
        
        if (success === 'google_login') {
            App.showToast('Login com Google realizado com sucesso!', 'success');
            // Limpar par√¢metros da URL
            window.history.replaceState({}, document.title, window.location.pathname);
            // Recarregar para atualizar o estado da aplica√ß√£o
            window.location.reload();
        } else if (error === 'google_auth_error') {
            App.showToast(`Erro na autentica√ß√£o: ${decodeURIComponent(message || 'Erro desconhecido')}`, 'error');
            // Limpar par√¢metros da URL
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    });
    </script>
    
    <script type="text/babel">
    // ==========================================================
// == L√ìGICA DO HOTBOT (COMPONENTES E ESTILOS PADRONIZADOS) ==
    // ==========================================================
    function launchHotBot(containerElement) {
        const { useState, useCallback, useEffect, useRef, useMemo } = window.React;
        const { ReactFlowProvider, ReactFlow, useNodesState, useEdgesState, addEdge, Background, Controls, Handle, Position } = window.ReactFlow;

    const API_BASE_URL = App.state.API_BASE_URL;
        const api = axios.create({ baseURL: API_BASE_URL });
        
        api.interceptors.request.use(
            config => {
            // Usar fun√ß√£o helper segura para obter token
            const token = App.getToken ? App.getToken() : App.state.token;
                if (token) {
                    config.headers['Authorization'] = `Bearer ${token}`;
                }
                return config;
            },
            error => Promise.reject(error)
        );

        api.interceptors.response.use(
            response => response,
            async error => {
                const status = error?.response?.status;
                const originalRequest = error?.config;

                // Tentar refresh em casos de 401 ou 403
                if ((status === 401 || status === 403) && originalRequest && !originalRequest._retry) {
                    // Evitar tentar refresh em rotas p√∫blicas ou de autentica√ß√£o
                    const isAuthRoute = 
                        originalRequest.url?.includes('/api/auth/refresh') ||
                        originalRequest.url?.includes('/api/auth/logout') ||
                        originalRequest.url?.includes('/api/sellers/login');
                    
                    if (!isAuthRoute) {
                        originalRequest._retry = true;
                        console.log(`[Axios Interceptor] Tentando renovar token ap√≥s erro ${status}...`);
                        const refreshed = await App.tryRefreshToken();
                        if (refreshed) {
                            const token = App.state.token || App.getToken();
                            if (token) {
                                originalRequest.headers = originalRequest.headers || {};
                                originalRequest.headers['Authorization'] = `Bearer ${token}`;
                                console.log(`[Axios Interceptor] Token renovado, repetindo requisi√ß√£o...`);
                                return api(originalRequest);
                            }
                        } else {
                            console.warn(`[Axios Interceptor] Falha ao renovar token ap√≥s erro ${status}.`);
                            // S√≥ fazer logout se n√£o houver refresh token dispon√≠vel
                            const refreshToken = App.state.refreshToken || App.getRefreshToken();
                            if (!refreshToken) {
                                console.warn(`[Axios Interceptor] Sem refresh token, deslogando...`);
                                await App.logout();
                            }
                        }
                    }
                }

                return Promise.reject(error);
            }
        );

    const Icons = {
        contacts: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zm-1.586 3.414a2 2 0 012.828 0L12 11.236V13h2v-2a2 2 0 00-2-2H8.414zM16 6a3 3 0 11-6 0 3 3 0 016 0z" /><path d="M18 9a2 2 0 012 2v2h-2v-2a2 2 0 01-2-2h-2a4 4 0 00-4 4v1a1 1 0 001 1h8a1 1 0 001-1v-1a4 4 0 00-4-4h-2z" /></svg>,
        attach: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M8 4a3 3 0 00-3 3v4a5 5 0 0010 0V7a3 3 0 10-6 0v4a1 1 0 102 0V7a1 1 0 112 0v4a3 3 0 11-6 0V7a1 1 0 011-1z" clipRule="evenodd" /></svg>,
        bots: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M11 17a1 1 0 001.447.894l4-2A1 1 0 0017 15V5a1 1 0 00-1.447-.894l-4 2A1 1 0 0011 7v10zM4 17a1 1 0 001.447.894l4-2A1 1 0 0010 15V5a1 1 0 00-1.447-.894l-4 2A1 1 0 004 7v10z" /></svg>,
        flows: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M12.586 2.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0l-1.5-1.5a2 2 0 112.828-2.828l1.5 1.5z" clipRule="evenodd" /><path fillRule="evenodd" d="M3.586 12.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0l-1.5-1.5a2 2 0 112.828-2.828l1.5 1.5z" clipRule="evenodd" /><path fillRule="evenodd" d="M8.586 6.586a2 2 0 10-2.828 2.828l3 3a2 2 0 002.828 0l1.5-1.5a2 2 0 10-2.828-2.828l-1.5 1.5z" clipRule="evenodd" /></svg>,
        chat: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8H5v2h2V8zm2 0h2v2H9V8zm6 0h-2v2h2V8z" clipRule="evenodd" /></svg>,
        media: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clipRule="evenodd" /></svg>,
        disparos: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>,
        history: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clipRule="evenodd" /></svg>,
        send: <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>,
    };

    function AppHotBot() {
            const [isLoading, setIsLoading] = useState(true);
            const [currentPage, setCurrentPage] = useState(() => {
                // Restaurar a √∫ltima p√°gina visitada do localStorage
                return localStorage.getItem('hotbot-currentPage') || 'bots';
            });
            const [editingFlow, setEditingFlow] = useState(null);
            const [bots, setBots] = useState([]);
            const [importingFlowLink, setImportingFlowLink] = useState(null);
            const [pressels, setPressels] = useState([]);
            const [thankYouPages, setThankYouPages] = useState([]);
            const [hostedCheckouts, setHostedCheckouts] = useState([]);
            const [flowEditorDirty, setFlowEditorDirty] = useState(false);
            const [flowEditorSaveHandler, setFlowEditorSaveHandler] = useState(null);
            const [discardChangesToken, setDiscardChangesToken] = useState(0);
            const [showUnsavedPrompt, setShowUnsavedPrompt] = useState(false);
            const [pendingNavigation, setPendingNavigation] = useState(null);
            const [isProcessingNavigation, setIsProcessingNavigation] = useState(false);

            const registerFlowEditorSaveHandler = useCallback((handler) => {
                setFlowEditorSaveHandler(() => handler || null);
            }, []);

            const handleFlowEditorDirtyChange = useCallback((value) => {
                setFlowEditorDirty(Boolean(value));
            }, []);

            const attemptPageChange = useCallback((nextPage, options = {}) => {
                const performNavigation = () => {
                    options.onNavigate?.();
                    setCurrentPage(nextPage);
                    options.afterNavigate?.();
                };

                if (
                    !options.force &&
                    currentPage === 'flow-editor' &&
                    nextPage !== 'flow-editor' &&
                    flowEditorDirty
                ) {
                    setPendingNavigation(() => performNavigation);
                    setShowUnsavedPrompt(true);
                    return false;
                }

                performNavigation();
                return true;
            }, [currentPage, flowEditorDirty]);

            const closeUnsavedPrompt = useCallback(() => {
                setShowUnsavedPrompt(false);
                setPendingNavigation(null);
                setIsProcessingNavigation(false);
            }, []);

            const handleLeaveWithoutSaving = useCallback(() => {
                const next = pendingNavigation;
                setShowUnsavedPrompt(false);
                setPendingNavigation(null);
                setIsProcessingNavigation(false);
                setFlowEditorDirty(false);
                setDiscardChangesToken((token) => token + 1);
                if (next) {
                    next();
                }
            }, [pendingNavigation]);

            const handleSaveAndLeave = useCallback(async () => {
                if (!flowEditorSaveHandler) {
                    handleLeaveWithoutSaving();
                    return;
                }

                setIsProcessingNavigation(true);
                try {
                    const saved = await flowEditorSaveHandler();
                    if (saved) {
                        const next = pendingNavigation;
                        setShowUnsavedPrompt(false);
                        setPendingNavigation(null);
                        setFlowEditorDirty(false);
                        setIsProcessingNavigation(false);
                        if (next) {
                            next();
                        }
                    } else {
                        setIsProcessingNavigation(false);
                    }
                } catch (error) {
                    console.error('Erro ao salvar antes de sair do editor:', error);
                    setIsProcessingNavigation(false);
                }
            }, [flowEditorSaveHandler, pendingNavigation, handleLeaveWithoutSaving]);

            const handlePromptCancel = useCallback(() => {
                closeUnsavedPrompt();
            }, [closeUnsavedPrompt]);

            // Salvar a p√°gina atual no localStorage sempre que mudar
            // Mas n√£o salvar estados tempor√°rios como flow-editor ou import-flow
            useEffect(() => {
                const temporaryPages = ['flow-editor', 'import-flow'];
                if (!temporaryPages.includes(currentPage)) {
                    localStorage.setItem('hotbot-currentPage', currentPage);
                }
            }, [currentPage]);

            const fetchInitialData = useCallback(() => {
                setIsLoading(true);
            api.get('/api/dashboard/data')
                .then((res) => {
                    setBots(res.data.bots || []);
                    setPressels(res.data.pressels || []);
                    setThankYouPages(res.data.thankYouPages || []);
                    setHostedCheckouts(res.data.hostedCheckouts || []);
                })
                .catch((err) => { console.error("Error fetching HotBot data:", err); App.logout(); })
                    .finally(() => setIsLoading(false));
            }, []);

            useEffect(() => {
                fetchInitialData();
                const urlParams = new URLSearchParams(window.location.search);
                const shareLink = urlParams.get('link');
                if (shareLink) {
                    setImportingFlowLink(shareLink);
                    setCurrentPage('import-flow');
                }
            }, [fetchInitialData]);

            // Se tentar acessar flow-editor sem um fluxo v√°lido, redirecionar para flows
            useEffect(() => {
                if (currentPage === 'flow-editor' && !editingFlow) {
                    attemptPageChange('flows', { force: true });
                }
            }, [attemptPageChange, currentPage, editingFlow]);

            const navigateToFlowEditor = useCallback((flow) => {
                setShowUnsavedPrompt(false);
                setPendingNavigation(null);
                setIsProcessingNavigation(false);
                setEditingFlow(flow);
                setFlowEditorDirty(false);
                setCurrentPage('flow-editor');
            }, []);

            const handleNavigationRequest = useCallback((page) => {
                attemptPageChange(page, {
                    onNavigate: () => {
                        if (page !== 'flow-editor') {
                            setEditingFlow(null);
                        }
                        if (page !== 'flow-editor') {
                            setFlowEditorDirty(false);
                        }
                    }
                });
            }, [attemptPageChange]);
            
        if (isLoading) return <div className="flex items-center justify-center h-full text-white">Carregando dados do HotBot...</div>;

            const PageComponent = {
                bots: <BotsPage bots={bots} fetchBots={fetchInitialData} />,
                flows: <FlowsListPage bots={bots} onEditFlow={navigateToFlowEditor} />,
                chat: <LiveChatPage bots={bots} />,
                media: <MediaLibraryPage />,
                disparos: <DisparosPage bots={bots} />,
                'flow-editor': editingFlow ? (
                    <FlowEditorPage
                        flow={editingFlow}
                        onRequestClose={() => attemptPageChange('flows', { onNavigate: () => setEditingFlow(null) })}
                        pressels={pressels}
                        thankYouPages={thankYouPages}
                        hostedCheckouts={hostedCheckouts}
                        onDirtyChange={handleFlowEditorDirtyChange}
                        registerSaveHandler={registerFlowEditorSaveHandler}
                        discardChangesToken={discardChangesToken}
                    />
                ) : null,
                'import-flow': (
                    <ImportFlowPage
                        shareableLinkId={importingFlowLink}
                        bots={bots}
                        onImported={() => {
                            attemptPageChange('flows', {
                                force: true,
                                onNavigate: () => {
                                    window.history.pushState({}, '', window.location.pathname);
                                    setImportingFlowLink(null);
                                }
                            });
                        }}
                    />
                )
            }[currentPage];

            return (
            <>
                {showUnsavedPrompt && (
                    <div
                        style={{
                            position: 'fixed',
                            inset: 0,
                            backgroundColor: 'rgba(15, 23, 42, 0.75)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            zIndex: 2000
                        }}
                    >
                        <div
                            style={{
                                backgroundColor: 'var(--bg-secondary)',
                                border: '1px solid var(--border-color)',
                                borderRadius: '12px',
                                padding: '24px',
                                maxWidth: '420px',
                                width: '90%',
                                boxShadow: '0 20px 40px rgba(15, 23, 42, 0.4)'
                            }}
                        >
                            <h3 style={{ fontSize: '1.25rem', marginBottom: '0.75rem', color: 'var(--text-primary)' }}>
                                Altera√ß√µes n√£o salvas
                            </h3>
                            <p style={{ color: 'var(--text-secondary)', lineHeight: 1.5 }}>
                                Voc√™ possui mudan√ßas no fluxo que ainda n√£o foram salvas. Deseja salvar antes de sair do editor?
                            </p>
                            <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '0.5rem', marginTop: '1.5rem' }}>
                                <button
                                    className="btn btn-secondary"
                                    onClick={handlePromptCancel}
                                    disabled={isProcessingNavigation}
                                >
                                    Continuar editando
                                </button>
                                <button
                                    className="btn btn-danger"
                                    onClick={handleLeaveWithoutSaving}
                                    disabled={isProcessingNavigation}
                                >
                                    Sair sem salvar
                                </button>
                                <button
                                    className="btn btn-primary"
                                    onClick={handleSaveAndLeave}
                                    disabled={isProcessingNavigation}
                                >
                                    {isProcessingNavigation ? 'Salvando...' : 'Salvar e sair'}
                                </button>
                            </div>
                        </div>
                    </div>
                )}
                <HotBotNav currentPage={currentPage} onNavigate={handleNavigationRequest} disabled={isProcessingNavigation || showUnsavedPrompt} />
                <main className="hotbot-content">
                        <div style={{animation: 'fadeIn 0.5s ease-in-out', height: '100%'}}>
                            {PageComponent}
                        </div>
                    </main>
            </>
            );
        }
    
    function HotBotNav({ currentPage, onNavigate, disabled }) {
        const pages = { 
            bots: { name: 'Bots', icon: Icons.bots },
            flows: { name: 'Fluxos', icon: Icons.flows },
            chat: { name: 'Chat ao Vivo', icon: Icons.chat },
            media: { name: 'Biblioteca', icon: Icons.media },
            disparos: { name: 'Disparos', icon: Icons.disparos },
        };
        return (
            <div className="hotbot-nav-bar">
                {Object.entries(pages).map(([key, { name, icon }]) => (
                    <button 
                        key={key} 
                        className={`tab-button nav-button ${currentPage === key ? 'active' : ''}`} 
                        onClick={() => onNavigate(key)} 
                        disabled={disabled}
                        title={name}
                    >
                        {React.cloneElement(icon, { className: 'h-5 w-5' })}
                        <span>{name}</span>
                    </button>
                ))}
            </div>
        );
    }
    
    function BotsPage({ bots, fetchBots }) {
      const [newBotName, setNewBotName] = useState('');
        const handleCreateBot = async (e) => { e.preventDefault(); if (!newBotName) return; try { await api.post('/api/bots', { bot_name: newBotName }); setNewBotName(''); fetchBots(); App.showToast('Bot criado com sucesso!', 'success'); } catch (e) { App.showToast(e.response?.data?.message || 'Erro ao criar bot', 'error'); } };
        const handleDeleteBot = async (id) => { if (confirm('Tem certeza que deseja excluir este bot e todos os seus dados?')) { try { await api.delete(`/api/bots/${id}`); fetchBots(); App.showToast('Bot exclu√≠do!', 'success'); } catch (e) { App.showToast('Erro ao excluir', 'error'); } } };
      const handleUpdateToken = async (id) => {
            const token = prompt("Insira o novo Token do Bot (obtido no @BotFather):"); 
          if (token) { 
              try { 
                  await api.put(`/api/bots/${id}`, { bot_token: token }); 
                    App.showToast('Token atualizado!', 'success');
                  fetchBots(); 
              } catch (e) { 
                    App.showToast(e.response?.data?.message || 'Erro ao atualizar token', 'error');
              } 
          } 
      };
        const handleConfigureGroup = async (id) => {
            const currentBot = bots.find(b => b.id === id);
            const groupId = prompt(
                "Insira o ID do Supergrupo do Telegram:\n\n" +
                "Como obter o ID:\n" +
                "1. Adicione o bot como administrador do grupo (Confirme que seu grupo √© um Supergrupo\n" +
                "2. Adicione o bot @myidbot no seu grupo e mande o comando /getgroupid\n" +
                "3. O bot vai mandar o ID do grupo (Come√ßa com -100)\n\n" +
                "ID atual: " + (currentBot?.telegram_supergroup_id || "N√£o configurado")
            );
            
            if (groupId !== null) {
                try {
                    await api.put(`/api/bots/${id}`, { 
                        bot_token: currentBot?.bot_token || '',
                        telegram_supergroup_id: groupId.trim() || null 
                    });
                    App.showToast(groupId ? 'Grupo configurado!' : 'Grupo removido!', 'success');
                    fetchBots();
                } catch (e) {
                    App.showToast(e.response?.data?.message || 'Erro ao configurar grupo', 'error');
                }
            }
        };
        const handleSetWebhook = async (id) => { try { const res = await api.post(`/api/bots/${id}/set-webhook`); App.showToast(res.data.message, 'success'); } catch (e) { App.showToast(e.response?.data?.message || 'Falha ao configurar webhook', 'error'); } };
        
      return (
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div className="card p-6 rounded-lg lg:col-span-1">
                    <h2 className="text-xl font-semibold mb-4 text-white">Adicionar Novo Bot</h2>
                    <form onSubmit={handleCreateBot} className="space-y-4">
                        <input name="bot_name" className="form-input w-full p-2" value={newBotName} onChange={(e) => setNewBotName(e.target.value)} placeholder="Username do Bot (sem @)" required />
                        <button type="submit" className="btn w-full p-2 rounded-md">Criar Bot</button>
                    </form>
                    </div>
                <div className="card p-6 rounded-lg lg:col-span-2">
                    <h2 className="text-xl font-semibold text-white mb-4">Bots Ativos</h2>
                    <div className="space-y-3 max-h-96 overflow-y-auto pr-2">
                        {bots.length > 0 ? bots.map(bot => (
                            <div key={bot.id} className="p-4 bg-slate-900/50 rounded-lg flex flex-col sm:flex-row justify-between items-center gap-4">
                                <span className="font-semibold text-white">{bot.bot_name}</span>
                                <div className="flex items-center gap-2 flex-shrink-0">
                                    <button className="btn btn-secondary text-xs py-1 px-3" onClick={() => handleUpdateToken(bot.id)}>Token</button>
                                    <button className="btn btn-secondary text-xs py-1 px-3" onClick={() => handleConfigureGroup(bot.id)}>Grupo</button>
                                    <button className="btn btn-secondary text-xs py-1 px-3" onClick={() => handleSetWebhook(bot.id)}>Webhook</button>
                                    <button className="btn btn-red text-xs py-1 px-2" onClick={() => handleDeleteBot(bot.id)}>Excluir</button>
                                </div>
                            </div>
                        )) : <p className="text-slate-500 text-center py-4">Nenhum bot criado ainda.</p>}
                </div>
            </div>
          </div>
        );
    }
    function ShareFlowModal({ flow, onClose, onLinkGenerated }) {
        const [isPaid, setIsPaid] = useState(false);
        const [price, setPrice] = useState(10);
        const [allowReshare, setAllowReshare] = useState(false);
        const [bundleLinkedFlows, setBundleLinkedFlows] = useState(false);
        const [bundleMedia, setBundleMedia] = useState(false);
        const [isGenerating, setIsGenerating] = useState(false);

        const handleGenerateLink = async () => {
            setIsGenerating(true);
            try {
                const options = {
                    priceInCents: isPaid ? Math.round(price * 100) : 0,
                    allowReshare,
                    bundleLinkedFlows,
                    bundleMedia
                };
                const response = await api.post(`/api/flows/${flow.id}/generate-share-link`, options);
                const link = `${window.location.origin}/?link=${response.data.shareable_link_id}`;
                prompt("Link de compartilhamento gerado! Copie abaixo:", link);
                onLinkGenerated();
                onClose();
            } catch (error) {
                alert('Erro ao gerar link: ' + (error.response?.data?.message || 'Tente novamente.'));
            } finally {
                setIsGenerating(false);
            }
        };

        return (
            <div className="login-overlay" style={{ zIndex: 101 }}>
                <div className="login-box" style={{ width: '500px' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                        <h2 style={{ fontWeight: 800, margin: 0 }}>Compartilhar Fluxo</h2>
                        <button onClick={onClose} style={{ background: 'none', border: 'none', color: 'white', fontSize: '1.5rem', cursor: 'pointer' }}>&times;</button>
                    </div>

                    <div className="form-group checkbox-group">
                        <input type="checkbox" id="isPaid" checked={isPaid} onChange={e => setIsPaid(e.target.checked)} />
                        <label htmlFor="isPaid">Cobrar pela importa√ß√£o deste fluxo?</label>
                    </div>
                    {isPaid && (
                        <div className="form-group">
                            <label htmlFor="price">Pre√ßo (R$)</label>
                            <input id="price" className="form-input" type="number" min="1" step="0.01" value={price} onChange={e => setPrice(parseFloat(e.target.value))} />
                        </div>
                    )}
                    
                    <div style={{ background: 'rgba(56, 189, 248, 0.1)', padding: '1rem', borderRadius: '8px', marginBottom: '1.5rem' }}>
                        <p style={{ color: 'var(--brand-primary)', fontSize: '0.9rem', margin: 0, fontWeight: '500' }}>üí° Configure o que ser√° inclu√≠do no compartilhamento:</p>
                    </div>

                    <div className="form-group checkbox-group">
                        <input type="checkbox" id="bundleFlows" checked={bundleLinkedFlows} onChange={e => setBundleLinkedFlows(e.target.checked)} />
                        <label htmlFor="bundleFlows" style={{ fontWeight: '500' }}>‚úÖ Incluir fluxos anexados (encaminhados)</label>
                    </div>
                    <div className="form-group checkbox-group">
                        <input type="checkbox" id="bundleMedia" checked={bundleMedia} onChange={e => setBundleMedia(e.target.checked)} />
                        <label htmlFor="bundleMedia" style={{ fontWeight: '500' }}>‚úÖ Incluir m√≠dias (imagens, v√≠deos, √°udios)</label>
                    </div>
                     <div className="form-group checkbox-group">
                        <input type="checkbox" id="allowReshare" checked={allowReshare} onChange={e => setAllowReshare(e.target.checked)} />
                        <label htmlFor="allowReshare">Permitir que quem importar compartilhe tamb√©m</label>
                    </div>

                    <button className="btn btn-primary" style={{ width: '100%' }} onClick={handleGenerateLink} disabled={isGenerating}>
                        {isGenerating ? 'Gerando...' : 'Gerar Link de Compartilhamento'}
                    </button>
                </div>
            </div>
        );
    }

    function FlowsListPage({ bots, onEditFlow }) {
        const [selectedBotId, setSelectedBotId] = useState('');
        const [flows, setFlows] = useState([]);
        const [isShareModalOpen, setIsShareModalOpen] = useState(false);
        const [flowToShare, setFlowToShare] = useState(null);
        
        const fetchFlows = useCallback(async () => {
            if (!selectedBotId) { setFlows([]); return; }
            try {
                const res = await api.get('/api/flows');
                setFlows(res.data.filter(f => f.bot_id == selectedBotId));
            } catch (e) { console.error("Erro ao buscar fluxos", e); }
        }, [selectedBotId]);
        
        const updateLeadState = useCallback((chatId, transformer) => {
            setUsers(prev => prev.map(lead => {
                if (lead.chat_id !== chatId) return lead;
                const updated = transformer({ ...lead });
                return updated || lead;
            }));
            setSelectedChat(prev => {
                if (!prev || prev.chat_id !== chatId) return prev;
                const updated = transformer({ ...prev });
                return updated || prev;
            });
        }, []);
        
        useEffect(() => {
            if (bots.length > 0 && !selectedBotId) setSelectedBotId(bots[0].id);
        }, [bots, selectedBotId]);

        useEffect(() => { fetchFlows(); }, [fetchFlows]);

        const handleCreate = async () => {
            const n = prompt("Nome do novo fluxo:");
            if(n && selectedBotId) {
                try {
                    await api.post('/api/flows', { name: n, botId: selectedBotId });
                    fetchFlows();
                } catch (e) { alert("Erro ao criar fluxo."); }
            }
        };

        const handleDelete = async (id) => {
            if (confirm("Tem certeza que deseja excluir este fluxo?")) {
                try {
                    await api.delete(`/api/flows/${id}`);
                    fetchFlows();
                } catch (e) { alert("Erro ao excluir fluxo."); }
            }
        };

        const handleToggleActive = async (flowId, currentStatus) => {
            try {
                const newStatus = !currentStatus;
                await api.patch(`/api/flows/${flowId}/activate`, { isActive: newStatus });
                fetchFlows();
            } catch (e) { 
                alert("Erro ao atualizar status do fluxo."); 
            }
        };

        const handleOpenShareModal = (flow) => {
            setFlowToShare(flow);
            setIsShareModalOpen(true);
        };

        return (
            <>
                {isShareModalOpen && <ShareFlowModal flow={flowToShare} onClose={() => setIsShareModalOpen(false)} onLinkGenerated={fetchFlows} />}
                <div style={{padding: '2rem 3rem', height: '100%', overflowY: 'auto'}}>
                    <div className="page-header"><h2>Fluxos de Conversa</h2><button className="btn btn-primary" onClick={handleCreate} disabled={!selectedBotId}>+ Novo Fluxo</button></div>
                    <div className="form-group" style={{maxWidth: '400px', marginBottom: '2rem'}}><label htmlFor="botSelect">Selecione um Bot</label><select id="botSelect" className="form-select" value={selectedBotId} onChange={e => setSelectedBotId(e.target.value)}><option value="">-- Selecione --</option>{bots.map(b => <option key={b.id} value={b.id}>{b.bot_name}</option>)}</select></div>
                    <div className="grid">
                        {flows.map(flow => (
                            <div key={flow.id} className="bot-card">
                               <div className="bot-card-header"><div className="icon">{Icons.flows}</div><h3>{flow.name}</h3></div>
                               <p style={{color: 'var(--text-secondary)', fontSize: '0.9rem', marginBottom: '1.5rem', flexGrow: 1}}>Modificado em: {new Date(flow.updated_at).toLocaleDateString()}</p>
                                <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '1rem'}}>
                                    <label style={{display: 'flex', alignItems: 'center', gap: '0.5rem', fontSize: '0.9rem', cursor: 'pointer'}}>
                                        <input 
                                            type="checkbox" 
                                            checked={!!flow.is_active} 
                                            onChange={() => handleToggleActive(flow.id, flow.is_active)}
                                            style={{cursor: 'pointer'}}
                                        />
                                        <span style={{color: flow.is_active ? 'var(--brand-primary)' : 'var(--text-secondary)', fontWeight: flow.is_active ? '600' : '400'}}>
                                            {flow.is_active ? 'Gatilho Ativo' : 'Gatilho Inativo'}
                                        </span>
                                    </label>
                                </div>
                                {flow.shareable_link_id && <p style={{color: 'var(--brand-secondary)', fontSize: '0.8rem', fontWeight: '600', marginBottom: '1rem'}}>‚úì Compartilhado</p>}
                                <div className="bot-card-actions">
                                    <button className="btn btn-primary btn-sm" onClick={() => onEditFlow(flow)}>Editor</button>
                                    <button 
                                        className="btn btn-secondary btn-sm" 
                                        onClick={() => handleOpenShareModal(flow)}
                                        title="Compartilhar fluxo"
                                    >
                                        Compartilhar
                                    </button>
                                    <button className="btn btn-danger btn-sm" style={{gridColumn: '1 / -1'}} onClick={() => handleDelete(flow.id)}>Excluir</button>
                                </div>
                            </div>
                        ))}
                        {flows.length === 0 && selectedBotId && <p style={{color: 'var(--text-secondary)'}}>Nenhum fluxo criado para este bot.</p>}
                    </div>
                </div>
            </>
        );
    }
    
    function ImportFlowPage({ shareableLinkId, bots, onImported }) {
        const [selectedBotId, setSelectedBotId] = useState('');
        const [isImporting, setIsImporting] = useState(false);
        const [isLoading, setIsLoading] = useState(true);
        const [flowDetails, setFlowDetails] = useState(null);
        const [error, setError] = useState('');
        const [pixData, setPixData] = useState(null);
        const [isWaitingPayment, setIsWaitingPayment] = useState(false);
        const [pollingInterval, setPollingInterval] = useState(null);

        useEffect(() => {
            if (bots.length > 0 && !selectedBotId) {
                setSelectedBotId(bots[0].id);
            }
        }, [bots]);

        useEffect(() => {
            if (shareableLinkId) {
                setIsLoading(true);
                api.get(`/api/share/details/${shareableLinkId}`)
                    .then(response => {
                        setFlowDetails(response.data);
                    })
                    .catch(err => {
                        setError(err.response?.data?.message || 'N√£o foi poss√≠vel carregar os detalhes deste fluxo.');
                    })
                    .finally(() => {
                        setIsLoading(false);
                    });
            }
        }, [shareableLinkId]);

        const handleFreeImport = async () => {
            if (!selectedBotId) { alert('Por favor, selecione um bot para importar o fluxo.'); return; }
            setIsImporting(true);
            try {
                await api.post('/api/flows/import-from-link', { shareableLinkId, botId: selectedBotId });
                alert('Fluxo importado com sucesso!');
                onImported();
            } catch (err) {
                alert('Erro ao importar o fluxo: ' + (err.response?.data?.message || 'Tente novamente.'));
            } finally {
                setIsImporting(false);
            }
        };
        
        const handleInitiatePixPayment = async () => {
            if (!selectedBotId) { 
                alert('Por favor, selecione um bot para importar o fluxo.'); 
                return; 
            }
            
            setIsWaitingPayment(true);
            try {
                const response = await api.post('/api/flows/generate-pix-import', { shareableLinkId });
                setPixData(response.data);
                
                // Iniciar polling para verificar pagamento
                startPaymentPolling(response.data.purchase_transaction_id);
            } catch (err) {
                alert('Erro ao gerar PIX: ' + (err.response?.data?.message || 'Tente novamente.'));
                setIsWaitingPayment(false);
            }
        };
        
        const startPaymentPolling = (purchaseTransactionId) => {
            console.log('[Polling] Iniciando verifica√ß√£o de pagamento:', purchaseTransactionId);
            
            const interval = setInterval(async () => {
                try {
                    const response = await api.get(`/api/flows/check-payment/${purchaseTransactionId}`);
                    console.log('[Polling] Status:', response.data);
                    
                    if (response.data.is_paid) {
                        console.log('[Polling] Pagamento confirmado! Importando fluxo...');
                        clearInterval(interval);
                        setPollingInterval(null);
                        
                        // Importar fluxo automaticamente
                        await handlePaidImport(purchaseTransactionId);
                    }
                } catch (err) {
                    console.error('[Polling] Erro ao verificar pagamento:', err);
                }
            }, 3000); // Verifica a cada 3 segundos
            
            setPollingInterval(interval);
        };
        
        const handlePaidImport = async (purchaseTransactionId) => {
            setIsImporting(true);
            try {
                await api.post('/api/flows/import-paid', { 
                    purchaseTransactionId, 
                    botId: selectedBotId
                });
                
                alert('üéâ Pagamento confirmado! Fluxo importado com sucesso!');
                setPixData(null);
                setIsWaitingPayment(false);
                onImported();
            } catch (err) {
                alert('Erro ao importar fluxo pago: ' + (err.response?.data?.message || 'Tente novamente.'));
                setIsWaitingPayment(false);
            } finally {
                setIsImporting(false);
            }
        };
        
        const handleCancelPayment = () => {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                setPollingInterval(null);
            }
            setPixData(null);
            setIsWaitingPayment(false);
        };
        
        // Cleanup ao desmontar componente
        useEffect(() => {
            return () => {
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                }
            };
        }, [pollingInterval]);

        if (isLoading) {
            return <div style={{ padding: '2rem 3rem' }}><h2>A carregar detalhes do fluxo...</h2></div>;
        }

        if (error) {
            return <div style={{ padding: '2rem 3rem' }}><h2>Erro</h2><p style={{color: 'var(--danger-text)'}}>{error}</p></div>;
        }
        
        const isPaid = flowDetails && flowDetails.share_price_cents > 0;
        const priceInReais = (flowDetails.share_price_cents / 100).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        const qrCodeSrc = normalizePixQrCodeSrc(pixData?.qr_code_base64);

        return (
            <div style={{ padding: '2rem 3rem', height: '100%', overflowY: 'auto' }}>
                <div className="page-header"><h2>Importar Fluxo: {flowDetails?.name}</h2></div>
                <div className="card" style={{ maxWidth: '600px', margin: '0 auto' }}>
                    
                    {isPaid ? (
                        <>
                            {!pixData ? (
                                <>
                                    <h3>Este √© um fluxo pago</h3>
                                    <p style={{color: 'var(--text-secondary)', margin: '1rem 0' }}>Para importar este fluxo, √© necess√°rio o pagamento de:</p>
                                    <h2 style={{color: 'var(--brand-primary)', marginBottom: '2rem' }}>{priceInReais}</h2>
                                    
                                    <div className="form-group" style={{marginBottom: '1.5rem'}}>
                                        <label htmlFor="botSelectImportPaid">Selecione o Bot de Destino</label>
                                        <select id="botSelectImportPaid" className="form-select" value={selectedBotId} onChange={e => setSelectedBotId(e.target.value)}>
                                            <option value="">-- Selecione um Bot --</option>
                                            {bots.map(b => <option key={b.id} value={b.id}>{b.bot_name}</option>)}
                                        </select>
                                    </div>
                                    
                                    <button className="btn btn-primary" onClick={handleInitiatePixPayment} disabled={isWaitingPayment || !selectedBotId}>
                                        {isWaitingPayment ? 'Gerando PIX...' : 'Pagar com PIX para Importar'}
                                    </button>
                                </>
                            ) : (
                                <div style={{textAlign: 'center'}}>
                                    <h3 style={{color: 'var(--brand-primary)', marginBottom: '1rem'}}>Pague com PIX</h3>
                                    <p style={{color: 'var(--text-secondary)', marginBottom: '1.5rem'}}>
                                        Valor: <strong>{(pixData.value).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</strong>
                                    </p>
                                    
                                    {qrCodeSrc && (
                                        <div style={{marginBottom: '1.5rem'}}>
                                            <img 
                                                src={qrCodeSrc} 
                                                alt="QR Code PIX" 
                                                style={{maxWidth: '280px', border: '2px solid var(--border-color)', borderRadius: '8px', padding: '10px', backgroundColor: 'white', display: 'block', margin: '0 auto'}}
                                            />
                                        </div>
                                    )}
                                    
                                    <div style={{marginBottom: '1.5rem'}}>
                                        <p style={{fontSize: '0.9rem', color: 'var(--text-secondary)', marginBottom: '0.5rem'}}>C√≥digo PIX Copia e Cola:</p>
                                        <div style={{
                                            backgroundColor: 'var(--bg-secondary)', 
                                            padding: '0.75rem', 
                                            borderRadius: '6px', 
                                            border: '1px solid var(--border-color)',
                                            wordBreak: 'break-all',
                                            fontSize: '0.85rem',
                                            fontFamily: 'monospace',
                                            maxHeight: '100px',
                                            overflowY: 'auto'
                                        }}>
                                            {pixData.qr_code_text}
                                        </div>
                                        <button 
                                            className="btn btn-secondary btn-sm" 
                                            style={{marginTop: '0.5rem'}}
                                            onClick={() => {
                                                navigator.clipboard.writeText(pixData.qr_code_text);
                                                alert('C√≥digo PIX copiado!');
                                            }}
                                        >
                                            üìã Copiar C√≥digo PIX
                                        </button>
                                    </div>
                                    
                                    <div style={{
                                        backgroundColor: '#fff3cd', 
                                        border: '1px solid #ffc107', 
                                        borderRadius: '6px', 
                                        padding: '1rem',
                                        marginBottom: '1rem'
                                    }}>
                                        <p style={{margin: 0, fontSize: '0.9rem', color: '#856404'}}>
                                            ‚è±Ô∏è <strong>Aguardando confirma√ß√£o do pagamento...</strong><br/>
                                            O fluxo ser√° importado automaticamente ap√≥s a confirma√ß√£o.
                                        </p>
                                    </div>
                                    
                                    <button className="btn btn-danger btn-sm" onClick={handleCancelPayment}>
                                        Cancelar Pagamento
                                    </button>
                                </div>
                            )}
                        </>
                    ) : (
                        <>
                            <p style={{ color: 'var(--text-secondary)', marginBottom: '1.5rem' }}>Selecione para qual dos seus bots voc√™ deseja adicionar este fluxo gratuito.</p>
                            <div className="form-group">
                                <label htmlFor="botSelectImport">Selecione o Bot de Destino</label>
                                <select id="botSelectImport" className="form-select" value={selectedBotId} onChange={e => setSelectedBotId(e.target.value)}>
                                    <option value="">-- Selecione um Bot --</option>
                                    {bots.map(b => <option key={b.id} value={b.id}>{b.bot_name}</option>)}
                                </select>
                            </div>
                            <button className="btn btn-primary" onClick={handleFreeImport} disabled={isImporting || !selectedBotId}>
                                {isImporting ? 'Importando...' : 'Confirmar Importa√ß√£o Gratuita'}
                            </button>
                        </>
                    )}
                </div>
            </div>
        );
    }
    
    function DisparosPage({ bots }) {
    const { useState, useEffect, useCallback } = window.React;
    // Tab state
    const [activeTab, setActiveTab] = useState('disparos');
    
    // Disparo states
    const [selectedBotIds, setSelectedBotIds] = useState([]);
    const [campaignName, setCampaignName] = useState('');
    const [contactCount, setContactCount] = useState(0);
    const [isFilteringContacts, setIsFilteringContacts] = useState(false);
    const [isSending, setIsSending] = useState(false);
    const [isScheduled, setIsScheduled] = useState(false);
    const [scheduledDateTime, setScheduledDateTime] = useState('');
    const [selectedTagIds, setSelectedTagIds] = useState([]);
    const [tagFilterMode, setTagFilterMode] = useState('include'); // 'include' ou 'exclude'
    const [availableTags, setAvailableTags] = useState([]);
    const [isLoadingTags, setIsLoadingTags] = useState(false);
    
    // Disparo flow states
    const [disparoFlows, setDisparoFlows] = useState([]);
    const [selectedDisparoFlowId, setSelectedDisparoFlowId] = useState('');
    const [editingDisparoFlow, setEditingDisparoFlow] = useState(null);
    const [isLoadingFlows, setIsLoadingFlows] = useState(false);
    
    // Disparo flows management tab states
    const [selectedBotIdFlows, setSelectedBotIdFlows] = useState('');
    const [disparoFlowsList, setDisparoFlowsList] = useState([]);
    const [isLoadingFlowsList, setIsLoadingFlowsList] = useState(false);
    
    // Disparo progress states (unificado para higieniza√ß√£o + disparo)
    const [activeDisparoId, setActiveDisparoId] = useState(null);
    const [showDisparoProgressModal, setShowDisparoProgressModal] = useState(false);
    const [disparoProgress, setDisparoProgress] = useState(null);
    const disparoPollingIntervalRef = window.React.useRef(null);
    const [isDisparoInProgress, setIsDisparoInProgress] = useState(false);
    
    // Historico tab states
    const [history, setHistory] = useState([]);
    const [isLoadingHistory, setIsLoadingHistory] = useState(true);
    const [isChecking, setIsChecking] = useState(null);
    const [currentPage, setCurrentPage] = useState(1);
    const [totalPages, setTotalPages] = useState(1);
    const [totalItems, setTotalItems] = useState(0);
    const [itemsPerPage, setItemsPerPage] = useState(20);
    const [disparoPollingInterval, setDisparoPollingInterval] = useState(null);
    
    // Dashboard data states for button URL dropdown
    const [pressels, setPressels] = useState([]);
    const [thankYouPages, setThankYouPages] = useState([]);
    const [hostedCheckouts, setHostedCheckouts] = useState([]);
    
    const API_BASE_URL = App.state.API_BASE_URL;
    const buildPreviewSrc = (value) => {
        if (!value) return null;
        const v = String(value).trim();
        return v.startsWith('http') ? v : `${API_BASE_URL}/api/media/preview/storage/${v}`;
    };

    // Reset tags when bots change
    useEffect(() => {
        setSelectedTagIds([]);
        setTagFilterMode('include');
        setAvailableTags([]);
    }, [selectedBotIds]);
    
    // Verificar se h√° disparo em progresso ao montar componente
    useEffect(() => {
        const checkActiveDisparo = async () => {
            try {
                const response = await App.apiRequest('/api/disparos/check-active', 'GET');
                if (response.active && response.disparo) {
                    setActiveDisparoId(response.disparo.id);
                    setIsDisparoInProgress(true);
                    
                    // S√≥ mostrar modal se n√£o for agendado (agendados n√£o t√™m progresso)
                    if (response.disparo.status !== 'SCHEDULED') {
                    setShowDisparoProgressModal(true);
                    setDisparoProgress({ 
                        status: response.disparo.status, 
                            progress_percentage: response.disparo.progress_percentage || 0,
                        current_step: response.disparo.current_step
                    });
                    startDisparoPolling(response.disparo.id);
                    } else {
                        // Para agendados, apenas bloquear bot√£o, n√£o mostrar modal
                        setShowDisparoProgressModal(false);
                    }
                } else {
                    setIsDisparoInProgress(false);
                }
            } catch (error) {
                console.error('Erro ao verificar disparo ativo:', error);
            }
        };
        
        if (activeTab === 'disparos') {
            checkActiveDisparo();
        }
        
        // Cleanup ao desmontar
        return () => {
            if (disparoPollingIntervalRef.current) {
                clearInterval(disparoPollingIntervalRef.current);
                disparoPollingIntervalRef.current = null;
            }
        };
    }, [activeTab]);
    
    // Verificar periodicamente se h√° disparo em progresso (para liberar bot√£o quando concluir)
    useEffect(() => {
        if (activeTab !== 'disparos' || isDisparoInProgress) return;
        
        const checkInterval = setInterval(async () => {
            try {
                const response = await App.apiRequest('/api/disparos/check-active', 'GET');
                if (!response.active) {
                    setIsDisparoInProgress(false);
                }
            } catch (error) {
                console.error('Erro ao verificar disparo ativo:', error);
            }
        }, 5000); // Verificar a cada 5 segundos
        
        return () => clearInterval(checkInterval);
    }, [activeTab, isDisparoInProgress]);
    
    // Fetch available tags when bots change
    useEffect(() => {
        const fetchTags = async () => {
            if (selectedBotIds.length === 0) {
                setAvailableTags([]);
                return;
            }
            
            setIsLoadingTags(true);
            try {
                const allTags = [];
                for (const botId of selectedBotIds) {
                    try {
                        const tags = await App.apiRequest(`/api/tags?botId=${botId}`, 'GET');
                        if (Array.isArray(tags)) {
                            allTags.push(...tags);
                        }
                    } catch (error) {
                        console.error(`Erro ao buscar tags do bot ${botId}:`, error);
                    }
                }
                // Remover duplicatas por ID e tamb√©m por t√≠tulo para tags autom√°ticas
                const seenIds = new Set();
                const seenAutomaticTitles = new Set();
                const uniqueTags = allTags.filter(tag => {
                    // Para tags autom√°ticas, verificar por t√≠tulo tamb√©m
                    if (tag.type === 'automatic' || tag.id === 'Pagante') {
                        if (seenAutomaticTitles.has(tag.title)) {
                            return false;
                        }
                        seenAutomaticTitles.add(tag.title);
                        return true;
                    }
                    // Para tags custom, verificar por ID
                    if (seenIds.has(tag.id)) {
                        return false;
                    }
                    seenIds.add(tag.id);
                    return true;
                });
                setAvailableTags(uniqueTags);
            } catch (error) {
                console.error('Erro ao buscar tags:', error);
                setAvailableTags([]);
            } finally {
                setIsLoadingTags(false);
            }
        };
        fetchTags();
    }, [selectedBotIds]);

    // Fetch contact count when selected bots change (SEM tags - apenas contagem b√°sica)
    useEffect(() => {
        const fetchCount = async () => {
            if (selectedBotIds.length === 0) {
                setContactCount(0);
                return;
            }
            // Se h√° tags selecionadas, n√£o buscar automaticamente - usu√°rio deve clicar em "Filtrar"
            if (selectedTagIds.length > 0) {
                setContactCount(0); // Resetar contagem quando tags s√£o selecionadas
                return;
            }
            try {
                const requestBody = { 
                    botIds: selectedBotIds
                };
                
                const response = await App.apiRequest('/api/bots/contacts-count', 'POST', requestBody);
                setContactCount(response.count);
            } catch (error) {
                console.error("Erro ao buscar contagem de contatos", error);
                setContactCount(0);
                App.showToast('Erro ao buscar contagem de contatos.', 'error');
            }
        };
        fetchCount();
    }, [selectedBotIds]); // Removido selectedTagIds e tagFilterMode das depend√™ncias

    // Fun√ß√£o para filtrar contatos manualmente (chamada pelo bot√£o)
    const handleFilterContacts = async () => {
        if (selectedBotIds.length === 0) {
            App.showToast('Selecione pelo menos um bot antes de filtrar.', 'warning');
            return;
        }
        
        setIsFilteringContacts(true);
        try {
            const requestBody = { 
                botIds: selectedBotIds
            };
            
            // Adicionar tagIds e tagFilterMode se tags foram selecionadas
            if (selectedTagIds.length > 0) {
                requestBody.tagIds = selectedTagIds;
                requestBody.tagFilterMode = tagFilterMode;
            }
            
            const response = await App.apiRequest('/api/bots/contacts-count', 'POST', requestBody);
            setContactCount(response.count);
            
            if (selectedTagIds.length > 0) {
                App.showToast(`Filtro aplicado: ${response.count} contato(s) encontrado(s).`, 'success');
            } else {
                App.showToast(`Contagem atualizada: ${response.count} contato(s).`, 'success');
            }
        } catch (error) {
            console.error("Erro ao filtrar contatos", error);
            setContactCount(0);
            App.showToast('Erro ao filtrar contatos. Tente novamente.', 'error');
        } finally {
            setIsFilteringContacts(false);
        }
    };

    // Fetch disparo flows
    const fetchDisparoFlows = useCallback(async () => {
        setIsLoadingFlows(true);
        try {
            const flows = await App.apiRequest('/api/disparo-flows', 'GET');
            setDisparoFlows(flows);
        } catch (error) {
            console.error('Erro ao buscar fluxos de disparo:', error);
            App.showToast('Erro ao carregar fluxos de disparo.', 'error');
        } finally {
            setIsLoadingFlows(false);
        }
    }, []);

    useEffect(() => {
        if (activeTab === 'disparos') {
            fetchDisparoFlows();
        }
    }, [activeTab, fetchDisparoFlows]);

    // Fetch disparo flows for management tab
    const fetchDisparoFlowsList = useCallback(async () => {
        setIsLoadingFlowsList(true);
        try {
            const flows = await App.apiRequest('/api/disparo-flows', 'GET');
            setDisparoFlowsList(flows);
        } catch (error) {
            console.error('Erro ao buscar fluxos de disparo:', error);
            App.showToast('Erro ao carregar fluxos de disparo.', 'error');
        } finally {
            setIsLoadingFlowsList(false);
        }
    }, []);

    useEffect(() => {
        if (activeTab === 'fluxos-disparo') {
            fetchDisparoFlowsList();
        }
    }, [activeTab, fetchDisparoFlowsList]);

    // Fetch dashboard data for button URL dropdown
    const fetchDashboardData = useCallback(async () => {
        try {
            const res = await api.get('/api/dashboard/data');
            setPressels(res.data.pressels || []);
            setThankYouPages(res.data.thankYouPages || []);
            setHostedCheckouts(res.data.hostedCheckouts || []);
        } catch (error) {
            console.error('Erro ao buscar dados do dashboard:', error);
        }
    }, []);

    useEffect(() => {
        fetchDashboardData();
    }, [fetchDashboardData]);

    // Fetch history for historico tab
    const fetchHistory = useCallback((page = 1, showToast = false) => {
        setIsLoadingHistory(true);
        App.apiRequest(`/api/disparos/history?page=${page}&limit=${itemsPerPage}`, 'GET')
            .then(res => {
                // Compatibilidade com resposta antiga e nova
                if (res.data && res.pagination) {
                    setHistory(res.data);
                    setCurrentPage(res.pagination.page);
                    setTotalPages(res.pagination.totalPages);
                    setTotalItems(res.pagination.total);
                } else {
                    // Resposta antiga (array direto)
                    setHistory(res);
                    setCurrentPage(1);
                    setTotalPages(1);
                    setTotalItems(res.length);
                }
                if (showToast) {
                    App.showToast('Hist√≥rico atualizado com sucesso!', 'success');
                }
            })
            .catch(() => {
                console.error('Erro ao atualizar hist√≥rico.');
                if (showToast) {
                    App.showToast('Erro ao atualizar hist√≥rico.', 'error');
                }
            })
            .finally(() => setIsLoadingHistory(false));
    }, [itemsPerPage]);

    // Polling para disparos em execu√ß√£o
    useEffect(() => {
        // Verificar se h√° disparos em execu√ß√£o
        const hasRunningDisparos = history.some(item => 
            item.status === 'RUNNING' || item.status === 'PENDING'
        );

        if (hasRunningDisparos && activeTab === 'historico') {
            // Iniciar polling a cada 4 segundos
            const interval = setInterval(() => {
                fetchHistory(currentPage, false); // Atualizar sem toast
            }, 4000);
            
            setDisparoPollingInterval(interval);
            
            return () => {
                clearInterval(interval);
            };
        } else {
            // Limpar intervalo se n√£o h√° disparos em execu√ß√£o
            if (disparoPollingInterval) {
                clearInterval(disparoPollingInterval);
                setDisparoPollingInterval(null);
            }
        }
    }, [history, activeTab, currentPage, fetchHistory, disparoPollingInterval]);

    useEffect(() => {
        if (activeTab === 'historico') {
            setCurrentPage(1);
            setIsLoadingHistory(true);
            App.apiRequest(`/api/disparos/history?page=1&limit=${itemsPerPage}`, 'GET')
                .then(res => {
                    if (res.data && res.pagination) {
                        setHistory(res.data);
                        setCurrentPage(res.pagination.page);
                        setTotalPages(res.pagination.totalPages);
                        setTotalItems(res.pagination.total);
                    } else {
                        setHistory(res);
                        setCurrentPage(1);
                        setTotalPages(1);
                        setTotalItems(res.length);
                    }
                })
                .catch(() => App.showToast('Erro ao carregar o hist√≥rico.', 'error'))
                .finally(() => setIsLoadingHistory(false));
        }
    }, [activeTab, itemsPerPage]);

    const handleCreateDisparoFlow = async () => {
        if (selectedBotIds.length === 0) {
            App.showToast('Selecione pelo menos um bot primeiro.', 'error');
            return;
        }
        // Usar o primeiro bot selecionado para criar o fluxo
        const botId = selectedBotIds[0];
        const name = prompt('Nome do novo fluxo de disparo:');
        if (!name) return;
        
        try {
            const newFlow = await App.apiRequest('/api/disparo-flows', 'POST', { name, botId });
            setEditingDisparoFlow(newFlow);
            await fetchDisparoFlows();
        } catch (error) {
            App.showToast('Erro ao criar fluxo de disparo.', 'error');
        }
    };

    const handleEditDisparoFlow = async (flowId) => {
        try {
            const flow = await App.apiRequest(`/api/disparo-flows/${flowId}`, 'GET');
            setEditingDisparoFlow(flow);
        } catch (error) {
            App.showToast('Erro ao carregar fluxo de disparo.', 'error');
        }
    };

    const handleCreateDisparoFlowFromTab = async () => {
        if (bots.length === 0) {
            App.showToast('Nenhum bot dispon√≠vel.', 'error');
            return;
        }
        const name = prompt('Nome do novo fluxo de disparo:');
        if (!name) return;
        
        // Usar o primeiro bot dispon√≠vel para criar o fluxo
        const botId = bots[0].id;
        try {
            const newFlow = await App.apiRequest('/api/disparo-flows', 'POST', { name, botId });
            setEditingDisparoFlow(newFlow);
            await fetchDisparoFlowsList();
        } catch (error) {
            App.showToast('Erro ao criar fluxo de disparo.', 'error');
        }
    };

    const handleDeleteDisparoFlow = async (id) => {
        if (confirm('Tem certeza que deseja excluir este fluxo de disparo?')) {
            try {
                await App.apiRequest(`/api/disparo-flows/${id}`, 'DELETE');
                await fetchDisparoFlowsList();
                App.showToast('Fluxo de disparo exclu√≠do com sucesso.', 'success');
            } catch (error) {
                App.showToast('Erro ao excluir fluxo de disparo.', 'error');
            }
        }
    };

    const handleBotSelection = (botId) => {
        setSelectedBotIds(prev =>
            prev.includes(botId) ? prev.filter(id => id !== botId) : [...prev, botId]
        );
    };

    // Fun√ß√£o handleHygienize removida - higieniza√ß√£o agora √© autom√°tica no disparo

    const addStep = (type) => {
        const newStep = { id: Date.now(), type };
        // Initialize step data based on type (same as old frontend)
        switch (type) {
            case 'message': newStep.text = ''; newStep.buttonText = ''; newStep.buttonUrl = ''; break;
            case 'image': case 'video': case 'audio': newStep.fileUrl = ''; newStep.caption = ''; break;
            case 'pix': newStep.valueInCents = 100; newStep.pixMessage = ''; newStep.pixButtonText = 'üìã Copiar C√≥digo'; break;
            case 'check_pix': newStep.deliveryText = '‚úÖ Pagamento confirmado! Aqui est√° seu acesso:'; newStep.deliveryButtonText = 'Acessar Conte√∫do'; newStep.deliveryButtonUrl = ''; break;
            default: break;
        }
        setFlowSteps(prev => [...prev, newStep]);
    };

    const updateStep = (id, field, value) => {
        setFlowSteps(prev => prev.map(step => step.id === id ? { ...step, [field]: value } : step));
    };

    const removeStep = (id) => {
        setFlowSteps(prev => prev.filter(step => step.id !== id));
    };

    // Function to open the modal and store the callback
    const openMediaLibrary = (callback, allowedTypes = null) => {
        setMediaSelectionCallback(() => callback); // Store the specific callback
        setMediaAllowedTypes(allowedTypes);
        setIsMediaModalOpen(true);
    };

    // Function called when media is selected in the modal
    const handleSelectMedia = (mediaItem) => {
        if (mediaSelectionCallback) {
            mediaSelectionCallback(mediaItem.file_id); // Execute the stored callback
        }
        setIsMediaModalOpen(false);
        setMediaSelectionCallback(null); // Clear the callback
        setMediaAllowedTypes(null);
    };

    const handleSubmit = async (e) => {
    e.preventDefault();
    if (!campaignName || selectedBotIds.length === 0 || !selectedDisparoFlowId) {
        App.showToast('Preencha o nome da campanha, selecione ao menos um bot e escolha um fluxo de disparo.', 'error');
        return;
    }
    
    // Verificar se h√° disparo ativo (apenas para disparos imediatos)
    if (!isScheduled && isDisparoInProgress) {
        App.showToast('J√° existe um disparo em andamento. Aguarde a conclus√£o antes de iniciar um novo.', 'error');
        return;
    }
    
    // Validar agendamento se ativado
    if (isScheduled) {
        // Verificar se j√° existe disparo agendado
        try {
            const activeCheck = await App.apiRequest('/api/disparos/check-active', 'GET');
            if (activeCheck.active && activeCheck.disparo && activeCheck.disparo.status === 'SCHEDULED') {
                const scheduledDateStr = activeCheck.disparo.scheduled_at 
                    ? new Date(activeCheck.disparo.scheduled_at).toLocaleString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                    : 'data n√£o definida';
                App.showToast(`J√° existe um disparo agendado: "${activeCheck.disparo.campaign_name}" para ${scheduledDateStr}. Cancele o disparo agendado antes de criar um novo.`, 'error');
                return;
            }
        } catch (error) {
            console.error('Erro ao verificar disparo agendado:', error);
        }
        if (!scheduledDateTime) {
            App.showToast('Por favor, selecione uma data e hora para o agendamento.', 'error');
            return;
        }
        const scheduledDate = new Date(scheduledDateTime);
        const now = new Date();
        const minScheduledTime = new Date(now.getTime() + 120000);
        
        if (scheduledDate <= minScheduledTime) {
            const minDateStr = minScheduledTime.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            App.showToast(`A data/hora de agendamento deve ser no futuro. Data/hora m√≠nima: ${minDateStr}`, 'error');
            return;
        }
    }
    
    setIsSending(true);
    try {
        const requestBody = { 
            campaignName, 
            botIds: selectedBotIds, 
            disparoFlowId: selectedDisparoFlowId
        };
        
        // Adicionar tagIds e tagFilterMode se tags foram selecionadas
        if (selectedTagIds.length > 0) {
            requestBody.tagIds = selectedTagIds;
            requestBody.tagFilterMode = tagFilterMode;
        }
        
        // Adicionar scheduledAt se agendamento estiver ativado
        if (isScheduled && scheduledDateTime) {
            const scheduledDate = new Date(scheduledDateTime);
            requestBody.scheduledAt = scheduledDate.toISOString();
        }
        
        const response = await App.apiRequest('/api/bots/mass-send', 'POST', requestBody);
        
        // Se for agendado, n√£o mostrar modal de progresso
        if (isScheduled) {
            App.showToast(response.message || 'Disparo agendado com sucesso!', 'success');
            setCampaignName('');
            setSelectedBotIds([]);
            setSelectedDisparoFlowId('');
            setContactCount(0);
            setIsScheduled(false);
            setScheduledDateTime('');
            setSelectedTagIds([]);
            setTagFilterMode('include');
        } else {
            // Disparo imediato - iniciar polling
            const historyId = response.historyId;
            if (historyId) {
                setActiveDisparoId(historyId);
                setShowDisparoProgressModal(true);
                setIsDisparoInProgress(true);
                setDisparoProgress({ 
                    status: 'PENDING', 
                    progress_percentage: 0, 
                    current_step: null 
                });
                
                // Iniciar polling do status
                startDisparoPolling(historyId);
            }
        }
    } catch (error) {
        // Se o erro for 409 (conflito - disparo ativo ou agendado), atualizar estado
        if (error.response?.status === 409) {
            const errorData = error.response?.data;
            App.showToast(errorData?.message || 'J√° existe um disparo em andamento ou agendado.', 'error');
            
            // Se o backend retornou informa√ß√µes do disparo ativo, atualizar estado
            if (errorData?.activeDisparo) {
                setIsDisparoInProgress(true);
                setActiveDisparoId(errorData.activeDisparo.id);
                // S√≥ mostrar modal se n√£o for agendado
                if (errorData.activeDisparo.status !== 'SCHEDULED') {
                    setShowDisparoProgressModal(true);
                    // Verificar status do disparo ativo
                    try {
                        const statusResponse = await App.apiRequest(`/api/disparos/status/${errorData.activeDisparo.id}`, 'GET');
                        setDisparoProgress(statusResponse);
                        startDisparoPolling(errorData.activeDisparo.id);
                    } catch (statusError) {
                        console.error('Erro ao buscar status do disparo ativo:', statusError);
                    }
                }
            }
            
            // Se o backend retornou informa√ß√µes do disparo agendado
            if (errorData?.scheduledDisparo) {
                setIsDisparoInProgress(true);
                // N√£o mostrar modal para agendados, apenas bloquear bot√£o
            }
        } else {
        App.showToast(error.response?.data?.message || 'Erro ao iniciar disparo.', 'error');
        }
        console.error("Erro submit disparo:", error);
    } finally {
        setIsSending(false);
    }
};

    // Fun√ß√£o para iniciar polling do status do disparo
    const startDisparoPolling = (historyId) => {
        // Limpar polling anterior se existir
        if (disparoPollingIntervalRef.current) {
            clearInterval(disparoPollingIntervalRef.current);
        }
        
        const interval = setInterval(async () => {
            try {
                const status = await App.apiRequest(`/api/disparos/status/${historyId}`, 'GET');
                setDisparoProgress(status);
                
                // Parar polling se completou ou falhou
                if (status.status === 'COMPLETED' || status.status === 'FAILED') {
                    clearInterval(interval);
                    disparoPollingIntervalRef.current = null;
                    setIsDisparoInProgress(false);
                    
                    if (status.status === 'COMPLETED') {
                        App.showToast('Disparo conclu√≠do com sucesso!', 'success');
                        // Fechar modal ap√≥s 2 segundos
                        setTimeout(() => {
                            setShowDisparoProgressModal(false);
                            setActiveDisparoId(null);
                        }, 2000);
                    } else {
                        App.showToast('Disparo falhou. Verifique os logs.', 'error');
                    }
                    
                    // Atualizar hist√≥rico
                    if (activeTab === 'historico') {
                        fetchHistory(currentPage, false);
                    }
                }
            } catch (error) {
                console.error('Erro ao consultar status do disparo:', error);
            }
        }, 2000); // Polling a cada 2 segundos
        
        disparoPollingIntervalRef.current = interval;
    };
    // renderStep function remains largely the same, just ensure classNames match the new CSS if needed
    const renderStep = (step) => {
        switch (step.type) {
            case 'message': return (<div key={step.id} className="card" style={{ marginBottom: '1rem' }}><h4 style={{ marginBottom: '1rem', display: 'flex', justifyContent: 'space-between' }}><span>üí¨ Enviar Mensagem</span> <button className="btn btn-red btn-sm" onClick={() => removeStep(step.id)}>&times;</button></h4><div className="form-group"><label>Texto da Mensagem</label><textarea className="form-textarea" rows="3" value={step.text || ''} onChange={e => updateStep(step.id, 'text', e.target.value)} placeholder="Use {{primeiro_nome}} ou {{nome_completo}}" /></div><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}><div className="form-group"><label>Texto do Bot√£o (Opcional)</label><input type="text" className="form-input" value={step.buttonText || ''} onChange={e => updateStep(step.id, 'buttonText', e.target.value)} /></div><div className="form-group"><label>URL do Bot√£o (Opcional)</label><input type="url" className="form-input" value={step.buttonUrl || ''} onChange={e => updateStep(step.id, 'buttonUrl', e.target.value)} /></div></div></div>);
            case 'image': case 'video': case 'audio': return (
                <div key={step.id} className="card" style={{ marginBottom: '1rem' }}>
                    <h4 style={{ marginBottom: '1rem', display: 'flex', justifyContent: 'space-between' }}>
                        <span>{step.type === 'image' ? 'üñºÔ∏è' : (step.type === 'video' ? 'üé¨' : 'üéµ')} Enviar {step.type.charAt(0).toUpperCase() + step.type.slice(1)}</span> <button className="btn btn-red btn-sm" onClick={() => removeStep(step.id)}>&times;</button>
                    </h4>
                    <div className="form-group"><label>File ID ou URL</label><input type="text" className="form-input" value={step.fileUrl || ''} onChange={e => updateStep(step.id, 'fileUrl', e.target.value)} /></div>
                    {(() => { const src = buildPreviewSrc(step.fileUrl); if (!src) return null; return (<div className="form-group"><label>Preview</label>{step.type === 'image' ? (<img src={src} alt="preview" className="media-preview" />) : step.type === 'video' ? (<video src={src} className="media-preview" muted autoPlay loop playsInline preload="metadata" controls />) : (<audio src={src} controls style={{ width: '100%' }} />)}</div>); })()}
                    <button type="button" className="btn btn-secondary btn-sm" style={{ marginBottom: '1rem' }} onClick={() => openMediaLibrary(fileId => updateStep(step.id, 'fileUrl', fileId), [step.type])}>Selecionar da Biblioteca</button>
                    <div className="form-group"><label>Legenda (Opcional)</label><textarea className="form-textarea" rows="2" value={step.caption || ''} onChange={e => updateStep(step.id, 'caption', e.target.value)} /></div>
                </div>
            );
            case 'pix': return (<div key={step.id} className="card" style={{ marginBottom: '1rem' }}><h4 style={{ marginBottom: '1rem', display: 'flex', justifyContent: 'space-between' }}><span>üí≥ Gerar PIX</span> <button className="btn btn-red btn-sm" onClick={() => removeStep(step.id)}>&times;</button></h4><div className="form-group"><label>Valor (em centavos)</label><input type="number" className="form-input" value={step.valueInCents === undefined ? 100 : step.valueInCents} onChange={e => updateStep(step.id, 'valueInCents', parseInt(e.target.value, 10))} /></div><div className="form-group"><label>Texto da Mensagem PIX</label><textarea className="form-textarea" rows="2" value={step.pixMessage || ''} onChange={e => updateStep(step.id, 'pixMessage', e.target.value)} /></div><div className="form-group"><label>Texto do Bot√£o PIX</label><input type="text" className="form-input" value={step.pixButtonText || ''} onChange={e => updateStep(step.id, 'pixButtonText', e.target.value)} /></div></div>);
            // check_pix might need adjustments depending on how the CRON job handles delivery logic
            case 'check_pix': return (<div key={step.id} className="card" style={{ marginBottom: '1rem', borderLeft: '4px solid var(--info-bg)' }}><h4 style={{ marginBottom: '1rem', display: 'flex', justifyContent: 'space-between' }}><span>üîç Verificar PIX & Entregar</span> <button className="btn btn-red btn-sm" onClick={() => removeStep(step.id)}>&times;</button></h4><p style={{ color: 'var(--text-secondary)', fontSize: '0.8rem', marginBottom: '1rem' }}>Esta a√ß√£o s√≥ ser√° executada se o PIX gerado na etapa anterior for pago.</p><div className="form-group"><label>Texto de Entrega (P√≥s-Pagamento)</label><textarea className="form-textarea" rows="3" value={step.deliveryText || ''} onChange={e => updateStep(step.id, 'deliveryText', e.target.value)} /></div><div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem' }}><div className="form-group"><label>Texto do Bot√£o de Entrega</label><input type="text" className="form-input" value={step.deliveryButtonText || ''} onChange={e => updateStep(step.id, 'deliveryButtonText', e.target.value)} /></div><div className="form-group"><label>URL do Bot√£o de Entrega</label><input type="url" className="form-input" value={step.deliveryButtonUrl || ''} onChange={e => updateStep(step.id, 'deliveryButtonUrl', e.target.value)} /></div></div></div>);
            default: return null;
        }
    };

    // Render functions for each tab
    const renderDisparosTab = () => (
        <div style={{ maxWidth: '800px', margin: '0 auto' }}>
            <form onSubmit={handleSubmit}>
                {/* Campaign Info Card */}
                <div className="card campaign-info-card">
                    <div className="form-group">
                        <label>1. Nome da Campanha</label>
                        <input
                            type="text"
                            className="form-input"
                            value={campaignName}
                            onChange={e => setCampaignName(e.target.value)}
                            placeholder="Ex: Lan√ßamento VIP"
                            required
                        />
                    </div>
                    <div className="form-group">
                        <label>2. Selecione os Bots de Destino</label>
                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '1rem' }}>
                            {bots.map(bot => (
                                <label key={bot.id} className="checkbox-group" style={{ marginBottom: 0 }}>
                                    <input
                                        type="checkbox"
                                        checked={selectedBotIds.includes(bot.id)}
                                        onChange={() => handleBotSelection(bot.id)}
                                    />
                                    {bot.bot_name}
                                </label>
                            ))}
                        </div>
                        <div style={{ marginTop: '1rem', display: 'flex', alignItems: 'center', gap: '1rem', flexWrap: 'wrap' }}>
                            <p style={{ color: 'var(--text-secondary)', fontSize: '0.9rem', margin: 0 }}>
                                Total de contatos: <strong style={{ color: 'var(--accent-primary)' }}>{contactCount}</strong>
                            </p>
                            {selectedTagIds.length > 0 && contactCount === 0 && !isFilteringContacts && (
                                <span style={{ 
                                    fontSize: '0.85rem', 
                                    color: 'var(--warning)',
                                    fontStyle: 'italic'
                                }}>
                                    Clique em "Filtrar Contatos" para aplicar os filtros
                                </span>
                            )}
                        </div>
                        
                        {/* Tag Filter Section */}
                        {availableTags.length > 0 && (
                            <div style={{ marginTop: '1.5rem', padding: '1rem', background: 'var(--bg-secondary)', borderRadius: '8px' }}>
                                <label style={{ display: 'block', fontWeight: '600', marginBottom: '0.75rem', fontSize: '0.95rem' }}>
                                    üè∑Ô∏è Filtrar por Tags (Opcional)
                                </label>
                                
                                {/* Seletor de Modo TEM/N√ÉO TEM */}
                                <div style={{ marginBottom: '1rem', display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                    <label style={{ fontSize: '0.9rem', fontWeight: '500', color: 'var(--text-primary)' }}>
                                        Modo de filtro:
                                    </label>
                                    <select
                                        value={tagFilterMode}
                                        onChange={(e) => setTagFilterMode(e.target.value)}
                                        style={{
                                            padding: '0.5rem 0.75rem',
                                            borderRadius: '6px',
                                            border: '1px solid var(--border-color)',
                                            background: 'var(--bg-primary)',
                                            color: 'var(--text-primary)',
                                            fontSize: '0.9rem',
                                            cursor: 'pointer',
                                            minWidth: '150px'
                                        }}
                                    >
                                        <option value="include">TEM (Incluir)</option>
                                        <option value="exclude">N√ÉO TEM (Excluir)</option>
                                    </select>
                                    <span style={{ fontSize: '0.85rem', color: 'var(--text-secondary)' }}>
                                        {tagFilterMode === 'include' 
                                            ? 'Incluir apenas contatos que t√™m as tags selecionadas'
                                            : 'Excluir contatos que t√™m as tags selecionadas'}
                                    </span>
                                </div>
                                
                                <p style={{ color: 'var(--text-secondary)', fontSize: '0.85rem', marginBottom: '0.75rem' }}>
                                    Selecione as tags para filtrar os contatos.
                                </p>
                                {isLoadingTags ? (
                                    <p style={{ color: 'var(--text-secondary)', fontSize: '0.9rem' }}>Carregando tags...</p>
                                ) : (
                                    <div style={{ display: 'flex', flexWrap: 'wrap', gap: '0.5rem' }}>
                                        {availableTags.map(tag => (
                                            <label 
                                                key={tag.id}
                                                style={{ 
                                                    display: 'flex', 
                                                    alignItems: 'center', 
                                                    gap: '0.5rem',
                                                    padding: '0.5rem 0.75rem',
                                                    borderRadius: '6px',
                                                    background: selectedTagIds.includes(tag.id) 
                                                        ? `linear-gradient(135deg, ${tag.color}20 0%, ${tag.color}10 100%)`
                                                        : 'var(--bg-primary)',
                                                    border: selectedTagIds.includes(tag.id) 
                                                        ? `2px solid ${tag.color}` 
                                                        : '1px solid var(--border-color)',
                                                    cursor: 'pointer',
                                                    transition: 'all 0.2s',
                                                    fontSize: '0.9rem'
                                                }}
                                                onMouseEnter={(e) => {
                                                    if (!selectedTagIds.includes(tag.id)) {
                                                        e.currentTarget.style.borderColor = tag.color;
                                                        e.currentTarget.style.background = `${tag.color}10`;
                                                    }
                                                }}
                                                onMouseLeave={(e) => {
                                                    if (!selectedTagIds.includes(tag.id)) {
                                                        e.currentTarget.style.borderColor = 'var(--border-color)';
                                                        e.currentTarget.style.background = 'var(--bg-primary)';
                                                    }
                                                }}
                                            >
                                                <input
                                                    type="checkbox"
                                                    checked={selectedTagIds.includes(tag.id)}
                                                    onChange={(e) => {
                                                        if (e.target.checked) {
                                                            setSelectedTagIds([...selectedTagIds, tag.id]);
                                                        } else {
                                                            setSelectedTagIds(selectedTagIds.filter(id => id !== tag.id));
                                                        }
                                                    }}
                                                    style={{ 
                                                        width: '16px', 
                                                        height: '16px', 
                                                        cursor: 'pointer',
                                                        accentColor: tag.color
                                                    }}
                                                />
                                                <span 
                                                    style={{ 
                                                        fontWeight: selectedTagIds.includes(tag.id) ? '600' : '500',
                                                        color: selectedTagIds.includes(tag.id) ? tag.color : 'var(--text-primary)'
                                                    }}
                                                >
                                                    {tag.title}
                                                </span>
                                            </label>
                                        ))}
                                    </div>
                                )}
                                {selectedTagIds.length > 0 && (
                                    <div style={{ marginTop: '1rem', display: 'flex', alignItems: 'center', gap: '1rem', flexWrap: 'wrap' }}>
                                        <p style={{ 
                                            color: 'var(--accent-primary)', 
                                            fontSize: '0.85rem',
                                            fontWeight: '500',
                                            margin: 0
                                        }}>
                                            {selectedTagIds.length} tag(s) selecionada(s)
                                        </p>
                                        <button
                                            type="button"
                                            onClick={handleFilterContacts}
                                            disabled={isFilteringContacts || selectedBotIds.length === 0}
                                            style={{
                                                padding: '0.5rem 1rem',
                                                borderRadius: '6px',
                                                border: 'none',
                                                background: isFilteringContacts 
                                                    ? 'var(--text-secondary)' 
                                                    : 'var(--accent-primary)',
                                                color: 'white',
                                                fontSize: '0.9rem',
                                                fontWeight: '600',
                                                cursor: isFilteringContacts || selectedBotIds.length === 0 ? 'not-allowed' : 'pointer',
                                                opacity: isFilteringContacts || selectedBotIds.length === 0 ? 0.6 : 1,
                                                transition: 'all 0.2s',
                                                display: 'flex',
                                                alignItems: 'center',
                                                gap: '0.5rem'
                                            }}
                                            onMouseEnter={(e) => {
                                                if (!isFilteringContacts && selectedBotIds.length > 0) {
                                                    e.currentTarget.style.opacity = '0.9';
                                                    e.currentTarget.style.transform = 'scale(1.02)';
                                                }
                                            }}
                                            onMouseLeave={(e) => {
                                                if (!isFilteringContacts && selectedBotIds.length > 0) {
                                                    e.currentTarget.style.opacity = '1';
                                                    e.currentTarget.style.transform = 'scale(1)';
                                                }
                                            }}
                                        >
                                            {isFilteringContacts ? (
                                                <>
                                                    <span style={{ 
                                                        display: 'inline-block',
                                                        width: '14px',
                                                        height: '14px',
                                                        border: '2px solid white',
                                                        borderTopColor: 'transparent',
                                                        borderRadius: '50%',
                                                        animation: 'spin 0.8s linear infinite'
                                                    }}></span>
                                                    Filtrando...
                                                </>
                                            ) : (
                                                <>
                                                    üîç Filtrar Contatos
                                                </>
                                            )}
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                    </div>
                </div>

                {/* Flow Selection Card */}
                <div className="card flow-steps-container">
                    <label style={{ display: 'block', fontWeight: '600', color: 'var(--text-primary)', fontSize: '1.1rem', marginBottom: '0.5rem' }}>
                        3. Selecione ou Crie um Fluxo de Disparo
                    </label>
                    <p style={{ color: 'var(--text-secondary)', fontSize: '0.9rem', marginBottom: '1.5rem' }}>
                        Use o editor visual para criar e gerenciar seus fluxos de disparo. Os fluxos podem ser reutilizados em m√∫ltiplas campanhas.
                    </p>
                    
                    <div className="form-group" style={{ marginBottom: '1rem' }}>
                        <label htmlFor="disparoFlowSelect">Fluxo de Disparo</label>
                        <div style={{ display: 'flex', gap: '0.5rem', alignItems: 'flex-start' }}>
                            <select 
                                id="disparoFlowSelect" 
                                className="form-select" 
                                value={selectedDisparoFlowId} 
                                onChange={e => setSelectedDisparoFlowId(e.target.value)}
                                style={{ flex: 1 }}
                                disabled={isLoadingFlows}
                            >
                                <option value="">-- Selecione um fluxo --</option>
                                {disparoFlows.map(flow => (
                                    <option key={flow.id} value={flow.id}>{flow.name}</option>
                                ))}
                            </select>
                            {selectedDisparoFlowId && (
                                <button 
                                    type="button" 
                                    className="btn btn-secondary" 
                                    onClick={() => handleEditDisparoFlow(selectedDisparoFlowId)}
                                    title="Editar fluxo selecionado"
                                >
                                    ‚úèÔ∏è Editar
                                </button>
                            )}
                        </div>
                    </div>
                    
                    {selectedDisparoFlowId && (
                        <div style={{ padding: '1rem', background: 'var(--bg-secondary)', borderRadius: '8px', marginTop: '1rem' }}>
                            <p style={{ color: 'var(--success)', fontSize: '0.9rem', margin: 0 }}>
                                ‚úì Fluxo selecionado: {disparoFlows.find(f => f.id === parseInt(selectedDisparoFlowId))?.name || 'Carregando...'}
                            </p>
                        </div>
                    )}
                </div>

                {/* Scheduling Section */}
                <div className="card" style={{ marginTop: '1.5rem', border: isScheduled ? '2px solid var(--accent-primary)' : '1px solid var(--border-color)' }}>
                    <div className="form-group" style={{ marginBottom: 0 }}>
                        <label style={{ 
                            display: 'flex', 
                            alignItems: 'center', 
                            gap: '0.75rem', 
                            cursor: 'pointer',
                            padding: '0.5rem',
                            borderRadius: '6px',
                            transition: 'background-color 0.2s',
                            marginBottom: isScheduled ? '1rem' : '0'
                        }}
                        onMouseEnter={(e) => e.currentTarget.style.backgroundColor = 'var(--bg-secondary)'}
                        onMouseLeave={(e) => e.currentTarget.style.backgroundColor = 'transparent'}
                        >
                            <input
                                type="checkbox"
                                checked={isScheduled}
                                onChange={e => {
                                    setIsScheduled(e.target.checked);
                                    if (!e.target.checked) {
                                        setScheduledDateTime('');
                                    }
                                }}
                                style={{ 
                                    width: '18px', 
                                    height: '18px', 
                                    cursor: 'pointer',
                                    accentColor: 'var(--accent-primary)'
                                }}
                            />
                            <span style={{ 
                                fontWeight: '600', 
                                fontSize: '1rem',
                                color: isScheduled ? 'var(--accent-primary)' : 'var(--text-primary)',
                                transition: 'color 0.2s'
                            }}>
                                ‚è∞ Agendar disparo
                            </span>
                        </label>
                        {isScheduled && (
                            <div style={{ 
                                marginTop: '1rem', 
                                padding: '1.25rem', 
                                background: 'var(--bg-secondary)',
                                borderRadius: '8px',
                                border: '1px solid var(--accent-primary)',
                                boxShadow: '0 2px 8px rgba(0, 0, 0, 0.1)'
                            }}>
                                <div className="form-group" style={{ marginBottom: 0 }}>
                                    <label style={{ 
                                        fontWeight: '600', 
                                        marginBottom: '0.5rem',
                                        display: 'block',
                                        color: 'var(--text-primary)'
                                    }}>
                                        Data e Hora do Agendamento
                                    </label>
                                    <input
                                        type="datetime-local"
                                        className="form-input"
                                        value={scheduledDateTime}
                                        onChange={e => setScheduledDateTime(e.target.value)}
                                        min={(() => {
                                            const now = new Date();
                                            // Converter para hor√°rio local no formato YYYY-MM-DDTHH:mm
                                            const year = now.getFullYear();
                                            const month = String(now.getMonth() + 1).padStart(2, '0');
                                            const day = String(now.getDate()).padStart(2, '0');
                                            const hours = String(now.getHours()).padStart(2, '0');
                                            const minutes = String(now.getMinutes()).padStart(2, '0');
                                            return `${year}-${month}-${day}T${hours}:${minutes}`;
                                        })()}
                                        required={isScheduled}
                                        style={{
                                            fontSize: '1rem',
                                            padding: '0.75rem',
                                            border: '1px solid var(--border-color)',
                                            borderRadius: '6px'
                                        }}
                                    />
                                    {scheduledDateTime && (
                                        <p style={{ 
                                            marginTop: '0.75rem', 
                                            color: 'var(--accent-primary)', 
                                            fontSize: '0.9rem',
                                            fontWeight: '500',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '0.5rem'
                                        }}>
                                            <span>üìÖ</span>
                                            <span>Agendado para: {new Date(scheduledDateTime).toLocaleString('pt-BR', { 
                                                day: '2-digit', 
                                                month: '2-digit', 
                                                year: 'numeric',
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            })}</span>
                                        </p>
                                    )}
                                    <p style={{ 
                                        marginTop: scheduledDateTime ? '0.5rem' : '0.75rem', 
                                        color: 'var(--text-secondary)', 
                                        fontSize: '0.85rem',
                                        lineHeight: '1.4'
                                    }}>
                                        O disparo ser√° executado automaticamente na data/hora selecionada.
                                    </p>
                                </div>
                            </div>
                        )}
                    </div>
                </div>

                {/* Submit Button */}
                <button type="submit" className="btn btn-primary" style={{ width: '100%', padding: '1rem', marginTop: '1.5rem' }} disabled={isSending || isDisparoInProgress || selectedBotIds.length === 0}>
                    {isDisparoInProgress && !isScheduled ? 'Aguarde a conclus√£o do disparo em andamento' : 
                     isDisparoInProgress && isScheduled ? 'J√° existe um disparo agendado. Cancele o agendamento antes de criar um novo.' :
                     isSending ? (isScheduled ? 'Agendando...' : 'Disparando...') : 
                     isScheduled ? `Agendar para ${contactCount} contato(s)` :
                     `Disparar para ${contactCount} contato(s)`}
                </button>
                {isDisparoInProgress && !isScheduled && (
                    <p style={{ color: 'var(--warning)', fontSize: '0.85rem', marginTop: '0.5rem', textAlign: 'center' }}>
                        ‚ö†Ô∏è N√£o √© poss√≠vel iniciar um novo disparo enquanto houver um em andamento
                    </p>
                )}
                {isDisparoInProgress && isScheduled && (
                    <p style={{ color: 'var(--warning)', fontSize: '0.85rem', marginTop: '0.5rem', textAlign: 'center' }}>
                        ‚ö†Ô∏è J√° existe um disparo agendado. Cancele o agendamento no hist√≥rico antes de criar um novo
                    </p>
                )}
            </form>
            
            {/* Modal de Progresso Unificado (Higieniza√ß√£o + Disparo) */}
            {showDisparoProgressModal && disparoProgress && (
                <div style={{
                    position: 'fixed',
                    top: 0,
                    left: 0,
                    right: 0,
                    bottom: 0,
                    background: 'rgba(0, 0, 0, 0.7)',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    zIndex: 10000
                }}>
                    <div style={{
                        background: 'var(--bg-primary)',
                        borderRadius: '12px',
                        padding: '2rem',
                        maxWidth: '500px',
                        width: '90%',
                        boxShadow: '0 10px 40px rgba(0, 0, 0, 0.3)'
                    }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                            <h3 style={{ margin: 0, color: 'var(--text-primary)' }}>
                                {disparoProgress.status === 'COMPLETED' ? '‚úì Disparo Finalizado' :
                                 disparoProgress.status === 'FAILED' ? '‚úó Disparo Falhou' :
                                 disparoProgress.current_step === 'hygienizing' ? 'üîç Higienizando Contatos' : 
                                 disparoProgress.current_step === 'sending' ? 'üì§ Executando Disparos' :
                                 '‚è≥ Processando Disparo'}
                            </h3>
                            <button 
                                className="btn btn-secondary btn-sm"
                                onClick={() => setShowDisparoProgressModal(false)}
                                style={{ padding: '0.5rem 1rem' }}
                            >
                                Minimizar
                            </button>
                        </div>
                        
                        {/* Indicador de Est√°gio */}
                        {disparoProgress.status !== 'COMPLETED' && disparoProgress.status !== 'FAILED' && (
                            <div style={{ 
                                marginBottom: '1.5rem', 
                                padding: '1rem', 
                                background: 'var(--bg-secondary)', 
                                borderRadius: '8px',
                                border: '1px solid var(--border-color)'
                            }}>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.5rem' }}>
                                    <div style={{
                                        width: '12px',
                                        height: '12px',
                                        borderRadius: '50%',
                                        background: disparoProgress.current_step === 'hygienizing' 
                                            ? 'var(--accent-primary)' 
                                            : disparoProgress.current_step === 'sending'
                                            ? 'var(--accent-secondary)'
                                            : 'var(--text-secondary)',
                                        animation: disparoProgress.status !== 'PENDING' ? 'pulse 2s infinite' : 'none'
                                    }}></div>
                                    <strong style={{ color: 'var(--text-primary)', fontSize: '0.95rem' }}>
                                        {disparoProgress.current_step === 'hygienizing' ? 'Etapa 1: Higienizando Contatos' :
                                         disparoProgress.current_step === 'sending' ? 'Etapa 2: Executando Disparos' :
                                         'Aguardando in√≠cio...'}
                                    </strong>
                                </div>
                                {disparoProgress.current_step === 'hygienizing' && (
                                    <p style={{ color: 'var(--text-secondary)', fontSize: '0.85rem', margin: 0, marginLeft: '1.75rem' }}>
                                        Validando contatos ativos e removendo inativos...
                                    </p>
                                )}
                                {disparoProgress.current_step === 'sending' && (
                                    <p style={{ color: 'var(--text-secondary)', fontSize: '0.85rem', margin: 0, marginLeft: '1.75rem' }}>
                                        Enviando mensagens para os contatos v√°lidos...
                                    </p>
                                )}
                            </div>
                        )}
                        
                        {/* Mensagem de Finaliza√ß√£o */}
                        {disparoProgress.status === 'COMPLETED' && (
                            <div style={{ 
                                marginBottom: '1.5rem', 
                                padding: '1rem', 
                                background: 'var(--success)', 
                                borderRadius: '8px',
                                color: 'white',
                                textAlign: 'center'
                            }}>
                                <div style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>‚úì</div>
                                <strong style={{ fontSize: '1rem' }}>Disparo conclu√≠do com sucesso!</strong>
                                <p style={{ margin: '0.5rem 0 0 0', fontSize: '0.9rem', opacity: 0.9 }}>
                                    {disparoProgress.sent_messages || 0} mensagens enviadas
                                </p>
                            </div>
                        )}
                        
                        {disparoProgress.status === 'FAILED' && (
                            <div style={{ 
                                marginBottom: '1.5rem', 
                                padding: '1rem', 
                                background: 'var(--danger)', 
                                borderRadius: '8px',
                                color: 'white',
                                textAlign: 'center'
                            }}>
                                <div style={{ fontSize: '2rem', marginBottom: '0.5rem' }}>‚úó</div>
                                <strong style={{ fontSize: '1rem' }}>Disparo falhou</strong>
                                <p style={{ margin: '0.5rem 0 0 0', fontSize: '0.9rem', opacity: 0.9 }}>
                                    Verifique os logs para mais detalhes
                                </p>
                            </div>
                        )}
                        
                        <div style={{ marginBottom: '1rem' }}>
                            <div style={{
                                width: '100%',
                                height: '28px',
                                background: 'var(--bg-secondary)',
                                borderRadius: '14px',
                                overflow: 'hidden',
                                position: 'relative'
                            }}>
                                <div style={{
                                    height: '100%',
                                    width: `${disparoProgress.progress_percentage || 0}%`,
                                    background: disparoProgress.status === 'FAILED' 
                                        ? 'var(--danger)' 
                                        : disparoProgress.status === 'COMPLETED'
                                        ? 'var(--success)'
                                        : 'linear-gradient(90deg, var(--accent-primary), var(--accent-secondary))',
                                    transition: 'width 0.3s ease',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    color: 'white',
                                    fontSize: '0.8rem',
                                    fontWeight: '600'
                                }}>
                                    {disparoProgress.progress_percentage || 0}%
                                </div>
                            </div>
                        </div>
                        
                        <p style={{ color: 'var(--text-secondary)', marginBottom: '1rem', fontSize: '0.9rem' }}>
                            <strong>Status:</strong> {
                                disparoProgress.status === 'PENDING' ? 'Aguardando in√≠cio...' :
                                disparoProgress.status === 'HYGIENIZING' ? 'Higienizando contatos...' :
                                disparoProgress.status === 'RUNNING' ? 'Enviando mensagens...' :
                                disparoProgress.status === 'COMPLETED' ? 'Conclu√≠do!' :
                                disparoProgress.status === 'FAILED' ? 'Falhou' :
                                'Processando...'
                            }
                        </p>
                        
                        {disparoProgress.current_step === 'hygienizing' && (
                            <p style={{ color: 'var(--text-secondary)', marginBottom: '1rem', fontSize: '0.9rem' }}>
                                <strong>Progresso:</strong> {disparoProgress.processed_contacts || 0} de {disparoProgress.total_contacts || 0} contatos processados
                            </p>
                        )}
                        
                        {disparoProgress.current_step === 'sending' && (
                            <p style={{ color: 'var(--text-secondary)', marginBottom: '1rem', fontSize: '0.9rem' }}>
                                <strong>Progresso:</strong> {disparoProgress.sent_messages || 0} de {disparoProgress.total_messages || 0} mensagens enviadas
                            </p>
                        )}
                        
                        {disparoProgress.inactive_count !== null && disparoProgress.inactive_count > 0 && (
                            <p style={{ color: 'var(--success)', marginBottom: '1rem', fontSize: '0.9rem' }}>
                                <strong>‚úì {disparoProgress.inactive_count} contatos inativos removidos</strong>
                            </p>
                        )}
                        
                        {disparoProgress.status === 'COMPLETED' && (
                            <button 
                                className="btn btn-primary"
                                onClick={() => {
                                    setShowDisparoProgressModal(false);
                                    setActiveDisparoId(null);
                                    setIsDisparoInProgress(false);
                                }}
                                style={{ width: '100%' }}
                            >
                                Fechar
                            </button>
                        )}
                        
                        {disparoProgress.status === 'FAILED' && (
                            <button 
                                className="btn btn-secondary"
                                onClick={() => {
                                    setShowDisparoProgressModal(false);
                                    setActiveDisparoId(null);
                                    setIsDisparoInProgress(false);
                                }}
                                style={{ width: '100%' }}
                            >
                                Fechar
                            </button>
                        )}
                    </div>
                </div>
            )}
        </div>
    );

    const handleCheckConversions = async (historyId) => {
        setIsChecking(historyId);
        try {
            const res = await App.apiRequest(`/api/disparos/check-conversions/${historyId}`, 'POST');
            App.showToast(res.message, 'success');
            fetchHistory(currentPage, false);
        } catch (error) {
            App.showToast('Erro ao verificar: ' + (error.response?.data?.message || error.message), 'error');
        } finally {
            setIsChecking(null);
        }
    };
    
    const [isCancelling, setIsCancelling] = useState(null);
    
    const handleCancelDisparo = async (historyId, campaignName) => {
        if (!confirm(`Tem certeza que deseja cancelar o disparo "${campaignName}"?`)) {
            return;
        }
        
        setIsCancelling(historyId);
        try {
            const res = await App.apiRequest(`/api/disparos/cancel/${historyId}`, 'POST');
            App.showToast(res.message || 'Disparo cancelado com sucesso!', 'success');
            fetchHistory(currentPage, false);
            // Verificar se ainda h√° disparo ativo ap√≥s cancelamento
            const activeCheck = await App.apiRequest('/api/disparos/check-active', 'GET');
            setIsDisparoInProgress(activeCheck.active);
        } catch (error) {
            App.showToast('Erro ao cancelar: ' + (error.response?.data?.message || error.message), 'error');
        } finally {
            setIsCancelling(null);
        }
    };
    
    const getStatusChip = (status) => {
        const styles = {
            PENDING: { background: '#a16207', color: '#fefce8' },
            SCHEDULED: { background: '#7c3aed', color: '#ede9fe' },
            RUNNING: { background: '#1d4ed8', color: '#dbeafe' },
            COMPLETED: { background: '#166534', color: '#dcfce7' },
            FAILED: { background: '#991b1b', color: '#fee2e2' }
        };
        const labels = {
            PENDING: 'Pendente',
            SCHEDULED: 'Agendado',
            RUNNING: 'Em Execu√ß√£o',
            COMPLETED: 'Conclu√≠do',
            FAILED: 'Falhou'
        };
        return <span style={{...styles[status], padding: '4px 8px', borderRadius: '12px', fontSize: '0.8rem', fontWeight: '600'}}>{labels[status] || status}</span>
    };

    const renderDisparoFlowsTab = () => {
        return (
            <div style={{padding: '2rem 3rem', height: '100%', overflowY: 'auto'}}>
                <div className="page-header">
                    <h2>Fluxos de Disparo</h2>
                    <button 
                        className="btn btn-primary" 
                        onClick={handleCreateDisparoFlowFromTab} 
                        disabled={bots.length === 0}
                    >
                        + Novo Fluxo de Disparo
                    </button>
                </div>
                {isLoadingFlowsList ? (
                    <p style={{textAlign: 'center', padding: '2rem', color: 'var(--text-secondary)'}}>Carregando...</p>
                ) : (
                    <div className="grid">
                        {disparoFlowsList.map(flow => (
                            <div key={flow.id} className="bot-card">
                                <div className="bot-card-header">
                                    <div className="icon">{Icons.flows}</div>
                                    <h3>{flow.name}</h3>
                                </div>
                                <p style={{color: 'var(--text-secondary)', fontSize: '0.9rem', marginBottom: '1.5rem', flexGrow: 1}}>
                                    Modificado em: {new Date(flow.updated_at || flow.created_at).toLocaleDateString()}
                                </p>
                                <div className="bot-card-actions">
                                    <button 
                                        className="btn btn-primary btn-sm" 
                                        onClick={() => handleEditDisparoFlow(flow.id)}
                                    >
                                        Editor
                                    </button>
                                    <button 
                                        className="btn btn-danger btn-sm" 
                                        style={{gridColumn: '1 / -1'}} 
                                        onClick={() => handleDeleteDisparoFlow(flow.id)}
                                    >
                                        Excluir
                                    </button>
                                </div>
                            </div>
                        ))}
                        {disparoFlowsList.length === 0 && (
                            <p style={{color: 'var(--text-secondary)'}}>Nenhum fluxo de disparo criado ainda.</p>
                        )}
                    </div>
                )}
            </div>
        );
    };

    const renderPagination = () => {
        if (totalPages <= 1) return null;
        
        return (
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '1.5rem', padding: '1rem' }}>
                <button 
                    className="btn btn-secondary" 
                    onClick={() => fetchHistory(currentPage - 1, false)}
                    disabled={currentPage === 1 || isLoadingHistory}
                >
                    Anterior
                </button>
                <span style={{ color: 'var(--text-secondary)' }}>
                    P√°gina {currentPage} de {totalPages} ({totalItems} total)
                </span>
                <button 
                    className="btn btn-secondary" 
                    onClick={() => fetchHistory(currentPage + 1, false)}
                    disabled={currentPage === totalPages || isLoadingHistory}
                >
                    Pr√≥ximo
                </button>
            </div>
        );
    };

    const renderHistoricoTab = () => {
        return (
            <div>
                <div className="page-header" style={{ marginBottom: '1.5rem' }}>
                    <h2>Hist√≥rico de Disparos</h2>
                    <button className="btn btn-secondary" onClick={() => fetchHistory(currentPage, true)} disabled={isLoadingHistory}>Atualizar</button>
                </div>
                <div className="card">
                    <table style={{width: '100%', borderCollapse: 'collapse', textAlign: 'left'}}>
                        <thead>
                            <tr style={{borderBottom: '1px solid var(--border-color)'}}>
                                <th style={{padding: '1rem'}}>Campanha</th>
                                <th style={{padding: '1rem'}}>Data Cria√ß√£o</th>
                                <th style={{padding: '1rem'}}>Agendado Para</th>
                                <th style={{padding: '1rem'}}>Status</th>
                                <th style={{padding: '1rem'}}>Envios</th>
                                <th style={{padding: '1rem'}}>Convers√µes</th>
                                <th style={{padding: '1rem'}}>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {isLoadingHistory ? (<tr><td colSpan="7" style={{textAlign: 'center', padding: '2rem'}}>A carregar...</td></tr>) : 
                             history.map(item => {
                                const progressPercentage = item.total_jobs > 0 
                                    ? Math.round((item.processed_jobs / item.total_jobs) * 100)
                                    : 0;
                                
                                return (
                                    <React.Fragment key={item.id}>
                                        <tr style={{borderBottom: '1px solid var(--border-color)'}}>
                                            <td style={{padding: '1rem', fontWeight: '600'}}>{item.campaign_name}</td>
                                            <td style={{padding: '1rem'}}>{new Date(item.created_at).toLocaleString('pt-BR')}</td>
                                            <td style={{padding: '1rem'}}>
                                                {item.scheduled_at ? (
                                                    <span style={{color: 'var(--accent-primary)', fontWeight: '600'}}>
                                                        {new Date(item.scheduled_at).toLocaleString('pt-BR')}
                                                    </span>
                                                ) : (
                                                    <span style={{color: 'var(--text-secondary)'}}>Imediato</span>
                                                )}
                                            </td>
                                            <td style={{padding: '1rem'}}>{getStatusChip(item.status)}</td>
                                            <td style={{padding: '1rem'}}>{item.total_sent || 0}</td>
                                            <td style={{padding: '1rem', fontWeight: 'bold', color: 'var(--brand-primary)'}}>{item.conversions || 0}</td>
                                            <td style={{padding: '1rem'}}>
                                                <div style={{display: 'flex', gap: '0.5rem', flexWrap: 'wrap'}}>
                                                    {item.status === 'SCHEDULED' && (
                                                        <button 
                                                            className="btn btn-secondary btn-sm" 
                                                            onClick={() => handleCancelDisparo(item.id, item.campaign_name)} 
                                                            disabled={isCancelling === item.id}
                                                            style={{background: 'var(--danger)', borderColor: 'var(--danger)'}}
                                                        >
                                                            {isCancelling === item.id ? 'Cancelando...' : 'Cancelar'}
                                                        </button>
                                                    )}
                                                    {(item.status === 'RUNNING' || item.status === 'PENDING' || item.status === 'HYGIENIZING') && (
                                                        <button 
                                                            className="btn btn-secondary btn-sm" 
                                                            onClick={() => handleCancelDisparo(item.id, item.campaign_name)} 
                                                            disabled={isCancelling === item.id}
                                                            style={{background: 'var(--danger)', borderColor: 'var(--danger)'}}
                                                        >
                                                            {isCancelling === item.id ? 'Cancelando...' : 'Cancelar'}
                                                        </button>
                                                    )}
                                                <button className="btn btn-secondary btn-sm" onClick={() => handleCheckConversions(item.id)} disabled={isChecking === item.id}>
                                                    {isChecking === item.id ? 'A verificar...' : 'Verificar PIX'}
                                                </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {(item.status === 'RUNNING' || item.status === 'PENDING') && (
                                            <tr>
                                                <td colSpan="7" style={{padding: '0.75rem 1rem', background: 'linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.6) 100%)', borderTop: '1px solid rgba(56, 189, 248, 0.1)'}}>
                                                    <div style={{display: 'flex', flexDirection: 'column', gap: '0.75rem'}}>
                                                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                                            <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                                                                <span style={{fontSize: '0.875rem', color: 'var(--text-secondary)', fontWeight: '500'}}>
                                                                    Progresso:
                                                                </span>
                                                                <span style={{fontSize: '0.875rem', color: 'var(--text-primary)', fontWeight: '600'}}>
                                                                    {item.processed_jobs || 0} de {item.total_jobs || 0} processados
                                                                </span>
                                                            </div>
                                                            <span style={{
                                                                fontWeight: '700', 
                                                                fontSize: '0.9rem',
                                                                color: item.status === 'RUNNING' ? 'var(--accent-primary)' : '#fbbf24',
                                                                textShadow: item.status === 'RUNNING' 
                                                                    ? '0 0 8px rgba(56, 189, 248, 0.4)' 
                                                                    : '0 0 8px rgba(251, 191, 36, 0.4)'
                                                            }}>
                                                                {progressPercentage}%
                                                            </span>
                                                        </div>
                                                        <div style={{
                                                            width: '100%',
                                                            height: '12px',
                                                            background: 'rgba(15, 23, 42, 0.6)',
                                                            borderRadius: '6px',
                                                            overflow: 'hidden',
                                                            position: 'relative',
                                                            border: '1px solid rgba(56, 189, 248, 0.1)',
                                                            boxShadow: 'inset 0 2px 4px rgba(0, 0, 0, 0.3)'
                                                        }}>
                                                            <div style={{
                                                                height: '100%',
                                                                width: `${progressPercentage}%`,
                                                                background: item.status === 'RUNNING' 
                                                                    ? 'linear-gradient(90deg, #38bdf8 0%, #0ea5e9 50%, #0284c7 100%)'
                                                                    : 'linear-gradient(90deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%)',
                                                                transition: 'width 0.5s cubic-bezier(0.4, 0, 0.2, 1)',
                                                                borderRadius: '6px',
                                                                boxShadow: item.status === 'RUNNING'
                                                                    ? '0 0 12px rgba(56, 189, 248, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.2)'
                                                                    : '0 0 12px rgba(251, 191, 36, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.2)',
                                                                position: 'relative',
                                                                overflow: 'hidden'
                                                            }}>
                                                                {item.status === 'RUNNING' && (
                                                                    <div style={{
                                                                        position: 'absolute',
                                                                        top: 0,
                                                                        left: '-100%',
                                                                        width: '100%',
                                                                        height: '100%',
                                                                        background: 'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent)',
                                                                        animation: 'shimmer 2s infinite'
                                                                    }}></div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        )}
                                    </React.Fragment>
                                );
                            })}
                        </tbody>
                    </table>
                     {!isLoadingHistory && history.length === 0 && <p style={{textAlign: 'center', padding: '2rem', color: 'var(--text-secondary)'}}>Nenhum disparo encontrado.</p>}
                </div>
                {renderPagination()}
            </div>
        );
    };

    // Se estiver editando um fluxo de disparo, mostrar o editor
    if (editingDisparoFlow) {
        return (
            <FlowEditorPage
                flow={editingDisparoFlow}
                onRequestClose={() => {
                    setEditingDisparoFlow(null);
                    fetchDisparoFlows();
                    fetchDisparoFlowsList();
                    // Voltar para a aba de fluxos de disparo se estava editando de l√°
                    if (activeTab === 'fluxos-disparo' || activeTab === 'disparos') {
                        // Manter na aba atual ou voltar para fluxos-disparo
                    }
                }}
                pressels={pressels}
                thankYouPages={thankYouPages}
                hostedCheckouts={hostedCheckouts}
                onDirtyChange={() => {}}
                registerSaveHandler={() => {}}
                discardChangesToken={null}
                isDisparoFlow={true}
            />
        );
    }

    return (
        <div style={{ padding: '0 1.5rem 1.5rem 1.5rem', height: '100%', overflowY: 'auto' }}>
            {/* Tabs Navigation */}
            <div className="tabs-container">
                <button 
                    className={activeTab === 'disparos' ? 'active' : ''} 
                    onClick={() => setActiveTab('disparos')}
                >
                    Novo Disparo
                </button>
                <button 
                    className={activeTab === 'fluxos-disparo' ? 'active' : ''} 
                    onClick={() => setActiveTab('fluxos-disparo')}
                >
                    Fluxos de Disparo
                </button>
                <button 
                    className={activeTab === 'historico' ? 'active' : ''} 
                    onClick={() => setActiveTab('historico')}
                >
                    Hist√≥rico
                </button>
            </div>

            {/* Tab Content */}
            {activeTab === 'disparos' && renderDisparosTab()}
            {activeTab === 'fluxos-disparo' && renderDisparoFlowsTab()}
            {activeTab === 'historico' && renderHistoricoTab()}
        </div>
    );
}
    
    function DisparosHistoryPage() {
        const [history, setHistory] = useState([]);
        const [isLoading, setIsLoading] = useState(true);
        const [isChecking, setIsChecking] = useState(null);
        const [pollingInterval, setPollingInterval] = useState(null);

        const fetchHistory = useCallback((showToast = true) => {
            setIsLoading(true);
            api.get('/api/disparos/history')
                .then(res => {
                    setHistory(res.data);
                    if (showToast) {
                        App.showToast('Hist√≥rico atualizado com sucesso!', 'success');
                    }
                })
                .catch(() => {
                    console.error('Erro ao atualizar hist√≥rico.');
                    if (showToast) {
                        App.showToast('Erro ao atualizar hist√≥rico.', 'error');
                    }
                })
                .finally(() => setIsLoading(false));
        }, []);

        useEffect(() => {
            setIsLoading(true);
            api.get('/api/disparos/history')
                .then(res => setHistory(res.data))
                .catch(() => alert('Erro ao carregar o hist√≥rico.'))
                .finally(() => setIsLoading(false));
        }, []);

        // Polling para disparos em execu√ß√£o
        useEffect(() => {
            const hasRunningDisparos = history.some(item => 
                item.status === 'RUNNING' || item.status === 'PENDING'
            );

            if (hasRunningDisparos) {
                const interval = setInterval(() => {
                    fetchHistory(false); // Atualizar sem toast
                }, 4000);
                
                setPollingInterval(interval);
                
                return () => {
                    clearInterval(interval);
                };
            } else {
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                    setPollingInterval(null);
                }
            }
        }, [history, fetchHistory, pollingInterval]);
        
        const handleCheckConversions = async (historyId) => {
            setIsChecking(historyId);
            try {
                const res = await api.post(`/api/disparos/check-conversions/${historyId}`);
                alert(res.data.message);
                fetchHistory();
            } catch (error) {
                alert('Erro ao verificar: ' + (error.response?.data?.message || error.message));
            } finally {
                setIsChecking(null);
            }
        };
        
        const [isCancelling, setIsCancelling] = useState(null);
        
        const handleCancelDisparo = async (historyId, campaignName) => {
            if (!confirm(`Tem certeza que deseja cancelar o disparo "${campaignName}"?`)) {
                return;
            }
            
            setIsCancelling(historyId);
            try {
                const res = await api.post(`/api/disparos/cancel/${historyId}`);
                alert(res.data.message || 'Disparo cancelado com sucesso!');
                fetchHistory();
            } catch (error) {
                alert('Erro ao cancelar: ' + (error.response?.data?.message || error.message));
            } finally {
                setIsCancelling(null);
            }
        };
        
        const getStatusChip = (status) => {
            const styles = {
                PENDING: { background: '#a16207', color: '#fefce8' },
                SCHEDULED: { background: '#7c3aed', color: '#ede9fe' },
                RUNNING: { background: '#1d4ed8', color: '#dbeafe' },
                COMPLETED: { background: '#166534', color: '#dcfce7' },
                FAILED: { background: '#991b1b', color: '#fee2e2' },
                CANCELLED: { background: '#6b7280', color: '#f3f4f6' },
                HYGIENIZING: { background: '#059669', color: '#d1fae5' }
            };
            const labels = {
                PENDING: 'Pendente',
                SCHEDULED: 'Agendado',
                RUNNING: 'Em Execu√ß√£o',
                COMPLETED: 'Conclu√≠do',
                FAILED: 'Falhou',
                CANCELLED: 'Cancelado',
                HYGIENIZING: 'Higienizando'
            };
            return <span style={{...styles[status], padding: '4px 8px', borderRadius: '12px', fontSize: '0.8rem', fontWeight: '600'}}>{labels[status] || status}</span>
        }

        return (
            <div style={{ padding: '2rem 3rem', height: '100%', overflowY: 'auto' }}>
                <div className="page-header"><h2>Hist√≥rico de Disparos</h2><button className="btn btn-secondary" onClick={fetchHistory} disabled={isLoading}>Atualizar</button></div>
                <div className="card">
                    <table style={{width: '100%', borderCollapse: 'collapse', textAlign: 'left'}}>
                        <thead>
                            <tr style={{borderBottom: '1px solid var(--border-color)'}}>
                                <th style={{padding: '1rem'}}>Campanha</th>
                                <th style={{padding: '1rem'}}>Data Cria√ß√£o</th>
                                <th style={{padding: '1rem'}}>Agendado Para</th>
                                <th style={{padding: '1rem'}}>Status</th>
                                <th style={{padding: '1rem'}}>Envios</th>
                                <th style={{padding: '1rem'}}>Convers√µes</th>
                                <th style={{padding: '1rem'}}>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {isLoading ? (<tr><td colSpan="7" style={{textAlign: 'center', padding: '2rem'}}>A carregar...</td></tr>) : 
                             history.map(item => {
                                const progressPercentage = item.total_jobs > 0 
                                    ? Math.round((item.processed_jobs / item.total_jobs) * 100)
                                    : 0;
                                
                                return (
                                    <React.Fragment key={item.id}>
                                        <tr style={{borderBottom: '1px solid var(--border-color)'}}>
                                            <td style={{padding: '1rem', fontWeight: '600'}}>{item.campaign_name}</td>
                                            <td style={{padding: '1rem'}}>{new Date(item.created_at).toLocaleString('pt-BR')}</td>
                                            <td style={{padding: '1rem'}}>
                                                {item.scheduled_at ? (
                                                    <span style={{color: 'var(--accent-primary)', fontWeight: '600'}}>
                                                        {new Date(item.scheduled_at).toLocaleString('pt-BR')}
                                                    </span>
                                                ) : (
                                                    <span style={{color: 'var(--text-secondary)'}}>Imediato</span>
                                                )}
                                            </td>
                                            <td style={{padding: '1rem'}}>{getStatusChip(item.status)}</td>
                                            <td style={{padding: '1rem'}}>{item.total_sent || 0}</td>
                                            <td style={{padding: '1rem', fontWeight: 'bold', color: 'var(--brand-primary)'}}>{item.conversions || 0}</td>
                                            <td style={{padding: '1rem'}}>
                                                <div style={{display: 'flex', gap: '0.5rem', flexWrap: 'wrap'}}>
                                                    {item.status === 'SCHEDULED' && (
                                                        <button 
                                                            className="btn btn-secondary btn-sm" 
                                                            onClick={() => handleCancelDisparo(item.id, item.campaign_name)} 
                                                            disabled={isCancelling === item.id}
                                                            style={{background: 'var(--danger)', borderColor: 'var(--danger)'}}
                                                        >
                                                            {isCancelling === item.id ? 'Cancelando...' : 'Cancelar'}
                                                        </button>
                                                    )}
                                                    {(item.status === 'RUNNING' || item.status === 'PENDING' || item.status === 'HYGIENIZING') && (
                                                        <button 
                                                            className="btn btn-secondary btn-sm" 
                                                            onClick={() => handleCancelDisparo(item.id, item.campaign_name)} 
                                                            disabled={isCancelling === item.id}
                                                            style={{background: 'var(--danger)', borderColor: 'var(--danger)'}}
                                                        >
                                                            {isCancelling === item.id ? 'Cancelando...' : 'Cancelar'}
                                                        </button>
                                                    )}
                                                <button className="btn btn-secondary btn-sm" onClick={() => handleCheckConversions(item.id)} disabled={isChecking === item.id}>
                                                    {isChecking === item.id ? 'A verificar...' : 'Verificar PIX'}
                                                </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {(item.status === 'RUNNING' || item.status === 'PENDING') && (
                                            <tr>
                                                <td colSpan="7" style={{padding: '0.75rem 1rem', background: 'linear-gradient(135deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.6) 100%)', borderTop: '1px solid rgba(56, 189, 248, 0.1)'}}>
                                                    <div style={{display: 'flex', flexDirection: 'column', gap: '0.75rem'}}>
                                                        <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                                                            <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                                                                <span style={{fontSize: '0.875rem', color: 'var(--text-secondary)', fontWeight: '500'}}>
                                                                    Progresso:
                                                                </span>
                                                                <span style={{fontSize: '0.875rem', color: 'var(--text-primary)', fontWeight: '600'}}>
                                                                    {item.processed_jobs || 0} de {item.total_jobs || 0} processados
                                                                </span>
                                                            </div>
                                                            <span style={{
                                                                fontWeight: '700', 
                                                                fontSize: '0.9rem',
                                                                color: item.status === 'RUNNING' ? 'var(--accent-primary)' : '#fbbf24',
                                                                textShadow: item.status === 'RUNNING' 
                                                                    ? '0 0 8px rgba(56, 189, 248, 0.4)' 
                                                                    : '0 0 8px rgba(251, 191, 36, 0.4)'
                                                            }}>
                                                                {progressPercentage}%
                                                            </span>
                                                        </div>
                                                        <div style={{
                                                            width: '100%',
                                                            height: '12px',
                                                            background: 'rgba(15, 23, 42, 0.6)',
                                                            borderRadius: '6px',
                                                            overflow: 'hidden',
                                                            position: 'relative',
                                                            border: '1px solid rgba(56, 189, 248, 0.1)',
                                                            boxShadow: 'inset 0 2px 4px rgba(0, 0, 0, 0.3)'
                                                        }}>
                                                            <div style={{
                                                                height: '100%',
                                                                width: `${progressPercentage}%`,
                                                                background: item.status === 'RUNNING' 
                                                                    ? 'linear-gradient(90deg, #38bdf8 0%, #0ea5e9 50%, #0284c7 100%)'
                                                                    : 'linear-gradient(90deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%)',
                                                                transition: 'width 0.5s cubic-bezier(0.4, 0, 0.2, 1)',
                                                                borderRadius: '6px',
                                                                boxShadow: item.status === 'RUNNING'
                                                                    ? '0 0 12px rgba(56, 189, 248, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.2)'
                                                                    : '0 0 12px rgba(251, 191, 36, 0.5), inset 0 1px 0 rgba(255, 255, 255, 0.2)',
                                                                position: 'relative',
                                                                overflow: 'hidden'
                                                            }}>
                                                                {item.status === 'RUNNING' && (
                                                                    <div style={{
                                                                        position: 'absolute',
                                                                        top: 0,
                                                                        left: '-100%',
                                                                        width: '100%',
                                                                        height: '100%',
                                                                        background: 'linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent)',
                                                                        animation: 'shimmer 2s infinite'
                                                                    }}></div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </td>
                                            </tr>
                                        )}
                                    </React.Fragment>
                                );
                            })}
                        </tbody>
                    </table>
                     {!isLoading && history.length === 0 && <p style={{textAlign: 'center', padding: '2rem', color: 'var(--text-secondary)'}}>Nenhum disparo encontrado.</p>}
                </div>
            </div>
        );
    }

    function SettingsPage() {
        const [apiKey, setApiKey] = useState('');
        const [isLoading, setIsLoading] = useState(true);
        const [isSaving, setIsSaving] = useState(false);
        useEffect(() => {
            api.get('/api/dashboard/data')
                .then(res => setApiKey(res.data.settings?.api_key || ''))
                .catch(() => alert("N√£o foi poss√≠vel carregar as suas configura√ß√µes."))
                .finally(() => setIsLoading(false));
        }, []);
        const handleSave = async (e) => {
            e.preventDefault();
            setIsSaving(true);
            try {
                const res = await api.put('/api/settings/hottrack-key', { apiKey });
                alert(res.data.message);
            } catch (error) {
                alert('Erro ao salvar: ' + (error.response?.data?.message || error.message));
            } finally {
                setIsSaving(false);
            }
        };
        if (isLoading) { return <div style={{padding: '2rem 3rem'}}><div className="page-header"><h2>Integra√ß√µes</h2></div><p>A carregar...</p></div>; }
        return (
            <div style={{ padding: '2rem 3rem', height: '100%', overflowY: 'auto' }}>
                <div className="page-header"><h2>Integra√ß√µes</h2></div>
                <div className="card" style={{ maxWidth: '700px' }}>
                    <h3 style={{color: 'var(--text-primary)'}}>Integra√ß√£o com HotTrack PIX</h3>
                    <p style={{color: 'var(--text-secondary)', marginBottom: '1.5rem', fontSize: '0.9rem'}}>Insira a sua Chave de API da plataforma HotTrack para permitir que este bot gere e consulte PIXs.</p>
                    <form onSubmit={handleSave}>
                        <div className="form-group"><label htmlFor="hottrackApiKey">A sua Chave de API HotTrack</label><input id="hottrackApiKey" className="form-input" type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="Cole a sua chave de API aqui" /></div>
                        <button className="btn btn-primary" type="submit" disabled={isSaving}>{isSaving ? 'A guardar...' : 'Guardar Chave'}</button>
                    </form>
                </div>
            </div>
        );
    }
    
    function LiveChatPage({ bots }) {
        const [selectedBotId, setSelectedBotId] = useState('');
        const [allFlows, setAllFlows] = useState([]);
        const [users, setUsers] = useState([]);
        const [filteredUsers, setFilteredUsers] = useState([]);
        const [selectedChat, setSelectedChat] = useState(null);
        const [messages, setMessages] = useState([]);
        const [newMessage, setNewMessage] = useState('');
        const [searchTerm, setSearchTerm] = useState('');
        
        const [showOnlyActive, setShowOnlyActive] = useState(false);
        const [inactiveChatIds, setInactiveChatIds] = useState([]);
        const [isValidating, setIsValidating] = useState(false);
        
        const [customTags, setCustomTags] = useState([]);
        const [tagFilters, setTagFilters] = useState([]);
        const [isTagManagerOpen, setIsTagManagerOpen] = useState(false);
        const [tagContextMenu, setTagContextMenu] = useState(null);
        const [newTagTitle, setNewTagTitle] = useState('');
        const [newTagColor, setNewTagColor] = useState('#2563EB');
        const [isSavingTag, setIsSavingTag] = useState(false);
        const [tagError, setTagError] = useState('');
        const [isLoadingTags, setIsLoadingTags] = useState(false);
        
        const [isMediaModalOpen, setIsMediaModalOpen] = useState(false);
        const chatWindowRef = useRef(null);
        const fileInputRef = useRef(null);
        const leadForContextMenu = tagContextMenu ? users.find(u => u.chat_id === tagContextMenu.chatId) : null;
        const contextMenuPosition = useMemo(() => {
            if (!tagContextMenu) return null;
            if (typeof window === 'undefined') {
                return { top: tagContextMenu.y, left: tagContextMenu.x };
            }
            const maxTop = Math.max(0, window.innerHeight - 220);
            const maxLeft = Math.max(0, window.innerWidth - 220);
            return {
                top: Math.max(0, Math.min(tagContextMenu.y, maxTop)),
                left: Math.max(0, Math.min(tagContextMenu.x, maxLeft))
            };
        }, [tagContextMenu]);
        const tagFilterOptions = useMemo(() => {
            const automatic = [{ key: 'auto:Pagante', label: 'Pagante', variant: 'auto' }];
            // Filtrar tags custom que t√™m o mesmo nome de tags autom√°ticas para evitar duplicatas
            const automaticTagNames = ['Pagante'];
            const filteredCustomTags = customTags.filter(tag => 
                !automaticTagNames.includes(tag.title)
            );
            const custom = filteredCustomTags.map(tag => ({
                key: `custom:${tag.id}`,
                label: tag.title,
                variant: 'custom',
                color: tag.color
            }));
            return [...automatic, ...custom];
        }, [customTags]);
        
        const getContrastColor = useCallback((hexColor) => {
            if (!hexColor || typeof hexColor !== 'string') return '#ffffff';
            const sanitized = hexColor.replace('#', '');
            if (sanitized.length !== 6) return '#ffffff';
            const r = parseInt(sanitized.substring(0, 2), 16);
            const g = parseInt(sanitized.substring(2, 4), 16);
            const b = parseInt(sanitized.substring(4, 6), 16);
            const brightness = (r * 299 + g * 587 + b * 114) / 1000;
            return brightness > 160 ? '#0f172a' : '#ffffff';
        }, []);

        const updateLeadState = useCallback((chatId, transformer) => {
            setUsers(prev =>
                prev.map(lead => {
                    if (lead.chat_id !== chatId) return lead;
                    const updated = transformer({ ...lead });
                    return updated || lead;
                })
            );
            setSelectedChat(prev => {
                if (!prev || prev.chat_id !== chatId) return prev;
                const updated = transformer({ ...prev });
                return updated || prev;
            });
        }, []);

        useEffect(() => {
            const handleGlobalClick = () => setTagContextMenu(null);
            const handleKeyDown = (event) => {
                if (event.key === 'Escape') setTagContextMenu(null);
            };
            const handleScroll = () => setTagContextMenu(null);
            window.addEventListener('click', handleGlobalClick);
            window.addEventListener('keydown', handleKeyDown);
            window.addEventListener('scroll', handleScroll, true);
            return () => {
                window.removeEventListener('click', handleGlobalClick);
                window.removeEventListener('keydown', handleKeyDown);
                window.removeEventListener('scroll', handleScroll, true);
            };
        }, []);
        
        useEffect(() => {
            if (bots.length > 0 && !selectedBotId) {
                setSelectedBotId(bots[0].id);
            }
        }, [bots]);
        
        useEffect(() => {
            const chatWindow = chatWindowRef.current;
            if (!chatWindow) return;

            const isScrolledToBottom = chatWindow.scrollHeight - chatWindow.clientHeight <= chatWindow.scrollTop + 150;

            if (isScrolledToBottom) {
                chatWindow.scrollTo({ top: chatWindow.scrollHeight, behavior: 'smooth' });
            }
        }, [messages]);
        
        useEffect(() => {
            setTagContextMenu(null);
            setTagFilters([]);
        }, [selectedBotId]);
        
        useEffect(() => {
            api.get('/api/flows').then(({data}) => setAllFlows(data || []));
        }, []);

        const fetchTags = useCallback(async () => {
            if (!selectedBotId) {
                setCustomTags([]);
                return;
            }
            setIsLoadingTags(true);
            try {
                const { data } = await api.get('/api/tags', { params: { botId: selectedBotId } });
                const safeData = Array.isArray(data) ? data : [];
                // Filtrar apenas tags custom (excluir tags autom√°ticas)
                const customOnlyTags = safeData.filter(tag => tag.type !== 'automatic' && tag.id !== 'Pagante');
                setCustomTags(customOnlyTags);
                setTagFilters(prev => prev.filter(key => {
                    if (!key.startsWith('custom:')) return true;
                    const tagId = Number(key.split(':')[1]);
                    return safeData.some(tag => tag.id === tagId);
                }));
            } catch (e) {
                console.error("Erro ao carregar tags personalizadas", e);
                alert('N√£o foi poss√≠vel carregar as tags personalizadas.');
            } finally {
                setIsLoadingTags(false);
            }
        }, [selectedBotId]);

        useEffect(() => { fetchTags(); }, [fetchTags]);

        const fetchUsers = useCallback(async () => {
            if (!selectedBotId) {
                setUsers([]);
                return;
            }
            try {
                const { data } = await api.get(`/api/chats/${selectedBotId}`);
                const normalized = (data || []).map(lead => ({
                    ...lead,
                    custom_tags: Array.isArray(lead.custom_tags) ? lead.custom_tags : [],
                    automatic_tags: Array.isArray(lead.automatic_tags) ? lead.automatic_tags : []
                }));
                setUsers(normalized);
            } catch (e) {
                console.error("Erro ao buscar usu√°rios", e);
            }
        }, [selectedBotId]);
        
        const handleConversationContextMenu = (event, user) => {
            event.preventDefault();
            setTagContextMenu({ x: event.clientX, y: event.clientY, chatId: user.chat_id });
        };

        const toggleLeadTag = async (tag, lead) => {
            if (!tag || !lead) return;
            
            // Prevenir adi√ß√£o/remo√ß√£o de tags autom√°ticas
            if (tag.type === 'automatic' || tag.id === 'Pagante' || tag.title === 'Pagante') {
                alert('Tags autom√°ticas n√£o podem ser adicionadas ou removidas manualmente.');
                return;
            }
            
            const isAssigned = (lead.custom_tags || []).some(t => t.id === tag.id);
            try {
                if (isAssigned) {
                    await api.delete(`/api/leads/${selectedBotId}/${lead.chat_id}/tags/${tag.id}`);
                    updateLeadState(lead.chat_id, current => ({
                        ...current,
                        custom_tags: (current.custom_tags || []).filter(t => t.id !== tag.id)
                    }));
                } else {
                    await api.post(`/api/leads/${selectedBotId}/${lead.chat_id}/tags`, { tagId: tag.id });
                    updateLeadState(lead.chat_id, current => {
                        const currentTags = Array.isArray(current.custom_tags) ? current.custom_tags : [];
                        if (currentTags.some(t => t.id === tag.id)) return current;
                        return {
                            ...current,
                            custom_tags: [...currentTags, { id: tag.id, title: tag.title, color: tag.color }]
                        };
                    });
                }
            } catch (error) {
                console.error("Erro ao atualizar tags do lead:", error);
                const errorMessage = error.response?.data?.message || 'Erro ao atualizar tags do lead.';
                alert(errorMessage);
            }
        };

        const handleTagFilterToggle = (key) => {
            setTagFilters(prev => prev.includes(key) ? prev.filter(item => item !== key) : [...prev, key]);
        };

        const handleOpenTagManager = () => {
            setTagError('');
            setTagContextMenu(null);
            setIsTagManagerOpen(true);
        };

        const handleCreateTag = async (event) => {
            event.preventDefault();
            if (!selectedBotId) {
                setTagError('Selecione um bot para criar tags.');
                return;
            }
            const trimmedTitle = newTagTitle.trim();
            if (!trimmedTitle) {
                setTagError('Informe um t√≠tulo.');
                return;
            }
            
            // Prevenir cria√ß√£o de tags com nomes de tags autom√°ticas
            const automaticTagNames = ['Pagante'];
            if (automaticTagNames.includes(trimmedTitle)) {
                setTagError(`N√£o √© poss√≠vel criar uma tag custom com o nome "${trimmedTitle}". Esta √© uma tag autom√°tica do sistema.`);
                return;
            }
            
            if (trimmedTitle.length > 12) {
                setTagError('O t√≠tulo deve ter no m√°ximo 12 caracteres.');
                return;
            }
            setIsSavingTag(true);
            setTagError('');
            try {
                const payload = {
                    title: trimmedTitle,
                    color: newTagColor.toUpperCase(),
                    botId: selectedBotId
                };
                const { data } = await api.post('/api/tags', payload);
                setCustomTags(prev => {
                    const next = [...prev, data];
                    return next.sort((a, b) => a.title.localeCompare(b.title));
                });
                setNewTagTitle('');
            } catch (error) {
                const message = error.response?.data?.message || 'Erro ao criar tag.';
                setTagError(message);
            } finally {
                setIsSavingTag(false);
            }
        };

        const handleDeleteTag = async (tagId) => {
            if (!confirm('Deseja realmente excluir esta tag?')) return;
            try {
                await api.delete(`/api/tags/${tagId}`);
                setCustomTags(prev => prev.filter(tag => tag.id !== tagId));
                setTagFilters(prev => prev.filter(key => key !== `custom:${tagId}`));
                setUsers(prev => prev.map(lead => ({
                    ...lead,
                    custom_tags: (lead.custom_tags || []).filter(tag => tag.id !== tagId)
                })));
                setSelectedChat(prev => prev ? {
                    ...prev,
                    custom_tags: (prev.custom_tags || []).filter(tag => tag.id !== tagId)
                } : prev);
            } catch (error) {
                console.error("Erro ao excluir tag:", error);
                alert('Erro ao excluir tag.');
            }
        };

        useEffect(() => {
            if (!selectedBotId) return;
            fetchUsers();
            const intervalId = setInterval(fetchUsers, 10000);
            return () => clearInterval(intervalId);
        }, [fetchUsers, selectedBotId]);

        const fetchMessages = useCallback(async () => {
             if (!selectedBotId || !selectedChat?.chat_id) return;
             try {
                 const { data } = await api.get(`/api/chats/${selectedBotId}/${selectedChat.chat_id}`);
                 setMessages(prevMessages => JSON.stringify(prevMessages) === JSON.stringify(data) ? prevMessages : data);
             } catch (e) {
                 console.error("Erro ao buscar mensagens", e);
             }
        }, [selectedBotId, selectedChat?.chat_id]);

        useEffect(() => {
            if (!selectedChat) return;
            fetchMessages(); 
            const intervalId = setInterval(fetchMessages, 5000);
            return () => clearInterval(intervalId);
        }, [fetchMessages, selectedChat]);
        
        // Fun√ß√£o auxiliar que retorna o nome completo (l√≥gica original)
        const getDisplayName = (u) => { 
            if (!u) return ''; 
            if (u.click_id) { 
                const cleanId = u.click_id.replace('/start ', ''); 
                return cleanId.charAt(0).toUpperCase() + cleanId.slice(1); 
            } 
            return `${u.first_name || ''} ${u.last_name || ''}`.trim() || 'Desconhecido'; 
        };
        
        // Fun√ß√£o para pegar apenas o primeiro nome do Telegram
        const getFirstName = (u) => {
            if (!u) return 'Desconhecido';
            // Usa first_name do Telegram se existir
            if (u.first_name) return u.first_name;
            // Fallback: se n√£o tiver first_name, usa click_id
            if (u.click_id) {
                const cleanId = u.click_id.replace('/start ', '');
                return cleanId.charAt(0).toUpperCase() + cleanId.slice(1);
            }
            return 'Desconhecido';
        };
        
        // Fun√ß√£o para pegar o ID (click_id se tiver, sen√£o chat_id)
        const getLeadId = (u) => {
            if (!u) return '';
            // Prioridade: click_id
            if (u.click_id) {
                const cleanId = u.click_id.replace('/start ', '');
                return cleanId;
            }
            // Fallback: chat_id
            return u.chat_id ? String(u.chat_id) : '';
        };

        const formatLastMessageTime = (timestamp) => {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            if (Number.isNaN(date.getTime())) return '';
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        };
        
        useEffect(() => {
            const activeUsers = showOnlyActive 
                ? users.filter(u => !inactiveChatIds.includes(u.chat_id))
                : users;

            const normalizedTerm = searchTerm.toLowerCase();

            setFilteredUsers(
                activeUsers.filter(u => {
                    const firstName = (u.first_name || '').toLowerCase();
                    const leadId = getLeadId(u).toLowerCase();
                    const matchesSearch = !normalizedTerm || firstName.includes(normalizedTerm) || leadId.includes(normalizedTerm);
                    if (!matchesSearch) return false;

                    if (tagFilters.length === 0) return true;
                    const leadTagKeys = [
                        ...(Array.isArray(u.automatic_tags) ? u.automatic_tags.map(name => `auto:${name}`) : []),
                        ...(Array.isArray(u.custom_tags) ? u.custom_tags.map(tag => `custom:${tag.id}`) : [])
                    ];
                    return tagFilters.every(tagKey => leadTagKeys.includes(tagKey));
                })
            );
        }, [searchTerm, users, showOnlyActive, inactiveChatIds, tagFilters]);

        useEffect(() => {
            if (!selectedChat) return;
            const updated = users.find(u => u.chat_id === selectedChat.chat_id);
            if (!updated) return;
            const customChanged = JSON.stringify(updated.custom_tags || []) !== JSON.stringify(selectedChat.custom_tags || []);
            const autoChanged = JSON.stringify(updated.automatic_tags || []) !== JSON.stringify(selectedChat.automatic_tags || []);
            if (customChanged || autoChanged || updated.first_name !== selectedChat.first_name || updated.last_message_at !== selectedChat.last_message_at) {
                setSelectedChat(prev => prev ? { ...prev, ...updated } : prev);
            }
        }, [users, selectedChat]);

    const handleFilterActiveToggle = async () => {
        const nextState = !showOnlyActive;
        setShowOnlyActive(nextState);

        if (nextState && selectedBotId) {
            setIsValidating(true);
            try {
                const { data } = await api.post('/api/bots/validate-contacts', { botId: selectedBotId });
                setInactiveChatIds(data.inactive_contacts.map(c => c.chat_id));
            } catch (error) {
                console.error("Erro ao validar contatos", error);
                alert('N√£o foi poss√≠vel validar os contatos.');
            } finally {
                setIsValidating(false);
            }
        }
    };

    useEffect(() => {
        if (selectedBotId) {
            setSelectedChat(null);
        }
    }, [selectedBotId]);

    const handleSelectChat = useCallback((user) => {
        if (selectedChat?.chat_id !== user.chat_id) {
            setMessages([]);
            setSelectedChat(user);
        }
    }, [selectedChat]);

    const handleSend = async (e) => { e.preventDefault(); const txt = newMessage.trim(); if (!txt || !selectedChat) return; setNewMessage(''); try { await api.post(`/api/chats/${selectedBotId}/send-message`, { chatId: selectedChat.chat_id, text: txt }); await fetchMessages(); } catch (e) { console.error("Erro", e); alert('Erro ao enviar mensagem.');} };
		const handleFileChange = (e) => {
			const file = e.target.files[0];
			if (!file || !selectedChat) return;
			const MB = 1024 * 1024;
			if (file.type?.startsWith('video/') && file.size > 50 * MB) {
				alert('V√≠deo maior que 50 MB (limite do Telegram).');
				e.target.value = null;
				return;
			}
			if (file.type?.startsWith('image/') && file.size > 10 * MB) {
				alert('Imagem maior que 10 MB (limite do Telegram).');
				e.target.value = null;
				return;
			}
			if (file.type?.startsWith('audio/') && file.size > 50 * MB) {
				alert('√Åudio maior que 50 MB (limite do Telegram).');
				e.target.value = null;
				return;
			}
			const reader = new FileReader();
			reader.readAsDataURL(file);
			reader.onload = async () => {
				try {
					const base64Data = reader.result.split(',')[1];
					await api.post(`/api/chats/${selectedBotId}/send-media`, { chatId: selectedChat.chat_id, fileData: base64Data, fileType: file.type, fileName: file.name });
					fetchMessages();
				} catch (error) {
					alert('Falha no upload: ' + (error.response?.data?.message || error.message));
				}
			};
			e.target.value = null;
		};
        
        const handleSendFromLibrary = async (mediaItem) => {
            if (!selectedChat || !selectedBotId) return;
            setIsMediaModalOpen(false);
            try {
                await api.post(`/api/chats/${selectedBotId}/send-library-media`, {
                    chatId: selectedChat.chat_id,
                    fileId: mediaItem.file_id,
                    fileType: mediaItem.file_type
                });
                fetchMessages();
            } catch (error) {
                alert('Falha ao enviar m√≠dia da biblioteca: ' + (error.response?.data?.message || error.message));
            }
        };

        const handleDelete = async (id) => { if (confirm(`Certeza?`)) { try { await api.delete(`/api/chats/${selectedBotId}/${id}`); fetchUsers(); if (selectedChat?.chat_id === id) { setSelectedChat(null); } } catch (e) { alert('Erro'); } } };
        
        const getMessageSender = (msg) => {
            const selectedBot = bots.find(b => b.id == selectedBotId);
            switch(msg.sender_type) {
                case 'user': return `${msg.first_name || ''} ${msg.last_name || ''}`.trim();
                case 'operator': return 'Voc√™ (Operador)';
                case 'bot': return `${(selectedBot?.bot_name || 'Bot').replace('@', '')} (Automa√ß√£o)`;
                default: return 'Desconhecido';
            }
        };
        const getMessageBubbleClass = (senderType) => {
            if (senderType === 'user') return 'message-user';
            return 'message-attendant';
        };

        // ******** CORRE√á√ÉO DE SEGURAN√áA (XSS) APLICADA AQUI ********
        const renderMessageButtons = (msg) => {
            if (!msg.reply_markup) return null;
            
            let replyMarkup;
            try {
                replyMarkup = typeof msg.reply_markup === 'string' ? JSON.parse(msg.reply_markup) : msg.reply_markup;
            } catch (e) {
                console.error('Erro ao parsear reply_markup:', e);
                return null;
            }
            
            if (!replyMarkup.inline_keyboard || !Array.isArray(replyMarkup.inline_keyboard)) return null;
            
            return (
                <div className="inline-buttons-container">
                    {replyMarkup.inline_keyboard.map((row, rowIndex) => (
                        <div key={rowIndex} className="inline-buttons-row">
                            {row.map((button, btnIndex) => (
                                <span key={btnIndex} className="inline-button">
                                    {button.text}
                                    {button.url && <span className="inline-button-url"> ({button.url})</span>}
                                </span>
                            ))}
                        </div>
                    ))}
                </div>
            );
        };
        
        const renderMessageContent = (msg) => {
            const text = msg.message_text || '';
            const content = [];
            
            if (msg.media_type === 'photo') {
                content.push(<img key="photo" src={`${API_BASE_URL}/api/media/preview/${msg.bot_id}/${msg.media_file_id}`} className="chat-media" alt="Foto" onClick={() => window.open(`${API_BASE_URL}/api/media/preview/${msg.bot_id}/${msg.media_file_id}`)} />);
            } else if (msg.media_type === 'video') {
                content.push(<video key="video" src={`${API_BASE_URL}/api/media/preview/${msg.bot_id}/${msg.media_file_id}`} className="chat-media" controls />);
            } else if (msg.media_type === 'voice') {
                content.push(<audio key="voice" src={`${API_BASE_URL}/api/media/preview/${msg.bot_id}/${msg.media_file_id}`} className="chat-audio" controls />);
            }
            
            // SANITIZA√á√ÉO: Limpa o HTML de qualquer script malicioso antes de renderizar.
            // A biblioteca DOMPurify foi adicionada no <head> do HTML.
            const sanitizedHtml = DOMPurify.sanitize(text.replace(/\n/g, '<br />'));
            content.push(<div key="text" dangerouslySetInnerHTML={{ __html: sanitizedHtml }} />);
            
            // Adiciona bot√µes inline se existirem
            const buttons = renderMessageButtons(msg);
            if (buttons) {
                content.push(buttons);
            }
            
            return <>{content}</>;
        };
        
        const botFlows = allFlows.filter(f => f.bot_id == selectedBotId);

        return (
            <div className="chat-page-layout">
                {isMediaModalOpen && <MediaLibraryModal onSelect={handleSendFromLibrary} onClose={() => setIsMediaModalOpen(false)} />}
                {isTagManagerOpen && (
                    <div className="tag-manager-backdrop" onClick={() => setIsTagManagerOpen(false)}>
                        <div className="tag-manager-modal" onClick={e => e.stopPropagation()}>
                            <div className="tag-manager-header">
                                <h3>Gerenciar tags</h3>
                                <button type="button" onClick={() => setIsTagManagerOpen(false)} aria-label="Fechar">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <form className="tag-manager-form" onSubmit={handleCreateTag}>
                                <div className="form-group">
                                    <label>T√≠tulo (at√© 12 caracteres)</label>
                                    <input
                                        className="form-input"
                                        maxLength={12}
                                        value={newTagTitle}
                                        onChange={e => setNewTagTitle(e.target.value)}
                                        placeholder="Ex: VIP"
                                        required
                                    />
                                </div>
                                <div className="form-group">
                                    <label>Cor</label>
                                    <div className="tag-color-picker">
                                        <input
                                            type="color"
                                            value={newTagColor}
                                            onChange={e => setNewTagColor(e.target.value.toUpperCase())}
                                            aria-label="Selecionar cor da tag"
                                        />
                                        <span>{newTagColor}</span>
                                    </div>
                                </div>
                                {tagError && <p className="tag-error">{tagError}</p>}
                                <button className="btn btn-primary" type="submit" disabled={isSavingTag}>
                                    {isSavingTag ? 'Salvando...' : 'Criar tag'}
                                </button>
                            </form>
                            <div className="tag-manager-list">
                                {isLoadingTags ? (
                                    <p className="tag-loading">Carregando tags...</p>
                                ) : customTags.length === 0 ? (
                                    <p className="tag-empty">Nenhuma tag criada ainda.</p>
                                ) : (
                                    customTags.map(tag => (
                                        <div key={`manager-${tag.id}`} className="tag-manager-item">
                                            <span
                                                className="tag-badge"
                                                style={{ backgroundColor: tag.color, color: getContrastColor(tag.color), borderColor: tag.color }}
                                            >
                                                {tag.title}
                                            </span>
                                            <button type="button" className="btn btn-red btn-sm" onClick={() => handleDeleteTag(tag.id)}>
                                                Excluir
                                            </button>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>
                    </div>
                )}
                {tagContextMenu && contextMenuPosition && leadForContextMenu && (
                    <div
                        className="tag-context-menu"
                        style={{ top: contextMenuPosition.top, left: contextMenuPosition.left }}
                        onClick={e => e.stopPropagation()}
                    >
                        <div className="tag-context-title">Tags personalizadas</div>
                        {customTags.length === 0 ? (
                            <p className="tag-context-empty">Crie tags para atribu√≠-las aos seus leads.</p>
                        ) : (
                            customTags.map(tag => {
                                    const isAssigned = (leadForContextMenu.custom_tags || []).some(t => t.id === tag.id);
                                    return (
                                        <button
                                            key={`context-${tag.id}`}
                                            type="button"
                                            className={`tag-context-item ${isAssigned ? 'active' : ''}`}
                                            onClick={() => toggleLeadTag(tag, leadForContextMenu)}
                                        >
                                            <span className="tag-color-dot" style={{ backgroundColor: tag.color }} />
                                            <span>{tag.title}</span>
                                            {isAssigned && <span className="tag-context-check">‚úì</span>}
                                        </button>
                                    );
                                })
                        )}
                    </div>
                )}
                <div style={{display: 'flex', flexDirection: 'column', height: '100%'}}>
                    <div className="page-header" style={{padding: '2rem 3rem 2rem 3rem', margin: 0}}><h2>Chat ao Vivo</h2><div className="form-group" style={{ marginBottom: 0, minWidth: '300px' }}><select id="botSelectChat" className="form-select" value={selectedBotId} onChange={e => setSelectedBotId(e.target.value)}><option value="">-- Selecione um Bot --</option>{bots.map(b => <option key={b.id} value={b.id}>{b.bot_name}</option>)}</select></div></div>
                    <div className="chat-container" style={{height: 'calc(100vh - 8.5rem)', margin: '0 3rem 2rem 3rem'}} >
                        <div className="conversations-panel">
                            <div className="conversations-header">
                                <input type="text" className="form-input" placeholder="Buscar..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                <div className="tag-actions">
                                    <button
                                        type="button"
                                        className="btn btn-secondary btn-sm"
                                        onClick={handleOpenTagManager}
                                        disabled={!selectedBotId}
                                    >
                                        Gerenciar tags
                                    </button>
                                    <div className="tag-filter-container">
                                        <span className="tag-filter-label">Filtrar por tags:</span>
                                        {tagFilterOptions.map(option => {
                                            const isActive = tagFilters.includes(option.key);
                                            const style = option.variant === 'custom'
                                                ? {
                                                    borderColor: option.color,
                                                    backgroundColor: isActive ? option.color : 'transparent',
                                                    color: isActive ? getContrastColor(option.color) : option.color
                                                  }
                                                : undefined;
                                            const className = `tag-filter-chip ${option.variant === 'auto' ? 'auto' : ''} ${isActive ? 'active' : ''}`;
                                            return (
                                                <button
                                                    key={option.key}
                                                    type="button"
                                                    className={className}
                                                    style={style}
                                                    onClick={() => handleTagFilterToggle(option.key)}
                                                >
                                                    {option.label}
                                                </button>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                            <div style={{ padding: '0.75rem 1rem', borderBottom: '1px solid var(--border-color)', display: 'flex', alignItems: 'center', gap: '0.75rem' }}>
                                <label htmlFor="activeFilter" style={{ cursor: 'pointer', flexGrow: 1, color: 'var(--text-secondary)', fontSize: '0.9rem' }}>
                                    {isValidating ? 'Validando...' : 'Mostrar apenas ativos'}
                                </label>
                                <input 
                                    type="checkbox" 
                                    id="activeFilter" 
                                    checked={showOnlyActive} 
                                    onChange={handleFilterActiveToggle} 
                                    disabled={isValidating}
                                />
                            </div>
                            <div className="conversations-list">
                                {filteredUsers.map(u => {
                                    const formattedTime = formatLastMessageTime(u.last_message_at);
                                    return (
                                        <div
                                            key={u.chat_id}
                                            className={`conversation-item ${selectedChat?.chat_id === u.chat_id ? 'active' : ''}`}
                                            onClick={() => handleSelectChat(u)}
                                            onContextMenu={(e) => handleConversationContextMenu(e, u)}
                                        >
                                            <div className="conversation-item-header">
                                                <div className="conversation-item-name">
                                                    {getFirstName(u)}
                                                    <span style={{fontSize: '0.75rem', color: 'var(--text-secondary)', marginLeft: '0.5rem'}}>#{getLeadId(u)}</span>
                                                </div>
                                                {formattedTime ? <span className="conversation-item-time">{formattedTime}</span> : null}
                                            </div>
                                            <p className="conversation-item-preview">{u.message_text}</p>
                                            <div className="conversation-item-tags">
                                                {(u.automatic_tags || []).map(tagName => (
                                                    <span key={`auto-${tagName}`} className="tag-badge tag-badge--auto">{tagName}</span>
                                                ))}
                                                {(u.custom_tags || []).map(tag => (
                                                    <span
                                                        key={`custom-${tag.id}`}
                                                        className="tag-badge"
                                                        style={{ backgroundColor: tag.color, color: getContrastColor(tag.color), borderColor: tag.color }}
                                                    >
                                                        {tag.title}
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                        <div className="chat-window">
                            {selectedChat ? (
                                <>
                                    <div className="chat-header">
                                        <div className="chat-header-main">
                                            <h3>
                                                {getFirstName(selectedChat)}
                                                <span style={{fontSize: '0.85rem', color: 'var(--text-secondary)', fontWeight: '400'}}>#{getLeadId(selectedChat)}</span>
                                            </h3>
                                            <div className="chat-header-tags">
                                                {(selectedChat.automatic_tags || []).map(tagName => (
                                                    <span key={`header-auto-${tagName}`} className="tag-badge tag-badge--auto">{tagName}</span>
                                                ))}
                                                {(selectedChat.custom_tags || []).map(tag => (
                                                    <span
                                                        key={`header-custom-${tag.id}`}
                                                        className="tag-badge"
                                                        style={{ backgroundColor: tag.color, color: getContrastColor(tag.color), borderColor: tag.color }}
                                                    >
                                                        {tag.title}
                                                    </span>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="chat-header-actions">
                                            <button className="btn btn-danger btn-sm" onClick={() => handleDelete(selectedChat.chat_id)}>Excluir</button>
                                        </div>
                                    </div>
                                    <div className="message-list" ref={chatWindowRef}>
                                        {messages.map((m, i) => (
                                            <div key={m.message_id || i} className={`message-bubble ${getMessageBubbleClass(m.sender_type)}`}>
                                                <strong>{getMessageSender(m)}</strong>
                                                {renderMessageContent(m)}
                                                <div className="message-bubble-time">{new Date(m.created_at).toLocaleTimeString()}</div>
                                            </div>
                                        ))}
                                    </div>
                                    <div className="chat-input-area">
                                        <form onSubmit={handleSend} className="chat-input-form">
                                            <input type="file" ref={fileInputRef} onChange={handleFileChange} hidden accept="image/*,video/*,audio/*" />
                                            <button type="button" className="attach-btn" onClick={() => fileInputRef.current.click()} title="Anexar do computador">{Icons.attach}</button>
                                            <button type="button" className="attach-btn" onClick={() => setIsMediaModalOpen(true)} title="Selecionar da Biblioteca">{Icons.media}</button>
                                            <input className="form-input chat-input" value={newMessage} onChange={e => setNewMessage(e.target.value)} placeholder="Digite..." />
                                            <button className="btn btn-primary" type="submit">{Icons.send}</button>
                                        </form>
                                    </div>
                                </>
                            ) : (
                                <div className="centered-placeholder">
                                    {Icons.chat}
                                    <h3>Selecione uma conversa</h3>
                                    <p>Escolha um contato √† esquerda.</p>
                                </div>
                            )}
                        </div>
                        <div className="contact-panel">
                            {selectedChat ? (<>
                                <h3>Detalhes</h3>
                                <div className="contact-detail"><label>Nome</label><p>{`${selectedChat.first_name || ''} ${selectedChat.last_name || ''}`.trim() || 'N√£o informado'}</p></div>
                                <div className="contact-detail">
                                    <label>Tags</label>
                                    <div className="contact-tags">
                                        {(selectedChat.automatic_tags || []).map(tagName => (
                                            <span key={`panel-auto-${tagName}`} className="tag-badge tag-badge--auto">{tagName}</span>
                                        ))}
                                        {(selectedChat.custom_tags || []).map(tag => (
                                            <span
                                                key={`panel-custom-${tag.id}`}
                                                className="tag-badge"
                                                style={{ backgroundColor: tag.color, color: getContrastColor(tag.color), borderColor: tag.color }}
                                            >
                                                {tag.title}
                                            </span>
                                        ))}
                                        {(!selectedChat.automatic_tags || selectedChat.automatic_tags.length === 0) && (!selectedChat.custom_tags || selectedChat.custom_tags.length === 0) && (
                                            <span style={{ color: 'var(--text-secondary)', fontSize: '0.85rem' }}>Sem tags atribu√≠das.</span>
                                        )}
                                    </div>
                                    <small style={{ color: 'var(--text-secondary)', display: 'block', marginTop: '0.5rem' }}>Use o clique direito na lista para atribuir tags.</small>
                                </div>
                                <ChatActionsPanel botId={selectedBotId} chat={selectedChat} flows={botFlows} onAction={fetchMessages}/>
                            </>) : (<div className="centered-placeholder"><h3>Informa√ß√µes</h3><p>Detalhes do contato aqui.</p></div>)}
                        </div>
                    </div>
                </div>
            </div>
        );
    }
    
    function ChatActionsPanel({ botId, chat, flows, onAction }) {
        const [pixValue, setPixValue] = useState(100);
        const [pixMessage, setPixMessage] = useState('üö® O PIX expira em 6 minutos.');
        const [pixButtonText, setPixButtonText] = useState('üìã Copiar C√≥digo PIX');
        const [selectedFlow, setSelectedFlow] = useState('');

        const handleGeneratePix = async () => {
            try {
                const res = await api.post('/api/chats/generate-pix', {
                    botId,
                    chatId: chat.chat_id,
                    click_id: chat.click_id,
                    valueInCents: pixValue,
                    pixMessage: pixMessage,
                    pixButtonText: pixButtonText
                });
                alert(res.data.message);
                onAction();
            } catch (e) {
                alert('Erro: ' + (e.response?.data?.message || e.message));
            }
        };

        const handleCheckPix = async () => {
             try {
                const res = await api.get(`/api/chats/check-pix/${botId}/${chat.chat_id}`);
                alert(`Status do PIX: ${res.data.status}`);
            } catch (e) {
                alert('Erro: ' + (e.response?.data?.message || e.message));
            }
        };

        const handleStartFlow = async () => {
            if (!selectedFlow) {
                alert('Selecione um fluxo para iniciar.');
                return;
            }
            try {
                const res = await api.post('/api/chats/start-flow', { botId, chatId: chat.chat_id, flowId: selectedFlow });
                alert(res.data.message);
                setTimeout(() => {
                    onAction();
                }, 1500);
            } catch (e) {
                alert('Erro: ' + (e.response?.data?.message || e.message));
            }
        };

        return (
            <div className="actions-panel">
                <h3>A√ß√µes R√°pidas</h3>
                <div className="form-group">
                    <label htmlFor="pixValue">Valor do PIX (em centavos)</label>
                    <input id="pixValue" type="number" className="form-input" value={pixValue} onChange={e => setPixValue(e.target.value)} />
                    <label htmlFor="pixMessage">Texto da Mensagem do PIX</label>
                    <textarea id="pixMessage" className="form-textarea" rows="3" value={pixMessage} onChange={e => setPixMessage(e.target.value)} />
                    <label htmlFor="pixButtonText">Texto do Bot√£o PIX</label>
                    <input id="pixButtonText" type="text" className="form-input" value={pixButtonText} onChange={e => setPixButtonText(e.target.value)} />
                    <button className="btn btn-secondary btn-sm" onClick={handleGeneratePix} style={{marginTop: '1rem'}}>Gerar e Enviar PIX</button>
                    <button className="btn btn-secondary btn-sm" onClick={handleCheckPix}>Consultar √öltimo PIX</button>
                </div>
                <div className="form-group">
                    <label htmlFor="flowSelect">Iniciar Fluxo</label>
                    <select id="flowSelect" className="form-select" value={selectedFlow} onChange={e => setSelectedFlow(e.target.value)}>
                        <option value="">Selecione um fluxo...</option>
                        {flows.map(f => <option key={f.id} value={f.id}>{f.name}</option>)}
                    </select>
                    <button className="btn btn-secondary btn-sm" onClick={handleStartFlow} disabled={!selectedFlow}>Iniciar Fluxo</button>
                </div>
            </div>
        );
    }
    
    function MediaLibraryPage() {
        const [media, setMedia] = useState([]);
        const [isUploading, setIsUploading] = useState(false);
        const [activeTab, setActiveTab] = useState('image'); // 'image' | 'video' | 'audio'
        const fetchMedia = async () => { try { const { data } = await api.get('/api/media'); setMedia(data); } catch (e) { console.error("Erro ao buscar m√≠dias", e); }};
        useEffect(() => { fetchMedia(); }, []);
        const resolveType = (item) => {
            if (item.file_type) return item.file_type;
            const name = (item.file_name || '').toLowerCase();
            if (/(\.png|\.jpg|\.jpeg|\.gif|\.webp)$/.test(name)) return 'image';
            if (/(\.mp4|\.mov|\.webm|\.mkv)$/.test(name)) return 'video';
            if (/(\.mp3|\.wav|\.ogg)$/.test(name)) return 'audio';
            return 'image';
        };
        // Helper para construir URL de preview - usa storage_url se dispon√≠vel
        const getMediaPreviewUrl = (item, useThumbnail = true) => {
            if (useThumbnail && item.thumbnail_storage_url) {
                return item.thumbnail_storage_url;
            }
            if (item.storage_url) {
                return item.storage_url;
            }
            // Fallback para m√©todo antigo
            const fileId = useThumbnail ? (item.thumbnail_file_id || item.file_id) : item.file_id;
            return `${API_BASE_URL}/api/media/preview/storage/${fileId}`;
        };
        const filtered = media.filter(item => resolveType(item) === activeTab);
        const handleFileChange = (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const fileType = file.type.startsWith('image/') ? 'image' : (file.type.startsWith('video/') ? 'video' : (file.type.startsWith('audio/') ? 'audio' : null));
            if (!fileType) {
                alert("Formato de ficheiro n√£o suportado.");
                return;
            }
			const MB = 1024 * 1024;
			if (fileType === 'video' && file.size > 50 * MB) { alert('V√≠deo maior que 50 MB (limite do Telegram).'); e.target.value = null; return; }
			if (fileType === 'image' && file.size > 10 * MB) { alert('Imagem maior que 10 MB (limite do Telegram).'); e.target.value = null; return; }
			if (fileType === 'audio' && file.size > 50 * MB) { alert('√Åudio maior que 50 MB (limite do Telegram).'); e.target.value = null; return; }
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                setIsUploading(true);
                try {
                    const base64Data = reader.result.split(',')[1];
                    await api.post('/api/media/upload', { fileName: file.name, fileData: base64Data, fileType: fileType });
                    fetchMedia();
                } catch (error) {
                    alert('Falha no upload: ' + (error.response?.data?.message || error.message));
                } finally {
                    setIsUploading(false);
                }
            };
        };
        const handleDelete = async (id) => { if (confirm('Tem a certeza?')) { try { await api.delete(`/api/media/${id}`); fetchMedia(); } catch(e) { alert('Erro ao excluir.'); }}};
        return (
            <div style={{ padding: '2rem 3rem', height: '100%', overflowY: 'auto' }}>
                <div className="page-header">
                    <h2>Biblioteca de M√≠dia</h2>
                    <label className={`btn btn-primary ${isUploading ? 'disabled' : ''}`}>
                        {isUploading ? 'A carregar...' : '+ Carregar M√≠dia'}
                        <input type="file" hidden onChange={handleFileChange} disabled={isUploading} accept="image/*,video/*,audio/*" />
                    </label>
                </div>
                <div style={{display:'flex', gap: '0.5rem', marginBottom: '1rem'}}>
                    <button className={`btn btn-secondary ${activeTab==='image'?'active':''}`} onClick={()=>setActiveTab('image')}>Imagens</button>
                    <button className={`btn btn-secondary ${activeTab==='video'?'active':''}`} onClick={()=>setActiveTab('video')}>V√≠deos</button>
                    <button className={`btn btn-secondary ${activeTab==='audio'?'active':''}`} onClick={()=>setActiveTab('audio')}>√Åudios</button>
                </div>
                <div className="grid">
                    {filtered.map(item => (
                        <div key={item.id} className="bot-card">
                             {resolveType(item) === 'image' ? (
                                <img src={getMediaPreviewUrl(item, true)} className="media-preview" alt={item.file_name} />
                             ) : resolveType(item) === 'video' ? (
                                item.thumbnail_file_id || item.thumbnail_storage_url ? (
                                    <img src={getMediaPreviewUrl(item, true)} className="media-preview" alt={item.file_name} />
                                ) : (
                                    <video src={getMediaPreviewUrl(item, false)} className="media-preview" muted autoPlay loop playsInline preload="metadata" />
                                )
                             ) : (
                                <audio src={getMediaPreviewUrl(item, false)} className="media-preview" controls />
                             )}
                             <h3 style={{fontSize: '1.1rem', marginBottom: '0.5rem'}}>{item.file_name}</h3>
                             <p style={{color: 'var(--text-secondary)', fontSize: '0.8rem', wordBreak: 'break-all', flexGrow: 1, marginBottom: '1rem'}}>File ID: {item.file_id}</p>
                             <button className="btn btn-danger btn-sm" onClick={() => handleDelete(item.id)}>Excluir</button>
                        </div>
                    ))}
                </div>
                {media.length === 0 && !isUploading && <p style={{color: 'var(--text-secondary)'}}>A sua biblioteca est√° vazia.</p>}
            </div>
        );
    }
    
    function ContactsPage({ bots }) {
        const [selectedBotId, setSelectedBotId] = useState('');
        const [isLoading, setIsLoading] = useState(false);
        const [inactiveContacts, setInactiveContacts] = useState(null);
        const [showProgressModal, setShowProgressModal] = useState(false);
        const [validationProgress, setValidationProgress] = useState(null);
        const [validationId, setValidationId] = useState(null);
        const [pollingInterval, setPollingInterval] = useState(null);
        
        useEffect(() => {
            if (bots.length > 0 && !selectedBotId) {
                setSelectedBotId(bots[0].id);
            }
        }, [bots]);

        // Limpar polling quando componente desmontar ou valida√ß√£o completar
        useEffect(() => {
            return () => {
                if (pollingInterval) {
                    clearInterval(pollingInterval);
                }
            };
        }, [pollingInterval]);

        const handleValidate = async () => {
            if (!selectedBotId) {
                alert('Por favor, selecione um bot.');
                return;
            }
            setIsLoading(true);
            setInactiveContacts(null);
            setValidationProgress(null);
            setValidationId(null);
            
            try {
                const response = await api.post('/api/bots/validate-contacts', { botId: selectedBotId });
                
                // Verificar se √© resposta ass√≠ncrona (status 202)
                if (response.status === 202 || response.data.validation_id) {
                    const vId = response.data.validation_id;
                    setValidationId(vId);
                    setShowProgressModal(true);
                    setValidationProgress({ status: 'PENDING', progress_percentage: 0, processed_contacts: 0, total_contacts: response.data.total_contacts || 0 });
                    App.showToast('Valida√ß√£o iniciada. Processando em background...', 'success');
                    
                    // Iniciar polling
                    const interval = setInterval(async () => {
                        try {
                            const statusResponse = await api.get(`/api/bots/validate-contacts/${vId}`);
                            const status = statusResponse.data;
                            setValidationProgress(status);
                            
                            // Parar polling se completou ou falhou
                            if (status.status === 'COMPLETED' || status.status === 'FAILED') {
                                clearInterval(interval);
                                setPollingInterval(null);
                                
                                if (status.status === 'COMPLETED') {
                                    setInactiveContacts(status.inactive_contacts || []);
                                    setIsLoading(false);
                                    setTimeout(() => {
                                        setShowProgressModal(false);
                                        if (status.inactive_contacts && status.inactive_contacts.length === 0) {
                                            alert('Nenhum contato inativo encontrado!');
                                        }
                                    }, 1000);
                                } else {
                                    setIsLoading(false);
                                    setShowProgressModal(false);
                                    alert('Erro na valida√ß√£o: ' + (status.error_message || 'Erro desconhecido'));
                                }
                            }
                        } catch (pollError) {
                            console.error('Erro ao consultar status da valida√ß√£o:', pollError);
                        }
                    }, 2000); // Polling a cada 2 segundos
                    
                    setPollingInterval(interval);
                } else {
                    // Resposta s√≠ncrona (fallback para casos sem muitos contatos)
                    setInactiveContacts(response.data.inactive_contacts || []);
                    setIsLoading(false);
                    if (!response.data.inactive_contacts || response.data.inactive_contacts.length === 0) {
                        alert('Nenhum contato inativo encontrado!');
                    }
                }
            } catch (error) {
                setIsLoading(false);
                setShowProgressModal(false);
                alert('Erro ao validar contatos: ' + (error.response?.data?.message || 'Falha na valida√ß√£o.'));
            }
        };

        const handleRemove = async () => {
            if (!inactiveContacts || inactiveContacts.length === 0) {
                alert('Nenhum contato inativo para remover.');
                return;
            }
            if (!confirm(`Tem certeza que deseja remover ${inactiveContacts.length} contato(s) inativo(s)? Esta a√ß√£o n√£o pode ser desfeita.`)) {
                return;
            }
            setIsLoading(true);
            try {
                const chatIds = inactiveContacts.map(c => c.chat_id);
                const response = await api.post('/api/bots/remove-contacts', { botId: selectedBotId, chatIds });
                alert(response.data.message);
                setInactiveContacts([]);
            } catch (error) {
                alert('Erro ao remover contatos: ' + (error.response?.data?.message || 'Falha na remo√ß√£o.'));
            } finally {
                setIsLoading(false);
            }
        };
        return (
            <div style={{ padding: '2rem 3rem', height: '100%', overflowY: 'auto' }}>
                <div className="page-header"><h2>Higieniza√ß√£o de Contatos</h2></div>
                <div className="card" style={{ maxWidth: '700px', margin: '0 auto' }}>
                    <p style={{color: 'var(--text-secondary)', marginBottom: '1.5rem', fontSize: '0.9rem'}}>
                        Use esta ferramenta para verificar quais contatos bloquearam seu bot e remov√™-los da sua base. Isso garante que seus disparos tenham uma melhor entrega e performance.
                    </p>
                    <div className="form-group" style={{maxWidth: '400px', marginBottom: '2rem'}}>
                        <label htmlFor="botSelect">Selecione um Bot</label>
                        <select id="botSelect" className="form-select" value={selectedBotId} onChange={e => { setSelectedBotId(e.target.value); setInactiveContacts(null); }}>
                            <option value="">-- Selecione --</option>
                            {bots.map(b => <option key={b.id} value={b.id}>{b.bot_name}</option>)}
                        </select>
                    </div>
                    <button className="btn btn-primary" onClick={handleValidate} disabled={isLoading || !selectedBotId}>
                        {isLoading ? 'Validando...' : 'Validar Contatos Ativos'}
                    </button>
                    
                    {/* Modal de Progresso */}
                    {showProgressModal && validationProgress && (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            background: 'rgba(0, 0, 0, 0.7)',
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            zIndex: 10000
                        }}>
                            <div style={{
                                background: 'var(--bg-primary)',
                                padding: '2rem',
                                borderRadius: '12px',
                                maxWidth: '500px',
                                width: '90%',
                                boxShadow: '0 4px 20px rgba(0,0,0,0.3)'
                            }}>
                                <h3 style={{marginTop: 0, marginBottom: '1.5rem'}}>Validando Contatos</h3>
                                
                                {/* Barra de Progresso */}
                                <div style={{
                                    width: '100%',
                                    height: '30px',
                                    background: 'var(--bg-secondary)',
                                    borderRadius: '15px',
                                    overflow: 'hidden',
                                    marginBottom: '1rem',
                                    position: 'relative'
                                }}>
                                    <div style={{
                                        width: `${validationProgress.progress_percentage}%`,
                                        height: '100%',
                                        background: validationProgress.status === 'FAILED' 
                                            ? 'var(--danger)' 
                                            : validationProgress.status === 'COMPLETED'
                                            ? 'var(--success)'
                                            : 'linear-gradient(90deg, var(--primary), var(--primary-light))',
                                        transition: 'width 0.3s ease',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        color: 'white',
                                        fontWeight: 'bold',
                                        fontSize: '0.85rem'
                                    }}>
                                        {validationProgress.progress_percentage}%
                                    </div>
                                </div>
                                
                                {/* Informa√ß√µes de Progresso */}
                                <div style={{marginBottom: '1rem'}}>
                                    <p style={{margin: '0.5rem 0', color: 'var(--text-secondary)'}}>
                                        <strong>Status:</strong> {
                                            validationProgress.status === 'PENDING' ? 'Aguardando in√≠cio...' :
                                            validationProgress.status === 'RUNNING' ? 'Validando contatos...' :
                                            validationProgress.status === 'COMPLETED' ? 'Conclu√≠do!' :
                                            'Erro na valida√ß√£o'
                                        }
                                    </p>
                                    <p style={{margin: '0.5rem 0', color: 'var(--text-secondary)'}}>
                                        <strong>Progresso:</strong> {validationProgress.processed_contacts} de {validationProgress.total_contacts} contatos
                                    </p>
                                    {validationProgress.status === 'COMPLETED' && validationProgress.inactive_contacts && (
                                        <p style={{margin: '0.5rem 0', color: 'var(--success)'}}>
                                            <strong>Contatos inativos encontrados:</strong> {validationProgress.inactive_contacts.length}
                                        </p>
                                    )}
                                    {validationProgress.status === 'FAILED' && validationProgress.error_message && (
                                        <p style={{margin: '0.5rem 0', color: 'var(--danger)'}}>
                                            <strong>Erro:</strong> {validationProgress.error_message}
                                        </p>
                                    )}
                                </div>
                                
                                {/* Bot√£o Fechar (apenas quando completar ou falhar) */}
                                {(validationProgress.status === 'COMPLETED' || validationProgress.status === 'FAILED') && (
                                    <button 
                                        className="btn btn-primary" 
                                        onClick={() => {
                                            setShowProgressModal(false);
                                            if (pollingInterval) {
                                                clearInterval(pollingInterval);
                                                setPollingInterval(null);
                                            }
                                        }}
                                        style={{width: '100%'}}
                                    >
                                        Fechar
                                    </button>
                                )}
                            </div>
                        </div>
                    )}
                    
                    {inactiveContacts && (
                        <div style={{marginTop: '2rem'}}>
                            <h3>Contatos Inativos Encontrados: {inactiveContacts.length}</h3>
                            {inactiveContacts.length > 0 ? (
                                <>
                                    <ul style={{listStyle: 'none', maxHeight: '300px', overflowY: 'auto', background: 'var(--bg-primary)', padding: '1rem', borderRadius: '8px', margin: '1rem 0'}}>
                                        {inactiveContacts.map(c => (
                                            <li key={c.chat_id} style={{padding: '0.5rem', borderBottom: '1px solid var(--border-color)'}}>
                                                {c.first_name || ''} {c.last_name || ''} ({c.username ? `@${c.username}`: c.chat_id})
                                            </li>
                                        ))}
                                    </ul>
                                    <button className="btn btn-danger" onClick={handleRemove} disabled={isLoading}>
                                        {isLoading ? 'Removendo...' : `Remover ${inactiveContacts.length} Contato(s)`}
                                    </button>
                                </>
                            ) : (
                                <p style={{color: 'var(--text-secondary)', marginTop: '1rem'}}>√ìtima not√≠cia! Nenhum contato inativo foi encontrado para este bot.</p>
                            )}
                        </div>
                    )}
                </div>
            </div>
        );
    }
    
    function MediaLibraryModal({ onSelect, onClose, allowedTypes = null }) {
        const [media, setMedia] = useState([]);
        const tabsAll = ['image','video','audio'];
        const initialTab = Array.isArray(allowedTypes) && allowedTypes.length > 0 ? allowedTypes[0] : 'image';
        const [activeTab, setActiveTab] = useState(initialTab);
        useEffect(() => { api.get('/api/media').then(res => setMedia(res.data)); }, []);
        const resolveType = (item) => {
            if (item.file_type) return item.file_type;
            const name = (item.file_name || '').toLowerCase();
            if (/(\.png|\.jpg|\.jpeg|\.gif|\.webp)$/.test(name)) return 'image';
            if (/(\.mp4|\.mov|\.webm|\.mkv)$/.test(name)) return 'video';
            if (/(\.mp3|\.wav|\.ogg)$/.test(name)) return 'audio';
            return 'image';
        };
        // Helper para construir URL de preview - usa storage_url se dispon√≠vel
        const getMediaPreviewUrl = (item, useThumbnail = true) => {
            if (useThumbnail && item.thumbnail_storage_url) {
                return item.thumbnail_storage_url;
            }
            if (item.storage_url) {
                return item.storage_url;
            }
            // Fallback para m√©todo antigo
            const fileId = useThumbnail ? (item.thumbnail_file_id || item.file_id) : item.file_id;
            return `${API_BASE_URL}/api/media/preview/storage/${fileId}`;
        };
        const allowed = Array.isArray(allowedTypes) ? allowedTypes : tabsAll;
        const displayed = media.filter(m => allowed.includes(resolveType(m)) && resolveType(m) === activeTab);
        return (
            <div className="login-overlay" style={{zIndex: 2000}}>
                <div className="login-box" style={{width: '80vw', maxWidth: '900px', height: '80vh', display: 'flex', flexDirection: 'column'}}>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1rem'}}>
                        <h2>Selecionar M√≠dia</h2>
                        <button onClick={onClose} style={{background: 'none', border: 'none', color: 'white', fontSize: '1.5rem', cursor: 'pointer'}}>&times;</button>
                    </div>
                    <div style={{display:'flex', gap:'0.5rem', padding:'0 1rem'}}>
                        {allowed.map(t => (
                            <button key={t} className={`btn btn-secondary ${activeTab===t?'active':''}`} onClick={()=>setActiveTab(t)}>
                                {t==='image'?'Imagens':t==='video'?'V√≠deos':'√Åudios'}
                            </button>
                        ))}
                    </div>
                    <div className="grid" style={{overflowY: 'auto', flex: 1, padding: '1rem'}}>
                        {displayed.map(item => (
                            <div key={item.id} className="bot-card" onClick={() => onSelect(item)} style={{cursor: 'pointer'}}>
                                {resolveType(item) === 'image' ? (
                                    <img src={getMediaPreviewUrl(item, true)} className="media-preview" alt={item.file_name} />
                                 ) : resolveType(item) === 'video' ? (
                                    item.thumbnail_file_id || item.thumbnail_storage_url ? (
                                        <img src={getMediaPreviewUrl(item, true)} className="media-preview" alt={item.file_name} />
                                    ) : (
                                        <video src={getMediaPreviewUrl(item, false)} className="media-preview" muted autoPlay loop playsInline preload="metadata" />
                                    )
                                 ) : (
                                    <audio src={getMediaPreviewUrl(item, false)} className="media-preview" controls />
                                 )}
                                <div className="bot-card-header" style={{padding: 0, marginBottom: 0}}><h3 style={{fontSize: '1.1rem'}}>{item.file_name}</h3></div>
                            </div>
                        ))}
                    </div>
                </div>
            </div>
        );
    }
    
    const initialNodes = [{ id: 'start', type: 'trigger', position: { x: 250, y: 50 }, data: {}, deletable: false }];
    

    const getActionIcon = (actionType) => {
        const icons = {
            message: 'üí¨',
            image: 'üñºÔ∏è',
            video: 'üé¨',
            audio: 'üéµ',
            typing_action: '‚úçÔ∏è',
            action_pix: 'üí≥',
            action_check_pix: 'üîç',
            forward_flow: '‚ÜóÔ∏è',
            delay: '‚è±Ô∏è',
            action_create_invite_link: 'üîó',
            action_remove_user_from_group: 'üë§'
        };
        return icons[actionType] || '‚ùì';
    };

    const getActionLabel = (actionType) => {
        const labels = {
            message: 'Mensagem',
            image: 'Imagem',
            video: 'V√≠deo',
            audio: '√Åudio',
            typing_action: 'Digitando',
            action_pix: 'PIX',
            action_check_pix: 'Verificar PIX',
            forward_flow: 'Encaminhar',
            delay: 'Atraso',
            action_create_invite_link: 'Criar Convite',
            action_remove_user_from_group: 'Remover Usu√°rio'
        };
        return labels[actionType] || actionType;
    };

    const DEFAULT_INVITE_MESSAGE = 'Seu link exclusivo est√° pronto! Clique no bot√£o abaixo para acessar.';
    const DEFAULT_INVITE_BUTTON_TEXT = 'Acessar convite';

    const normalizeInviteAction = (action) => {
        if (!action || action.type !== 'action_create_invite_link') {
            return { action, changed: false };
        }

        const originalData = action.data || {};
        const normalizedData = { ...originalData };
        let changed = false;

        const existingMessage = (originalData.messageText ?? originalData.text ?? '').trim();
        const messageText = existingMessage || DEFAULT_INVITE_MESSAGE;

        if (normalizedData.messageText !== messageText) {
            normalizedData.messageText = messageText;
            changed = true;
        }

        if (normalizedData.text !== messageText) {
            normalizedData.text = messageText;
            changed = true;
        }

        const existingButton = (originalData.buttonText || '').trim();
        const buttonText = existingButton || DEFAULT_INVITE_BUTTON_TEXT;

        if (normalizedData.buttonText !== buttonText) {
            normalizedData.buttonText = buttonText;
            changed = true;
        }

        ['linkName', 'sendMessage', 'buttonUrl', 'buttonLink'].forEach((field) => {
            if (field in normalizedData) {
                delete normalizedData[field];
                changed = true;
            }
        });

        return {
            action: changed ? { ...action, data: normalizedData } : action,
            changed
        };
    };

    const createActionWithDefaults = (type, data = {}) => {
        const baseAction = { type, data };
        return normalizeInviteAction(baseAction).action;
    };

    const validateTextForUrls = (text) => {
        if (!text || typeof text !== 'string') return { valid: true, urls: [] };

        // Remove vari√°veis do sistema antes de validar
        const textWithoutVariables = text.replace(/\{\{[^}]+\}\}/g, '');

        // Padr√µes de URL a detectar
        const patterns = [
            /(?:https?|ftp):\/\/[^\s]+/gi,                          // URLs com protocolo
            /www\.[^\s]+/gi,                                        // URLs com www
            /[a-zA-Z0-9-]+\.(?:com|net|org|br|app|io|co|dev|tech|link|site|online|store|shop|xyz|info|biz|me|tv|cc|us|uk|de|fr|es|it|pt|ru|cn|jp|kr|in|au|ca|mx|ar|cl|pe|ve|co\.uk|com\.br|gov|edu|mil)[^\s]*/gi  // Dom√≠nios comuns
        ];

        const foundUrls = [];
        patterns.forEach(pattern => {
            const matches = textWithoutVariables.match(pattern);
            if (matches) {
                foundUrls.push(...matches);
            }
        });

        return {
            valid: foundUrls.length === 0,
            urls: foundUrls
        };
    };

    function EditorPanel({ selectedNode, setNodes, setEdges, setSelectedNode, availableFlows, openMediaLibrary, presselDomains, thankYouPages, hostedCheckouts, isDisparoFlow = false }) {
        const API_BASE_URL = App.state.API_BASE_URL;
        const buildPreviewSrc = (value) => {
            if (!value) return null;
            const v = String(value).trim();
            return v.startsWith('http') ? v : `${API_BASE_URL}/api/media/preview/storage/${v}`;
        };
        const [nodeData, setNodeData] = useState(selectedNode.data || {});
        const textAreaRef = useRef(null);
        const modalContentRef = useRef(null);
        const scrollIntervalRef = useRef(null);
        const autoScrollHandlerRef = useRef(null);
        const [draggedIndex, setDraggedIndex] = useState(null);
        const [dragOverIndex, setDragOverIndex] = useState(null);
        const [urlValidationErrors, setUrlValidationErrors] = useState({});
        
        useEffect(() => { 
            if (!selectedNode) {
                return;
            }

            if (selectedNode.type === 'trigger') {
                setNodeData(selectedNode.data || {});
                return;
            }

            const currentData = selectedNode.data || {};
            const actionsSource = Array.isArray(currentData.actions) ? currentData.actions : [];
            const normalizedResults = actionsSource.map(action => normalizeInviteAction(action));
            const normalizedActions = normalizedResults.map(result => result.action);
            const actionsChanged = normalizedResults.some(result => result.changed) || !Array.isArray(currentData.actions);

            const ensuredData = {
                ...currentData,
                actions: normalizedActions,
                waitForReply: currentData.waitForReply ?? false,
                replyTimeout: currentData.replyTimeout ?? 5
            };

            setNodeData(ensuredData);

            if (
                actionsChanged ||
                currentData.waitForReply === undefined ||
                currentData.replyTimeout === undefined
            ) {
                setNodes(nds => nds.map(n => n.id === selectedNode.id ? { ...n, data: ensuredData } : n));
            }
        }, [selectedNode, setNodes]);
        
        // Nodes agora s√≥ t√™m a√ß√µes (sem a√ß√£o principal)
        const actions = nodeData.actions || [];

        
        // Fun√ß√µes para gerenciar a√ß√µes
        const addAction = (actionType) => {
            const actions = nodeData.actions || [];
            if (actions.length >= 5) {
                alert('Voc√™ pode adicionar no m√°ximo 5 a√ß√µes.');
                return;
            }
            const newAction = createActionWithDefaults(actionType);
            const newData = { ...nodeData, actions: [...actions, newAction] };
            setNodeData(newData);
            setNodes(nds => nds.map(n => n.id === selectedNode.id ? { ...n, data: newData } : n));
        };
        
        const removeAction = (index) => {
            const actions = (nodeData.actions || []).filter((_, i) => i !== index);
            const newData = { ...nodeData, actions };
            setNodeData(newData);
            setNodes(nds => nds.map(n => n.id === selectedNode.id ? { ...n, data: newData } : n));
        };
        
        const updateAction = (index, field, value) => {
            const actions = [...(nodeData.actions || [])];
            if (!actions[index]) return;
            actions[index] = {
                ...actions[index],
                data: { ...actions[index].data, [field]: value }
            };
            const newData = { ...nodeData, actions };
            setNodeData(newData);
            setNodes(nds => nds.map(n => n.id === selectedNode.id ? { ...n, data: newData } : n));
        };
        
        const updateActionMultiple = (index, updates) => {
            const actions = [...(nodeData.actions || [])];
            if (!actions[index]) return;
            actions[index] = {
                ...actions[index],
                data: { ...actions[index].data, ...updates }
            };
            const newData = { ...nodeData, actions };
            setNodeData(newData);
            setNodes(nds => nds.map(n => n.id === selectedNode.id ? { ...n, data: newData } : n));
        };

        const updateNode = (field, value) => {
            const newData = { ...nodeData, [field]: value };
            setNodeData(newData);
            setNodes(nds => nds.map(n => n.id === selectedNode.id ? { ...n, data: newData } : n));
        };
        // Fun√ß√£o de auto-scroll durante drag
        const handleAutoScroll = useCallback((e) => {
            if (!modalContentRef.current || draggedIndex === null) {
                if (scrollIntervalRef.current) {
                    clearInterval(scrollIntervalRef.current);
                    scrollIntervalRef.current = null;
                }
                return;
            }
            
            const container = modalContentRef.current;
            if (!container) return;
            
            const rect = container.getBoundingClientRect();
            const mouseY = e.clientY;
            const scrollThreshold = 80; // Dist√¢ncia das bordas em pixels para ativar scroll
            const scrollSpeed = 15; // Velocidade do scroll
            
            const distanceFromTop = mouseY - rect.top;
            const distanceFromBottom = rect.bottom - mouseY;
            
            // Limpar intervalo anterior se existir
            if (scrollIntervalRef.current) {
                clearInterval(scrollIntervalRef.current);
                scrollIntervalRef.current = null;
            }
            
            // Scroll para cima
            if (distanceFromTop < scrollThreshold && container.scrollTop > 0) {
                scrollIntervalRef.current = setInterval(() => {
                    if (!modalContentRef.current || draggedIndex === null) {
                        if (scrollIntervalRef.current) {
                            clearInterval(scrollIntervalRef.current);
                            scrollIntervalRef.current = null;
                        }
                        return;
                    }
                    const cont = modalContentRef.current;
                    if (cont && cont.scrollTop > 0) {
                        cont.scrollTop -= scrollSpeed;
                    } else {
                        if (scrollIntervalRef.current) {
                            clearInterval(scrollIntervalRef.current);
                            scrollIntervalRef.current = null;
                        }
                    }
                }, 16); // ~60fps
            }
            // Scroll para baixo
            else if (distanceFromBottom < scrollThreshold && 
                     container.scrollTop < container.scrollHeight - container.clientHeight) {
                scrollIntervalRef.current = setInterval(() => {
                    if (!modalContentRef.current || draggedIndex === null) {
                        if (scrollIntervalRef.current) {
                            clearInterval(scrollIntervalRef.current);
                            scrollIntervalRef.current = null;
                        }
                        return;
                    }
                    const cont = modalContentRef.current;
                    if (cont && cont.scrollTop < cont.scrollHeight - cont.clientHeight) {
                        cont.scrollTop += scrollSpeed;
                    } else {
                        if (scrollIntervalRef.current) {
                            clearInterval(scrollIntervalRef.current);
                            scrollIntervalRef.current = null;
                        }
                    }
                }, 16); // ~60fps
            }
        }, [draggedIndex]);
        
        // Atualizar ref quando fun√ß√£o mudar
        useEffect(() => {
            autoScrollHandlerRef.current = handleAutoScroll;
        }, [handleAutoScroll]);
        
        // Fun√ß√µes de drag and drop
        const handleDragStart = (e, index) => {
            setDraggedIndex(index);
            e.dataTransfer.effectAllowed = 'move';
            
            // Adicionar listener para auto-scroll imediatamente
            const handler = (ev) => handleAutoScroll(ev);
            document.addEventListener('dragover', handler, false);
            autoScrollHandlerRef.current = handler;
        };
        
        const handleDragOver = (e, index) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            if (draggedIndex !== null && draggedIndex !== index) {
                setDragOverIndex(index);
            }
            // Auto-scroll durante drag over
            handleAutoScroll(e);
        };
        
        const handleDragLeave = () => {
            setDragOverIndex(null);
        };
        
        const handleDrop = (e, dropIndex) => {
            e.preventDefault();
            if (draggedIndex === null) return;
            if (draggedIndex === dropIndex) {
                setDraggedIndex(null);
                setDragOverIndex(null);
                return;
            }
            
            const actions = [...(nodeData.actions || [])];
            const draggedAction = actions[draggedIndex];
            actions.splice(draggedIndex, 1);
            actions.splice(dropIndex, 0, draggedAction);
            
            const newData = { ...nodeData, actions };
            setNodeData(newData);
            setNodes(nds => nds.map(n => n.id === selectedNode.id ? { ...n, data: newData } : n));
            
            setDraggedIndex(null);
            setDragOverIndex(null);
        };
        
        const handleDragEnd = () => {
            // Limpar auto-scroll
            if (scrollIntervalRef.current) {
                clearInterval(scrollIntervalRef.current);
                scrollIntervalRef.current = null;
            }
            // Remover listener de auto-scroll
            if (autoScrollHandlerRef.current) {
                document.removeEventListener('dragover', autoScrollHandlerRef.current, false);
                autoScrollHandlerRef.current = null;
            }
            
            setDraggedIndex(null);
            setDragOverIndex(null);
        };
        
        // Cleanup ao desmontar
        useEffect(() => {
            return () => {
                if (scrollIntervalRef.current) {
                    clearInterval(scrollIntervalRef.current);
                    scrollIntervalRef.current = null;
                }
                if (autoScrollHandlerRef.current) {
                    document.removeEventListener('dragover', autoScrollHandlerRef.current, false);
                }
            };
        }, []);
        
        const renderActionEditor = (action, index) => {
            const actionData = action.data || {};
            const actionTypeNames = {
                message: 'üí¨ Mensagem',
                image: 'üñºÔ∏è Imagem',
                video: 'üé¨ V√≠deo',
                audio: 'üéµ √Åudio',
                delay: '‚è±Ô∏è Atraso',
                typing_action: '‚úçÔ∏è Digitando',
                action_pix: 'üí≥ PIX',
                action_check_pix: 'üîç Verificar PIX',
                forward_flow: '‚Ü™Ô∏è Encaminhar',
                action_create_invite_link: 'üîó Criar Convite',
                action_remove_user_from_group: 'üë§ Remover Usu√°rio'
            };
            
            const isDragging = draggedIndex === index;
            const isDragOver = dragOverIndex === index;
            
            return (
                <div 
                    key={index}
                    className={`action-item ${isDragging ? 'dragging' : ''} ${isDragOver ? 'drag-over' : ''}`}
                    draggable={true}
                    onDragStart={(e) => handleDragStart(e, index)}
                    onDragOver={(e) => handleDragOver(e, index)}
                    onDragLeave={handleDragLeave}
                    onDrop={(e) => handleDrop(e, index)}
                    onDragEnd={handleDragEnd}
                >
                    <div className="action-drag-handle" title="Arrastar para reordenar">
                        ‚ò∞
                    </div>
                    <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '0.75rem', paddingLeft: '2rem'}}>
                        <strong style={{color: 'var(--text-primary)'}}>
                            {actionTypeNames[action.type] || action.type}
                        </strong>
                        <button 
                            type="button"
                            className="btn btn-red btn-sm" 
                            onClick={() => removeAction(index)}
                            style={{padding: '0.25rem 0.5rem', fontSize: '0.8rem'}}
                        >
                            ‚úï
                        </button>
                    </div>
                    
                    {action.type === 'message' && (
                        <>
                            <div className="form-group">
                                <label style={{fontSize: '0.85rem'}}>Texto</label>
                                <textarea 
                                    id={`message-textarea-${index}`}
                                    className="form-textarea" 
                                    rows="3" 
                                    maxLength="4096" 
                                    value={actionData.text || ''} 
                                    onChange={e => {
                                        const text = e.target.value;
                                        updateAction(index, 'text', text);
                                        
                                        // Validar em tempo real
                                        const validation = validateTextForUrls(text);
                                        setUrlValidationErrors(prev => ({
                                            ...prev,
                                            [`message-${index}`]: validation
                                        }));
                                    }} 
                                    placeholder="Use {{primeiro_nome}}, {{nome_completo}} ou {{cidade}} (m√°x: 4096 caracteres)"
                                />
                                {urlValidationErrors[`message-${index}`] && !urlValidationErrors[`message-${index}`].valid && (
                                    <div style={{
                                        color: '#ef4444',
                                        fontSize: '0.75rem',
                                        marginTop: '0.25rem',
                                        padding: '0.5rem',
                                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                        borderRadius: '0.25rem',
                                        border: '1px solid rgba(239, 68, 68, 0.3)'
                                    }}>
                                        ‚ö†Ô∏è <strong>Links detectados:</strong> {urlValidationErrors[`message-${index}`].urls.join(', ')}
                                        <br />
                                        <span style={{fontSize: '0.7rem'}}>Use o bot√£o oficial para adicionar links.</span>
                                    </div>
                                )}
                            </div>
                            <div className="form-group">
                                <label style={{fontSize: '0.85rem'}}>Texto do Bot√£o</label>
                                <input 
                                    type="text" 
                                    className="form-input" 
                                    value={actionData.buttonText || ''} 
                                    onChange={e => updateAction(index, 'buttonText', e.target.value)} 
                                    placeholder="Texto do Bot√£o"
                                    style={{fontSize: '0.85rem'}}
                                />
                            </div>
                            <div className="form-group">
                                <label style={{fontSize: '0.85rem'}}>URL do Bot√£o</label>
                                <select
                                    className="form-input"
                                    value={actionData.buttonUrl || ''}
                                    onChange={e => updateAction(index, 'buttonUrl', e.target.value)}
                                    style={{fontSize: '0.85rem'}}
                                >
                                    <option value="">Selecione uma op√ß√£o...</option>
                                    
                                    {presselDomains && presselDomains.length > 0 && (
                                        <optgroup label="üîó Pressels">
                                            {presselDomains.map((domain, i) => (
                                                <option key={`pressel-${i}`} value={domain.value}>
                                                    {domain.label}
                                                </option>
                                            ))}
                                        </optgroup>
                                    )}
                                    
                                    {thankYouPages && thankYouPages.length > 0 && (
                                        <optgroup label="‚úÖ P√°ginas de Obrigado">
                                            {thankYouPages.map(ty => (
                                                <option key={ty.id} value={`${window.location.origin}/obrigado/${ty.id}`}>
                                                    {ty.name || ty.id}
                                                </option>
                                            ))}
                                        </optgroup>
                                    )}
                                    
                                    {hostedCheckouts && hostedCheckouts.length > 0 && (
                                        <optgroup label="üí≥ Checkouts">
                                            {hostedCheckouts.map(checkout => (
                                                <option key={checkout.id} value={`${window.location.origin}/oferta/${checkout.id}`}>
                                                    {checkout.name || checkout.id}
                                                </option>
                                            ))}
                                        </optgroup>
                                    )}
                                </select>
                            </div>
                            
                            <div style={{marginTop: '0.5rem', marginBottom: '0.5rem'}}>
                                <label style={{fontSize: '0.75rem', color: 'var(--text-secondary)', marginBottom: '0.25rem', display: 'block'}}>
                                    Adicionar Vari√°vel:
                                </label>
                                <div style={{display: 'flex', gap: '0.5rem', flexWrap: 'wrap'}}>
                                    <button 
                                        type="button"
                                        className="btn btn-secondary btn-sm"
                                        onClick={() => {
                                            const textarea = document.getElementById(`message-textarea-${index}`);
                                            if (textarea) {
                                                const cursorPos = textarea.selectionStart;
                                                const textBefore = actionData.text?.substring(0, cursorPos) || '';
                                                const textAfter = actionData.text?.substring(cursorPos) || '';
                                                updateAction(index, 'text', textBefore + '{{primeiro_nome}}' + textAfter);
                                                setTimeout(() => {
                                                    textarea.focus();
                                                    textarea.setSelectionRange(cursorPos + 17, cursorPos + 17);
                                                }, 0);
                                            }
                                        }}
                                        style={{fontSize: '0.75rem', padding: '0.25rem 0.5rem'}}
                                    >
                                        + Primeiro Nome
                                    </button>
                                    <button 
                                        type="button"
                                        className="btn btn-secondary btn-sm"
                                        onClick={() => {
                                            const textarea = document.getElementById(`message-textarea-${index}`);
                                            if (textarea) {
                                                const cursorPos = textarea.selectionStart;
                                                const textBefore = actionData.text?.substring(0, cursorPos) || '';
                                                const textAfter = actionData.text?.substring(cursorPos) || '';
                                                updateAction(index, 'text', textBefore + '{{nome_completo}}' + textAfter);
                                                setTimeout(() => {
                                                    textarea.focus();
                                                    textarea.setSelectionRange(cursorPos + 17, cursorPos + 17);
                                                }, 0);
                                            }
                                        }}
                                        style={{fontSize: '0.75rem', padding: '0.25rem 0.5rem'}}
                                    >
                                        + Nome Completo
                                    </button>
                                    <button 
                                        type="button"
                                        className="btn btn-secondary btn-sm"
                                        onClick={() => {
                                            const textarea = document.getElementById(`message-textarea-${index}`);
                                            if (textarea) {
                                                const cursorPos = textarea.selectionStart;
                                                const textBefore = actionData.text?.substring(0, cursorPos) || '';
                                                const textAfter = actionData.text?.substring(cursorPos) || '';
                                                updateAction(index, 'text', textBefore + '{{cidade}}' + textAfter);
                                                setTimeout(() => {
                                                    textarea.focus();
                                                    textarea.setSelectionRange(cursorPos + 10, cursorPos + 10);
                                                }, 0);
                                            }
                                        }}
                                        style={{fontSize: '0.75rem', padding: '0.25rem 0.5rem'}}
                                    >
                                        + Cidade
                                    </button>
                                </div>
                            </div>
                            
                        </>
                    )}
                    
                    {(action.type === 'image' || action.type === 'video') && (
                        <>
                            <div className="form-group">
                                <label style={{fontSize: '0.85rem'}}>File ID ou URL</label>
                                <input 
                                    type="text" 
                                    className="form-input" 
                                    value={actionData[action.type === 'image' ? 'imageUrl' : 'videoUrl'] || ''} 
                                    onChange={e => updateAction(index, action.type === 'image' ? 'imageUrl' : 'videoUrl', e.target.value)}
                                    style={{fontSize: '0.85rem'}}
                                />
                            </div>
                            {(() => {
                                const src = buildPreviewSrc(actionData[action.type === 'image' ? 'imageUrl' : 'videoUrl']);
                                if (!src) return null;
                                return (
                                    <div className="form-group">
                                        <label style={{fontSize: '0.85rem'}}>Preview</label>
                                        {action.type === 'image' ? (
                                            <img src={src} alt="preview" style={{ width: '100%', height: 150, objectFit: 'cover', borderRadius: 8, border: '1px solid rgba(255,255,255,0.1)' }} />
                                        ) : (
                                            <video src={src} controls style={{ width: '100%', height: 150, objectFit: 'cover', borderRadius: 8, border: '1px solid rgba(255,255,255,0.1)' }} />
                                        )}
                                    </div>
                                );
                            })()}
                            <button 
                                type="button"
                                className="btn btn-secondary btn-sm" 
                                onClick={() => openMediaLibrary(media => {
                                    updateAction(index, action.type === 'image' ? 'imageUrl' : 'videoUrl', media.file_id);
                                }, [action.type])}
                                style={{fontSize: '0.8rem', marginBottom: '0.5rem'}}
                            >
                                Selecionar da Biblioteca
                            </button>
                            <div className="form-group">
                                <label style={{fontSize: '0.85rem'}}>Legenda</label>
                                <textarea 
                                    className="form-textarea" 
                                    rows="2" 
                                    maxLength="1024" 
                                    value={actionData.caption || ''} 
                                    onChange={e => {
                                        const caption = e.target.value;
                                        updateAction(index, 'caption', caption);
                                        
                                        // Validar em tempo real
                                        const validation = validateTextForUrls(caption);
                                        setUrlValidationErrors(prev => ({
                                            ...prev,
                                            [`caption-${index}`]: validation
                                        }));
                                    }}
                                    style={{fontSize: '0.85rem'}}
                                    placeholder="Legenda (m√°x: 1024 caracteres)"
                                />
                                {urlValidationErrors[`caption-${index}`] && !urlValidationErrors[`caption-${index}`].valid && (
                                    <div style={{
                                        color: '#ef4444',
                                        fontSize: '0.75rem',
                                        marginTop: '0.25rem',
                                        padding: '0.5rem',
                                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                        borderRadius: '0.25rem',
                                        border: '1px solid rgba(239, 68, 68, 0.3)'
                                    }}>
                                        ‚ö†Ô∏è <strong>Links detectados:</strong> {urlValidationErrors[`caption-${index}`].urls.join(', ')}
                                        <br />
                                        <span style={{fontSize: '0.7rem'}}>Use o bot√£o oficial para adicionar links.</span>
                                    </div>
                                )}
                            </div>
                        </>
                    )}
                    
                    {action.type === 'audio' && (
                        <>
                            <div className="form-group">
                                <label style={{fontSize: '0.85rem'}}>File ID ou URL</label>
                                <input 
                                    type="text" 
                                    className="form-input" 
                                    value={actionData.audioUrl || ''} 
                                    onChange={e => updateAction(index, 'audioUrl', e.target.value)}
                                    style={{fontSize: '0.85rem'}}
                                />
                            </div>
                            {(() => {
                                const src = buildPreviewSrc(actionData.audioUrl);
                                if (!src) return null;
                                return (
                                    <div className="form-group">
                                        <label style={{fontSize: '0.85rem'}}>Preview</label>
                                        <audio src={src} controls style={{ width: '100%' }} />
                                    </div>
                                );
                            })()}
                            <button 
                                type="button"
                                className="btn btn-secondary btn-sm" 
                                onClick={() => openMediaLibrary(media => updateAction(index, 'audioUrl', media.file_id), ['audio'])}
                                style={{fontSize: '0.8rem', marginBottom: '0.5rem'}}
                            >
                                Selecionar da Biblioteca
                            </button>
                            <div className="form-group">
                                <label style={{fontSize: '0.85rem'}}>Dura√ß√£o (segundos)</label>
                                <input 
                                    type="number" 
                                    className="form-input" 
                                    value={actionData.durationInSeconds || 0} 
                                    onChange={e => updateAction(index, 'durationInSeconds', parseInt(e.target.value, 10))}
                                    style={{fontSize: '0.85rem'}}
                                />
                            </div>
                        </>
                    )}
                    
                    {action.type === 'delay' && (
                        <div className="form-group">
                            <label style={{fontSize: '0.85rem'}}>Aguardar por (segundos)</label>
                            <input 
                                type="number" 
                                className="form-input" 
                                value={actionData.delayInSeconds || 1} 
                                onChange={e => updateAction(index, 'delayInSeconds', parseInt(e.target.value, 10))}
                                style={{fontSize: '0.85rem'}}
                            />
                        </div>
                    )}
                    
                    {action.type === 'typing_action' && (
                        <div className="form-group">
                            <label style={{fontSize: '0.85rem'}}>Dura√ß√£o (segundos)</label>
                            <input 
                                type="number" 
                                className="form-input" 
                                value={actionData.durationInSeconds || 1} 
                                onChange={e => updateAction(index, 'durationInSeconds', parseInt(e.target.value, 10))}
                                style={{fontSize: '0.85rem'}}
                            />
                        </div>
                    )}
                    {action.type === 'action_pix' && (
                        <>
                            <div className="form-group">
                                <label style={{fontSize: '0.85rem'}}>Valor (centavos)</label>
                                <input 
                                    type="number" 
                                    className="form-input" 
                                    value={actionData.valueInCents || 0} 
                                    onChange={e => updateAction(index, 'valueInCents', parseInt(e.target.value, 10))}
                                    style={{fontSize: '0.85rem'}}
                                />
                            </div>
                            <div className="form-group">
                                <label style={{fontSize: '0.85rem'}}>Texto da Mensagem do PIX</label>
                                <textarea 
                                    className="form-textarea" 
                                    rows="2" 
                                    maxLength="1024" 
                                    value={actionData.pixMessageText || ''} 
                                    onChange={e => updateAction(index, 'pixMessageText', e.target.value)}
                                    style={{fontSize: '0.85rem'}}
                                    placeholder="Texto da mensagem (m√°x: 1024 caracteres)"
                                />
                            </div>
                        </>
                    )}
                    
                    {action.type === 'forward_flow' && (
                        <div className="form-group">
                            <label style={{fontSize: '0.85rem'}}>Encaminhar para o fluxo</label>
                            <select 
                                className="form-select" 
                                value={(nodeData.actions && nodeData.actions[index] && nodeData.actions[index].data && nodeData.actions[index].data.targetFlowId != null) ? String(nodeData.actions[index].data.targetFlowId) : ''} 
                                onChange={e => {
                                    const selectedValue = e.target.value;
                                    const selectedFlow = availableFlows.find(f => String(f.id) === String(selectedValue));
                                    
                                    // Garante que targetFlowId seja sempre um n√∫mero
                                    const targetFlowId = selectedValue && selectedValue !== '' ? Number(selectedValue) : null;
                                    const targetFlowName = selectedFlow ? selectedFlow.name : '';
                                    
                                    // Salva ambos os valores de uma vez para evitar problemas de timing
                                    updateActionMultiple(index, {
                                        targetFlowId: targetFlowId,
                                        targetFlowName: targetFlowName
                                    });
                                }}
                                style={{fontSize: '0.85rem'}}
                            >
                                <option value="">Selecione um fluxo...</option>
                                {availableFlows.map(f => (
                                    <option key={f.id} value={String(f.id)}>{f.name}</option>
                                ))}
                            </select>
                        </div>
                    )}
                    
                    {action.type === 'action_check_pix' && (
                        <div className="form-group">
                            <label style={{fontSize: '0.85rem'}}>Texto de Entrega (P√≥s-Pagamento)</label>
                            <textarea 
                                className="form-textarea" 
                                rows="2" 
                                maxLength="4096" 
                                value={actionData.deliveryText || ''} 
                                onChange={e => updateAction(index, 'deliveryText', e.target.value)}
                                style={{fontSize: '0.85rem'}}
                                placeholder="Texto de entrega (m√°x: 4096 caracteres)"
                            />
                        </div>
                    )}
                    
                    {action.type === 'action_create_invite_link' && (
                        <>
                            <div className="form-group">
                                <label style={{fontSize: '0.85rem'}}>Mensagem</label>
                                <textarea
                                    id={`invite-message-textarea-${index}`}
                                    className="form-textarea"
                                    rows="3"
                                    maxLength="4096"
                                    value={(actionData.messageText ?? actionData.text ?? '')}
                                    onChange={e => {
                                        const text = e.target.value;
                                        updateActionMultiple(index, { messageText: text, text });
                                        const validation = validateTextForUrls(text);
                                        setUrlValidationErrors(prev => ({
                                            ...prev,
                                            [`invite-${index}`]: validation
                                        }));
                                    }}
                                    style={{fontSize: '0.85rem'}}
                                    placeholder="Escreva a mensagem. Use {{invite_link}} para inserir o link gerado."
                                />
                                {urlValidationErrors[`invite-${index}`] && !urlValidationErrors[`invite-${index}`].valid && (
                                    <div style={{
                                        color: '#ef4444',
                                        fontSize: '0.75rem',
                                        marginTop: '0.25rem',
                                        padding: '0.5rem',
                                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                                        borderRadius: '0.25rem',
                                        border: '1px solid rgba(239, 68, 68, 0.3)'
                                    }}>
                                        ‚ö†Ô∏è <strong>Links detectados:</strong> {urlValidationErrors[`invite-${index}`].urls.join(', ')}
                                        <br />
                                        <span style={{fontSize: '0.7rem'}}>Use {'{{invite_link}}'} para incluir o link automaticamente.</span>
                                    </div>
                                )}
                            </div>
                            <div className="form-group">
                                <label style={{fontSize: '0.85rem'}}>Texto do Bot√£o</label>
                                <input
                                    type="text"
                                    className="form-input"
                                    value={actionData.buttonText || ''}
                                    onChange={e => updateAction(index, 'buttonText', e.target.value)}
                                    style={{fontSize: '0.85rem'}}
                                    placeholder="Texto exibido no bot√£o (obrigat√≥rio)"
                                />
                            </div>
                            <p style={{fontSize: '0.8rem', color: 'var(--text-secondary)'}}>
                                O link do bot√£o √© gerado automaticamente e v√°lido para um √∫nico acesso.
                            </p>
                        </>
                    )}
                    
                    {action.type === 'action_remove_user_from_group' && (
                        <p style={{fontSize: '0.85rem', color: 'var(--text-secondary)', marginTop: '0.75rem'}}>
                            Esta a√ß√£o remove e bane automaticamente o usu√°rio atual do grupo, revogando o √∫ltimo convite ativo.
                            Se um novo link descart√°vel for criado no fluxo, o usu√°rio ser√° desbanido antes do envio.
                        </p>
                    )}
                </div>
            );
        };
        
        const onDelete = () => {
            setNodes(nds => nds.filter(n => n.id !== selectedNode.id));
            setEdges(eds => eds.filter(e => e.source !== selectedNode.id && e.target !== selectedNode.id));
            setSelectedNode(null);
        };



        const availableActionTypes = ['message', 'image', 'video', 'audio','typing_action'];
        const actionTypeLabels = {
            message: 'üí¨ Mensagem',
            image: 'üñºÔ∏è Imagem',
            video: 'üé¨ V√≠deo',
            audio: 'üéµ √Åudio',
            typing_action: '‚úçÔ∏è Digitando',
            forward_flow: '‚Ü™Ô∏è Encaminhar'
        };

        if (!selectedNode) return null;
        
        return (
            <div className="node-editor-modal-overlay" onClick={(e) => {
                if (e.target === e.currentTarget) {
                    setSelectedNode(null);
                }
            }}>
                <div className="node-editor-modal" onClick={(e) => e.stopPropagation()}>
                    <div className="node-editor-modal-header">
                        <h3>Editar N√≥</h3>
                        <button 
                            className="node-editor-modal-close"
                            onClick={() => setSelectedNode(null)}
                            title="Fechar"
                        >
                            ‚úï
                        </button>
                    </div>
                    <div 
                        className="node-editor-modal-content" 
                        ref={modalContentRef}
                        onDragOver={(e) => {
                            e.preventDefault();
                            if (draggedIndex !== null) {
                                handleAutoScroll(e);
                            }
                        }}
                    >
                        {/* Lista de a√ß√µes */}
                        {actions.length > 0 && (
                            <div style={{marginBottom: '1.5rem'}}>
                                {actions.map((action, index) => renderActionEditor(action, index))}
                            </div>
                        )}
                        
                        {/* Bot√µes para adicionar a√ß√µes */}
                        {actions.length < 5 && !actions.some(a => ['action_check_pix', 'forward_flow'].includes(a.type)) && (
                            <div style={{marginTop: actions.length > 0 ? '1rem' : '0'}}>
                                <label style={{display: 'block', fontWeight: '600', color: 'var(--text-primary)', fontSize: '0.9rem', marginBottom: '0.5rem'}}>
                                    Adicionar A√ß√£o ({actions.length}/5)
                                </label>
                                <div style={{display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '0.5rem', marginBottom: '0.5rem'}}>
                                    {availableActionTypes.map(actionType => (
                                        <button
                                            key={actionType}
                                            type="button"
                                            className="btn btn-secondary btn-sm"
                                            onClick={() => addAction(actionType)}
                                            style={{fontSize: '0.8rem', padding: '0.5rem'}}
                                        >
                                            + {actionTypeLabels[actionType]}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                        
                        {actions.length >= 5 && (
                            <p style={{fontSize: '0.85rem', color: 'var(--warning)', fontStyle: 'italic', marginTop: actions.length > 0 ? '1rem' : '0'}}>
                                Limite de 5 a√ß√µes atingido. Remova uma a√ß√£o para adicionar outra.
                            </p>
                        )}
                    </div>
                    <div className="node-editor-modal-footer">
                        <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                            {!isDisparoFlow && !actions.some(a => ['action_check_pix', 'forward_flow'].includes(a.type)) && (
                                <label style={{fontSize: '0.85rem', display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                                    <input 
                                        type="checkbox"
                                        checked={!!nodeData.waitForReply}
                                        onChange={e => updateNode('waitForReply', e.target.checked)}
                                    />
                                    Aguardar Resposta
                                </label>
                            )}
                            {!isDisparoFlow && nodeData.waitForReply && (
                                <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                                    <label style={{fontSize: '0.85rem'}}>Tempo (min)</label>
                                    <input 
                                        type="number"
                                        className="form-input"
                                        value={nodeData.replyTimeout || 5}
                                        onChange={e => updateNode('replyTimeout', parseInt(e.target.value, 10))}
                                        style={{width: '80px', fontSize: '0.85rem'}}
                                    />
                                </div>
                            )}
                        </div>
                        <div style={{display: 'flex', gap: '0.75rem'}}>
                            <button className="btn btn-danger" onClick={onDelete}>Excluir N√≥</button>
                            <button className="btn btn-secondary" onClick={() => setSelectedNode(null)}>Fechar</button>
                        </div>
                    </div>
                </div>
            </div>
        );
    }
    
function FlowEditorPage({
        flow,
        onRequestClose,
        pressels,
        thankYouPages,
        hostedCheckouts,
        onDirtyChange,
        registerSaveHandler,
        discardChangesToken = 0,
        isDisparoFlow = false
    }) {
        const reactFlowWrapper = useRef(null);
        const [nodes, setNodesState, rawOnNodesChange] = useNodesState(initialNodes);
        const [edges, setEdgesState, rawOnEdgesChange] = useEdgesState([]);
        const [selectedNode, setSelectedNode] = useState(null);
        const [reactFlowInstance, setReactFlowInstance] = useState(null);
        const [presselDomains, setPresselDomains] = useState([]);
        const [hasUnsavedChanges, setHasUnsavedChanges] = useState(false);
        const updateDirtyState = useCallback((value) => {
            setHasUnsavedChanges(prev => {
                if (prev !== value && typeof onDirtyChange === 'function') {
                    onDirtyChange(value);
                }
                return value;
            });
        }, [onDirtyChange]);
        
        // Handle node copy
        useEffect(() => {
            const handleNodeCopy = (e) => {
                const { nodeId } = e.detail;
                setNodes((nds) => {
                    const nodeToCopy = nds.find(n => n.id === nodeId);
                    if (!nodeToCopy) return nds;
                    
                    const newNode = {
                        ...nodeToCopy,
                        id: `node-${Date.now()}`,
                        position: {
                            x: nodeToCopy.position.x + 30,
                            y: nodeToCopy.position.y + 30
                        },
                        selected: false,
                        data: { 
                            ...nodeToCopy.data,
                            actions: nodeToCopy.data.actions ? [...nodeToCopy.data.actions] : []
                        }
                    };
                    
                    return [...nds, newNode];
                });
            };

            // Handle node delete
            const handleNodeDelete = (e) => {
                const { nodeId } = e.detail;
                if (!isDisparoFlow && nodeId === 'start') {
                    alert('N√£o √© poss√≠vel excluir o n√≥ de in√≠cio do fluxo.');
                    return;
                }
                
                setNodes((nds) => nds.filter(node => node.id !== nodeId));
                setEdges((eds) => {
                    // Remove edges connected to the deleted node
                    const edgesToRemove = new Set(
                        eds
                            .filter(edge => edge.source === nodeId || edge.target === nodeId)
                            .map(edge => edge.id)
                    );
                    return eds.filter(edge => !edgesToRemove.has(edge.id));
                });
                
                if (selectedNode?.id === nodeId) {
                    setSelectedNode(null);
                }
            };

            window.addEventListener('node-copy', handleNodeCopy);
            window.addEventListener('node-delete', handleNodeDelete);

            return () => {
                window.removeEventListener('node-copy', handleNodeCopy);
                window.removeEventListener('node-delete', handleNodeDelete);
            };
        }, [setNodes, setEdges, selectedNode]);
        const [availableFlows, setAvailableFlows] = useState([]);
        const [isMediaModalOpen, setIsMediaModalOpen] = useState(false);
        const [mediaSelectionCallback, setMediaSelectionCallback] = useState(null);
        const [mediaAllowedTypes, setMediaAllowedTypes] = useState(null);
        const [isInitialized, setIsInitialized] = useState(false);
        const [isNodeSelectorOpen, setIsNodeSelectorOpen] = useState(false);
        const [isGroupMenuOpen, setIsGroupMenuOpen] = useState(false);
        const [selectedEdge, setSelectedEdge] = useState(null);
        const [isFading, setIsFading] = useState(false);
        const [nodeStats, setNodeStats] = useState({}); // Contagens de execu√ß√£o dos nodes

        // Fun√ß√£o para formatar n√∫meros grandes (ex: 1200 -> "1.2k")
        const formatCount = useCallback((count) => {
            if (!count || count === 0) return '0';
            if (count < 1000) return count.toString();
            if (count < 1000000) return (count / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
            return (count / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
        }, []);

        // CustomNode definido dentro do FlowEditor para ter acesso ao nodeStats
        const CustomNode = useCallback(({ id, type, data, isConnectable, selected }) => {
            const API_BASE_URL = App.state.API_BASE_URL;
            const buildPreviewSrc = (value) => {
                if (!value) return null;
                const v = String(value).trim();
                return v.startsWith('http') ? v : `${API_BASE_URL}/api/media/preview/storage/${v}`;
            };
            
            // Obt√©m a contagem de execu√ß√µes deste node
            const executionCount = nodeStats[id] || 0;
            
            // Trigger node mant√©m comportamento antigo
            if (type === 'trigger') {
                return (
                    <>
                        <div className={`node-header react-flow__node-trigger`}>
                            <div style={{display: 'flex', alignItems: 'center', gap: '0.5rem'}}>
                                {isDisparoFlow ? 'üì§ Disparo Manual' : 'üöÄ Gatilho Inicial'}
                            </div>
                        </div>
                        <div className="node-content">
                            {isDisparoFlow ? 'Disparo acionado manualmente quando executado.' : 'In√≠cio do fluxo com click_id.'}
                        </div>
                        <Handle type="source" position={Position.Bottom} id="a" isConnectable={isConnectable} />
                    </>
                );
            }
            
            // Nodes normais: mostrar apenas as a√ß√µes
            const actions = data.actions || [];
            const getActionInfo = (actionType, actionData) => {
                const actionInfoMap = {
                    message: { icon: 'üí¨', name: 'Mensagem', content: actionData.text ? `"${actionData.text.substring(0, 30)}..."` : 'Configure.' },
                    image: { icon: 'üñºÔ∏è', name: 'Imagem', content: actionData.imageUrl ? 'Configurado.' : 'Configure.' },
                    video: { icon: 'üé¨', name: 'V√≠deo', content: actionData.videoUrl ? 'Configurado.' : 'Configure.' },
                    audio: { icon: 'üéµ', name: '√Åudio', content: actionData.audioUrl ? 'Configurado.' : 'Configure.' },
                    delay: { icon: '‚è±Ô∏è', name: 'Atraso', content: `Aguardar ${actionData.delayInSeconds || 1}s.` },
                    typing_action: { icon: '‚úçÔ∏è', name: 'Digitando', content: `${actionData.durationInSeconds || 1}s.` },
                    action_pix: { icon: 'üí≥', name: 'PIX', content: `R$ ${((actionData.valueInCents || 0) / 100).toFixed(2)}.` },
                    action_check_pix: { icon: 'üîç', name: 'Verificar PIX', content: 'Verificar pagamento.' },
                    forward_flow: { icon: '‚Ü™Ô∏è', name: 'Encaminhar', content: actionData.targetFlowName || 'Configure.' },
                    action_create_invite_link: { 
                        icon: 'üîó', 
                        name: 'Criar Convite', 
                        content: (() => {
                            const messagePreview = (actionData.messageText || actionData.text || '').trim();
                            const buttonPreview = (actionData.buttonText || '').trim();
                            const messageLabel = messagePreview ? `"${messagePreview.substring(0, 30)}${messagePreview.length > 30 ? '‚Ä¶' : ''}"` : 'Mensagem n√£o definida.';
                            const buttonLabel = buttonPreview ? `Bot√£o: ${buttonPreview}` : 'Bot√£o sem texto.';
                            return `${messageLabel} ‚Ä¢ ${buttonLabel}`;
                        })()
                    },
                    action_remove_user_from_group: { icon: 'üë§', name: 'Remover Usu√°rio', content: 'Remove e bane o usu√°rio do grupo.' },
                };
                return actionInfoMap[actionType] || { icon: '‚ùì', name: actionType, content: 'Configure.' };
            };
            
            const hasConditionalExits = data.waitForReply || actions.some(a => a.type === 'action_check_pix');
            
            return (
                <>
                <Handle type="target" position={Position.Top} isConnectable={isConnectable}  />
                    <div className={`node-header ${actions.length > 0 ? `react-flow__node-${actions[0].type}` : ''}`} style={{ position: 'relative' }}>
                        {/* Badge de contagem de execu√ß√µes - apenas para fluxos normais */}
                        {!isDisparoFlow && (
                            <div className="node-execution-badge" title={`Este node foi executado ${executionCount} vez${executionCount !== 1 ? 'es' : ''}`}>
                                {formatCount(executionCount)}
                            </div>
                        )}
                        <div className="action-badge">
                            {actions.length > 0 ? (
                                <>
                                    {getActionIcon(actions[0].type)}
                                    {getActionLabel(actions[0].type)}
                                    {actions.length > 1 && ` +${actions.length - 1}`}
                                </>
                            ) : 'N√≥ vazio'}
                        </div>
                        <div className="node-actions" style={{display: 'flex', gap: '4px'}}>
                            <button 
                                onClick={(e) => {
                                    e.stopPropagation();
                                    const event = new CustomEvent('node-copy', { detail: { nodeId: id } });
                                    window.dispatchEvent(event);
                                }}
                                className="node-action-btn"
                                title="Copiar n√≥"
                            >
                                üìã
                            </button>
                            <button 
                                onClick={(e) => {
                                    e.stopPropagation();
                                    const event = new CustomEvent('node-delete', { detail: { nodeId: id } });
                                    window.dispatchEvent(event);
                                }}
                                className="node-action-btn delete"
                                title="Excluir n√≥"
                            >
                                ‚ùå
                            </button>
                        </div>
                    </div>
                    <div className="node-content" style={{ position: 'relative' }}>
                        {actions.length === 0 ? (
                            <div style={{color: 'var(--text-secondary)', fontSize: '0.85rem'}}>Adicione a√ß√µes neste n√≥</div>
                        ) : (
                            actions.map((action, idx) => {
                                const actInfo = getActionInfo(action.type, action.data || {});
                                const actSrc = action.type === 'image' ? buildPreviewSrc((action.data||{}).imageUrl) : action.type === 'video' ? buildPreviewSrc((action.data||{}).videoUrl) : null;
                                return (
                                    <div key={idx} style={{fontSize: '0.75rem', display: 'flex', alignItems: 'center', gap: '0.3rem', marginTop: idx > 0 ? '0.3rem' : 0, opacity: 0.9}}>
                                        <span>{actInfo.icon}</span>
                                        <span style={{fontWeight: '600'}}>{actInfo.name}:</span>
                                        <span>{actInfo.content}</span>
                                        {actSrc && (
                                            <span style={{ marginLeft: 'auto' }}>
                                                {action.type === 'image' ? (
                                                    <img src={actSrc} alt="preview" style={{ width: 40, height: 28, objectFit: 'cover', borderRadius: 4, border: '1px solid rgba(255,255,255,0.1)' }} />
                                                ) : (
                                                    <video src={actSrc} style={{ width: 40, height: 28, objectFit: 'cover', borderRadius: 4, border: '1px solid rgba(255,255,255,0.1)' }} muted autoPlay loop playsInline preload="metadata" />
                                                )}
                                            </span>
                                        )}
                                    </div>
                                );
                            })
                        )}
                    </div>
                    
                    {(() => {
                        // Verificar se h√° a√ß√µes que precisam de handles condicionais
                        const hasWaitForReply = data.waitForReply;
                        const hasCheckPix = actions.some(a => a.type === 'action_check_pix');
                        
                        if (hasWaitForReply) {
                            return (
                                <>
                                    <div className="handle-label" style={{ left: '25%', transform: 'translateX(-50%)' }}>Com Resp.</div>
                                    <Handle type="source" position={Position.Bottom} id="a" style={{ left: '25%' }} isConnectable={isConnectable} />
                                    <div className="handle-label" style={{ left: '75%', transform: 'translateX(-50%)' }}>Sem Resp.</div>
                                    <Handle type="source" position={Position.Bottom} id="b" style={{ left: '75%' }} isConnectable={isConnectable} />
                                </>
                            );
                        }
                        if (hasCheckPix) {
                            return (
                                <>
                                    <div className="handle-label" style={{ left: '25%', transform: 'translateX(-50%)' }}>Pago</div>
                                    <Handle type="source" position={Position.Bottom} id="a" style={{ left: '25%' }} isConnectable={isConnectable} />
                                    <div className="handle-label" style={{ left: '75%', transform: 'translateX(-50%)' }}>Pendente</div>
                                    <Handle type="source" position={Position.Bottom} id="b" style={{ left: '75%' }} isConnectable={isConnectable} />
                                </>
                            );
                        }
                        // Handle padr√£o para nodes normais
                        return <Handle type="source" position={Position.Bottom} id="a" isConnectable={isConnectable} />;
                    })()}
                </>
            );
        }, [nodeStats, formatCount, isDisparoFlow]);

        const nodeTypes = useMemo(() => ({ trigger: CustomNode, action: CustomNode }), [CustomNode]);

        const setNodes = useCallback((updater, options = {}) => {
            setNodesState(updater);
            if (!options.skipDirty) {
                updateDirtyState(true);
            }
        }, [setNodesState, updateDirtyState]);

        const setEdges = useCallback((updater, options = {}) => {
            setEdgesState(updater);
            if (!options.skipDirty) {
                updateDirtyState(true);
            }
        }, [setEdgesState, updateDirtyState]);

        const handleNodesChange = useCallback((changes) => {
            if (changes && changes.length > 0) {
                updateDirtyState(true);
            }
            rawOnNodesChange(changes);
        }, [rawOnNodesChange, updateDirtyState]);

        const handleEdgesChange = useCallback((changes) => {
            if (changes && changes.length > 0) {
                updateDirtyState(true);
            }
            rawOnEdgesChange(changes);
        }, [rawOnEdgesChange, updateDirtyState]);

        useEffect(() => {
            const beforeUnloadHandler = (event) => {
                if (!hasUnsavedChanges) return;
                event.preventDefault();
                event.returnValue = '';
                return '';
            };

            if (hasUnsavedChanges) {
                window.addEventListener('beforeunload', beforeUnloadHandler);
            }

            return () => {
                window.removeEventListener('beforeunload', beforeUnloadHandler);
            };
        }, [hasUnsavedChanges]);

        useEffect(() => {
            if (discardChangesToken > 0) {
                updateDirtyState(false);
            }
        }, [discardChangesToken, updateDirtyState]);

        useEffect(() => {
            if (!selectedEdge) {
                setIsFading(false);
                return;
            }
            
            const handleClick = (e) => {
                if (!e.target.closest('.node-action-btn')) {
                    setIsFading(true);
                    setTimeout(() => setSelectedEdge(null), 300);
                }
            };
            
            const timeout = setTimeout(() => {
                setIsFading(true);
                setTimeout(() => setSelectedEdge(null), 300);
            }, 1000);
            
            document.addEventListener('mousedown', handleClick);
            
            return () => {
                document.removeEventListener('mousedown', handleClick);
                clearTimeout(timeout);
            };
        }, [selectedEdge]);


        // Function to center the view on all nodes
        const centerViewOnNodes = useCallback(() => {
            if (reactFlowInstance && nodes.length > 0) {
                // Calculate the bounding box of all nodes
                const nodePositions = nodes.map(node => ({
                    x: node.position.x,
                    y: node.position.y,
                    width: 200, // Default node width
                    height: 50   // Default node height
                }));
                
                // Find the boundaries
                const minX = Math.min(...nodePositions.map(n => n.x));
                const maxX = Math.max(...nodePositions.map(n => n.x + (n.width || 200)));
                const minY = Math.min(...nodePositions.map(n => n.y));
                const maxY = Math.max(...nodePositions.map(n => n.y + (n.height || 50)));
                
                // Calculate center and zoom
                const centerX = (minX + maxX) / 2;
                const centerY = (minY + maxY) / 2;
                const width = maxX - minX;
                const height = maxY - minY;
                
                // Get the viewport dimensions
                const viewport = reactFlowWrapper.current.getBoundingClientRect();
                const viewportRatio = viewport.width / viewport.height;
                const nodesRatio = width / height;
                
                // Calculate zoom level to fit all nodes
                let zoom = 1;
                if (nodesRatio > viewportRatio) {
                    zoom = viewport.width / (width + 100); // Add some padding
                } else {
                    zoom = viewport.height / (height + 100); // Add some padding
                }
                
                // Limit zoom to reasonable values
                zoom = Math.min(Math.max(0.01, zoom), 2.0);
                
                // Set the view
                reactFlowInstance.setViewport({
                    x: viewport.width / 2 - centerX * zoom,
                    y: viewport.height / 2 - centerY * zoom,
                    zoom: zoom
                });
            }
        }, [reactFlowInstance, nodes]);
        // Initialize flow and center view
        useEffect(() => {
            if (flow?.nodes) {
                const flowContent = typeof flow.nodes === 'string' ? JSON.parse(flow.nodes) : flow.nodes;
                // Para fluxos de disparo, se n√£o houver nodes, criar um n√≥ trigger inicial
                const defaultNodes = isDisparoFlow 
                    ? [{ id: 'start', type: 'trigger', position: { x: 250, y: 50 }, data: {}, deletable: false }]
                    : initialNodes;
                const nodesToSet = (flowContent.nodes || defaultNodes).map(node => {
                    const nodeData = node.data || {};
                    if (node.type === 'trigger') {
                        return {
                            ...node,
                            data: nodeData,
                            deletable: isDisparoFlow ? false : (node.deletable !== undefined ? node.deletable : false)
                        };
                    }

                    const actionsSource = Array.isArray(nodeData.actions) ? nodeData.actions : [];
                    const normalizedActions = actionsSource.map(action => normalizeInviteAction(action).action);

                    return {
                        ...node,
                        data: {
                            ...nodeData,
                            actions: normalizedActions,
                            waitForReply: nodeData.waitForReply ?? false,
                            replyTimeout: nodeData.replyTimeout ?? 5
                        }
                    };
                });
                setNodes(nodesToSet, { skipDirty: true });
                setEdges(flowContent.edges || [], { skipDirty: true });
                updateDirtyState(false);
                
                // Find the initial node (trigger node for both normal and disparo flows)
                const initialNode = nodesToSet.find(node => node.type === 'trigger');
                
                // If we have an initial node, center the view on it
                if (initialNode && reactFlowInstance) {
                    setTimeout(() => {
                        reactFlowInstance.fitView({
                            padding: 0.5,
                            includeHiddenNodes: false,
                            duration: 300,
                            nodes: [initialNode]
                        });
                    }, 100);
                } else if (nodesToSet.length > 0) {
                    // If no trigger node but we have nodes, center on all nodes
                    setTimeout(() => {
                        reactFlowInstance?.fitView({
                            padding: 0.5,
                            duration: 300
                        });
                    }, 100);
                }
                
                // Mark as not initialized to trigger centering after first render
                setIsInitialized(false);
            }
            
            if(flow?.bot_id) {
                api.get('/api/flows')
                   .then(res => setAvailableFlows(res.data.filter(f => f.bot_id == flow.bot_id && f.id !== flow.id)))
                   .catch(console.error);
            }
            
            // Buscar estat√≠sticas de execu√ß√£o dos nodes (apenas para fluxos normais, n√£o disparos)
            if (flow?.id && !isDisparoFlow) {
                api.get(`/api/flows/${flow.id}/node-stats`)
                   .then(res => setNodeStats(res.data || {}))
                   .catch(err => {
                       console.error('Erro ao buscar estat√≠sticas dos nodes:', err);
                       setNodeStats({});
                   });
            } else {
                // Para fluxos de disparo, n√£o buscar estat√≠sticas
                setNodeStats({});
            }
        }, [flow, reactFlowInstance, setEdges, setNodes, isDisparoFlow]);
        
        // Carregar dom√≠nios das pressels
        useEffect(() => {
            const loadPresselDomains = async () => {
                if (!pressels || pressels.length === 0) {
                    setPresselDomains([]);
                    return;
                }
                
                try {
                    const allDomains = [];
                    for (const pressel of pressels) {
                        const domains = await api.get(`/api/pressels/${pressel.id}/domains`);
                        if (domains.data && domains.data.length > 0) {
                            domains.data.forEach(d => {
                                allDomains.push({
                                    label: `${pressel.name} - ${d.domain}`,
                                    value: d.domain,
                                    type: 'pressel'
                                });
                            });
                        }
                    }
                    setPresselDomains(allDomains);
                } catch (error) {
                    console.error('Erro ao carregar dom√≠nios das pressels:', error);
                    setPresselDomains([]);
                }
            };
            
            loadPresselDomains();
        }, [pressels]);
        
        // Center view after first render and when nodes are loaded
        useEffect(() => {
            if (!isInitialized && nodes.length > 0 && reactFlowInstance) {
                // Small delay to ensure the DOM is ready
                const timer = setTimeout(() => {
                    centerViewOnNodes();
                    setIsInitialized(true);
                }, 100);
                
                return () => clearTimeout(timer);
            }
        }, [isInitialized, nodes, reactFlowInstance, centerViewOnNodes]);

        const onNodesDelete = useCallback((deleted) => {
            setEdges((prevEdges) => {
                const connectedEdges = getConnectedEdges(deleted, prevEdges);
                return prevEdges.filter((edge) => !connectedEdges.includes(edge));
            });
        }, [setEdges]);
        const onConnect = useCallback((params) => {
            // Garante que cada handle s√≥ pode conectar a 1 n√≥
            // Remove qualquer conex√£o existente do mesmo handle antes de adicionar nova
            setEdges((eds) => {
                // Remove todas as conex√µes existentes do mesmo source e sourceHandle
                const filteredEdges = eds.filter(
                    edge => !(edge.source === params.source && edge.sourceHandle === params.sourceHandle)
                );
                
                // Adiciona a nova conex√£o
                return addEdge({ ...params, type: 'smoothstep', animated: true, selectable: true }, filteredEdges);
            });
        }, [setEdges]);
        const onNodeClick = useCallback((_, node) => setSelectedNode(node), []);
        const onPaneClick = useCallback(() => { setSelectedNode(null); setSelectedEdge(null); }, []);
        const onDragOver = useCallback((event) => { event.preventDefault(); event.dataTransfer.dropEffect = 'move'; }, []);
        const onDrop = useCallback((event) => { 
            event.preventDefault(); 
            const actionType = event.dataTransfer.getData('application/reactflow'); 
            if (!actionType) return; 
            
            // Obter a posi√ß√£o relativa ao container do ReactFlow
            const reactFlowBounds = reactFlowWrapper.current.getBoundingClientRect();
            const position = reactFlowInstance.project({ 
                x: event.clientX - reactFlowBounds.left, 
                y: event.clientY - reactFlowBounds.top 
            }); 
            
            // Criar node vazio com uma primeira a√ß√£o
            const newNode = { 
                id: `action-${Date.now()}`, 
                type: 'action', 
                position, 
                data: { actions: [createActionWithDefaults(actionType)] }, 
            }; 
            setNodes((nds) => nds.concat(newNode)); 
        }, [reactFlowInstance, setNodes, reactFlowWrapper] );
        const handleSave = useCallback(async () => {
            if (!flow?.id) {
                alert('Fluxo inv√°lido. Atualize a p√°gina e tente novamente.');
                return false;
            }

            // Valida√ß√£o espec√≠fica para fluxos de disparo
            if (isDisparoFlow) {
                const hasAction = nodes.some(node => node.type === 'action');
                if (!hasAction) {
                    alert('‚ùå Fluxos de disparo devem ter pelo menos um n√≥ de a√ß√£o.');
                    return false;
                }
            }

            for (const node of nodes) {
                const actions = node.data?.actions || [];

                for (let i = 0; i < actions.length; i++) {
                    const action = actions[i];

                    if (action.type === 'message' && action.data?.text) {
                        const validation = validateTextForUrls(action.data.text);
                        if (!validation.valid) {
                            alert(`‚ùå Links n√£o s√£o permitidos no texto da mensagem!\n\nLinks detectados:\n‚Ä¢ ${validation.urls.join('\n‚Ä¢ ')}\n\nüí° Para adicionar links:\n1. Use o campo "Texto do Bot√£o"\n2. Selecione a URL no dropdown\n3. Isso garante rastreamento correto!`);
                            return false;
                        }
                    }

                    if (action.type === 'action_create_invite_link') {
                        const messageValue = (action.data?.messageText ?? action.data?.text ?? '').trim();
                        if (!messageValue) {
                            alert('‚ùå Defina o texto da mensagem para o convite.');
                            return false;
                        }
                        const validation = validateTextForUrls(messageValue);
                        if (!validation.valid) {
                            alert(`‚ùå Links n√£o s√£o permitidos na mensagem do convite!\n\nLinks detectados:\n‚Ä¢ ${validation.urls.join('\n‚Ä¢ ')}\n\nüí° Para usar o link gerado, adicione a vari√°vel {{invite_link}} ou utilize o bot√£o embutido.`);
                            return false;
                        }

                        const buttonValue = (action.data?.buttonText || '').trim();
                        if (!buttonValue) {
                            alert('‚ùå Informe o texto do bot√£o do convite.');
                            return false;
                        }

                        // Garantir sincroniza√ß√£o dos campos antes de salvar
                        action.data.messageText = messageValue;
                        action.data.text = messageValue;
                        action.data.buttonText = buttonValue;
                        delete action.data.buttonUrl;
                        delete action.data.sendMessage;
                        delete action.data.linkName;
                    }

                    if (['image', 'video', 'document'].includes(action.type) && action.data?.caption) {
                        const validation = validateTextForUrls(action.data.caption);
                        if (!validation.valid) {
                            alert(`‚ùå Links n√£o s√£o permitidos na legenda!\n\nLinks detectados:\n‚Ä¢ ${validation.urls.join('\n‚Ä¢ ')}\n\nüí° Para adicionar links:\n1. Use o campo "Texto do Bot√£o"\n2. Selecione a URL no dropdown\n3. Isso garante rastreamento correto!`);
                            return false;
                        }
                    }
                }
            }

            try {
                const endpoint = isDisparoFlow ? `/api/disparo-flows/${flow.id}` : `/api/flows/${flow.id}`;
                await api.put(endpoint, { name: flow.name, nodes: JSON.stringify({ nodes, edges }) });
                alert("Salvo!");
                updateDirtyState(false);
                return true;
            } catch (error) {
                console.error('Erro ao salvar fluxo:', error);
                alert("Erro ao salvar.");
                return false;
            }
        }, [api, edges, flow, nodes, isDisparoFlow]);
        useEffect(() => {
            if (typeof registerSaveHandler !== 'function') {
                return;
            }

            registerSaveHandler(handleSave);

            return () => {
                registerSaveHandler(null);
            };
        }, [registerSaveHandler, handleSave]);
        const addNode = (actionType, position = null) => {
            if (!reactFlowInstance) return;
            
            // If position is not provided, center it in the viewport
            let nodePosition = position;
            if (!nodePosition) {
                const reactFlowBounds = reactFlowWrapper.current.getBoundingClientRect();
                const viewportCenter = reactFlowInstance.screenToFlowPosition({
                    x: reactFlowBounds.width / 2,
                    y: reactFlowBounds.height / 2
                });
                nodePosition = viewportCenter;
            }
            
            // Criar node vazio com uma primeira a√ß√£o
            const newNode = { 
                id: `action-${Date.now()}`, 
                type: 'action', 
                position: nodePosition, 
                data: { 
                    actions: [createActionWithDefaults(actionType)]
                },
            };
            
            setNodes((nds) => nds.concat(newNode));
        };
        
        const onDragStart = (event, nodeType) => {
            event.dataTransfer.setData('application/reactflow', nodeType);
            // Prevent the click handler from firing after drag
            event.currentTarget._dragging = true;
            setTimeout(() => { event.currentTarget._dragging = false; }, 0);
        };

        const handleNodeButtonClick = (e, nodeType) => {
            // Only proceed if this is a left click and not part of a drag operation
            if (e.button === 0 && !e.currentTarget._dragging) {
                e.preventDefault();
                e.stopPropagation();
                addNode(nodeType);
            }
        };
        
        const openMediaLibrary = (callback, allowedTypes = null) => { setMediaSelectionCallback(() => callback); setMediaAllowedTypes(allowedTypes); setIsMediaModalOpen(true); };
        const handleSelectMedia = (mediaItem) => { if (mediaSelectionCallback) { mediaSelectionCallback(mediaItem); } setIsMediaModalOpen(false); setMediaSelectionCallback(null); setMediaAllowedTypes(null); };
        
        const nodeTypesList = [
            { type: 'message', icon: 'üí¨', label: 'Mensagem', category: 'Componentes' },
            { type: 'delay', icon: '‚è±Ô∏è', label: 'Atraso', category: 'Componentes' },
            { type: 'action_pix', icon: 'üí≥', label: 'Gerar PIX', category: 'A√ß√µes' },
            { type: 'action_check_pix', icon: 'üîç', label: 'Consultar PIX', category: 'A√ß√µes' },
            { type: 'forward_flow', icon: '‚Ü™Ô∏è', label: 'Encaminhar Fluxo', category: 'A√ß√µes' },
            { type: 'action_create_invite_link', icon: 'üîó', label: 'Criar Link de Convite', category: 'Grupo' },
            { type: 'action_remove_user_from_group', icon: 'üë§', label: 'Remover Usu√°rio do Grupo', category: 'Grupo' }
        ];
        
        const handleNodeTypeSelect = (nodeType) => {
            addNode(nodeType);
            setIsNodeSelectorOpen(false);
        };

        return (
            <div className="flow-editor-page">
                {isMediaModalOpen && <MediaLibraryModal onSelect={handleSelectMedia} onClose={() => setIsMediaModalOpen(false)} allowedTypes={mediaAllowedTypes} />}
                <div className="flow-header">
                    <h3>{isDisparoFlow ? 'üì§ Editando Fluxo de Disparo:' : 'Editando:'} {flow.name}</h3>
                    <div>
                        <button className="btn btn-secondary" onClick={() => onRequestClose && onRequestClose()}>Voltar</button>
                        <button className="btn btn-primary" onClick={handleSave}>Salvar</button>
                    </div>
                </div>
                <div className="flow-editor-container">
                    <div className="reactflow-wrapper" ref={reactFlowWrapper}>
                        <ReactFlowProvider>
                            <ReactFlow nodes={nodes} edges={edges} onNodesChange={handleNodesChange} onEdgesChange={handleEdgesChange} onConnect={onConnect} onNodeClick={onNodeClick} onPaneClick={onPaneClick} onInit={setReactFlowInstance} onDrop={onDrop} onDragOver={onDragOver} onNodesDelete={onNodesDelete} nodeTypes={nodeTypes} onEdgeClick={(event, edge) => { setSelectedEdge({ edge, x: event.clientX, y: event.clientY }); setIsFading(false); }} connectionMode="loose" connectionRadius={60} fitView minZoom={0.1} maxZoom={2.0}>
                                <Background />
                                <Controls />
                </ReactFlow>
                </ReactFlowProvider>
                </div>
                </div>
                {selectedEdge && (
                    <div style={{
                        position: 'fixed',
                        left: selectedEdge.x,
                        top: selectedEdge.y,
                        zIndex: 1000,
                        background: 'var(--bg-secondary)',
                        border: '1px solid var(--border-color)',
                        borderRadius: '4px',
                        padding: '4px',
                        animation: 'fadeIn 0.5s ease-out',
                        opacity: isFading ? 0 : 1,
                        transition: 'opacity 0.5s ease-out'
                    }}>
                    <button 
                        className="node-action-btn delete"
                        onClick={(e) => { 
                            e.stopPropagation();
                            setEdges(eds => eds.filter(e => e.id !== selectedEdge.edge.id)); 
                            setSelectedEdge(null); 
                        }}
                        title="Excluir edge"
                    >
                        ‚ùå
                    </button>
                    </div>
               )}
                <button 
                    className="add-node-fab" 
                    onClick={() => setIsNodeSelectorOpen(true)}
                    title="Adicionar Node"
                >
                    +
                </button>
                {isNodeSelectorOpen && (
                    <div className="node-selector-modal-overlay" onClick={(e) => {
                        if (e.target === e.currentTarget) {
                            setIsNodeSelectorOpen(false);
                            setIsGroupMenuOpen(false);
                        }
                    }}>
                        <div className="node-selector-modal" onClick={(e) => e.stopPropagation()}>
                            <div className="node-selector-modal-header">
                                <h3>Adicionar Node</h3>
                                <button 
                                    className="node-selector-modal-close"
                                    onClick={() => { setIsNodeSelectorOpen(false); setIsGroupMenuOpen(false); }}
                                    title="Fechar"
                                >
                                    ‚úï
                                </button>
                            </div>
                            <div className="node-selector-modal-content">
                                {nodeTypesList.filter(nodeType => {
                                    if (nodeType.category === 'Grupo') return false;
                                    if (isDisparoFlow && nodeType.type === 'forward_flow') return false;
                                    return true;
                                }).map(nodeType => (
                                    <button
                                        key={nodeType.type}
                                        className="node-selector-button"
                                        onClick={() => handleNodeTypeSelect(nodeType.type)}
                                    >
                                        <span className="node-selector-button-icon">{nodeType.icon}</span>
                                        <span>{nodeType.label}</span>
                                    </button>
                                ))}
                                {!isDisparoFlow && (
                                    <>
                                        <button
                                            className="node-selector-button"
                                            onClick={() => setIsGroupMenuOpen(!isGroupMenuOpen)}
                                            style={{ display: 'flex', alignItems: 'center', justifyContent: 'space-between' }}
                                        >
                                            <span style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                                                <span className="node-selector-button-icon">üë•</span>
                                                <span>Gerenciar Grupos</span>
                                            </span>
                                            <span style={{ fontSize: '0.9rem' }}>
                                                {isGroupMenuOpen ? '‚ñæ' : '‚ñ∏'}
                                            </span>
                                        </button>
                                        {isGroupMenuOpen && nodeTypesList.filter(nodeType => nodeType.category === 'Grupo').map(nodeType => (
                                    <button
                                        key={nodeType.type}
                                        className="node-selector-button"
                                        onClick={() => handleNodeTypeSelect(nodeType.type)}
                                        style={{ marginLeft: '12px' }}
                                    >
                                        <span className="node-selector-button-icon">{nodeType.icon}</span>
                                        <span>{nodeType.label}</span>
                                    </button>
                                ))}
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                )}
                {selectedNode && selectedNode.type !== 'trigger' && <EditorPanel selectedNode={selectedNode} setNodes={setNodes} setEdges={setEdges} setSelectedNode={setSelectedNode} availableFlows={availableFlows} openMediaLibrary={openMediaLibrary} presselDomains={presselDomains} thankYouPages={thankYouPages} hostedCheckouts={hostedCheckouts} isDisparoFlow={isDisparoFlow} />}
            </div>
        );
    }
    
    // --- FIM DO C√ìDIGO DO HOTBOT PARA COLAR ---

    // Renderiza a aplica√ß√£o React no container
    const root = window.ReactDOM.createRoot(containerElement);
    // Certifique-se de que o nome do componente principal foi renomeado
    root.render(<AppHotBot />); 
    window.hotBotRoot = root; // Guarda a refer√™ncia para poder desmontar
}
        // Renderiza a aplica√ß√£o React no container

    </script>
</body>
</html>